(self.webpackChunkmfModules=self.webpackChunkmfModules||[]).push([[548],{"./src/mobile.mediaViewer/ImageCarousel.js":(e,t,i)=>{const s=i("./src/mobile.startup/View.js"),a=i("./src/mobile.startup/util.js"),n=i("./src/mobile.startup/IconButton.js"),r=i("./src/mobile.startup/icons.js"),l=i("./src/mobile.startup/eventBusSingleton.js"),o=new(i("./src/mobile.startup/Button.js"))({label:mw.msg("mobile-frontend-media-details"),additionalClassNames:"button",progressive:!0}),d=new n({rotation:90,icon:"expand-invert",label:mw.msg("mobile-frontend-media-prev")}),m=new n({rotation:-90,icon:"expand-invert",label:mw.msg("mobile-frontend-media-next")}),h=i("./src/mobile.mediaViewer/LoadErrorMessage.js"),g=i("./src/mobile.mediaViewer/ImageGateway.js"),u=require("mediawiki.router");class c extends s{constructor(e){super(a.extend({className:"image-carousel",events:{"click .image-wrapper":"onToggleDetails","click .slider-button":"onSlide"}},e))}initialize(e){this.gateway=e.gateway||new g({api:e.api}),this.router=e.router||u,this.eventBus=e.eventBus,this.hasLoadError=!1,super.initialize(e)}get template(){return a.template('\n<button title="{{prevMsg}}" class="prev slider-button"></button>\n<div class="main">\n\t<div class="image-wrapper">\n\t\t<div class="image"></div>\n\t</div>\n\t\x3c!-- cancel button will go here --\x3e\n\t<div class="image-details">\n\t\t\x3c!-- details button will go here --\x3e\n\t\t<p class="truncated-text">{{caption}}</p>\n\t\t<p class="license"><a href="#">{{licenseLinkMsg}}</a></p>\n\t</div>\n</div>\n<button title="{{nextMsg}}" class="next slider-button"></button>\n\t')}get defaults(){return a.extend({},super.defaults,{licenseLinkMsg:mw.msg("mobile-frontend-media-license-link"),prevMsg:mw.msg("mobile-frontend-media-prev"),nextMsg:mw.msg("mobile-frontend-media-next"),thumbnails:[]})}onSlide(e){const t=this.$el.find(e.target).closest(".slider-button").data("thumbnail"),i=t.options.filename;this.router.navigateTo(null,{path:"#/media/"+i,useReplaceState:!0}),this.options.title=t.options.filename;const s=new c(this.options);this.$el.replaceWith(s.$el),this.$el=s.$el}preRender(){this.options.thumbnails.forEach(((e,t)=>{e.getFileName()===this.options.title&&(this.options.caption=e.getDescription(),this.galleryOffset=t)}))}_enableArrowImages(e){const t=this.galleryOffset;let i,s;void 0===this.galleryOffset?(i=e[e.length-1],s=e[0]):(i=e[0===t?e.length-1:t-1],s=e[t===e.length-1?0:t+1]),this.$el.find(".prev").data("thumbnail",i),this.$el.find(".next").data("thumbnail",s)}_disableArrowImages(){this.$el.find(".prev, .next").remove()}_handleRetry(){this.router.emit("hashchange")}postRender(){let e;const t=this.$el,i=r.spinner().$el,s=this.options.thumbnails||[],a=()=>{this.hasLoadError=!0,i.hide(),t.find(".image img").hide(),0===t.find(".load-fail-msg").length&&new h({retryPath:this.router.getPath()}).on("retry",(()=>this._handleRetry())).prependTo(t.find(".image"))},n=()=>{e.addClass("image-loaded")};s.length<2?this._disableArrowImages():this._enableArrowImages(s),this.$details=t.find(".image-details"),t.find(".image").append(i),this.$details.prepend(o.$el),this.gateway.getThumb(this.options.title).then((s=>{let r;const l=s.descriptionurl+"#mw-jump-to-license";i.hide(),this.thumbWidth=s.thumbwidth,this.thumbHeight=s.thumbheight,this.imgRatio=s.thumbwidth/s.thumbheight,e=this.parseHTML("<img>",document),e.on("load",n).on("error",a),e.attr("src",s.thumburl).attr("alt",this.options.caption),t.find(".image").append(e),this.$details.addClass("is-visible"),this._positionImage(),t.find(".image-details a").attr("href",l),s.extmetadata&&(s.extmetadata.LicenseShortName&&t.find(".license a").text(s.extmetadata.LicenseShortName.value).attr("href",l),s.extmetadata.Artist&&(r=s.extmetadata.Artist.value.replace(/<.*?>/g,""),t.find(".license").prepend(r+" &bull; "))),this.adjustDetails()}),(()=>{a()})),l.on("resize:throttled",(()=>this._positionImage())),this._positionImage()}onToggleDetails(){this.hasLoadError||(this.$el.find(".cancel, .slider-button").toggle(),this.$details.toggle(),this._positionImage())}_positionImage(){const e=a.getWindow();this.adjustDetails();const t=this.$details.is(":visible")?this.$details.outerHeight():0,i=e.width(),s=e.height()-t,n=i/s,r=this.$el.find("img");this.imgRatio>n?i<this.thumbWidth&&r.css({width:i,height:"auto"}):s<this.thumbHeight&&r.css({width:"auto",height:s}),this.$el.find(".image-wrapper").css("bottom",t),this.$el.find(".slider-button.prev").append(d.$el),this.$el.find(".slider-button.next").append(m.$el)}adjustDetails(){const e=a.getWindow().height();this.$el.find(".image-details").height()>.5*e&&this.$el.find(".image-details").css("max-height",.5*e)}}e.exports=c},"./src/mobile.mediaViewer/ImageGateway.js":(e,t,i)=>{const s=[320,640,800,1024,1280,1920,2560,2880],a=i("./src/mobile.startup/actionParams.js"),n=i("./src/mobile.startup/util.js");class r{constructor(e){this._cache={},this.api=e.api}getThumb(e){const t=this._cache[e],i=n.getWindow(),s=window.devicePixelRatio&&window.devicePixelRatio>1?window.devicePixelRatio:1;return t||(this._cache[e]=this.api.get(a({prop:"imageinfo",titles:e,iiprop:["url","extmetadata"],iiurlwidth:r.findSizeBucket(i.width()*s),iiurlheight:r.findSizeBucket(i.height()*s)})).then((e=>{if(e.query&&e.query.pages&&e.query.pages[0]&&e.query.pages[0].imageinfo)return e.query.pages[0].imageinfo[0];throw new Error("The API failed to return any pages matching the titles.")}))),this._cache[e]}static findSizeBucket(e){let t=0;for(;e>s[t]&&t<s.length-1;)++t;return s[t]}}e.exports=r},"./src/mobile.mediaViewer/LoadErrorMessage.js":(e,t,i)=>{const s=i("./src/mobile.startup/util.js"),a=i("./src/mobile.startup/icons.js"),n=i("./src/mobile.startup/View.js");e.exports=class extends n{constructor(e){super({events:{"click .load-fail-msg-link a":"onRetry"}},e)}get template(){return s.template('\n<div class="load-fail-msg">\n  <div class="load-fail-msg-text">{{msgToUser}}</div>\n  <div class="load-fail-msg-link">\n    <a href="#">{{retryTxt}}</a>\n  </div>\n</div>\n\t')}get isTemplateMode(){return!0}get defaults(){return s.extend({},super.defaults,{msgToUser:mw.msg("mobile-frontend-media-load-fail-message"),retryTxt:mw.msg("mobile-frontend-media-load-fail-retry")})}postRender(){this.$el.prepend(a.error().$el),this.$el.find(".load-fail-msg-link a").attr("href","#"+this.options.retryPath)}onRetry(){return this.emit("retry"),!1}}},"./src/mobile.mediaViewer/mobile.mediaViewer.js":(e,t,i)=>{const s=i("./src/mobile.startup/moduleLoaderSingleton.js"),a=i("./src/mobile.mediaViewer/ImageCarousel.js");s.define("mobile.mediaViewer",{ImageCarousel:a})}},e=>{e.O(0,[569],(()=>e(e.s="./src/mobile.mediaViewer/mobile.mediaViewer.js")));var t=e.O();(this.mfModules=this.mfModules||{})["mobile.mediaViewer"]=t}]);
//# sourceMappingURL=mobile.mediaViewer.js.map.json