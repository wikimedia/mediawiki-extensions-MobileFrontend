{"version":3,"sources":["webpack://mfModules.[name]/./node_modules/hogan.js/lib/compiler.js","webpack://mfModules.[name]/./node_modules/hogan.js/lib/hogan.js","webpack://mfModules.[name]/./node_modules/hogan.js/lib/template.js","webpack://mfModules.[name]/(webpack)/buildin/global.js","webpack://mfModules.[name]/./src/mobile.categories.overlays/CategoryGateway.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/AbuseFilterOverlay.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/AbuseFilterPanel.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/BlockMessage.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/EditorGateway.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/EditorOverlay.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/EditorOverlayBase.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/VisualEditorOverlay.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/parseSaveError.js","webpack://mfModules.[name]/./src/mobile.languages.structured/LanguageOverlay.js","webpack://mfModules.[name]/./src/mobile.languages.structured/rtlLanguages.js","webpack://mfModules.[name]/./src/mobile.languages.structured/util.js","webpack://mfModules.[name]/./src/mobile.mediaViewer/ImageGateway.js","webpack://mfModules.[name]/./src/mobile.mediaViewer/ImageOverlay.js","webpack://mfModules.[name]/./src/mobile.mediaViewer/LoadErrorMessage.js","webpack://mfModules.[name]/./src/mobile.special.nearby.scripts/Nearby.js","webpack://mfModules.[name]/./src/mobile.special.nearby.scripts/NearbyGateway.js","webpack://mfModules.[name]/./src/mobile.special.uploads.scripts/PhotoListGateway.js","webpack://mfModules.[name]/./src/mobile.special.watchlist.scripts/WatchList.js","webpack://mfModules.[name]/./src/mobile.special.watchlist.scripts/WatchListGateway.js","webpack://mfModules.[name]/./src/mobile.startup/Anchor.js","webpack://mfModules.[name]/./src/mobile.startup/Browser.js","webpack://mfModules.[name]/./src/mobile.startup/Button.js","webpack://mfModules.[name]/./src/mobile.startup/CtaDrawer.js","webpack://mfModules.[name]/./src/mobile.startup/Drawer.js","webpack://mfModules.[name]/./src/mobile.startup/Icon.js","webpack://mfModules.[name]/./src/mobile.startup/MessageBox.js","webpack://mfModules.[name]/./src/mobile.startup/Overlay.js","webpack://mfModules.[name]/./src/mobile.startup/OverlayManager.js","webpack://mfModules.[name]/./src/mobile.startup/Page.js","webpack://mfModules.[name]/./src/mobile.startup/PageGateway.js","webpack://mfModules.[name]/./src/mobile.startup/PageList.js","webpack://mfModules.[name]/./src/mobile.startup/Panel.js","webpack://mfModules.[name]/./src/mobile.startup/ScrollEndEventEmitter.js","webpack://mfModules.[name]/./src/mobile.startup/Section.js","webpack://mfModules.[name]/./src/mobile.startup/Thumbnail.js","webpack://mfModules.[name]/./src/mobile.startup/Toggler.js","webpack://mfModules.[name]/./src/mobile.startup/View.js","webpack://mfModules.[name]/./src/mobile.startup/actionParams.js","webpack://mfModules.[name]/./src/mobile.startup/cache.js","webpack://mfModules.[name]/./src/mobile.startup/context.js","webpack://mfModules.[name]/./src/mobile.startup/extendSearchParams.js","webpack://mfModules.[name]/./src/mobile.startup/icons.js","webpack://mfModules.[name]/./src/mobile.startup/lazyImages/lazyImageLoader.js","webpack://mfModules.[name]/./src/mobile.startup/lazyReferencesLoader.js","webpack://mfModules.[name]/./src/mobile.startup/loadingOverlay.js","webpack://mfModules.[name]/./src/mobile.startup/mfExtend.js","webpack://mfModules.[name]/./src/mobile.startup/moduleLoader.js","webpack://mfModules.[name]/./src/mobile.startup/rlModuleLoader.js","webpack://mfModules.[name]/./src/mobile.startup/search/SearchGateway.js","webpack://mfModules.[name]/./src/mobile.startup/time.js","webpack://mfModules.[name]/./src/mobile.startup/toast.js","webpack://mfModules.[name]/./src/mobile.startup/util.js","webpack://mfModules.[name]/./src/mobile.startup/watchstar/Watchstar.js","webpack://mfModules.[name]/./src/mobile.startup/watchstar/WatchstarGateway.js","webpack://mfModules.[name]/./src/mobile.startup/watchstar/WatchstarPageList.js","webpack://mfModules.[name]/./src/mobile.talk.overlays/TalkBoard.js","webpack://mfModules.[name]/./src/mobile.talk.overlays/TalkSectionAddOverlay.js","webpack://mfModules.[name]/./src/mobile.talk.overlays/TalkSectionOverlay.js","webpack://mfModules.[name]/./src/mobile.talk.overlays/autosign.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.categories.overlays/CategoryGateway.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.editor.overlay/EditorGateway.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.editor.overlay/EditorOverlay.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.languages.structured/LanguageOverlay.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.languages.structured/util.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.mediaViewer/ImageGateway.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.mediaViewer/ImageOverlay.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.special.nearby.scripts/Nearby.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.special.nearby.scripts/NearbyGateway.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.special.uploads.scripts/PhotoListGateway.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.special.watchlist.scripts/WatchList.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.special.watchlist.scripts/WatchListGateway.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/Browser.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/Button.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/CtaDrawer.test.html.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/CtaDrawer.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/Drawer.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/Overlay.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/OverlayManager.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/Page.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/PageGateway.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/Panel.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/ScrollEndEventEmitter.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/Section.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/Toggler.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/View.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/cache.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/context.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/extendSearchParams.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/icons.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/lazyReferencesLoader.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/mfExtend.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/moduleLoader.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/rlModuleLoader.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/time.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.startup/util.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.talk.overlays/TalkBoard.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.talk.overlays/TalkSectionAddOverlay.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.talk.overlays/TalkSectionOverlay.test.js","webpack://mfModules.[name]/./tests/node-qunit/mobile.talk.overlays/autosign.test.js","webpack://mfModules.[name]/./tests/node-qunit/utils/PageGateway.responses.js","webpack://mfModules.[name]/./tests/node-qunit/utils/PageInputs.html.js","webpack://mfModules.[name]/./tests/node-qunit/utils/dom.js","webpack://mfModules.[name]/./tests/node-qunit/utils/jQuery.js","webpack://mfModules.[name]/./tests/node-qunit/utils/mw.js","webpack://mfModules.[name]/./tests/node-qunit/utils/oo.js","webpack://mfModules.[name]/external \"jquery\"","webpack://mfModules.[name]/external \"jsdom\"","webpack://mfModules.[name]/external \"oojs\"","webpack://mfModules.[name]/external \"sinon\""],"names":["Hogan","rIsWhitespace","rQuot","rNewline","rCr","rSlash","tagTypes","#","^","/","!",">","<","=","_v","{","&","cleanTripleStache","token","n","substr","length","substring","trim","s","replace","tagChange","tag","text","index","charAt","i","l","isOpener","tags","o","isCloser","close","open","c","esc","chooseMethod","indexOf","walk","tree","code","section","nodes","end","otag","ctag","invertedSection","partial","tripleStache","variable","undefined","id","method","start","tok","indent","scan","delimiters","len","state","tagType","buf","tokens","seenTag","lineStart","addBuf","push","String","filterLine","haveSeenTag","noNewLine","isAllWhitespace","j","match","lineIsWhitespace","next","toString","splice","changeDelimiters","closeIndex","split","generate","options","asString","Template","Function","parse","buildTree","kind","stack","customTags","instructions","opener","shift","Error","pop","sectionTags","cache","compile","key","t","this","exports","__webpack_require__","module","useArrayBuffer","renderFunc","compiler","r","prototype","context","partials","v","str","coerceToString","hChars","test","rAmp","rLt","rGt","rApos","render","ri","rp","name","rs","tail","isArray","val","ctx","inverted","pass","ls","d","returnFound","names","f","cx","lv","found","ho","call","b","fl","result","Array","a","Object","g","eval","e","window","actionParams","require","util","SearchGateway","CategoryGateway","parent","apply","arguments","continueParams","canContinue","searchNamespace","save","title","categories","api","postWithToken","action","appendtext","summary","mw","msg","getCategories","params","self","extend","prop","titles","clprop","cllimit","get","then","data","continue","OO","inheritClass","Button","mfExtend","Overlay","AbuseFilterOverlay","props","className","defaults","confirmButton","additionalClassNames","progressive","templatePartials","button","template","content","postRender","$","attr","View","AbuseFilterPanel","isDisallowed","overlayManager","readMoreMsg","show","type","message","add","$el","removeClass","hide","addClass","Drawer","Icon","BlockMessage","stopHandIcon","userIcon","tagName","okButton","label","createDetailsAnchorHref","getUrl","wpTarget","blockId","createDetailsAnchorLabel","createTitle","reasonHeader","creatorHeader","user","gender","expiryHeader","icon","onShowDrawer","wiki","config","track","parseSaveError","EditorGateway","sectionId","oldId","isNewPage","hasChanged","getBlockInfo","pageObj","blockedError","actions","edit","some","error","blockinfo","loader","load","getContent","resolve","Deferred","userinfo","meta","rvprop","intestactions","intestactionsdetail","uiprop","rvstartid","isNumeric","rvsection","resp","revision","reject","query","pages","missing","revisions","timestamp","originalContent","setContent","setPrependText","prependtext","apiOptions","captchaid","captchaId","captchaword","captchaWord","basetimestamp","starttimestamp","saveContent","abortPreview","_pending","abort","getPreview","request","sectionLine","sectionpreview","pst","mobileformat","post","sections","line","promise","EditorOverlayBase","Section","VisualEditorOverlay","MessageBox","EditorOverlay","gateway","readOnly","isVisualEditorEnabled","editSwitcher","editingMsg","isAnon","_prepareAnonWarning","isVisualEditor","previewingMsg","events","input .wikitext-editor","messageBox","anonWarning","loginButton","block","signupButton","anonButton","warningOptions","editor","ns","namespaces","onInputWikitextEditor","onClickContinue","ev","target","hasClass","_showEditorAfterWarning","onClickBack","_hidePreview","using","switchToolbar","toolFactory","ui","ToolFactory","toolGroupFactory","ToolGroupFactory","register","libs","ve","MWEditModeVisualTool","MWEditModeSourceTool","Toolbar","classes","on","mode","confirm","onStageChanges","_switchToVisualEditor","setup","include","find","html","$element","emit","$preview","$content","$anonWarning","$anonHiddenButtons","hideSpinner","abuseFilterPanel","appendTo","_resizeEditor","bind","_loadContent","returnto","returnTo","returntoquery","warning","queryParams","signupParams","signupQueryParams","href","showSpinner","hideSpinnerAndShowPreview","scrollTop","getDocument","mainpage","parsedText","parsedSectionLine","parseHTML","el","scrollTo","showHidden","container","$scrollContainer","Element","static","getClosestScrollableContainer","css","height","_parseBlockInfo","blockInfo","expiry","reason","moment","blockpartial","creator","blockedby","url","duration","blockid","blockexpiry","format","to","blockreason","wikitext","parser","ast","jqueryMsg","wikiTextToAst","emitter","jqueryMsgParse","escape","escaped","toggle","reportError","log","mechanism","storage","set","targetLoader","addPlugin","loadModules","switching","replaceCurrent","_showAbuseFilter","onSaveBegin","confirmAborted","location","onSaveComplete","onSaveFailure","heading","details","handleCaptcha","saveFailureMessage","PageGateway","toast","mwUser","EditVeTool","toolGroup","super","isBorderBox","click .back","click .continue","click .submit","placeholder","summaryRequestMsg","pageGateway","editCount","isNewEditor","sessionId","allowCloseWindow","confirmCloseWindow","namespace","Tool","group","onSelect","onUpdateState","hasToolbar","continueMsg","cancelMsg","closeMsg","summaryMsg","waitMsg","waitIcon","toHtmlString","captchaMsg","captchaTryAgainMsg","switchMsg","confirmMsg","licenseMsg","editHeader","previewHeader","saveHeader","editor_interface","editing_session_id","confirmSave","$window","getWindow","saved","invalidatePage","showOnPageReload","hash","off","reload","editconflict","wasdeleted","abusefilter-disallowed","captcha","spamprotectiontext","titleblacklist-forbidden-edit","readonlyreason","info","errorNotice","$errorNoticeContainer","hideErrorNotice","empty","skipPreview","nextStep","saveMsg","hook","fire","onClickSubmit","windowManager","getWindowManager","addWindows","widgets","AbandonEditDialog","openWindow","closed","release","edited","shouldConfirmLeave","force","$input","captchaShown","setTimeout","mime","detach","question","applyHeaderOptions","isVE","destroyTarget","destroy","init","targetFactory","create","dataPromise","overlay","retval","switchToEditor","switchToSourceEditor","getSurface","getModel","hasBeenModified","langUtil","LanguageOverlay","languages","getStructuredLanguages","variants","getFrequentlyUsedLanguages","deviceLanguage","click a","input .search","inputPlaceholder","allLanguagesHeader","toLocaleUpperCase","suggestedLanguagesHeader","preRender","allLanguages","all","allLanguagesCount","suggestedLanguages","suggested","suggestedLanguagesCount","$siteLinksList","$languageItems","$subheaders","onLinkClick","lang","currentTarget","$visibleLanguageLinks","filter","saveLanguageUsageCount","each","link","onSearchInput","filterLanguages","toLowerCase","filteredList","forEach","language","langname","autonym","variant","join","mfUtils","rtlLanguages","getDir","dir","frequentlyUsedLanguages","hasOwn","hasOwnProperty","maxFrequency","minFrequency","missingDir","addLangDir","parentLanguage","deviceLanguagesWithVariants","slice","getDeviceLanguageOrParent","keys","frequency","map","sort","toLocaleLowerCase","warn","languageMap","JSON","saveFrequentlyUsedLanguages","stringify","languageCode","count","sizeBuckets","findSizeBucket","size","ImageGateway","_cache","getThumb","cachedThumb","imageSizeMultiplier","devicePixelRatio","iiprop","iiurlwidth","width","iiurlheight","imageinfo","_findSizeBucket","icons","LoadErrorMessage","router","ImageOverlay","eventBus","click .image-wrapper","click .slider-button","hasFixedHeader","hideOnExitClick","cancelButton","cancel","detailsButton","licenseLinkMsg","thumbnails","slideLeftButton","rotation","slideRightButton","onSlide","nextThumbnail","closest","EVENT_SLIDE","thumbnail","getFileName","caption","getDescription","galleryOffset","_enableArrowImages","thumbs","lastThumb","nextThumb","offset","_disableArrowImages","remove","_handleRetry","$img","removeLoader","showLoadFailMsg","hasLoadError","retryPath","getPath","prependTo","addImageLoadClass","$details","author","descriptionurl","thumbWidth","thumbwidth","thumbHeight","thumbheight","imgRatio","document","thumburl","append","_positionImage","extmetadata","LicenseShortName","value","Artist","prepend","adjustDetails","onToggleDetails","onExitClick","EVENT_EXIT","detailsHeight","windowWidth","windowHeight","windowRatio","is","outerHeight","click .load-fail-msg-link a","isTemplateMode","msgToUser","retryTxt","onRetry","NearbyGateway","WatchstarPageList","Nearby","_super","range","source","nearbyApi","errorType","errorOptions","_errorOptions","onItemClick","errorMessages","hasHeading","http","incompatible","pageList","_find","pagesSuccess","_isLoading","pagesError","latitude","longitude","getPages","exclude","pageTitle","getPagesAroundPage","_postRenderLinks","refresh","Page","extendSearchParams","_distanceMessage","Math","ceil","convertNumber","toFixed","coords","_search","ggscoord","page","ggspage","requestParams","colimit","generator","ggsradius","ggsnamespace","ggslimit","codistancefrompoint","codistancefrompage","ajax","p","newFromJSON","anchor","coordinates","dist","lat","lon","proximity","PhotoListGateway","username","category","limit","getWidth","small","_getImageDataFromPage","img","description","descriptionUrl","getQuery","gaiuser","gaisort","gaidir","gailimit","gcmtitle","gcmtype","gcmdir","gcmlimit","origin","getPhotos","photos","PageList","ScrollEndEventEmitter","WatchListGateway","WatchList","lastTitle","scrollEndEventEmitter","EVENT_SCROLL_END","_loadPages","getLastTitle","disable","setElement","$items","statuses","queryUnitializedItems","parsePagesFromItems","reduce","renderItems","enable","loadWatchlist","appendPage","templateOptions","wikidataDescription","item","gwrcontinue","shouldSkipFirstTitle","gwrnamespace","gwrlimit","apiUrl","parseData","p1","p2","Anchor","destructive","browser","memoize","memoized","cacheId","Date","now","random","Browser","ua","$container","userAgent","_fixIosLandscapeBug","isIos","lockViewport","addEventListener","version","ios","isWideScreen","parseInt","innerWidth","innerHeight","supportsAnimations","elemStyle","createElement","style","supportsProperty","property","toUpperCase","supportsTouchEvents","supportsGeoLocation","navigator","getSingleton","$html","quiet","CtaDrawer","progressiveButton","actionAnchor","redirectParams","redirectURL","signUpParams","Panel","click","collapseIcon","appendToElement","closeOnScroll","docReady","onHideDrawer","stopPropagation","one","minHideDelay","hasText","modifier","setRotationClass","_rotationClass","glyphPrefix","isSmall","base","getClassName","getGlyphClassName","testPassiveOpts","supportsPassive","passiveOpts","defineProperty","removeEventListener","passive","click .cancel, .confirm, .initial-header .back","fullScreen","header","backButton","headerButtonsListClassName","headerChrome","spinner","closeOnContentTap","$spinner","$overlayContent","setupEmulatedIosOverlayScrolling","onTouchStart","onTouchMove","_resizeContent","preventDefault","startY","touches","pageY","y","contentOuterHeight","contentLength","pageYOffset","iosTouchmoveHandler","iosResizeHandler","pageXOffset","OverlayManager","appendToSelector","_checkRoute","entries","hideCurrent","attachHideEvent","_onHideOverlay","back","_attachOverlay","parents","_show","once","_hideOverlay","_processMatch","factoryResult","current","m","_matchRoute","path","entry","route","previous","getNext","factory","unshift","HTML","time","Thumbnail","HEADING_SELECTOR","BLACKLISTED_THUMBNAIL_CLASS_SELECTORS","displayTitle","isMissing","languageUrl","getDisplayTitle","isLandscape","namespaceNumber","protection","isMainPage","inNamespace","findSectionHeadingByIndex","sectionIndex","eq","findChildInSectionLead","selector","$heading","$nextHeading","$lead","headingSelector","withNestedChildren","$matchingNodes","addBack","getLeadSectionElement","children","prevAll","nextAll","nextUntil","isWikiText","isWatched","getRevisionId","revId","getTitle","getId","getNamespaceId","args","isTalkPage","_sectionLookup","sectionData","getThumbnails","blacklistSelector","_thumbs","not","$a","$lazyImage","valid","legacyMatch","RegExp","filename","decodeURIComponent","getSection","getSections","getRedLinks","thumb","pageprops","displaytitle","terms","lastModified","getLastModifiedMessage","getTime","pageid","sectionTemplate","transformSections","lastSection","existingSectionLevels","level","collapseLevel","min","subsections","assignToParent","listOfSections","child","getPage","endpoint","leadOnly","dataType","redirect","noheadings","sectionprop","resolveObj","mv","mobileview","lastmodified","lastmodifiedby","lead","historyUrl","lastModifiedTimestamp","languageCount","languagecount","hasVariants","hasvariants","lastModifiedUserName","lastModifiedUserGender","_getLanguageVariantsFromApiResponse","generalData","general","variantPath","variantarticlepath","getPageLanguages","siprop","lllimit","llprop","llinlanguagecode","langlinks","_getAPIResponseFromHTML","$span","getSectionsFromHTML","renderPageImages","click .cancel","onCancel","isVisible","threshold","EventEmitter","mixinClass","_bindScroll","_scrollHandler","_onScroll","_unbindScroll","enabled","scrollNearEnd","scrollBottom","endPosition","top","hasReferences","siblings","escapeHash","arrowOptions","Toggler","_enable","prefix","isClosed","getExpandedSections","expandedSections","saveExpandedSections","expandStoredSections","toggler","$sectionHeading","$headline","cleanObsoleteStoredSections","floor","indicator","wasExpanded","toggleClass","aria-pressed","aria-expanded","expanded","isReferenceSection","Boolean","headline","isSectionOpen","storeSectionToggleState","reveal","$target","prev","expandSections","$link","collapseSectionsByDefault","checkHash","$indicator","tabindex","aria-haspopup","aria-controls","replaceWith","which","enableKeyboardActions","internalRedirect","internalRedirectHash","checkInternalRedirectAndHash","_getExpandedSections","_expandStoredSections","_cleanObsoleteStoredSections","delegateEventSplitter","idCounter","initialize","cid","uniqueId","_postInitialize","undelegateEvents","skipTemplateRender","delegateEvents","delegate","eventName","listener","undelegate","defaultParams","formatversion","otherParams","scriptPath","MemoryCache","NoCache","getMode","feature","displayWikibaseDescriptions","concat","CANCEL_GLYPH","glyph","watchIcon","watchedIcon","placeholderClass","queryPlaceholders","root","getElementsByClassName","loadImages","placeholders","when","loadImage","deferred","dataset","image","Image","class","alt","cssText","classList","parentNode","replaceChild","src","srcset","lazyImageLoader","getSectionId","hSelector","$parent","loadReferences","getReferencesLists","lastId","refListIndex","$placeholder","getReferencesList","refListElements","loadImagesAndSetData","noHeader","Child","ParentOrPrototype","initClass","ModuleLoader","_register","registry","localRequire","define","obj","deprecate","deprecatedId","replacement","loadingOverlay","newLoadingOverlay","loadModule","delegateHide","showLoadingOverlay","hideOverlayIfNeeded","body","searchCache","getApiData","redirects","pilimit","pithumbsize","tiny","_createSearchRegEx","_highlightSearchTerm","term","_getPage","pageInfo","displaytext","_processData","results","search","xhr","isCached","units","limits","timeAgo","timestampDelta","round","unit","getTimeAgoDelta","isNow","delta","ts","seconds","minutes","hours","days","months","years","getRegistrationMessage","isRecent","storageKey","Toast","requestIdleCallback","_showPending","notification","notify","notif","escapeSelector","grep","fn","documentElement","isModifiedEvent","altKey","ctrlKey","metaKey","shiftKey","repeatEvent","proxy","event","WatchstarGateway","Watchstar","funnel","ctaDrawerOptions","campaign","_watched","tooltip","unwatchedClass","watchedClass","onLinksClick","onStatusToggleAnon","drawer","onStatusToggleUser","checker","postWatched","stopInterval","clearInterval","setInterval","postStatusesByTitle","onStatusToggle","getStatuses","ids","getStatusesByID","getStatusesByTitle","inprop","pageids","rsp","_unmarshalGetResponse","watched","unwatch","wsGateway","_","$item","_appendWatchstar","watchstar","TalkBoard","$board","headings","pageData","_addContent","onFail","explanation","autosign","TalkSectionAddOverlay","editorApi","input .wikitext-editor, .summary","change .wikitext-editor, .summary","click .confirm-save","currentPageTitle","_saveHit","topicTitlePlaceHolder","topicContentPlaceHolder","contentHeader","$confirm","$subject","$ta","confirmMessage","onTextInput","clearTimeout","timer","onSaveClick","isOnTalkPage","status","editMsg","sectiontitle","popup","TalkSectionOverlay","focus textarea","click .save-button","saveButton","reply","$saveButton","_enableComments","renderFromApi","$commentBox","$textarea","onFocusTextarea","enableSaveButton","response","global","sandbox","jQuery","dom","mediaWiki","oo","sinon","QUnit","beforeEach","setUp","getSpy","stub","returns","batchcomplete","postSpy","afterEach","tearDown","restore","assert","notStrictEqual","strictEqual","ok","calledWith","spy","postStub","apiReject","apiHappy","apiRvNoSection","apiCaptchaFail","apiAbuseFilterDisallow","apiAbuseFilterWarning","apiAbuseFilterOther","apiTestError","apiReadOnly","apiExpiredToken","apiWithSectionLine","apiHappyTestContent","apiEmptySuccessResponse","apiNoSectionLine","apiRejectHttp","happyResponse","apiReadOnlyResponse","Api","*","0","1","onFirstCall","callCount","notOk","called","rejects","given","propEqual","resolveSpy","rejectSpy","done","async","expectedReturnValue","calledWithMatch","messageStub","getContentStub","previewResolve","withArgs","callback","2","blockedByUser","dBlockedContent","editorOverlay","apiLanguages","zh-min-nan","zh","en","ko","languageOverlay","currentLanguage","apiVariants","structuredLanguages","saveSpy","variantsMap","suggestedLanguage","err","imageGateway","catch","trigger","opts","nearby","nearbyGateway","arg","pageimage","primary","globe","msgKm","msgM","tests","getCall","toPrecision","pl","watchIconName","notCalled","pageimages","picontinue","warnings","contentmodel","pagelanguage","touched","lastrevid","new","watchlist","firstCall","response1","watchlistraw","mediawiki","tmpDOM","implementation","createHTMLDocument","browser4","browser5","browser2","ipad","iphone","android2","viewportTagVal","animationName","transform","transition","ontouchstart","geolocation","getAttribute","defaultURLs","overrideURLs","pageName","appendChild","removeChild","subject","outerHTML","callOnPresented","assertHidden","Event","dispatchEvent","bubbles","$viewport","headingNode","TestOverlay","fakeRouter","createFakeOverlay","fakeOverlay","singleton","showSpy","anotherFakeOverlay","factoryStub","notCalledWith","parentFakeOverlay","parentFactoryStub","calledOnce","retryOverlayFn","failedOverlay","successfulOverlay","onCall","stubPage","mobileTocPage","desktopPage","sectionPage","PARSER_OUTPUT","ambox","sectionHeading","sectionSubHeading","sectionBody","expect","testcase","textPage","pLegacyUrls","pNoViewer","pMetadata","pLazyImages","metadataTable","pLazyImagesTypo","pMetadataNested","tc","notMissing","testDesc","json","examples","page2","testData","getPageHeadings","input","output","getPageLanguagesResponse","getPageLanguagesCall","getAPIResponseFromHTML","expected","move","panel","is2","handler","emitSpy","subsection","$section0","$section","mwStorageSetCall","mwStorageSetCall2","mwStorageSetSpy","isEmptyObject","_typeof","localStorageValue","localStorageRemovalValue","expandedSectionsFromToggle","view","ChildView","EventsView","click p span","click p","onParagraphClick","onClick","view2","textFirstRun","TemplateModeView","ContainerView","click span","memoryCache","foo","expectedError","throws","qux","wbptterms","baz","quux","lazyReferencesLoader","skinPage","$elTwo","$elThree","$elFour","$elFive","TestChild","TestPrototype","testChild","testPrototype","protoMethod","rlModuleLoader","assertShowHideWorksWhenSuccessful","firstArg","secondArg","thirdArg","resolved","res","htmlFragment","innerHTML","NaN","testEl","MouseEvent","getPageDeferredReject","getPageDeferredResolve","board","toastStub","renderFromApiSpy","testCase","references","referencesPage","lazyLoadedReferencesPage","headless","jsdom","JSDOM","newMockMediaWiki"],"mappings":"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","file":"tests.mobilefrontend.js","sourcesContent":["/*\n *  Copyright 2011 Twitter, Inc.\n *  Licensed under the Apache License, Version 2.0 (the \"License\");\n *  you may not use this file except in compliance with the License.\n *  You may obtain a copy of the License at\n *\n *  http://www.apache.org/licenses/LICENSE-2.0\n *\n *  Unless required by applicable law or agreed to in writing, software\n *  distributed under the License is distributed on an \"AS IS\" BASIS,\n *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *  See the License for the specific language governing permissions and\n *  limitations under the License.\n */\n\n(function (Hogan) {\n  // Setup regex  assignments\n  // remove whitespace according to Mustache spec\n  var rIsWhitespace = /\\S/,\n      rQuot = /\\\"/g,\n      rNewline =  /\\n/g,\n      rCr = /\\r/g,\n      rSlash = /\\\\/g,\n      tagTypes = {\n        '#': 1, '^': 2, '/': 3,  '!': 4, '>': 5,\n        '<': 6, '=': 7, '_v': 8, '{': 9, '&': 10\n      };\n\n  Hogan.scan = function scan(text, delimiters) {\n    var len = text.length,\n        IN_TEXT = 0,\n        IN_TAG_TYPE = 1,\n        IN_TAG = 2,\n        state = IN_TEXT,\n        tagType = null,\n        tag = null,\n        buf = '',\n        tokens = [],\n        seenTag = false,\n        i = 0,\n        lineStart = 0,\n        otag = '{{',\n        ctag = '}}';\n\n    function addBuf() {\n      if (buf.length > 0) {\n        tokens.push(new String(buf));\n        buf = '';\n      }\n    }\n\n    function lineIsWhitespace() {\n      var isAllWhitespace = true;\n      for (var j = lineStart; j < tokens.length; j++) {\n        isAllWhitespace =\n          (tokens[j].tag && tagTypes[tokens[j].tag] < tagTypes['_v']) ||\n          (!tokens[j].tag && tokens[j].match(rIsWhitespace) === null);\n        if (!isAllWhitespace) {\n          return false;\n        }\n      }\n\n      return isAllWhitespace;\n    }\n\n    function filterLine(haveSeenTag, noNewLine) {\n      addBuf();\n\n      if (haveSeenTag && lineIsWhitespace()) {\n        for (var j = lineStart, next; j < tokens.length; j++) {\n          if (!tokens[j].tag) {\n            if ((next = tokens[j+1]) && next.tag == '>') {\n              // set indent to token value\n              next.indent = tokens[j].toString()\n            }\n            tokens.splice(j, 1);\n          }\n        }\n      } else if (!noNewLine) {\n        tokens.push({tag:'\\n'});\n      }\n\n      seenTag = false;\n      lineStart = tokens.length;\n    }\n\n    function changeDelimiters(text, index) {\n      var close = '=' + ctag,\n          closeIndex = text.indexOf(close, index),\n          delimiters = trim(\n            text.substring(text.indexOf('=', index) + 1, closeIndex)\n          ).split(' ');\n\n      otag = delimiters[0];\n      ctag = delimiters[1];\n\n      return closeIndex + close.length - 1;\n    }\n\n    if (delimiters) {\n      delimiters = delimiters.split(' ');\n      otag = delimiters[0];\n      ctag = delimiters[1];\n    }\n\n    for (i = 0; i < len; i++) {\n      if (state == IN_TEXT) {\n        if (tagChange(otag, text, i)) {\n          --i;\n          addBuf();\n          state = IN_TAG_TYPE;\n        } else {\n          if (text.charAt(i) == '\\n') {\n            filterLine(seenTag);\n          } else {\n            buf += text.charAt(i);\n          }\n        }\n      } else if (state == IN_TAG_TYPE) {\n        i += otag.length - 1;\n        tag = tagTypes[text.charAt(i + 1)];\n        tagType = tag ? text.charAt(i + 1) : '_v';\n        if (tagType == '=') {\n          i = changeDelimiters(text, i);\n          state = IN_TEXT;\n        } else {\n          if (tag) {\n            i++;\n          }\n          state = IN_TAG;\n        }\n        seenTag = i;\n      } else {\n        if (tagChange(ctag, text, i)) {\n          tokens.push({tag: tagType, n: trim(buf), otag: otag, ctag: ctag,\n                       i: (tagType == '/') ? seenTag - ctag.length : i + otag.length});\n          buf = '';\n          i += ctag.length - 1;\n          state = IN_TEXT;\n          if (tagType == '{') {\n            if (ctag == '}}') {\n              i++;\n            } else {\n              cleanTripleStache(tokens[tokens.length - 1]);\n            }\n          }\n        } else {\n          buf += text.charAt(i);\n        }\n      }\n    }\n\n    filterLine(seenTag, true);\n\n    return tokens;\n  }\n\n  function cleanTripleStache(token) {\n    if (token.n.substr(token.n.length - 1) === '}') {\n      token.n = token.n.substring(0, token.n.length - 1);\n    }\n  }\n\n  function trim(s) {\n    if (s.trim) {\n      return s.trim();\n    }\n\n    return s.replace(/^\\s*|\\s*$/g, '');\n  }\n\n  function tagChange(tag, text, index) {\n    if (text.charAt(index) != tag.charAt(0)) {\n      return false;\n    }\n\n    for (var i = 1, l = tag.length; i < l; i++) {\n      if (text.charAt(index + i) != tag.charAt(i)) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  function buildTree(tokens, kind, stack, customTags) {\n    var instructions = [],\n        opener = null,\n        token = null;\n\n    while (tokens.length > 0) {\n      token = tokens.shift();\n      if (token.tag == '#' || token.tag == '^' || isOpener(token, customTags)) {\n        stack.push(token);\n        token.nodes = buildTree(tokens, token.tag, stack, customTags);\n        instructions.push(token);\n      } else if (token.tag == '/') {\n        if (stack.length === 0) {\n          throw new Error('Closing tag without opener: /' + token.n);\n        }\n        opener = stack.pop();\n        if (token.n != opener.n && !isCloser(token.n, opener.n, customTags)) {\n          throw new Error('Nesting error: ' + opener.n + ' vs. ' + token.n);\n        }\n        opener.end = token.i;\n        return instructions;\n      } else {\n        instructions.push(token);\n      }\n    }\n\n    if (stack.length > 0) {\n      throw new Error('missing closing tag: ' + stack.pop().n);\n    }\n\n    return instructions;\n  }\n\n  function isOpener(token, tags) {\n    for (var i = 0, l = tags.length; i < l; i++) {\n      if (tags[i].o == token.n) {\n        token.tag = '#';\n        return true;\n      }\n    }\n  }\n\n  function isCloser(close, open, tags) {\n    for (var i = 0, l = tags.length; i < l; i++) {\n      if (tags[i].c == close && tags[i].o == open) {\n        return true;\n      }\n    }\n  }\n\n  Hogan.generate = function (tree, text, options) {\n    var code = 'var _=this;_.b(i=i||\"\");' + walk(tree) + 'return _.fl();';\n    if (options.asString) {\n      return 'function(c,p,i){' + code + ';}';\n    }\n\n    return new Hogan.Template(new Function('c', 'p', 'i', code), text, Hogan, options);\n  }\n\n  function esc(s) {\n    return s.replace(rSlash, '\\\\\\\\')\n            .replace(rQuot, '\\\\\\\"')\n            .replace(rNewline, '\\\\n')\n            .replace(rCr, '\\\\r');\n  }\n\n  function chooseMethod(s) {\n    return (~s.indexOf('.')) ? 'd' : 'f';\n  }\n\n  function walk(tree) {\n    var code = '';\n    for (var i = 0, l = tree.length; i < l; i++) {\n      var tag = tree[i].tag;\n      if (tag == '#') {\n        code += section(tree[i].nodes, tree[i].n, chooseMethod(tree[i].n),\n                        tree[i].i, tree[i].end, tree[i].otag + \" \" + tree[i].ctag);\n      } else if (tag == '^') {\n        code += invertedSection(tree[i].nodes, tree[i].n,\n                                chooseMethod(tree[i].n));\n      } else if (tag == '<' || tag == '>') {\n        code += partial(tree[i]);\n      } else if (tag == '{' || tag == '&') {\n        code += tripleStache(tree[i].n, chooseMethod(tree[i].n));\n      } else if (tag == '\\n') {\n        code += text('\"\\\\n\"' + (tree.length-1 == i ? '' : ' + i'));\n      } else if (tag == '_v') {\n        code += variable(tree[i].n, chooseMethod(tree[i].n));\n      } else if (tag === undefined) {\n        code += text('\"' + esc(tree[i]) + '\"');\n      }\n    }\n    return code;\n  }\n\n  function section(nodes, id, method, start, end, tags) {\n    return 'if(_.s(_.' + method + '(\"' + esc(id) + '\",c,p,1),' +\n           'c,p,0,' + start + ',' + end + ',\"' + tags + '\")){' +\n           '_.rs(c,p,' +\n           'function(c,p,_){' +\n           walk(nodes) +\n           '});c.pop();}';\n  }\n\n  function invertedSection(nodes, id, method) {\n    return 'if(!_.s(_.' + method + '(\"' + esc(id) + '\",c,p,1),c,p,1,0,0,\"\")){' +\n           walk(nodes) +\n           '};';\n  }\n\n  function partial(tok) {\n    return '_.b(_.rp(\"' +  esc(tok.n) + '\",c,p,\"' + (tok.indent || '') + '\"));';\n  }\n\n  function tripleStache(id, method) {\n    return '_.b(_.t(_.' + method + '(\"' + esc(id) + '\",c,p,0)));';\n  }\n\n  function variable(id, method) {\n    return '_.b(_.v(_.' + method + '(\"' + esc(id) + '\",c,p,0)));';\n  }\n\n  function text(id) {\n    return '_.b(' + id + ');';\n  }\n\n  Hogan.parse = function(tokens, text, options) {\n    options = options || {};\n    return buildTree(tokens, '', [], options.sectionTags || []);\n  },\n\n  Hogan.cache = {};\n\n  Hogan.compile = function(text, options) {\n    // options\n    //\n    // asString: false (default)\n    //\n    // sectionTags: [{o: '_foo', c: 'foo'}]\n    // An array of object with o and c fields that indicate names for custom\n    // section tags. The example above allows parsing of {{_foo}}{{/foo}}.\n    //\n    // delimiters: A string that overrides the default delimiters.\n    // Example: \"<% %>\"\n    //\n    options = options || {};\n\n    var key = text + '||' + !!options.asString;\n\n    var t = this.cache[key];\n\n    if (t) {\n      return t;\n    }\n\n    t = this.generate(this.parse(this.scan(text, options.delimiters), text, options), text, options);\n    return this.cache[key] = t;\n  };\n})(typeof exports !== 'undefined' ? exports : Hogan);\n","/*\n *  Copyright 2011 Twitter, Inc.\n *  Licensed under the Apache License, Version 2.0 (the \"License\");\n *  you may not use this file except in compliance with the License.\n *  You may obtain a copy of the License at\n *\n *  http://www.apache.org/licenses/LICENSE-2.0\n *\n *  Unless required by applicable law or agreed to in writing, software\n *  distributed under the License is distributed on an \"AS IS\" BASIS,\n *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *  See the License for the specific language governing permissions and\n *  limitations under the License.\n */\n\n// This file is for use with Node.js. See dist/ for browser files.\n\nvar Hogan = require('./compiler');\nHogan.Template = require('./template').Template;\nmodule.exports = Hogan; ","/*\n *  Copyright 2011 Twitter, Inc.\n *  Licensed under the Apache License, Version 2.0 (the \"License\");\n *  you may not use this file except in compliance with the License.\n *  You may obtain a copy of the License at\n *\n *  http://www.apache.org/licenses/LICENSE-2.0\n *\n *  Unless required by applicable law or agreed to in writing, software\n *  distributed under the License is distributed on an \"AS IS\" BASIS,\n *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *  See the License for the specific language governing permissions and\n *  limitations under the License.\n */\n\nvar Hogan = {};\n\n(function (Hogan, useArrayBuffer) {\n  Hogan.Template = function (renderFunc, text, compiler, options) {\n    this.r = renderFunc || this.r;\n    this.c = compiler;\n    this.options = options;\n    this.text = text || '';\n    this.buf = (useArrayBuffer) ? [] : '';\n  }\n\n  Hogan.Template.prototype = {\n    // render: replaced by generated code.\n    r: function (context, partials, indent) { return ''; },\n\n    // variable escaping\n    v: hoganEscape,\n\n    // triple stache\n    t: coerceToString,\n\n    render: function render(context, partials, indent) {\n      return this.ri([context], partials || {}, indent);\n    },\n\n    // render internal -- a hook for overrides that catches partials too\n    ri: function (context, partials, indent) {\n      return this.r(context, partials, indent);\n    },\n\n    // tries to find a partial in the curent scope and render it\n    rp: function(name, context, partials, indent) {\n      var partial = partials[name];\n\n      if (!partial) {\n        return '';\n      }\n\n      if (this.c && typeof partial == 'string') {\n        partial = this.c.compile(partial, this.options);\n      }\n\n      return partial.ri(context, partials, indent);\n    },\n\n    // render a section\n    rs: function(context, partials, section) {\n      var tail = context[context.length - 1];\n\n      if (!isArray(tail)) {\n        section(context, partials, this);\n        return;\n      }\n\n      for (var i = 0; i < tail.length; i++) {\n        context.push(tail[i]);\n        section(context, partials, this);\n        context.pop();\n      }\n    },\n\n    // maybe start a section\n    s: function(val, ctx, partials, inverted, start, end, tags) {\n      var pass;\n\n      if (isArray(val) && val.length === 0) {\n        return false;\n      }\n\n      if (typeof val == 'function') {\n        val = this.ls(val, ctx, partials, inverted, start, end, tags);\n      }\n\n      pass = (val === '') || !!val;\n\n      if (!inverted && pass && ctx) {\n        ctx.push((typeof val == 'object') ? val : ctx[ctx.length - 1]);\n      }\n\n      return pass;\n    },\n\n    // find values with dotted names\n    d: function(key, ctx, partials, returnFound) {\n      var names = key.split('.'),\n          val = this.f(names[0], ctx, partials, returnFound),\n          cx = null;\n\n      if (key === '.' && isArray(ctx[ctx.length - 2])) {\n        return ctx[ctx.length - 1];\n      }\n\n      for (var i = 1; i < names.length; i++) {\n        if (val && typeof val == 'object' && names[i] in val) {\n          cx = val;\n          val = val[names[i]];\n        } else {\n          val = '';\n        }\n      }\n\n      if (returnFound && !val) {\n        return false;\n      }\n\n      if (!returnFound && typeof val == 'function') {\n        ctx.push(cx);\n        val = this.lv(val, ctx, partials);\n        ctx.pop();\n      }\n\n      return val;\n    },\n\n    // find values with normal names\n    f: function(key, ctx, partials, returnFound) {\n      var val = false,\n          v = null,\n          found = false;\n\n      for (var i = ctx.length - 1; i >= 0; i--) {\n        v = ctx[i];\n        if (v && typeof v == 'object' && key in v) {\n          val = v[key];\n          found = true;\n          break;\n        }\n      }\n\n      if (!found) {\n        return (returnFound) ? false : \"\";\n      }\n\n      if (!returnFound && typeof val == 'function') {\n        val = this.lv(val, ctx, partials);\n      }\n\n      return val;\n    },\n\n    // higher order templates\n    ho: function(val, cx, partials, text, tags) {\n      var compiler = this.c;\n      var options = this.options;\n      options.delimiters = tags;\n      var text = val.call(cx, text);\n      text = (text == null) ? String(text) : text.toString();\n      this.b(compiler.compile(text, options).render(cx, partials));\n      return false;\n    },\n\n    // template result buffering\n    b: (useArrayBuffer) ? function(s) { this.buf.push(s); } :\n                          function(s) { this.buf += s; },\n    fl: (useArrayBuffer) ? function() { var r = this.buf.join(''); this.buf = []; return r; } :\n                           function() { var r = this.buf; this.buf = ''; return r; },\n\n    // lambda replace section\n    ls: function(val, ctx, partials, inverted, start, end, tags) {\n      var cx = ctx[ctx.length - 1],\n          t = null;\n\n      if (!inverted && this.c && val.length > 0) {\n        return this.ho(val, cx, partials, this.text.substring(start, end), tags);\n      }\n\n      t = val.call(cx);\n\n      if (typeof t == 'function') {\n        if (inverted) {\n          return true;\n        } else if (this.c) {\n          return this.ho(t, cx, partials, this.text.substring(start, end), tags);\n        }\n      }\n\n      return t;\n    },\n\n    // lambda replace variable\n    lv: function(val, ctx, partials) {\n      var cx = ctx[ctx.length - 1];\n      var result = val.call(cx);\n\n      if (typeof result == 'function') {\n        result = coerceToString(result.call(cx));\n        if (this.c && ~result.indexOf(\"{\\u007B\")) {\n          return this.c.compile(result, this.options).render(cx, partials);\n        }\n      }\n\n      return coerceToString(result);\n    }\n\n  };\n\n  var rAmp = /&/g,\n      rLt = /</g,\n      rGt = />/g,\n      rApos =/\\'/g,\n      rQuot = /\\\"/g,\n      hChars =/[&<>\\\"\\']/;\n\n\n  function coerceToString(val) {\n    return String((val === null || val === undefined) ? '' : val);\n  }\n\n  function hoganEscape(str) {\n    str = coerceToString(str);\n    return hChars.test(str) ?\n      str\n        .replace(rAmp,'&amp;')\n        .replace(rLt,'&lt;')\n        .replace(rGt,'&gt;')\n        .replace(rApos,'&#39;')\n        .replace(rQuot, '&quot;') :\n      str;\n  }\n\n  var isArray = Array.isArray || function(a) {\n    return Object.prototype.toString.call(a) === '[object Array]';\n  };\n\n})(typeof exports !== 'undefined' ? exports : Hogan);\n\n","var g;\r\n\r\n// This works in non-strict mode\r\ng = (function() {\r\n\treturn this;\r\n})();\r\n\r\ntry {\r\n\t// This works if eval is allowed (see CSP)\r\n\tg = g || Function(\"return this\")() || (1, eval)(\"this\");\r\n} catch (e) {\r\n\t// This works if the window reference is available\r\n\tif (typeof window === \"object\") g = window;\r\n}\r\n\r\n// g can still be undefined, but nothing to do about it...\r\n// We return undefined, instead of nothing here, so it's\r\n// easier to handle this case. if(!global) { ...}\r\n\r\nmodule.exports = g;\r\n","var\n\tprototype,\n\tactionParams = require( '../mobile.startup/actionParams' ),\n\tutil = require( '../mobile.startup/util' ),\n\tSearchGateway = require( '../mobile.startup/search/SearchGateway' );\n\n/**\n * Api for CategoryOverlay\n * @class CategoryGateway\n * @extends SearchGateway\n */\nfunction CategoryGateway() {\n\tCategoryGateway.parent.apply( this, arguments );\n}\nprototype = {\n\t/**\n\t * @memberof CategoryGateway\n\t * @instance\n\t */\n\tcontinueParams: {},\n\t/**\n\t * @memberof CategoryGateway\n\t * @instance\n\t */\n\tcanContinue: true,\n\t/**\n\t * @inheritdoc\n\t * @memberof CategoryGateway\n\t * @instance\n\t */\n\tsearchNamespace: 14,\n\t/**\n\t * Saves the categories passed to this function to the page\n\t * @memberof CategoryGateway\n\t * @instance\n\t * @param {string} title Title of the current page (to add the categories to)\n\t * @param {string} categories List of Categories to add\n\t * @return {jQuery.Deferred}\n\t */\n\tsave: function ( title, categories ) {\n\t\treturn this.api.postWithToken( 'csrf', {\n\t\t\taction: 'edit',\n\t\t\ttitle: title,\n\t\t\tappendtext: categories,\n\t\t\tsummary: mw.msg( 'mobile-frontend-categories-summary' )\n\t\t} );\n\t},\n\t/**\n\t * Returns the categories the title belongs to.\n\t * @memberof CategoryGateway\n\t * @instance\n\t * @param {string} title Title of the current page (to add the categories to)\n\t * @return {jQuery.Deferred|boolean} False, if no further continuation is possible,\n\t *                                   jQuery.Deferred otherwise.\n\t */\n\tgetCategories: function ( title ) {\n\t\tvar self = this, params;\n\n\t\tif ( this.canContinue === false ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tparams = util.extend( {}, {\n\t\t\tprop: 'categories',\n\t\t\ttitles: title,\n\t\t\tclprop: 'hidden',\n\t\t\tcllimit: 50\n\t\t}, this.continueParams );\n\t\treturn this.api.get( actionParams( params ) ).then( function ( data ) {\n\t\t\tif ( data.continue !== undefined ) {\n\t\t\t\tself.continueParams = data.continue;\n\t\t\t} else {\n\t\t\t\tself.canContinue = false;\n\t\t\t}\n\n\t\t\treturn data;\n\t\t} );\n\t}\n};\n\nOO.inheritClass( CategoryGateway, SearchGateway );\nutil.extend( CategoryGateway.prototype, prototype );\n\nmodule.exports = CategoryGateway;\n","var Button = require( '../mobile.startup/Button' ),\n\tutil = require( '../mobile.startup/util' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tOverlay = require( '../mobile.startup/Overlay' );\n\n/**\n * Overlay that shows a message about abuse.\n * This overlay is rendered when the error code from the API\n * is related to the abusefilter extension.\n * @class AbuseFilterOverlay\n * @extends Overlay\n * @param {Object} props\n */\nfunction AbuseFilterOverlay( props ) {\n\tOverlay.call( this,\n\t\tutil.extend( {\n\t\t\tclassName: 'overlay abusefilter-overlay'\n\t\t}, props )\n\t);\n}\n\nmfExtend( AbuseFilterOverlay, Overlay, {\n\t/**\n\t * @memberof AbuseFilterOverlay\n\t * @instance\n\t * @mixes Overlay#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {Object} defaults.confirmButton options for a confirm Button\n\t */\n\tdefaults: util.extend( {}, Overlay.prototype.defaults, {\n\t\tconfirmButton: new Button( {\n\t\t\tadditionalClassNames: 'cancel',\n\t\t\tprogressive: true\n\t\t} ).options\n\t} ),\n\t/**\n\t * @memberof AbuseFilterOverlay\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, Overlay.prototype.templatePartials, {\n\t\tbutton: Button.prototype.template,\n\t\tcontent: mw.template.get( 'mobile.editor.overlay', 'AbuseFilterOverlay.hogan' )\n\t} ),\n\t/**\n\t * @inheritdoc\n\t * @memberof AbuseFilterOverlay\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tOverlay.prototype.postRender.apply( this );\n\t\t// make links open in separate tabs\n\t\tthis.$( 'a' ).attr( 'target', '_blank' );\n\t}\n} );\n\nmodule.exports = AbuseFilterOverlay;\n","var util = require( '../mobile.startup/util' ),\n\tView = require( '../mobile.startup/View' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tAbuseFilterOverlay = require( './AbuseFilterOverlay' );\n\n/**\n * Panel that shows an error message related to the abusefilter extension.\n * @class AbuseFilterPanel\n * @extends View\n * @uses AbuseFilterOverlay\n *\n * @param {Object} options Configuration options\n * FIXME: should extend Panel not View. Or the name should be changed to something meaningful.\n */\nfunction AbuseFilterPanel( options ) {\n\tthis.isDisallowed = false;\n\tthis.overlayManager = options.overlayManager;\n\tView.call( this,\n\t\tutil.extend( {\n\t\t\tclassName: 'panel hidden'\n\t\t}, options )\n\t);\n}\n\nmfExtend( AbuseFilterPanel, View, {\n\t/**\n\t * @memberof AbuseFilterPanel\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} defaults.readMoreMsg A caption for the button\n\t * allowing the user to read more about the problems with their edit.\n\t * @property {OverlayManager} defaults.overlayManager instance\n\t */\n\tdefaults: {\n\t\treadMoreMsg: mw.msg( 'mobile-frontend-editor-abusefilter-read-more' )\n\t},\n\t/**\n\t * @memberof AbuseFilterPanel\n\t * @instance\n\t */\n\ttemplate: mw.template.get( 'mobile.editor.overlay', 'AbuseFilterPanel.hogan' ),\n\t/**\n\t * Show the panel. Create a route to show AbuseFilterOverlay with message.\n\t * @memberof AbuseFilterPanel\n\t * @instance\n\t * @param {string} type The type of alert, e.g. 'warning' or 'disallow'\n\t * @param {string} message Message to show in the AbuseFilter overlay\n\t */\n\tshow: function ( type, message ) {\n\t\tvar msg;\n\n\t\t// OverlayManager will replace previous instance of the route if present\n\t\tthis.overlayManager.add( /^\\/abusefilter$/, function () {\n\t\t\treturn new AbuseFilterOverlay( {\n\t\t\t\tmessage: message\n\t\t\t} );\n\t\t} );\n\n\t\tif ( type === 'warning' ) {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-abusefilter-warning' );\n\t\t} else if ( type === 'disallow' ) {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-abusefilter-disallow' );\n\t\t\tthis.isDisallowed = true;\n\t\t}\n\n\t\tthis.$( '.message p' ).text( msg );\n\t\tthis.$el.removeClass( 'hidden' );\n\t},\n\n\t/**\n\t * Hide the panel.\n\t * @memberof AbuseFilterPanel\n\t * @instance\n\t */\n\thide: function () {\n\t\tthis.$el.addClass( 'hidden' );\n\t}\n} );\n\nmodule.exports = AbuseFilterPanel;\n","'use strict';\nvar Drawer = require( '../mobile.startup/Drawer' ),\n\tButton = require( '../mobile.startup/Button' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tIcon = require( '../mobile.startup/Icon' ),\n\tutil = require( '../mobile.startup/util' );\n\n/**\n * This creates the drawer at the bottom of the screen that appears when a\n * blocked user tries to edit.\n * @class BlockReason\n * @extends Drawer\n */\nfunction BlockMessage() {\n\tDrawer.apply( this, arguments );\n}\n\nmfExtend( BlockMessage, Drawer, {\n\t/**\n\t * @memberof BlockMessage\n\t * @instance\n\t */\n\tdefaults: util.extend( {}, Drawer.prototype.defaults, {\n\t\tstopHandIcon: new Icon( {\n\t\t\tname: 'stop-hand'\n\t\t} ).options,\n\t\tuserIcon: new Icon( {\n\t\t\ttagName: 'span',\n\t\t\tname: 'profile'\n\t\t} ).options,\n\t\tokButton: new Button( {\n\t\t\tlabel: mw.msg( 'ok' ),\n\t\t\ttagName: 'button',\n\t\t\tprogressive: true,\n\t\t\tadditionalClassNames: 'cancel'\n\t\t} ).options,\n\t\tcreateDetailsAnchorHref: function () {\n\t\t\treturn mw.util.getUrl( 'Special:BlockList', { wpTarget: '#' + this.blockId } );\n\t\t},\n\t\tcreateDetailsAnchorLabel: function () {\n\t\t\treturn mw.msg( 'mobile-frontend-editor-blocked-drawer-help' );\n\t\t},\n\t\tcreateTitle: function () {\n\t\t\treturn this.partial ? mw.msg( 'mobile-frontend-editor-blocked-drawer-title-partial' ) : mw.msg( 'mobile-frontend-editor-blocked-drawer-title' );\n\t\t},\n\t\treasonHeader: mw.msg( 'mobile-frontend-editor-blocked-drawer-reason-header' ),\n\t\tcreatorHeader: function () {\n\t\t\t// The gender is the subject (the blockee) not the object (the blocker).\n\t\t\treturn mw.msg( 'mobile-frontend-editor-blocked-drawer-creator-header',\n\t\t\t\tthis.user.options.gender || 'unknown' );\n\t\t},\n\t\texpiryHeader: mw.msg( 'mobile-frontend-editor-blocked-drawer-expiry-header' )\n\t} ),\n\t/**\n\t * @memberof BlockMessage\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, Drawer.prototype.templatePartials, {\n\t\tbutton: Button.prototype.template,\n\t\ticon: Icon.prototype.template\n\t} ),\n\t/**\n\t * @inheritdoc\n\t * @memberof BlockMessage\n\t * @instance\n\t */\n\tonShowDrawer: function () {\n\t\tvar wiki = mw.config.get( 'wgDBname' );\n\n\t\tDrawer.prototype.onShowDrawer.apply( this );\n\n\t\tif ( mw.config.get( 'wgEnableBlockNoticeStats' ) ) {\n\t\t\tmw.track( 'counter.MediaWiki.BlockNotices.' + wiki + '.MobileFrontend.shown', 1 );\n\t\t}\n\t},\n\t/**\n\t * @memberof BlockMessage\n\t * @instance\n\t */\n\ttemplate: mw.template.get( 'mobile.editor.overlay', 'BlockMessage.hogan' )\n} );\n\nmodule.exports = BlockMessage;\n","var util = require( '../mobile.startup/util' ),\n\tparseSaveError = require( './parseSaveError' ),\n\tactionParams = require( '../mobile.startup/actionParams' );\n\n/**\n * API that helps save and retrieve page content\n * @class EditorGateway\n *\n * @param {Object} options Configuration options\n * @param {mw.Api} options.api an Api to use.\n * @param {string} options.title the title to edit\n * @param {number} options.sectionId the id of the section to operate edits on.\n * @param {number} [options.oldId] revision to operate on. If absent defaults to latest.\n * @param {boolean} [options.isNewPage] whether the page being created is new\n */\nfunction EditorGateway( options ) {\n\tthis.api = options.api;\n\tthis.title = options.title;\n\tthis.sectionId = options.sectionId;\n\tthis.oldId = options.oldId;\n\t// return an empty section for new pages\n\tthis.content = options.isNewPage ? '' : undefined;\n\tthis.hasChanged = false;\n}\n\nEditorGateway.prototype = {\n\t/**\n\t * Get the block (if there is one) from the result.\n\t * @memberof EditorGateway\n\t * @param {Object} pageObj\n\t * @return {Object|null}\n\t */\n\tgetBlockInfo: function ( pageObj ) {\n\t\tvar blockedError;\n\n\t\tif ( pageObj.actions &&\n\t\t\tpageObj.actions.edit &&\n\t\t\tArray.isArray( pageObj.actions.edit )\n\t\t) {\n\t\t\tpageObj.actions.edit.some( function ( error ) {\n\t\t\t\tif ( [ 'blocked', 'autoblocked' ].indexOf( error.code ) !== -1 ) {\n\t\t\t\t\tblockedError = error;\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t} );\n\n\t\t\tif ( blockedError && blockedError.data && blockedError.data.blockinfo ) {\n\t\t\t\t// Preload library used by EditorOverlay\n\t\t\t\t// to format block expiry datetime and duration\n\t\t\t\tmw.loader.load( 'moment' );\n\n\t\t\t\treturn blockedError.data.blockinfo;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t},\n\t/**\n\t * Get the content of a page.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @return {jQuery.Promise}\n\t */\n\tgetContent: function () {\n\t\tvar options,\n\t\t\tself = this;\n\n\t\tfunction resolve() {\n\t\t\treturn util.Deferred().resolve( {\n\t\t\t\ttext: self.content || '',\n\t\t\t\tblockinfo: self.blockinfo,\n\t\t\t\tuserinfo: self.userinfo\n\t\t\t} );\n\t\t}\n\n\t\tif ( this.content !== undefined ) {\n\t\t\treturn resolve();\n\t\t} else {\n\t\t\toptions = actionParams( {\n\t\t\t\tprop: [ 'revisions', 'info' ],\n\t\t\t\tmeta: 'userinfo',\n\t\t\t\trvprop: [ 'content', 'timestamp' ],\n\t\t\t\ttitles: self.title,\n\t\t\t\t// get block information for this user\n\t\t\t\tintestactions: 'edit',\n\t\t\t\tintestactionsdetail: 'full',\n\t\t\t\tuiprop: 'options'\n\t\t\t} );\n\t\t\t// Load text of old revision if desired\n\t\t\tif ( this.oldId ) {\n\t\t\t\toptions.rvstartid = this.oldId;\n\t\t\t}\n\t\t\t// See Bug 50136 - passing rvsection will fail with non wikitext\n\t\t\tif ( util.isNumeric( this.sectionId ) ) {\n\t\t\t\toptions.rvsection = this.sectionId;\n\t\t\t}\n\t\t\treturn this.api.get( options ).then( function ( resp ) {\n\t\t\t\tvar revision, pageObj;\n\n\t\t\t\tif ( resp.error ) {\n\t\t\t\t\treturn util.Deferred().reject( resp.error.code );\n\t\t\t\t}\n\n\t\t\t\tpageObj = resp.query.pages[0];\n\t\t\t\t// page might not exist and caller might not have known.\n\t\t\t\tif ( pageObj.missing !== undefined ) {\n\t\t\t\t\tself.content = '';\n\t\t\t\t} else {\n\t\t\t\t\trevision = pageObj.revisions[0];\n\t\t\t\t\tself.content = revision.content;\n\t\t\t\t\tself.timestamp = revision.timestamp;\n\t\t\t\t}\n\n\t\t\t\tself.userinfo = resp.query.userinfo;\n\n\t\t\t\t// save content a second time to be able to check for changes\n\t\t\t\tself.originalContent = self.content;\n\t\t\t\tself.blockinfo = self.getBlockInfo( pageObj );\n\n\t\t\t\treturn resolve();\n\t\t\t} );\n\t\t}\n\t},\n\n\t/**\n\t * Mark content as modified and set changes to be submitted when #save\n\t * is invoked.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @param {string} content New section content.\n\t */\n\tsetContent: function ( content ) {\n\t\tif ( this.originalContent !== content ) {\n\t\t\tthis.hasChanged = true;\n\t\t} else {\n\t\t\tthis.hasChanged = false;\n\t\t}\n\t\tthis.content = content;\n\t},\n\n\t/**\n\t * Mark content as modified and set text that should be prepended to given\n\t * section when #save is invoked.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @param {string} text Text to be prepended.\n\t */\n\tsetPrependText: function ( text ) {\n\t\tthis.prependtext = text;\n\t\tthis.hasChanged = true;\n\t},\n\n\t/**\n\t * Save the new content of the section, previously set using #setContent.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @param {Object} options Configuration options\n\t * @param {string} [options.summary] Optional summary for the edit.\n\t * @param {string} [options.captchaId] If CAPTCHA was requested, ID of the\n\t * captcha.\n\t * @param {string} [options.captchaWord] If CAPTCHA was requested, term\n\t * displayed in the CAPTCHA.\n\t * @return {jQuery.Deferred} On failure callback is passed an object with\n\t * `type` and `details` properties. `type` is a string describing the type\n\t * of error, `details` can be any object (usually error message).\n\t */\n\tsave: function ( options ) {\n\t\tvar self = this,\n\t\t\tresult = util.Deferred();\n\n\t\toptions = options || {};\n\n\t\t/**\n\t\t * Save content. Make an API request.\n\t\t * @return {jQuery.Deferred}\n\t\t */\n\t\tfunction saveContent() {\n\t\t\tvar apiOptions = {\n\t\t\t\taction: 'edit',\n\t\t\t\ttitle: self.title,\n\t\t\t\tsummary: options.summary,\n\t\t\t\tcaptchaid: options.captchaId,\n\t\t\t\tcaptchaword: options.captchaWord,\n\t\t\t\tbasetimestamp: self.timestamp,\n\t\t\t\tstarttimestamp: self.timestamp\n\t\t\t};\n\n\t\t\tif ( self.content !== undefined ) {\n\t\t\t\tapiOptions.text = self.content;\n\t\t\t} else if ( self.prependtext ) {\n\t\t\t\tapiOptions.prependtext = self.prependtext;\n\t\t\t}\n\n\t\t\tif ( util.isNumeric( self.sectionId ) ) {\n\t\t\t\tapiOptions.section = self.sectionId;\n\t\t\t}\n\n\t\t\tself.api.postWithToken( 'csrf', apiOptions ).then( function ( data ) {\n\t\t\t\tif ( data && data.edit && data.edit.result === 'Success' ) {\n\t\t\t\t\tself.hasChanged = false;\n\t\t\t\t\tresult.resolve();\n\t\t\t\t} else {\n\t\t\t\t\tresult.reject( parseSaveError( data ) );\n\t\t\t\t}\n\t\t\t}, function ( code, data ) {\n\t\t\t\tresult.reject( parseSaveError( data, code || 'unknown' ) );\n\t\t\t} );\n\t\t\treturn result;\n\t\t}\n\n\t\treturn saveContent();\n\t},\n\n\t/**\n\t * Abort any pending previews.\n\t * @memberof EditorGateway\n\t * @instance\n\t */\n\tabortPreview: function () {\n\t\tif ( this._pending ) {\n\t\t\tthis._pending.abort();\n\t\t}\n\t},\n\n\t/**\n\t * Get page preview from the API and abort any existing previews.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @param {Object} options API query parameters\n\t * @return {jQuery.Deferred}\n\t */\n\tgetPreview: function ( options ) {\n\t\tvar result = util.Deferred(),\n\t\t\tsectionLine = '',\n\t\t\trequest,\n\t\t\tself = this;\n\n\t\tutil.extend( options, {\n\t\t\taction: 'parse',\n\t\t\t// Enable section preview mode to avoid errors (bug 49218)\n\t\t\tsectionpreview: true,\n\t\t\t// needed for pre-save transform to work (bug 53692)\n\t\t\tpst: true,\n\t\t\t// Output mobile HTML (bug 54243)\n\t\t\tmobileformat: true,\n\t\t\ttitle: this.title,\n\t\t\tprop: [ 'text', 'sections' ]\n\t\t} );\n\n\t\tthis.abortPreview();\n\n\t\trequest = this.api.post( options );\n\t\tthis._pending = request.then( function ( resp ) {\n\t\t\tif ( resp && resp.parse && resp.parse.text ) {\n\t\t\t\t// section 0 haven't a section name so skip\n\t\t\t\tif ( self.sectionId !== 0 &&\n\t\t\t\t\tresp.parse.sections !== undefined &&\n\t\t\t\t\tresp.parse.sections[0] !== undefined &&\n\t\t\t\t\tresp.parse.sections[0].line !== undefined\n\t\t\t\t) {\n\t\t\t\t\tsectionLine = resp.parse.sections[0].line;\n\t\t\t\t}\n\t\t\t\tresult.resolve( {\n\t\t\t\t\ttext: resp.parse.text['*'],\n\t\t\t\t\tline: sectionLine\n\t\t\t\t} );\n\t\t\t} else {\n\t\t\t\tresult.reject();\n\t\t\t}\n\t\t}, function () {\n\t\t\tresult.reject();\n\t\t} ).promise( {\n\t\t\tabort: function () { request.abort(); }\n\t\t} );\n\n\t\treturn result;\n\t}\n};\n\nmodule.exports = EditorGateway;\n","var EditorOverlayBase = require( './EditorOverlayBase' ),\n\tutil = require( '../mobile.startup/util' ),\n\tSection = require( '../mobile.startup/Section' ),\n\tEditorGateway = require( './EditorGateway' ),\n\tAbuseFilterPanel = require( './AbuseFilterPanel' ),\n\tButton = require( '../mobile.startup/Button' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tBlockMessage = require( './BlockMessage' ),\n\tVisualEditorOverlay = require( './VisualEditorOverlay' ),\n\tMessageBox = require( '../mobile.startup/MessageBox' );\n\n/**\n * Overlay that shows an editor\n * @class EditorOverlay\n * @uses Section\n * @uses AbuseFilterPanel\n * @uses EditorGateway\n * @uses VisualEditorOverlay\n * @extends EditorOverlayBase\n *\n * @param {Object} options Configuration options\n */\nfunction EditorOverlay( options ) {\n\tthis.gateway = new EditorGateway( {\n\t\tapi: options.api,\n\t\ttitle: options.title,\n\t\tsectionId: options.sectionId,\n\t\toldId: options.oldId,\n\t\tisNewPage: options.isNewPage\n\t} );\n\tthis.readOnly = !!options.oldId; // If old revision, readOnly mode\n\tif ( this.isVisualEditorEnabled() ) {\n\t\toptions.editSwitcher = true;\n\t}\n\tif ( this.readOnly ) {\n\t\toptions.readOnly = true;\n\t\toptions.editingMsg = mw.msg( 'mobile-frontend-editor-viewing-source-page', options.title );\n\t} else {\n\t\toptions.editingMsg = mw.msg( 'mobile-frontend-editor-editing-page', options.title );\n\t}\n\tif ( options.isAnon ) {\n\t\t// add required data for anonymous editing warning\n\t\toptions = this._prepareAnonWarning( options );\n\t}\n\t// be explicit here. This may have been initialized from VE.\n\toptions.isVisualEditor = false;\n\toptions.previewingMsg = mw.msg( 'mobile-frontend-editor-previewing-page', options.title );\n\tEditorOverlayBase.call(\n\t\tthis,\n\t\tutil.extend(\n\t\t\t{ events: { 'input .wikitext-editor': 'onInputWikitextEditor' } },\n\t\t\toptions\n\t\t)\n\t);\n}\n\nmfExtend( EditorOverlay, EditorOverlayBase, {\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, EditorOverlayBase.prototype.templatePartials, {\n\t\tcontent: mw.template.get( 'mobile.editor.overlay', 'content.hogan' ),\n\t\tmessageBox: MessageBox.prototype.template,\n\t\tanonWarning: mw.template.get( 'mobile.editor.overlay', 'EditorOverlayAnonWarning.hogan' )\n\t} ),\n\t/**\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @mixes EditorOverlayBase#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {Object} defaults.loginButton options to render an sign in button\n\t * @property {Object} defaults.signupButton options to render a sign up button\n\t * @property {Object} defaults.anonButton options to render an edit anonymously button\n\t * @property {Object} defaults.warningOptions options for a MessageBox\n\t *  to display anonymous message warning\n\t * @property {mw.Api} defaults.api an api module to retrieve pages\n\t */\n\tdefaults: util.extend( {}, EditorOverlayBase.prototype.defaults, {\n\t\tloginButton: new Button( {\n\t\t\tblock: true,\n\t\t\tlabel: mw.msg( 'mobile-frontend-watchlist-cta-button-login' )\n\t\t} ).options,\n\t\tsignupButton: new Button( {\n\t\t\tblock: true,\n\t\t\tlabel: mw.msg( 'mobile-frontend-watchlist-cta-button-signup' )\n\t\t} ).options,\n\t\tanonButton: new Button( {\n\t\t\tlabel: mw.msg( 'mobile-frontend-editor-anon' ),\n\t\t\tblock: true,\n\t\t\tadditionalClassNames: 'continue anonymous',\n\t\t\tprogressive: true\n\t\t} ).options,\n\t\twarningOptions: {\n\t\t\tclassName: 'warningbox anon-msg',\n\t\t\tmsg: mw.msg( 'mobile-frontend-editor-anonwarning' )\n\t\t}\n\t} ),\n\t/**\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\teditor: 'wikitext',\n\t/**\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\tsectionLine: '',\n\n\t/**\n\t * Check whether VisualEditor is enabled or not.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @return {boolean}\n\t */\n\tisVisualEditorEnabled: function () {\n\t\tvar ns = mw.config.get( 'wgVisualEditorConfig' ) &&\n\t\t\tmw.config.get( 'wgVisualEditorConfig' ).namespaces;\n\n\t\treturn ns &&\n\t\t\tns.indexOf(\n\t\t\t\tmw.config.get( 'wgNamespaceNumber' )\n\t\t\t) > -1 &&\n\t\t\tmw.config.get( 'wgTranslatePageTranslation' ) !== 'translation' &&\n\t\t\tmw.config.get( 'wgPageContentModel' ) === 'wikitext';\n\t},\n\t/**\n\t * Wikitext Editor input handler\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\tonInputWikitextEditor: function () {\n\t\tthis.gateway.setContent( this.$( '.wikitext-editor' ).val() );\n\t\tthis.$( '.continue, .submit' ).prop( 'disabled', false );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\tonClickContinue: function ( ev ) {\n\t\t// handle the click on \"Edit without logging in\"\n\t\tif ( this.options.isAnon && this.$( ev.target ).hasClass( 'anonymous' ) ) {\n\t\t\tthis._showEditorAfterWarning();\n\t\t\treturn false;\n\t\t}\n\t\tEditorOverlayBase.prototype.onClickContinue.apply( this, arguments );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\tonClickBack: function () {\n\t\tEditorOverlayBase.prototype.onClickBack.apply( this, arguments );\n\t\tthis._hidePreview();\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tvar self = this;\n\n\t\tif ( this.isVisualEditorEnabled() ) {\n\t\t\tmw.loader.using( 'ext.visualEditor.switching' ).then( function () {\n\t\t\t\tvar switchToolbar,\n\t\t\t\t\ttoolFactory = new OO.ui.ToolFactory(),\n\t\t\t\t\ttoolGroupFactory = new OO.ui.ToolGroupFactory();\n\n\t\t\t\ttoolFactory.register( mw.libs.ve.MWEditModeVisualTool );\n\t\t\t\ttoolFactory.register( mw.libs.ve.MWEditModeSourceTool );\n\t\t\t\tswitchToolbar = new OO.ui.Toolbar( toolFactory, toolGroupFactory, {\n\t\t\t\t\tclasses: [ 'editor-switcher' ]\n\t\t\t\t} );\n\n\t\t\t\tswitchToolbar.on( 'switchEditor', function ( mode ) {\n\t\t\t\t\tif ( mode === 'visual' ) {\n\t\t\t\t\t\t// If the user tries to switch to the VisualEditor,\n\t\t\t\t\t\t// check if any changes have been made,\n\t\t\t\t\t\t// and if so, tell the user they have to save first.\n\t\t\t\t\t\tif ( !self.gateway.hasChanged ) {\n\t\t\t\t\t\t\t// TODO: Be more selective in which options we pass between editors\n\t\t\t\t\t\t\tself._switchToVisualEditor( self.options );\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// TODO: Replace with an OOUI dialog\n\t\t\t\t\t\t\tif ( window.confirm( mw.msg( 'mobile-frontend-editor-switch-confirm' ) ) ) {\n\t\t\t\t\t\t\t\tself.onStageChanges();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} );\n\n\t\t\t\tswitchToolbar.setup( [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'editMode',\n\t\t\t\t\t\ttype: 'list',\n\t\t\t\t\t\ticon: 'edit',\n\t\t\t\t\t\ttitle: mw.msg( 'visualeditor-mweditmode-tooltip' ),\n\t\t\t\t\t\tinclude: [ 'editModeVisual', 'editModeSource' ]\n\t\t\t\t\t}\n\t\t\t\t] );\n\n\t\t\t\tself.$el.find( '.switcher-container' ).html( switchToolbar.$element );\n\t\t\t\tswitchToolbar.emit( 'updateState' );\n\t\t\t} );\n\t\t}\n\n\t\tEditorOverlayBase.prototype.postRender.apply( this );\n\n\t\tthis.$preview = this.$( '.preview' );\n\t\tthis.$content = this.$( '.wikitext-editor' );\n\t\tthis.$content.addClass( 'mw-editfont-' + mw.user.options.get( 'editfont' ) );\n\t\tif ( self.options.isAnon ) {\n\t\t\tthis.$anonWarning = this.$( '.anonwarning' );\n\t\t\tthis.$content.hide();\n\t\t\t// the user has to click login, signup or edit without login,\n\t\t\t// disable \"Next\" button on top right\n\t\t\tthis.$anonHiddenButtons = this.$( '.overlay-header .continue, .editor-switcher' ).hide();\n\t\t\tthis.hideSpinner();\n\t\t}\n\t\t// make license links open in separate tabs\n\t\tthis.$( '.license a' ).attr( 'target', '_blank' );\n\n\t\tthis.abuseFilterPanel = new AbuseFilterPanel( {\n\t\t\toverlayManager: this.overlayManager\n\t\t} ).appendTo( this.$( '.panels' ) );\n\n\t\t// If in readOnly mode, make textarea readonly\n\t\tif ( this.readOnly ) {\n\t\t\tthis.$content.prop( 'readonly', true );\n\t\t}\n\n\t\tthis.$content.on( 'input', this._resizeEditor.bind( this ) );\n\n\t\tif ( !self.options.isAnon ) {\n\t\t\tthis._loadContent();\n\t\t}\n\t},\n\n\t/**\n\t * Sets additional values used for anonymous editing warning.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @private\n\t * @param {Object} options object\n\t * @return {Object} Object with all options\n\t */\n\t_prepareAnonWarning: function ( options ) {\n\t\tvar params = util.extend( {\n\t\t\t// use wgPageName as this includes the namespace if outside Main\n\t\t\t\treturnto: options.returnTo || mw.config.get( 'wgPageName' ),\n\t\t\t\treturntoquery: 'action=edit&section=' + options.sectionId,\n\t\t\t\twarning: 'mobile-frontend-edit-login-action'\n\t\t\t}, options.queryParams ),\n\t\t\tsignupParams = util.extend( {\n\t\t\t\ttype: 'signup',\n\t\t\t\twarning: 'mobile-frontend-edit-signup-action'\n\t\t\t}, options.signupQueryParams );\n\n\t\toptions.loginButton = util.extend( {\n\t\t\thref: mw.util.getUrl( 'Special:UserLogin', params )\n\t\t}, this.defaults.loginButton );\n\t\toptions.signupButton = util.extend( {\n\t\t\thref: mw.util.getUrl( 'Special:UserLogin', util.extend( params, signupParams ) )\n\t\t}, this.defaults.signupButton );\n\n\t\treturn options;\n\t},\n\n\t/**\n\t * Handles click on \"Edit without login\" in anonymous editing warning.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @private\n\t */\n\t_showEditorAfterWarning: function () {\n\t\tthis.showSpinner();\n\t\tthis.$anonWarning.hide();\n\t\t// reenable \"Next\" button\n\t\tthis.$anonHiddenButtons.show();\n\t\tthis._loadContent();\n\t},\n\n\t/**\n\t * Prepares the preview interface and reveals the save screen of the overlay\n\t * @inheritdoc\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\tonStageChanges: function () {\n\t\tvar self = this,\n\t\t\tparams = {\n\t\t\t\ttext: this.getContent()\n\t\t\t};\n\n\t\tthis.scrollTop = util.getDocument().find( 'body' ).scrollTop();\n\t\tthis.$content.hide();\n\t\tthis.showSpinner();\n\n\t\tif ( mw.config.get( 'wgIsMainPage' ) ) {\n\t\t\tparams.mainpage = 1; // Setting it to 0 will have the same effect\n\t\t}\n\n\t\tfunction hideSpinnerAndShowPreview() {\n\t\t\tself.hideSpinner();\n\t\t\tself.$preview.show();\n\t\t}\n\n\t\tthis.gateway.getPreview( params ).then( function ( result ) {\n\t\t\tvar parsedText = result.text,\n\t\t\t\tparsedSectionLine = result.line;\n\n\t\t\t// On desktop edit summaries strip tags. Mimic this behavior on mobile devices\n\t\t\tself.sectionLine = self.parseHTML( '<div>' ).html( parsedSectionLine ).text();\n\t\t\tnew Section( {\n\t\t\t\tel: self.$preview,\n\t\t\t\ttext: parsedText\n\t\t\t} ).$( 'a' ).on( 'click', false );\n\n\t\t\thideSpinnerAndShowPreview();\n\t\t}, function () {\n\t\t\tself.$preview.addClass( 'error' ).text( mw.msg( 'mobile-frontend-editor-error-preview' ) );\n\n\t\t\thideSpinnerAndShowPreview();\n\t\t} );\n\n\t\tEditorOverlayBase.prototype.onStageChanges.apply( this, arguments );\n\t},\n\n\t/**\n\t * Hides the preview and reverts back to initial screen.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @private\n\t */\n\t_hidePreview: function () {\n\t\tthis.gateway.abortPreview();\n\t\tthis.hideSpinner();\n\t\tthis.$preview.removeClass( 'error' ).hide();\n\t\tthis.$content.show();\n\t\twindow.scrollTo( 0, this.scrollTop );\n\t\tthis.showHidden( '.initial-header' );\n\t\tthis.abuseFilterPanel.hide();\n\t},\n\n\t/**\n\t * Resize the editor textarea, maintaining scroll position in iOS\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\t_resizeEditor: function () {\n\t\tvar scrollTop, container, $scrollContainer;\n\n\t\tif ( !this.$scrollContainer ) {\n\t\t\tcontainer = OO.ui.Element.static\n\t\t\t\t.getClosestScrollableContainer( this.$content[ 0 ] );\n\t\t\t// The scroll container will be either within the view\n\t\t\t// or the document element itself.\n\t\t\t$scrollContainer = this.$( container ).length ?\n\t\t\t\tthis.$( container ) : util.getDocument();\n\t\t\tthis.$scrollContainer = $scrollContainer;\n\t\t\tthis.$content.css( 'padding-bottom', this.$scrollContainer.height() * 0.6 );\n\t\t} else {\n\t\t\t$scrollContainer = this.$scrollContainer;\n\t\t}\n\n\t\t// Only do this if scroll container exists\n\t\tif ( this.$content.prop( 'scrollHeight' ) && $scrollContainer.length ) {\n\t\t\tscrollTop = $scrollContainer.scrollTop();\n\t\t\tthis.$content\n\t\t\t\t.css( 'height', 'auto' )\n\t\t\t\t// can't reuse prop( 'scrollHeight' ) because we need the current value\n\t\t\t\t.css( 'height', ( this.$content.prop( 'scrollHeight' ) + 2 ) + 'px' );\n\t\t\t$scrollContainer.scrollTop( scrollTop );\n\t\t}\n\t},\n\n\t/**\n\t * Set content to the user input field.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @param {string} content The content to set.\n\t */\n\tsetContent: function ( content ) {\n\t\tthis.$content\n\t\t\t.show()\n\t\t\t.val( content );\n\t\tthis._resizeEditor();\n\t},\n\n\t/**\n\t * Returns the content of the user input field.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @return {string}\n\t */\n\tgetContent: function () {\n\t\treturn this.$content.val();\n\t},\n\n\t/**\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @param {string} data\n\t * @return {string|false}\n\t */\n\t_parseBlockInfo: function ( data ) {\n\t\tvar blockInfo, expiry, reason,\n\t\t\tmoment = window.moment;\n\n\t\t// Workaround to parse a message parameter for mw.message, see T96885\n\t\tfunction jqueryMsgParse( wikitext ) {\n\t\t\tvar parser, ast;\n\t\t\t// eslint-disable-next-line new-cap\n\t\t\tparser = new mw.jqueryMsg.parser();\n\t\t\ttry {\n\t\t\t\tast = parser.wikiTextToAst( wikitext );\n\t\t\t\treturn parser.emitter.emit( ast ).html();\n\t\t\t} catch ( e ) {\n\t\t\t\t// Ignore error as it's probably the parser error. Usually this is because we\n\t\t\t\t// can't parse templates.\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tblockInfo = {\n\t\t\tpartial: data.blockinfo.blockpartial || false,\n\t\t\tuser: data.userinfo,\n\t\t\tcreator: {\n\t\t\t\tname: data.blockinfo.blockedby,\n\t\t\t\t// NS_USER === 2\n\t\t\t\turl: mw.util.getUrl(\n\t\t\t\t\tmw.config.get( 'wgFormattedNamespaces' )[2] + ':' +\n\t\t\t\t\tdata.blockinfo.blockedby\n\t\t\t\t)\n\t\t\t},\n\t\t\texpiry: null,\n\t\t\tduration: null,\n\t\t\treason: '',\n\t\t\tblockId: data.blockinfo.blockid\n\t\t};\n\n\t\texpiry = data.blockinfo.blockexpiry;\n\t\tif ( [ 'infinite', 'indefinite', 'infinity', 'never' ].indexOf( expiry ) === -1 ) {\n\t\t\tblockInfo.expiry = moment( expiry ).format( 'LLL' );\n\t\t\tblockInfo.duration = moment().to( expiry, true );\n\t\t}\n\n\t\treason = data.blockinfo.blockreason;\n\t\tif ( reason ) {\n\t\t\tblockInfo.reason = jqueryMsgParse( reason ) || mw.html.escape( reason );\n\t\t} else {\n\t\t\tblockInfo.reason = mw.message( 'mobile-frontend-editor-generic-block-reason' ).escaped();\n\t\t}\n\n\t\treturn blockInfo;\n\t},\n\n\t/**\n\t * Requests content from the API and reveals it in UI.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @private\n\t */\n\t_loadContent: function () {\n\t\tvar self = this,\n\t\t\t$el = this.$el;\n\n\t\tthis.$content.hide();\n\t\tthis.showSpinner();\n\t\t$el.addClass( 'overlay-loading' );\n\n\t\tthis.gateway.getContent()\n\t\t\t.then( function ( result ) {\n\t\t\t\tvar block, message,\n\t\t\t\t\tcontent = result.text;\n\n\t\t\t\tself.setContent( content );\n\t\t\t\t// check if user is blocked\n\t\t\t\tif ( result.blockinfo ) {\n\t\t\t\t\t// Lazy-load moment only if it's needed,\n\t\t\t\t\t// it's somewhat large (it is already used on\n\t\t\t\t\t// mobile by Echo's notifications panel, where it's also lazy-loaded)\n\t\t\t\t\tmw.loader.using( 'moment' ).then( function () {\n\t\t\t\t\t\tblock = self._parseBlockInfo( result );\n\t\t\t\t\t\tmessage = new BlockMessage( block );\n\t\t\t\t\t\tmessage.toggle();\n\t\t\t\t\t\tself.hide();\n\t\t\t\t\t\tself.hideSpinner();\n\t\t\t\t\t\t$el.removeClass( 'overlay-loading' );\n\t\t\t\t\t} );\n\t\t\t\t} else {\n\t\t\t\t\tself.hideSpinner();\n\t\t\t\t\t$el.removeClass( 'overlay-loading' );\n\t\t\t\t}\n\t\t\t}, function () {\n\t\t\t\tself.reportError( mw.msg( 'mobile-frontend-editor-error-loading' ) );\n\t\t\t\t$el.removeClass( 'overlay-loading' );\n\t\t\t} );\n\t},\n\n\t/**\n\t * Loads a {VisualEditorOverlay} and replaces the existing EditorOverlay with it\n\t * based on the current option values.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @private\n\t * @param {Object} options Object passed to the constructor\n\t */\n\t_switchToVisualEditor: function ( options ) {\n\t\tvar self = this;\n\t\tthis.log( {\n\t\t\taction: 'abort',\n\t\t\ttype: 'switchnochange',\n\t\t\tmechanism: 'navigate'\n\t\t} );\n\t\t// Save a user setting indicating that this user prefers using the VisualEditor\n\t\tmw.storage.set( 'preferredEditor', 'VisualEditor' );\n\t\t// Load the VisualEditor and replace the SourceEditor overlay with it\n\t\tthis.showSpinner();\n\t\tthis.$content.hide();\n\t\tmw.loader.using( 'ext.visualEditor.targetLoader' ).then( function () {\n\t\t\tmw.libs.ve.targetLoader.addPlugin( 'mobile.editor.ve' );\n\t\t\treturn mw.libs.ve.targetLoader.loadModules( 'visual' );\n\t\t} ).then(\n\t\t\tfunction () {\n\t\t\t\toptions.EditorOverlay = EditorOverlay;\n\t\t\t\tself.hideSpinner();\n\t\t\t\t// Unset classes from other editor\n\t\t\t\tdelete options.className;\n\t\t\t\tself.switching = true;\n\t\t\t\tself.overlayManager.replaceCurrent( new VisualEditorOverlay( options ) );\n\t\t\t\tself.switching = false;\n\t\t\t},\n\t\t\tfunction () {\n\t\t\t\tself.hideSpinner();\n\t\t\t\tself.$content.show();\n\t\t\t\t// FIXME: We should show an error notification, but right now toast\n\t\t\t\t// notifications are not dismissible when shown within the editor.\n\t\t\t}\n\t\t);\n\t},\n\n\t/**\n\t * Reveals an abuse filter panel inside the view.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @private\n\t * @param {string} type The type of alert, e.g. 'warning' or 'disallow'\n\t * @param {string} message Message to show in the AbuseFilter overlay\n\t */\n\t_showAbuseFilter: function ( type, message ) {\n\t\tthis.abuseFilterPanel.show( type, message );\n\t\tthis.showHidden( '.save-header' );\n\t\t// disable continue and save buttons, reenabled when user changes content\n\t\tthis.$( '.continue, .submit' ).prop( 'disabled', this.abuseFilterPanel.isDisallowed );\n\t},\n\n\t/**\n\t * Executed when the editor clicks the save button. Handles logging and submitting\n\t * the save action to the editor API.\n\t * @inheritdoc\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\tonSaveBegin: function () {\n\t\tvar self = this,\n\t\t\toptions = {\n\t\t\t\tsummary: this.$( '.summary' ).val()\n\t\t\t};\n\n\t\tif ( self.sectionLine !== '' ) {\n\t\t\toptions.summary = '/* ' + self.sectionLine + ' */' + options.summary;\n\t\t}\n\t\tEditorOverlayBase.prototype.onSaveBegin.apply( this, arguments );\n\t\tif ( this.confirmAborted ) {\n\t\t\treturn;\n\t\t}\n\t\tif ( this.captchaId ) {\n\t\t\toptions.captchaId = this.captchaId;\n\t\t\toptions.captchaWord = this.$( '.captcha-word' ).val();\n\t\t}\n\n\t\tthis.showHidden( '.saving-header' );\n\n\t\tthis.gateway.save( options )\n\t\t\t.then( function () {\n\t\t\t\tvar title = self.options.title;\n\t\t\t\t// Special case behaviour of main page\n\t\t\t\tif ( mw.config.get( 'wgIsMainPage' ) ) {\n\t\t\t\t\t// FIXME: Blocked on T189173\n\t\t\t\t\t// eslint-disable-next-line no-restricted-properties\n\t\t\t\t\twindow.location = mw.util.getUrl( title );\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tself.onSaveComplete();\n\t\t\t}, function ( data ) {\n\t\t\t\tself.onSaveFailure( data );\n\t\t\t} );\n\t},\n\n\t/**\n\t * Executed when page save fails. Handles error display and bookkeeping,\n\t * passes logging duties to the parent.\n\t * @inheritdoc\n\t * @memberof EditorOverlay\n\t * @instance\n\t */\n\tonSaveFailure: function ( data ) {\n\t\tvar heading, msg;\n\n\t\tif ( data.type === 'captcha' ) {\n\t\t\tthis.captchaId = data.details.id;\n\t\t\tthis.handleCaptcha( data.details );\n\t\t} else if ( data.type === 'abusefilter' ) {\n\t\t\tthis._showAbuseFilter( data.details.type, data.details.message );\n\t\t} else {\n\t\t\tmsg = this.saveFailureMessage( data );\n\t\t\tif ( data.type === 'readonly' ) {\n\t\t\t\theading = mw.msg( 'apierror-readonly' );\n\t\t\t}\n\n\t\t\tif ( msg || heading ) {\n\t\t\t\tthis.reportError( msg, heading );\n\t\t\t\tthis.showHidden( '.save-header, .save-panel' );\n\t\t\t}\n\t\t}\n\n\t\tEditorOverlayBase.prototype.onSaveFailure.apply( this, arguments );\n\t},\n\n\t/**\n\t * Checks whether the existing content has changed.\n\t * @memberof EditorOverlay\n\t * @instance\n\t * @return {boolean}\n\t */\n\thasChanged: function () {\n\t\treturn this.gateway.hasChanged;\n\t}\n} );\n\nmodule.exports = EditorOverlay;\n","var Overlay = require( '../mobile.startup/Overlay' ),\n\tutil = require( '../mobile.startup/util' ),\n\tPageGateway = require( '../mobile.startup/PageGateway' ),\n\tIcon = require( '../mobile.startup/Icon' ),\n\ttoast = require( '../mobile.startup/toast' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tMessageBox = require( '../mobile.startup/MessageBox' ),\n\tmwUser = mw.user;\n\n/**\n * 'Edit' button\n * @param {OO.ui.ToolGroup} toolGroup\n * @param {Object} config\n */\nfunction EditVeTool( toolGroup, config ) {\n\tconfig = config || {};\n\tconfig.classes = [ 'visual-editor' ];\n\tEditVeTool.super.call( this, toolGroup, config );\n}\nOO.inheritClass( EditVeTool, OO.ui.Tool );\n\nEditVeTool.static.name = 'editVe';\nEditVeTool.static.icon = 'edit';\nEditVeTool.static.group = 'editorSwitcher';\nEditVeTool.static.title = mw.msg( 'mobile-frontend-editor-switch-visual-editor' );\n/**\n * click handler\n * @memberof EditVeTool\n * @instance\n */\nEditVeTool.prototype.onSelect = function () {\n\t// will be overridden later\n};\n/**\n * Toolbar update state handler.\n * @memberof EditVeTool\n * @instance\n */\nEditVeTool.prototype.onUpdateState = function () {\n\t// do nothing\n};\n\n/**\n * Base class for EditorOverlay\n * @class EditorOverlayBase\n * @extends Overlay\n * @uses Icon\n * @uses user\n * @param {Object} params Configuration options\n * @param {number|null} params.editCount of user\n */\nfunction EditorOverlayBase( params ) {\n\tvar self = this,\n\t\toptions = util.extend(\n\t\t\t{\n\t\t\t\tclassName: 'overlay editor-overlay',\n\t\t\t\tisBorderBox: false\n\t\t\t},\n\t\t\tparams,\n\t\t\t{\n\t\t\t\tevents: util.extend(\n\t\t\t\t\t{\n\t\t\t\t\t\t'click .back': 'onClickBack',\n\t\t\t\t\t\t'click .continue': 'onClickContinue',\n\t\t\t\t\t\t'click .submit': 'onClickSubmit'\n\t\t\t\t\t},\n\t\t\t\t\tparams.events\n\t\t\t\t)\n\t\t\t}\n\t\t);\n\n\tif ( options.isNewPage ) {\n\t\toptions.placeholder = mw.msg( 'mobile-frontend-editor-placeholder-new-page', mwUser );\n\t}\n\t// change the message to request a summary when not in article namespace\n\tif ( mw.config.get( 'wgNamespaceNumber' ) !== 0 ) {\n\t\toptions.summaryRequestMsg = mw.msg( 'mobile-frontend-editor-summary' );\n\t}\n\tthis.pageGateway = new PageGateway( options.api );\n\tthis.editCount = options.editCount;\n\tthis.isNewPage = options.isNewPage;\n\tthis.isNewEditor = options.editCount === 0;\n\tthis.sectionId = options.sectionId;\n\t// FIXME: Pass this in via options rather than accessing mw.config\n\tthis.config = mw.config.get( 'wgMFEditorOptions' );\n\tthis.sessionId = options.sessionId;\n\tthis.overlayManager = options.overlayManager;\n\tthis.allowCloseWindow = mw.confirmCloseWindow( {\n\t\t// Returns true if content has changed\n\t\ttest: function () {\n\t\t\t// Check if content has changed\n\t\t\treturn self.hasChanged();\n\t\t},\n\n\t\t// Message to show the user, if content has changed\n\t\tmessage: mw.msg( 'mobile-frontend-editor-cancel-confirm' ),\n\t\t// Event namespace\n\t\tnamespace: 'editwarning'\n\t} );\n\n\tOverlay.call( this, options );\n}\n\nmfExtend( EditorOverlayBase, Overlay, {\n\t/**\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @mixes Overlay#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {OverlayManager} defaults.overlayManager instance\n\t * @property {mw.Api} defaults.api to interact with\n\t * @property {boolean} defaults.hasToolbar Whether the editor has a toolbar or not. When\n\t *  disabled a header will be show instead.\n\t * @property {string} defaults.continueMsg Caption for the next button on edit form\n\t * which takes you to the screen that shows a preview and license information.\n\t * @property {string} defaults.cancelMsg Caption for cancel button on edit form.\n\t * @property {string} defaults.closeMsg Caption for a button that takes you back to editing\n\t * from edit preview screen.\n\t * @property {string} defaults.summaryRequestMsg Header above edit summary input field\n\t * asking the user to summarize the changes they made to the page.\n\t * @property {string} defaults.summaryMsg A placeholder with examples for the summary input\n\t * field asking user what they changed.\n\t * @property {string} defaults.placeholder Placeholder text for empty sections.\n\t * @property {string} defaults.waitMsg Text that displays while a page edit is being saved.\n\t * @property {string} defaults.waitIcon HTML of the icon that displays while a page edit\n\t * is being saved.\n\t * @property {string} defaults.captchaMsg Placeholder for captcha input field.\n\t * @property {string} defaults.captchaTryAgainMsg A message shown when user enters\n\t * wrong CAPTCHA and a new one is displayed.\n\t * @property {string} defaults.switchMsg Label for button that allows the user\n\t * to switch between two different editing interfaces.\n\t * @property {string} defaults.licenseMsg Text and link of the license,\n\t * under which this contribution will be released to inform the user.\n\t */\n\tdefaults: util.extend( {}, Overlay.prototype.defaults, {\n\t\thasToolbar: false,\n\t\tcontinueMsg: mw.msg( 'mobile-frontend-editor-continue' ),\n\t\tcancelMsg: mw.msg( 'mobile-frontend-editor-cancel' ),\n\t\tcloseMsg: mw.msg( 'mobile-frontend-editor-keep-editing' ),\n\t\tsummaryRequestMsg: mw.msg( 'mobile-frontend-editor-summary-request' ),\n\t\tsummaryMsg: mw.msg( 'mobile-frontend-editor-summary-placeholder' ),\n\t\tplaceholder: mw.msg( 'mobile-frontend-editor-placeholder' ),\n\t\twaitMsg: mw.msg( 'mobile-frontend-editor-wait' ),\n\t\t// icons.spinner can't be used,\n\t\t// the spinner class changes to display:none in onStageChanges\n\t\twaitIcon: new Icon( {\n\t\t\tname: 'spinner',\n\t\t\tadditionalClassNames: 'savespinner loading'\n\t\t} ).toHtmlString(),\n\t\tcaptchaMsg: mw.msg( 'mobile-frontend-account-create-captcha-placeholder' ),\n\t\tcaptchaTryAgainMsg: mw.msg( 'mobile-frontend-editor-captcha-try-again' ),\n\t\tswitchMsg: mw.msg( 'mobile-frontend-editor-switch-editor' ),\n\t\tconfirmMsg: mw.msg( 'mobile-frontend-editor-cancel-confirm' ),\n\t\tlicenseMsg: undefined\n\t} ),\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, Overlay.prototype.templatePartials, {\n\t\teditHeader: mw.template.get( 'mobile.editor.overlay', 'editHeader.hogan' ),\n\t\tpreviewHeader: mw.template.get( 'mobile.editor.overlay', 'previewHeader.hogan' ),\n\t\tsaveHeader: mw.template.get( 'mobile.editor.overlay', 'saveHeader.hogan' )\n\t} ),\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\ttemplate: mw.template.get( 'mobile.editor.overlay', 'EditorOverlayBase.hogan' ),\n\t/**\n\t * Logs an event to http://meta.wikimedia.org/wiki/Schema:EditAttemptStep\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {Object} data\n\t */\n\tlog: function ( data ) {\n\t\tmw.track( 'mf.schemaEditAttemptStep', util.extend( data, {\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\teditor_interface: this.editor,\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\tediting_session_id: this.sessionId\n\t\t} ) );\n\t},\n\n\t/**\n\t * If this is a new article, require confirmation before saving.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @return {boolean} The user confirmed saving\n\t */\n\tconfirmSave: function () {\n\t\tif ( this.isNewPage &&\n\t\t\t// TODO: Replace with an OOUI dialog\n\t\t\t!window.confirm( mw.msg( 'mobile-frontend-editor-new-page-confirm', mwUser ) )\n\t\t) {\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t},\n\t/**\n\t * Executed when page save is complete. Handles reloading the page, showing toast\n\t * messages.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonSaveComplete: function () {\n\t\tvar msg,\n\t\t\t$window = util.getWindow(),\n\t\t\ttitle = this.options.title,\n\t\t\tself = this;\n\n\t\tthis.saved = true;\n\n\t\t// FIXME: use generic method for following 3 lines\n\t\tthis.pageGateway.invalidatePage( title );\n\n\t\tif ( this.isNewPage ) {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-success-new-page' );\n\t\t} else if ( this.isNewEditor ) {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-success-landmark-1' );\n\t\t} else {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-success' );\n\t\t}\n\t\ttoast.showOnPageReload( msg, 'success' );\n\n\t\t// Ensure we don't lose this event when logging\n\t\tthis.log( {\n\t\t\taction: 'saveSuccess'\n\t\t} );\n\t\tif ( self.sectionLine ) {\n\t\t\t// Ideally we'd want to do this via replaceState (see T189173)\n\t\t\t// eslint-disable-next-line no-restricted-properties\n\t\t\twindow.location.hash = self.sectionLine;\n\t\t} else {\n\t\t\t// Cancel the hash fragment\n\t\t\t// otherwise clicking back after a save will take you back to the editor.\n\t\t\t// We avoid calling the hide method of the overlay here as this can be asynchronous\n\t\t\t// and may conflict with the window.reload call below.\n\t\t\t// eslint-disable-next-line no-restricted-properties\n\t\t\twindow.location.hash = '#';\n\t\t}\n\n\t\t$window.off( 'beforeunload.mfeditorwarning' );\n\n\t\t// Note the \"#\" may be in the URL.\n\t\t// If so, using window.location alone will not reload the page\n\t\t// we need to forcefully refresh\n\t\t// eslint-disable-next-line no-restricted-properties\n\t\twindow.location.reload();\n\t},\n\t/**\n\t * Executed when page save fails. Handles logging the error. Subclasses\n\t * should display error messages as appropriate.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {Object} data Details about the failure, from EditorGateway.parseSaveError\n\t */\n\tonSaveFailure: function ( data ) {\n\t\tvar key = data && data.details && data.details.code,\n\t\t\ttypeMap = {\n\t\t\t\teditconflict: 'editConflict',\n\t\t\t\twasdeleted: 'editPageDeleted',\n\t\t\t\t'abusefilter-disallowed': 'extensionAbuseFilter',\n\t\t\t\tcaptcha: 'extensionCaptcha',\n\t\t\t\tspamprotectiontext: 'extensionSpamBlacklist',\n\t\t\t\t'titleblacklist-forbidden-edit': 'extensionTitleBlacklist'\n\t\t\t};\n\n\t\tif ( data.type === 'captcha' ) {\n\t\t\tkey = 'captcha';\n\t\t}\n\n\t\tthis.log( {\n\t\t\taction: 'saveFailure',\n\t\t\tmessage: this.saveFailureMessage( data ),\n\t\t\ttype: typeMap[key] || 'responseUnknown'\n\t\t} );\n\t},\n\t/**\n\t * Build a save failure message from the API response\n\t * @param {Object} data Details about the failure, from EditorGateway.parseSaveError\n\t * @return {string} message describing the failure for display to the user\n\t */\n\tsaveFailureMessage: function ( data ) {\n\t\tvar key = data && data.details && data.details.code,\n\t\t\t// When save failed with one of these error codes, the returned\n\t\t\t// message in response.error.info will be forwarded to the user.\n\t\t\t// FIXME: This shouldn't be needed when info texts are all localized.\n\t\t\twhitelistedErrorInfo = [\n\t\t\t\t'blocked',\n\t\t\t\t'autoblocked'\n\t\t\t];\n\t\tif ( data.type === 'readonly' ) {\n\t\t\treturn data.details.readonlyreason;\n\t\t}\n\t\tif ( key === 'editconflict' ) {\n\t\t\treturn mw.msg( 'mobile-frontend-editor-error-conflict' );\n\t\t} else if ( whitelistedErrorInfo.indexOf( key ) > -1 ) {\n\t\t\treturn data.error.info;\n\t\t}\n\t\treturn mw.msg( 'mobile-frontend-editor-error' );\n\t},\n\t/**\n\t * Report load errors back to the user. Silently record the error using EventLogging.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {string} text Text of message to display to user\n\t * @param {string} heading heading text to display to user\n\t */\n\treportError: function ( text, heading ) {\n\t\tvar errorNotice = new MessageBox( {\n\t\t\tclassName: 'errorbox',\n\t\t\tmsg: text,\n\t\t\theading: heading\n\t\t} );\n\t\tthis.$errorNoticeContainer.html( errorNotice.$el );\n\t},\n\thideErrorNotice: function () {\n\t\tthis.$errorNoticeContainer.empty();\n\t},\n\t/**\n\t * Prepares the penultimate screen before saving.\n\t * Expects to be overridden by child class.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonStageChanges: function () {\n\t\tthis.showHidden( '.save-header, .save-panel' );\n\t\tthis.log( {\n\t\t\taction: 'saveIntent'\n\t\t} );\n\t\t// Scroll to the top of the page, so that the summary input is visible\n\t\t// (even if overlay was scrolled down when editing) and weird iOS header\n\t\t// problems are avoided (header position not updating to the top of the\n\t\t// screen, instead staying lower until a subsequent scroll event).\n\t\twindow.scrollTo( 0, 1 );\n\t},\n\t/**\n\t * Executed when the editor clicks the save button. Expects to be overridden by child\n\t * class. Checks if the save needs to be confirmed.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonSaveBegin: function () {\n\t\tthis.confirmAborted = false;\n\t\tthis.hideErrorNotice();\n\t\t// Ask for confirmation in some cases\n\t\tif ( !this.confirmSave() ) {\n\t\t\tthis.confirmAborted = true;\n\t\t\treturn;\n\t\t}\n\t\tthis.log( {\n\t\t\taction: 'saveAttempt'\n\t\t} );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\t// log edit attempt\n\t\t// TODO: if VE/NWE become the default, or even loadable-by-URL, this\n\t\t// logging needs to be moved into the individual overlays, because postRender\n\t\t// for VE still wouldn't technically be 'ready'.\n\t\tthis.log( {\n\t\t\taction: 'ready'\n\t\t} );\n\t\tthis.log( {\n\t\t\taction: 'loaded'\n\t\t} );\n\n\t\t// decide what happens, when the user clicks the continue button\n\t\tif ( this.config.skipPreview ) {\n\t\t\t// skip the preview and save the changes\n\t\t\tthis.nextStep = 'onSaveBegin';\n\t\t\tthis.$( '.continue' ).text( this.defaults.saveMsg );\n\t\t} else {\n\t\t\t// default: show the preview step\n\t\t\tthis.nextStep = 'onStageChanges';\n\t\t}\n\t\tthis.$errorNoticeContainer = this.$el.find( '#error-notice-container' );\n\n\t\tOverlay.prototype.postRender.apply( this );\n\n\t\tthis.showHidden( '.initial-header' );\n\t},\n\tshow: function () {\n\t\tthis.saved = false;\n\t\tOverlay.prototype.show.call( this );\n\t\t// Inform other interested code that the editor has loaded\n\t\tmw.hook( 'mobileFrontend.editorOpened' ).fire( this.editor );\n\t},\n\t/**\n\t * Back button click handler\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonClickBack: function () {},\n\t/**\n\t * Submit button click handler\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonClickSubmit: function () {\n\t\tthis.onSaveBegin();\n\t},\n\t/**\n\t * Continue button click handler\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonClickContinue: function () {\n\t\tthis[this.nextStep]();\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @return {boolean|jQuery.Promise} Boolean, or promise resolving with a boolean\n\t */\n\thide: function () {\n\t\tvar windowManager,\n\t\t\tself = this;\n\t\tif ( this.hasChanged() ) {\n\t\t\twindowManager = OO.ui.getWindowManager();\n\t\t\twindowManager.addWindows( [ new mw.widgets.AbandonEditDialog() ] );\n\t\t\treturn windowManager.openWindow( 'abandonedit' )\n\t\t\t\t.closed.then( function ( data ) {\n\t\t\t\t\tif ( data && data.action === 'discard' ) {\n\t\t\t\t\t\t// log abandonment\n\t\t\t\t\t\tself.log( {\n\t\t\t\t\t\t\taction: 'abort',\n\t\t\t\t\t\t\tmechanism: 'cancel',\n\t\t\t\t\t\t\ttype: 'abandon'\n\t\t\t\t\t\t} );\n\t\t\t\t\t\tself.allowCloseWindow.release();\n\t\t\t\t\t\tmw.hook( 'mobileFrontend.editorClosed' ).fire();\n\t\t\t\t\t\tOverlay.prototype.hide.call( self );\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t}\n\t\tif ( !this.switching && !this.saved ) {\n\t\t\t// log leaving without changes\n\t\t\tthis.log( {\n\t\t\t\taction: 'abort',\n\t\t\t\tmechanism: 'cancel',\n\t\t\t\t// if this is VE, hasChanged will be false because the Surface has\n\t\t\t\t// already been destroyed (which is good because it stops us\n\t\t\t\t// double-showing the abandon changes dialog above)... but we can\n\t\t\t\t// test whether there *were* changes for logging purposes by\n\t\t\t\t// examining the target:\n\t\t\t\ttype: ( this.target && this.target.edited ) ? 'abandon' : 'nochange'\n\t\t\t} );\n\t\t}\n\t\tthis.allowCloseWindow.release();\n\t\tmw.hook( 'mobileFrontend.editorClosed' ).fire();\n\t\treturn Overlay.prototype.hide.call( self );\n\t},\n\t/**\n\t * Check, if the user should be asked if they really want to leave the page.\n\t * Returns false, if he hasn't made changes, otherwise true.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {boolean} [force] Whether this function should always return false\n\t * @return {boolean}\n\t */\n\tshouldConfirmLeave: function ( force ) {\n\t\tif ( force || !this.hasChanged() ) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\n\t},\n\t/**\n\t * Checks whether the state of the thing being edited as changed. Expects to be\n\t * implemented by child class.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\thasChanged: function () {},\n\t/**\n\t * Handles a failed save due to a CAPTCHA provided by ConfirmEdit extension.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {Object} details Details returned from the api.\n\t */\n\thandleCaptcha: function ( details ) {\n\t\tvar self = this,\n\t\t\t$input = this.$( '.captcha-word' );\n\n\t\tif ( this.captchaShown ) {\n\t\t\t$input.val( '' );\n\t\t\t$input.attr( 'placeholder', this.options.captchaTryAgainMsg );\n\t\t\tsetTimeout( function () {\n\t\t\t\t$input.attr( 'placeholder', self.options.captchaMsg );\n\t\t\t}, 2000 );\n\t\t}\n\n\t\t// handle different mime types different\n\t\tif ( details.mime.indexOf( 'image/' ) === 0 ) {\n\t\t\t// image based CAPTCHA's like provided by FancyCaptcha, ReCaptcha or similar\n\t\t\tthis.$( '.captcha-panel#question' ).detach();\n\t\t\tthis.$( '.captcha-panel img' ).attr( 'src', details.url );\n\t\t} else {\n\t\t\t// not image based CAPTCHA.\n\t\t\tthis.$( '.captcha-panel #image' ).detach();\n\t\t\tif ( details.mime.indexOf( 'text/html' ) === 0 ) {\n\t\t\t\t// handle mime type of HTML as HTML content (display as-is).\n\t\t\t\t// QuestyCaptcha now have default MIME type \"text/html\": see T147606\n\t\t\t\tthis.$( '.captcha-panel #question' ).html( details.question );\n\t\t\t} else {\n\t\t\t\t// handle mime types\n\t\t\t\t// (other than image based ones and HTML based ones)\n\t\t\t\t// as plain text by default.\n\t\t\t\t// e.g. MathCaptcha (solve a math formula) or\n\t\t\t\t// SimpleCaptcha (simple math formula)\n\t\t\t\tthis.$( '.captcha-panel #question' ).text( details.question );\n\t\t\t}\n\t\t}\n\n\t\tthis.showHidden( '.save-header, .captcha-panel' );\n\t\tthis.captchaShown = true;\n\t}\n} );\n\nmodule.exports = EditorOverlayBase;\n","/* global ve */\nvar EditorOverlayBase = require( './EditorOverlayBase' ),\n\tEditorGateway = require( './EditorGateway' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tutil = require( '../mobile.startup/util' );\n\n/**\n * Overlay for VisualEditor view\n * @class VisualEditorOverlay\n * @extends EditorOverlayBase\n *\n * @param {Object} options Configuration options\n * @param {EditorOverlay} options.EditorOverlay Class to use for standard\n *  Wikitext editor. It must be passed in explicitly to avoid a cyclic\n *  dependency between VisualEdtiorOverlay and EditorOverlay\n */\nfunction VisualEditorOverlay( options ) {\n\tthis.applyHeaderOptions( options, true );\n\tEditorOverlayBase.call( this,\n\t\tutil.extend( {\n\t\t\tisBorderBox: false,\n\t\t\tclassName: 'overlay editor-overlay editor-overlay-ve'\n\t\t}, options )\n\t);\n\tthis.EditorOverlay = options.EditorOverlay;\n\tthis.isNewPage = options.isNewPage;\n\n\t// Gateway present for a few utility purposes; the VE articletarget\n\t// handles the actual API calls separately\n\tthis.gateway = new EditorGateway( {\n\t\tapi: options.api,\n\t\ttitle: options.title,\n\t\tsectionId: options.sectionId,\n\t\toldId: options.oldId,\n\t\tisNewPage: options.isNewPage\n\t} );\n}\n\nmfExtend( VisualEditorOverlay, EditorOverlayBase, {\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, EditorOverlayBase.prototype.templatePartials, {\n\t\teditHeader: mw.template.get( 'mobile.editor.overlay', 'toolbarVE.hogan' ),\n\t\tcontent: mw.template.get( 'mobile.editor.overlay', 'contentVE.hogan' )\n\t} ),\n\t/**\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\teditor: 'visualeditor',\n\t/**\n\t * Set options that apply specifically to VisualEditorOverlay but not\n\t * EditorOverlay so that an EditorOverlay instance can be created effortlessly.\n\t * FIXME: Must be smarter way to do this.\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t * @param {Object} options Configuration options\n\t * @param {boolean} isVE whether the options are being generated for a VisualEditorOverlay\n\t *  or a EditorOverlay\n\t */\n\tapplyHeaderOptions: function ( options, isVE ) {\n\t\t// Set things that are known to be true.\n\t\toptions.hasToolbar = isVE;\n\t\toptions.isVisualEditor = isVE;\n\t},\n\t/**\n\t * Destroy the existing VisualEditor target.\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tdestroyTarget: function () {\n\t\tif ( this.target ) {\n\t\t\tthis.target.destroy();\n\t\t\tthis.target = null;\n\t\t}\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tshow: function () {\n\t\tEditorOverlayBase.prototype.show.apply( this, arguments );\n\n\t\tthis.target = ve.init.mw.targetFactory.create( 'article', this, {\n\t\t\t$element: this.$el,\n\t\t\t// || null so that scrolling is not triggered for the lead (0) section\n\t\t\t// (which has no header to scroll to)\n\t\t\tsection: this.options.sectionId || null\n\t\t} );\n\t\tthis.target.load( this.options.dataPromise );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\thide: function () {\n\t\tvar overlay = this,\n\t\t\tretval = EditorOverlayBase.prototype.hide.apply( this, arguments );\n\t\tif ( retval === true ) {\n\t\t\tthis.destroyTarget();\n\t\t} else if ( retval && retval.then ) {\n\t\t\tretval.then( function ( hide ) {\n\t\t\t\tif ( hide ) {\n\t\t\t\t\toverlay.destroyTarget();\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\t\treturn retval;\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tonClickBack: function () {\n\t\tEditorOverlayBase.prototype.onClickBack.apply( this, arguments );\n\t\tthis.switchToEditor();\n\t},\n\n\t/**\n\t * Reveal the editing interface.\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tswitchToEditor: function () {\n\t\tthis.showHidden( '.initial-header' );\n\t},\n\t/**\n\t * Loads an {EditorOverlay} and replaces the existing {VisualEditorOverlay}\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tswitchToSourceEditor: function () {\n\t\tvar self = this,\n\t\t\tEditorOverlay = this.EditorOverlay;\n\t\tthis.log( {\n\t\t\taction: 'abort',\n\t\t\ttype: 'switchnochange',\n\t\t\tmechanism: 'navigate'\n\t\t} );\n\t\t// Save a user setting indicating that this user prefers using the SourceEditor\n\t\tmw.storage.set( 'preferredEditor', 'SourceEditor' );\n\t\tthis.showSpinner();\n\t\tthis.$( '.surface' ).hide();\n\t\tself.hideSpinner();\n\t\tself.applyHeaderOptions( self.options, false );\n\t\t// Unset classes from other editor\n\t\tdelete self.options.className;\n\t\tself.switching = true;\n\t\tself.overlayManager.replaceCurrent( new EditorOverlay( self.options ) );\n\t\tself.switching = false;\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tonSaveComplete: function () {\n\t\tEditorOverlayBase.prototype.onSaveComplete.apply( this, arguments );\n\t\tthis.destroyTarget();\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\thasChanged: function () {\n\t\treturn this.target &&\n\t\t\tthis.target.getSurface() &&\n\t\t\tthis.target.getSurface().getModel().hasBeenModified() &&\n\t\t\t// If we just saved, there's not really any changes, and the\n\t\t\t// target is going to be destroyed in one tick\n\t\t\t!this.saved;\n\t}\n} );\n\nmodule.exports = VisualEditorOverlay;\n","/**\n * Turn an API response on save failure into a details object\n * @param {Object|null} data API response data\n * @param {string} [code] Text status message from API\n * @return {Object} An object with `type` and `details` properties.\n * `type` is a string describing the type of error, `details` can be any\n * object (usually error message).\n*/\nfunction parseSaveError( data, code ) {\n\tvar warning;\n\tif ( code ) {\n\t\tswitch ( code ) {\n\t\t\tcase 'readonly':\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'readonly',\n\t\t\t\t\tdetails: data.error\n\t\t\t\t};\n\t\t\tcase 'editconflict':\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'editconflict',\n\t\t\t\t\tdetails: data.error\n\t\t\t\t};\n\t\t\tdefault:\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tdetails: 'http'\n\t\t\t\t};\n\t\t}\n\t}\n\tif ( data ) {\n\t\tif ( data.error ) {\n\t\t\t// Edit API error\n\t\t\treturn {\n\t\t\t\ttype: 'error',\n\t\t\t\tdetails: data.error.code\n\t\t\t};\n\t\t} else if ( data.edit && data.edit.captcha ) {\n\t\t\t// CAPTCHAs\n\t\t\treturn {\n\t\t\t\ttype: 'captcha',\n\t\t\t\tdetails: data.edit.captcha\n\t\t\t};\n\t\t} else if ( data.edit && data.edit.code ) {\n\t\t\tcode = data.edit.code;\n\t\t\twarning = data.edit.warning;\n\n\t\t\t// FIXME: AbuseFilter should have more consistent API responses\n\t\t\tif ( /^abusefilter-warning/.test( code ) ) {\n\t\t\t\t// AbuseFilter warning\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'abusefilter',\n\t\t\t\t\tdetails: {\n\t\t\t\t\t\ttype: 'warning',\n\t\t\t\t\t\tmessage: warning\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t} else if ( /^abusefilter-disallow/.test( code ) ) {\n\t\t\t\t// AbuseFilter disallow\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'abusefilter',\n\t\t\t\t\tdetails: {\n\t\t\t\t\t\ttype: 'disallow',\n\t\t\t\t\t\tmessage: warning\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t} else if ( /^abusefilter/.test( code ) ) {\n\t\t\t\t// AbuseFilter other\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'abusefilter',\n\t\t\t\t\tdetails: {\n\t\t\t\t\t\ttype: 'other',\n\t\t\t\t\t\tmessage: warning\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t\t// other errors\n\t\t\treturn {\n\t\t\t\ttype: 'error',\n\t\t\t\tdetails: code\n\t\t\t};\n\t\t}\n\t}\n\treturn {\n\t\ttype: 'error',\n\t\tdetails: 'unknown'\n\t};\n}\nmodule.exports = parseSaveError;\n","var Overlay = require( '../mobile.startup/Overlay' ),\n\tutil = require( '../mobile.startup/util' ),\n\tlangUtil = require( './util' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' );\n\n/**\n * Overlay displaying a structured list of languages for a page\n *\n * @class LanguageOverlay\n * @extends Overlay\n *\n * @param {Object} options Configuration options\n * @param {Object[]} options.languages list of language objects as returned by the API\n * @param {Array|boolean} options.variants language variant objects\n *  or false if no variants exist\n * @param {string} [options.deviceLanguage] the device's primary language\n */\nfunction LanguageOverlay( options ) {\n\t/**\n\t * @prop {StructuredLanguages} languages` JSDoc.\n\t */\n\tthis.languages = langUtil.getStructuredLanguages(\n\t\toptions.languages,\n\t\toptions.variants,\n\t\tlangUtil.getFrequentlyUsedLanguages(),\n\t\toptions.deviceLanguage\n\t);\n\tOverlay.call(\n\t\tthis,\n\t\tutil.extend(\n\t\t\toptions,\n\t\t\t{\n\t\t\t\tclassName: 'overlay language-overlay',\n\t\t\t\tevents: {\n\t\t\t\t\t'click a': 'onLinkClick',\n\t\t\t\t\t'input .search': 'onSearchInput'\n\t\t\t\t}\n\t\t\t}\n\t\t)\n\t);\n}\n\nmfExtend( LanguageOverlay, Overlay, {\n\t/**\n\t * @memberof LanguageOverlay\n\t * @instance\n\t * @mixes Overlay#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {Object[]} defaults.languages each object has keys as\n\t *  returned by the langlink API https://www.mediawiki.org/wiki/API:Langlinks\n\t */\n\tdefaults: util.extend( {}, Overlay.prototype.defaults, {\n\t\theading: mw.msg( 'mobile-frontend-language-heading' ),\n\t\tinputPlaceholder: mw.msg( 'mobile-frontend-languages-structured-overlay-search-input-placeholder' ),\n\t\t// we can't rely on CSS only to uppercase the headings. See https://stackoverflow.com/questions/3777443/css-text-transform-not-working-properly-for-turkish-characters\n\t\tallLanguagesHeader: mw.msg( 'mobile-frontend-languages-structured-overlay-all-languages-header' ).toLocaleUpperCase(),\n\t\tsuggestedLanguagesHeader: mw.msg( 'mobile-frontend-languages-structured-overlay-suggested-languages-header' ).toLocaleUpperCase()\n\t} ),\n\t/**\n\t * @inheritdoc\n\t * @memberof LanguageOverlay\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, Overlay.prototype.templatePartials, {\n\t\tcontent: mw.template.get( 'mobile.languages.structured', 'LanguageOverlay.hogan' )\n\t} ),\n\t/**\n\t * @inheritdoc\n\t */\n\tpreRender: function () {\n\t\tvar languages = this.languages;\n\t\t// Update options with template properties before we perform the render.\n\t\tutil.extend( this.options, {\n\t\t\tallLanguages: languages.all,\n\t\t\tallLanguagesCount: languages.all.length,\n\t\t\tsuggestedLanguages: languages.suggested,\n\t\t\tsuggestedLanguagesCount: languages.suggested.length\n\t\t} );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof LanguageOverlay\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tOverlay.prototype.postRender.apply( this );\n\n\t\t// cache\n\t\tthis.$siteLinksList = this.$( '.site-link-list' );\n\t\tthis.$languageItems = this.$siteLinksList.find( 'a' );\n\t\tthis.$subheaders = this.$( 'h3' );\n\t},\n\t/**\n\t * Article link click event handler\n\t * @memberof LanguageOverlay\n\t * @instance\n\t * @param {jQuery.Event} ev\n\t */\n\tonLinkClick: function ( ev ) {\n\t\tvar $link = this.$( ev.currentTarget ),\n\t\t\tlang = $link.attr( 'lang' ),\n\t\t\tself = this,\n\t\t\t$visibleLanguageLinks = this.$languageItems.filter( ':visible' );\n\n\t\tlangUtil.saveLanguageUsageCount( lang, langUtil.getFrequentlyUsedLanguages() );\n\n\t\t// find the index of the clicked language in the list of visible results\n\t\t$visibleLanguageLinks.each( function ( i, link ) {\n\t\t\tif ( self.$( link ).hasClass( lang ) ) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} );\n\t},\n\t/**\n\t * Search input handler\n\t * @memberof LanguageOverlay\n\t * @instance\n\t * @param {jQuery.Event} ev Event object.\n\t */\n\tonSearchInput: function ( ev ) {\n\t\tthis.filterLanguages( this.$( ev.target ).val().toLowerCase() );\n\t},\n\t/**\n\t * Filter the language list to only show languages that match the current search term.\n\t * @memberof LanguageOverlay\n\t * @instance\n\t * @param {string} val of search term (lowercase).\n\t */\n\tfilterLanguages: function ( val ) {\n\t\tvar filteredList = [];\n\n\t\tif ( val ) {\n\t\t\tthis.options.languages.forEach( function ( language ) {\n\t\t\t\tvar langname = language.langname;\n\t\t\t\t// search by language code or language name\n\t\t\t\tif ( language.autonym.toLowerCase().indexOf( val ) > -1 ||\n\t\t\t\t\t\t( langname && langname.toLowerCase().indexOf( val ) > -1 ) ||\n\t\t\t\t\t\tlanguage.lang.toLowerCase().indexOf( val ) > -1\n\t\t\t\t) {\n\t\t\t\t\tfilteredList.push( language.lang );\n\t\t\t\t}\n\t\t\t} );\n\n\t\t\tif ( this.options.variants ) {\n\t\t\t\tthis.options.variants.forEach( function ( variant ) {\n\t\t\t\t\t// search by variant code or variant name\n\t\t\t\t\tif ( variant.autonym.toLowerCase().indexOf( val ) > -1 ||\n\t\t\t\t\t\tvariant.lang.toLowerCase().indexOf( val ) > -1\n\t\t\t\t\t) {\n\t\t\t\t\t\tfilteredList.push( variant.lang );\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t}\n\n\t\t\tthis.$languageItems.addClass( 'hidden' );\n\t\t\tif ( filteredList.length ) {\n\t\t\t\tthis.$siteLinksList.find( '.' + filteredList.join( ',.' ) ).removeClass( 'hidden' );\n\t\t\t}\n\t\t\tthis.$siteLinksList.addClass( 'filtered' );\n\t\t\tthis.$subheaders.addClass( 'hidden' );\n\t\t} else {\n\t\t\tthis.$languageItems.removeClass( 'hidden' );\n\t\t\tthis.$siteLinksList.removeClass( 'filtered' );\n\t\t\tthis.$subheaders.removeClass( 'hidden' );\n\t\t}\n\t}\n} );\n\nmodule.exports = LanguageOverlay;\n","module.exports = [\n\t'aeb',\n\t'aeb-arab',\n\t'ar',\n\t'arc',\n\t'arq',\n\t'arz',\n\t'azb',\n\t'bcc',\n\t'bgn',\n\t'bqi',\n\t'ckb',\n\t'dv',\n\t'fa',\n\t'glk',\n\t'he',\n\t'khw',\n\t'kk-arab',\n\t'kk-cn',\n\t'ks',\n\t'ks-arab',\n\t'ku-arab',\n\t'lki',\n\t'lrc',\n\t'luz',\n\t'mzn',\n\t'pnb',\n\t'ps',\n\t'sd',\n\t'sdh',\n\t'skr',\n\t'skr-arab',\n\t'ug',\n\t'ug-arab',\n\t'ur',\n\t'yi'\n];\n","var\n\tlog = mw.log,\n\tmfUtils = require( '../mobile.startup/util' ),\n\trtlLanguages = require( './rtlLanguages' );\n\n/**\n * @typedef {Object} Language\n * @prop {string} autonym of language e.g. franais\n * @prop {string} langname in the user's current language e.g French\n * @prop {string} title of the page in the language e.g. Espagne\n * @prop {string} dir (rtl or ltr)\n * @prop {string} url of the page\n *\n * @typedef {Object} SuggestedLanguage\n * @prop {string} autonym of language e.g. franais\n * @prop {string} langname in the user's current language e.g French\n * @prop {string} title of the page in the language e.g. Espagne\n * @prop {string} dir (rtl or ltr)\n * @prop {string} url of the page\n * @prop {number} frequency of times the language has been used by the given user\n *\n * @typedef {Object} StructuredLanguages\n * @prop {Language[]} all languages that are available\n * @prop {SuggestedLanguage[]} suggested languages based on users browsing history\n */\n\n/**\n * Return the device language if it's in the list of article languages.\n * If the language is a variant of a general language, and if the article\n * is not available in that language, then return the general language\n * if article is available in it. For example, if the device language is\n * 'en-gb', and the article is only available in 'en', then return 'en'.\n * @param {Object[]} languages list of language objects as returned by the API\n * @param {string|undefined} deviceLanguage the device's primary language\n * @return {string|undefined} Return undefined if the article is not available in\n *  the (general or variant) device language\n */\nfunction getDeviceLanguageOrParent( languages, deviceLanguage ) {\n\tvar parentLanguage, index,\n\t\thasOwn = Object.prototype.hasOwnProperty,\n\t\tdeviceLanguagesWithVariants = {};\n\n\tif ( !deviceLanguage ) {\n\t\treturn;\n\t}\n\n\t// Are we dealing with a variant?\n\tindex = deviceLanguage.indexOf( '-' );\n\tif ( index !== -1 ) {\n\t\tparentLanguage = deviceLanguage.slice( 0, index );\n\t}\n\n\tlanguages.forEach( function ( language ) {\n\t\tif ( language.lang === parentLanguage || language.lang === deviceLanguage ) {\n\t\t\tdeviceLanguagesWithVariants[ language.lang ] = true;\n\t\t}\n\t} );\n\n\tif ( hasOwn.call( deviceLanguagesWithVariants, deviceLanguage ) ) {\n\t\t// the device language is one of the available languages\n\t\treturn deviceLanguage;\n\t} else if ( hasOwn.call( deviceLanguagesWithVariants, parentLanguage ) ) {\n\t\t// no device language, but the parent language is one of the available languages\n\t\treturn parentLanguage;\n\t}\n}\n\n/**\n * Utility function for the structured language overlay\n *\n * @class util\n * @singleton\n */\nmodule.exports = {\n\t/**\n\t * Determine whether a language is LTR or RTL\n\t * This works around T74153 and T189036\n\t * @memberof util\n\t * @instance\n\t * @param {Object} language with 'lang' key.\n\t * @return {Object} language with 'lang' key and new 'dir' key.\n\t */\n\tgetDir: function ( language ) {\n\t\tvar dir = rtlLanguages.indexOf( language.lang ) > -1 ? 'rtl' : 'ltr';\n\t\treturn mfUtils.extend( {}, language, { dir: dir } );\n\t},\n\n\t/**\n\t * Return two sets of languages: suggested and all (everything else)\n\t *\n\t * Suggested languages are the ones that the user has used before. This also\n\t * includes the user device's primary language. Suggested languages are ordered\n\t * by frequency in descending order. The device's language is always at the top.\n\t * This group also includes the variants.\n\t *\n\t * All languages are the languages that are not suggested.\n\t * Languages in this list are ordered in the lexicographical order of\n\t * their language names.\n\t * @memberof util\n\t * @instance\n\t * @param {Object[]} languages list of language objects as returned by the API\n\t * @param {Array|boolean} variants language variant objects or false if no variants exist\n\t * @param {Object} frequentlyUsedLanguages list of the frequently used languages\n\t * @param {string} [deviceLanguage] the device's primary language\n\t * @return {StructuredLanguages}\n\t */\n\tgetStructuredLanguages: function (\n\t\tlanguages, variants, frequentlyUsedLanguages, deviceLanguage\n\t) {\n\t\tvar hasOwn = Object.prototype.hasOwnProperty,\n\t\t\tmaxFrequency = 0,\n\t\t\tminFrequency = 0,\n\t\t\tmissingDir = 0,\n\t\t\tsuggestedLanguages = [],\n\t\t\tallLanguages = [],\n\t\t\tself = this;\n\n\t\t// Is the article available in the user's device language?\n\t\tdeviceLanguage = getDeviceLanguageOrParent( languages, deviceLanguage );\n\t\tif ( deviceLanguage ) {\n\t\t\tObject.keys( frequentlyUsedLanguages ).forEach( function ( language ) {\n\t\t\t\tvar frequency = frequentlyUsedLanguages[ language ];\n\t\t\t\tmaxFrequency = maxFrequency < frequency ? frequency : maxFrequency;\n\t\t\t\tminFrequency = minFrequency > frequency ? frequency : minFrequency;\n\t\t\t} );\n\n\t\t\t// Make the device language the most frequently used one so that\n\t\t\t// it appears at the top of the list when sorted by frequency.\n\t\t\tfrequentlyUsedLanguages[ deviceLanguage ] = maxFrequency + 1;\n\t\t}\n\n\t\t/**\n\t\t * @param {Object} language\n\t\t * @return {Object} which has 'dir' key.\n\t\t */\n\t\tfunction addLangDir( language ) {\n\t\t\tif ( language.dir ) {\n\t\t\t\treturn language;\n\t\t\t} else {\n\t\t\t\tmissingDir++;\n\t\t\t\treturn self.getDir( language );\n\t\t\t}\n\t\t}\n\n\t\t// Separate languages into suggested and all languages.\n\t\tlanguages.map( addLangDir ).forEach( function ( language ) {\n\t\t\tif ( hasOwn.call( frequentlyUsedLanguages, language.lang ) ) {\n\t\t\t\tlanguage.frequency = frequentlyUsedLanguages[ language.lang ];\n\t\t\t\tsuggestedLanguages.push( language );\n\t\t\t} else {\n\t\t\t\tallLanguages.push( language );\n\t\t\t}\n\t\t} );\n\n\t\t// Add variants to the suggested languages list and assign the lowest\n\t\t// frequency because the variant hasn't been clicked on yet.\n\t\t// Note that the variants data doesn't contain the article title, thus\n\t\t// we cannot show it for the variants.\n\t\tif ( variants ) {\n\t\t\tvariants.map( addLangDir ).forEach( function ( variant ) {\n\t\t\t\tif ( hasOwn.call( frequentlyUsedLanguages, variant.lang ) ) {\n\t\t\t\t\tvariant.frequency = frequentlyUsedLanguages[variant.lang];\n\t\t\t\t} else {\n\t\t\t\t\tvariant.frequency = minFrequency - 1;\n\t\t\t\t}\n\t\t\t\tsuggestedLanguages.push( variant );\n\t\t\t} );\n\t\t}\n\n\t\t// sort suggested languages in descending order by frequency\n\t\tsuggestedLanguages = suggestedLanguages.sort( function ( a, b ) {\n\t\t\treturn b.frequency - a.frequency;\n\t\t} );\n\n\t\t/**\n\t\t * Compare language names lexicographically\n\t\t *\n\t\t * @param {Object} a first language\n\t\t * @param {Object} b second language\n\t\t * @return {number} Comparison value, 1 or -1\n\t\t */\n\t\tfunction compareLanguagesByLanguageName( a, b ) {\n\t\t\treturn a.autonym.toLocaleLowerCase() < b.autonym.toLocaleLowerCase() ? -1 : 1;\n\t\t}\n\n\t\tallLanguages = allLanguages.sort( compareLanguagesByLanguageName );\n\n\t\t// This works around T74153\n\t\tlog.warn(\n\t\t\tmissingDir === 0 ? 'Direction is provided. Please remove handling in getStructuredLanguages' :\n\t\t\t\t'`dir` attribute was missing from languages. Is T74153 resolved?'\n\t\t);\n\n\t\treturn {\n\t\t\tsuggested: suggestedLanguages,\n\t\t\tall: allLanguages\n\t\t};\n\t},\n\n\t/**\n\t * Return a map of frequently used languages on the current device.\n\t * @memberof util\n\t * @instance\n\t * @return {Object}\n\t */\n\tgetFrequentlyUsedLanguages: function () {\n\t\tvar languageMap = mw.storage.get( 'langMap' );\n\n\t\treturn languageMap ? JSON.parse( languageMap ) : {};\n\t},\n\n\t/**\n\t * Save the frequently used languages to the user's device\n\t * @memberof util\n\t * @instance\n\t * @param {Object} languageMap\n\t */\n\tsaveFrequentlyUsedLanguages: function ( languageMap ) {\n\t\tmw.storage.set( 'langMap', JSON.stringify( languageMap ) );\n\t},\n\n\t/**\n\t * Increment the current language usage by one and save it to the device.\n\t * Cap the result at 100.\n\t * @memberof util\n\t * @instance\n\t * @param {string} languageCode\n\t * @param {Object} frequentlyUsedLanguages list of the frequently used languages\n\t */\n\tsaveLanguageUsageCount: function ( languageCode, frequentlyUsedLanguages ) {\n\t\tvar count = frequentlyUsedLanguages[ languageCode ] || 0;\n\n\t\tcount += 1;\n\t\t// cap at 100 as this is enough data to work on\n\t\tfrequentlyUsedLanguages[ languageCode ] = count > 100 ? 100 : count;\n\t\tthis.saveFrequentlyUsedLanguages( frequentlyUsedLanguages );\n\t}\n};\n","var sizeBuckets = [ 320, 640, 800, 1024, 1280, 1920, 2560, 2880 ],\n\tactionParams = require( './../mobile.startup/actionParams' ),\n\tutil = require( './../mobile.startup/util' );\n\n/**\n * Gets the first size larger than or equal to the provided size\n * @memberof ImageGateway\n * @param {number} size\n * @return {number}\n */\nfunction findSizeBucket( size ) {\n\tvar i = 0;\n\twhile ( size > sizeBuckets[i] && i < sizeBuckets.length - 1 ) {\n\t\t++i;\n\t}\n\treturn sizeBuckets[i];\n}\n\n/**\n * API for retrieving image thumbnails for a given page\n * @class ImageGateway\n *\n * @param {Object} options Configuration options\n * @property {mw.Api} options.api\n */\nfunction ImageGateway( options ) {\n\tthis._cache = {};\n\tthis.api = options.api;\n}\n/**\n * Get thumbnail via the API and cache it. Return the result from the cache if exists.\n * @param {string} title Url of image\n * @return {jQuery.Deferred} with the image info\n */\nImageGateway.prototype.getThumb = function ( title ) {\n\tvar cachedThumb = this._cache[title],\n\t\t$window = util.getWindow(),\n\t\timageSizeMultiplier = ( window.devicePixelRatio && window.devicePixelRatio > 1 ) ?\n\t\t\twindow.devicePixelRatio : 1;\n\n\tif ( !cachedThumb ) {\n\t\tthis._cache[title] = this.api.get( actionParams( {\n\t\t\tprop: 'imageinfo',\n\t\t\ttitles: title,\n\t\t\tiiprop: [ 'url', 'extmetadata' ],\n\t\t\t// request an image devicePixelRatio times bigger than the reported screen size\n\t\t\t// for retina displays and zooming\n\t\t\tiiurlwidth: findSizeBucket( $window.width() * imageSizeMultiplier ),\n\t\t\tiiurlheight: findSizeBucket( $window.height() * imageSizeMultiplier )\n\t\t} ) ).then( function ( resp ) {\n\t\t\t// imageinfo is undefined for missing pages.\n\t\t\tif ( resp.query && resp.query.pages &&\n\t\t\t\tresp.query.pages[0] && resp.query.pages[0].imageinfo ) {\n\t\t\t\treturn resp.query.pages[0].imageinfo[0];\n\t\t\t}\n\t\t\tthrow new Error( 'The API failed to return any pages matching the titles.' );\n\t\t} );\n\t}\n\n\treturn this._cache[title];\n};\n\nImageGateway._findSizeBucket = findSizeBucket;\nmodule.exports = ImageGateway;\n","var Overlay = require( './../mobile.startup/Overlay' ),\n\tutil = require( './../mobile.startup/util' ),\n\tmfExtend = require( './../mobile.startup/mfExtend' ),\n\tIcon = require( './../mobile.startup/Icon' ),\n\ticons = require( './../mobile.startup/icons' ),\n\tButton = require( './../mobile.startup/Button' ),\n\tLoadErrorMessage = require( './LoadErrorMessage' ),\n\tImageGateway = require( './ImageGateway' ),\n\t// FIXME: mw.loader.require is a private function but there's no other way to get hold of\n\t// this right now using require will cause webpack to resolve it\n\t// Can be rewritten to mw.router when https://gerrit.wikimedia.org/r/#/c/mediawiki/core/+/482732 has been merged\n\trouter = mw.loader.require( 'mediawiki.router' );\n\n/**\n * Displays images in full screen overlay\n * @class ImageOverlay\n * @extends Overlay\n * @uses Icon\n * @uses ImageGateway\n * @uses LoadErrorMessage\n * @uses Router\n * @fires ImageOverlay#ImageOverlay-exit\n * @fires ImageOverlay#ImageOverlay-slide\n * @param {Object} options Configuration options\n * @param {OO.EventEmitter} options.eventBus Object used to listen for resize:throttled events\n */\nfunction ImageOverlay( options ) {\n\tthis.gateway = options.gateway || new ImageGateway( {\n\t\tapi: options.api\n\t} );\n\tthis.router = options.router || router;\n\tthis.eventBus = options.eventBus;\n\n\tOverlay.call(\n\t\tthis,\n\t\tutil.extend(\n\t\t\t{\n\t\t\t\tclassName: 'overlay media-viewer',\n\t\t\t\tevents: {\n\t\t\t\t\t'click .image-wrapper': 'onToggleDetails',\n\t\t\t\t\t// Click tracking for table of contents so we can see if people interact with it\n\t\t\t\t\t'click .slider-button': 'onSlide'\n\t\t\t\t}\n\t\t\t},\n\t\t\toptions\n\t\t)\n\t);\n}\n\nmfExtend( ImageOverlay, Overlay, {\n\t/**\n\t * allow pinch zooming\n\t * @memberof ImageOverlay\n\t * @instance\n\t */\n\thasFixedHeader: false,\n\t/**\n\t * @memberof ImageOverlay\n\t * @instance\n\t */\n\thideOnExitClick: false,\n\t/**\n\t * @memberof ImageOverlay\n\t * @instance\n\t */\n\ttemplate: mw.template.get( 'mobile.mediaViewer', 'Overlay.hogan' ),\n\n\t/**\n\t * @memberof ImageOverlay\n\t * @instance\n\t * @mixes Overlay#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {mw.Api} defaults.api instance of API to use\n\t * @property {string} defaults.cancelButton HTML of the cancel button.\n\t * @property {Object} defaults.detailsButton options for details button\n\t * @property {string} defaults.licenseLinkMsg Link to license information in media viewer.\n\t * @property {Thumbnail[]} defaults.thumbnails a list of thumbnails to browse\n\t */\n\tdefaults: util.extend( {}, Overlay.prototype.defaults, {\n\t\tcancelButton: icons.cancel( 'gray' ).toHtmlString(),\n\t\tdetailsButton: new Button( {\n\t\t\tlabel: mw.msg( 'mobile-frontend-media-details' ),\n\t\t\tadditionalClassNames: 'button',\n\t\t\tprogressive: true\n\t\t} ).options,\n\t\tlicenseLinkMsg: mw.msg( 'mobile-frontend-media-license-link' ),\n\t\tthumbnails: [],\n\t\tslideLeftButton: new Icon( {\n\t\t\trotation: 90,\n\t\t\tname: 'arrow-invert'\n\t\t} ).toHtmlString(),\n\t\tslideRightButton: new Icon( {\n\t\t\trotation: -90,\n\t\t\tname: 'arrow-invert'\n\t\t} ).toHtmlString()\n\t} ),\n\t/**\n\t * Event handler for slide event\n\t * @memberof ImageOverlay\n\t * @instance\n\t * @param {jQuery.Event} ev\n\t */\n\tonSlide: function ( ev ) {\n\t\tvar nextThumbnail = this.$( ev.target ).closest( '.slider-button' ).data( 'thumbnail' );\n\t\tthis.emit( ImageOverlay.EVENT_SLIDE, nextThumbnail );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof ImageOverlay\n\t * @instance\n\t */\n\tpreRender: function () {\n\t\tvar self = this;\n\t\tthis.options.thumbnails.forEach( function ( thumbnail, i ) {\n\t\t\tif ( thumbnail.getFileName() === self.options.title ) {\n\t\t\t\tself.options.caption = thumbnail.getDescription();\n\t\t\t\tself.galleryOffset = i;\n\t\t\t}\n\t\t} );\n\t},\n\t/**\n\t * Setup the next and previous images to enable the user to arrow through\n\t * all images in the set of images given in thumbs.\n\t * @memberof ImageOverlay\n\t * @instance\n\t * @param {Array} thumbs A set of images, which are available\n\t * @private\n\t */\n\t_enableArrowImages: function ( thumbs ) {\n\t\tvar offset = this.galleryOffset,\n\t\t\tlastThumb, nextThumb;\n\n\t\tif ( this.galleryOffset === undefined ) {\n\t\t\t// couldn't find a suitable matching thumbnail so make\n\t\t\t// next slide start at beginning and previous slide be end\n\t\t\tlastThumb = thumbs[thumbs.length - 1];\n\t\t\tnextThumb = thumbs[0];\n\t\t} else {\n\t\t\t// identify last thumbnail\n\t\t\tlastThumb = thumbs[ offset === 0 ? thumbs.length - 1 : offset - 1 ];\n\t\t\tnextThumb = thumbs[ offset === thumbs.length - 1 ? 0 : offset + 1 ];\n\t\t}\n\n\t\tthis.$( '.prev' ).data( 'thumbnail', lastThumb );\n\t\tthis.$( '.next' ).data( 'thumbnail', nextThumb );\n\t},\n\t/**\n\t * Disables the possibility to arrow through all images of the page.\n\t * @memberof ImageOverlay\n\t * @instance\n\t * @private\n\t */\n\t_disableArrowImages: function () {\n\t\tthis.$( '.prev, .next' ).remove();\n\t},\n\n\t/**\n\t * Handler for retry event which triggers when user tries to reload overlay\n\t * after a loading error.\n\t * @memberof ImageOverlay\n\t * @instance\n\t * @private\n\t */\n\t_handleRetry: function () {\n\t\t// A hacky way to simulate a reload of the overlay\n\t\tthis.router.emit( 'hashchange' );\n\t},\n\n\t/**\n\t * @inheritdoc\n\t * @memberof ImageOverlay\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tvar $img,\n\t\t\tthumbs = this.options.thumbnails || [],\n\t\t\tself = this;\n\n\t\t/**\n\t\t * Hide the spinner\n\t\t * @method\n\t\t * @ignore\n\t\t */\n\t\tfunction removeLoader() {\n\t\t\tself.hideSpinner();\n\t\t}\n\n\t\t/**\n\t\t * Display media load failure message\n\t\t * @method\n\t\t * @ignore\n\t\t */\n\t\tfunction showLoadFailMsg() {\n\t\t\tself.hasLoadError = true;\n\n\t\t\tremoveLoader();\n\t\t\t// hide broken image if present\n\t\t\tself.$( '.image img' ).hide();\n\n\t\t\t// show error message if not visible already\n\t\t\tif ( self.$( '.load-fail-msg' ).length === 0 ) {\n\t\t\t\tnew LoadErrorMessage( { retryPath: self.router.getPath() } )\n\t\t\t\t\t.on( 'retry', self._handleRetry.bind( self ) )\n\t\t\t\t\t.prependTo( self.$( '.image' ) );\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Start image load transitions\n\t\t * @method\n\t\t * @ignore\n\t\t */\n\t\tfunction addImageLoadClass() {\n\t\t\t$img.addClass( 'image-loaded' );\n\t\t}\n\n\t\tif ( thumbs.length < 2 ) {\n\t\t\tthis._disableArrowImages();\n\t\t} else {\n\t\t\tthis._enableArrowImages( thumbs );\n\t\t}\n\n\t\tthis.$details = this.$( '.details' );\n\n\t\tOverlay.prototype.postRender.apply( this );\n\n\t\tthis.gateway.getThumb( self.options.title ).then( function ( data ) {\n\t\t\tvar author, url = data.descriptionurl + '#mw-jump-to-license';\n\n\t\t\tremoveLoader();\n\n\t\t\tself.thumbWidth = data.thumbwidth;\n\t\t\tself.thumbHeight = data.thumbheight;\n\t\t\tself.imgRatio = data.thumbwidth / data.thumbheight;\n\n\t\t\t// We need to explicitly specify document for context param as jQuery 3\n\t\t\t// will create a new document for the element if the context is\n\t\t\t// undefined. If element is appended to active document, event handlers\n\t\t\t// can fire in both the active document and new document which can cause\n\t\t\t// insidious bugs.\n\t\t\t// (https://api.jquery.com/jquery.parsehtml/#entry-longdesc)\n\t\t\t$img = self.parseHTML( '<img>', document );\n\n\t\t\t// Remove the loader when the image is loaded or display load fail\n\t\t\t// message on failure\n\t\t\t//\n\t\t\t// Error event handler must be attached before error occurs\n\t\t\t// (https://api.jquery.com/error/#entry-longdesc)\n\t\t\t//\n\t\t\t// For the load event, it is more unclear what happens cross-browser when\n\t\t\t// the image is loaded from cache. It seems that a .complete check is\n\t\t\t// needed if attaching the load event after setting the src.\n\t\t\t// (http://stackoverflow.com/questions/910727/jquery-event-for-images-loaded#comment10616132_1110094)\n\t\t\t//\n\t\t\t// However, perhaps .complete check is not needed if attaching load\n\t\t\t// event prior to setting the image src\n\t\t\t// (https://stackoverflow.com/questions/12354865/image-onload-event-and-browser-cache#answer-12355031)\n\t\t\t$img.on( 'load', addImageLoadClass ).on( 'error', showLoadFailMsg );\n\t\t\t$img.attr( 'src', data.thumburl ).attr( 'alt', self.options.caption );\n\t\t\tself.$( '.image' ).append( $img );\n\n\t\t\tself.$details.addClass( 'is-visible' );\n\t\t\tself._positionImage();\n\t\t\tself.$( '.details a' ).attr( 'href', url );\n\t\t\tif ( data.extmetadata ) {\n\t\t\t\t// Add license information\n\t\t\t\tif ( data.extmetadata.LicenseShortName ) {\n\t\t\t\t\tself.$( '.license a' )\n\t\t\t\t\t\t.text( data.extmetadata.LicenseShortName.value )\n\t\t\t\t\t\t.attr( 'href', url );\n\t\t\t\t}\n\t\t\t\t// Add author information\n\t\t\t\tif ( data.extmetadata.Artist ) {\n\t\t\t\t\t// Strip any tags\n\t\t\t\t\tauthor = data.extmetadata.Artist.value.replace( /<.*?>/g, '' );\n\t\t\t\t\tself.$( '.license' ).prepend( author + ' &bull; ' );\n\t\t\t\t}\n\t\t\t}\n\t\t\tself.adjustDetails();\n\t\t}, function () {\n\t\t\t// retrieving image location failed so show load fail msg\n\t\t\tshowLoadFailMsg();\n\t\t} );\n\n\t\tthis.eventBus.on( 'resize:throttled', this._positionImage.bind( this ) );\n\t},\n\n\t/**\n\t * Event handler that toggles the details bar.\n\t * @memberof ImageOverlay\n\t * @instance\n\t */\n\tonToggleDetails: function () {\n\t\tif ( !this.hasLoadError ) {\n\t\t\tthis.$( '.cancel, .slider-button' ).toggle();\n\t\t\tthis.$details.toggle();\n\t\t\tthis._positionImage();\n\t\t}\n\t},\n\n\t/**\n\t * fixme: remove this redundant function.\n\t * @memberof ImageOverlay\n\t * @instance\n\t * @param {Event} ev\n\t */\n\tonExitClick: function ( ev ) {\n\t\tOverlay.prototype.onExitClick.apply( this, arguments );\n\t\tthis.emit( ImageOverlay.EVENT_EXIT, ev );\n\t},\n\n\t/**\n\t * @inheritdoc\n\t * @memberof ImageOverlay\n\t * @instance\n\t */\n\tshow: function () {\n\t\tOverlay.prototype.show.apply( this, arguments );\n\t\tthis._positionImage();\n\t},\n\n\t/**\n\t * Fit the image into the window if its dimensions are bigger than the window dimensions.\n\t * Compare window width to height ratio to that of image width to height when setting\n\t * image width or height.\n\t * @memberof ImageOverlay\n\t * @instance\n\t * @private\n\t */\n\t_positionImage: function () {\n\t\tvar detailsHeight, windowWidth, windowHeight, windowRatio, $img,\n\t\t\t$window = util.getWindow();\n\n\t\tthis.adjustDetails();\n\t\t// with a hidden details box we have a little bit more space, we just need to use it\n\t\tdetailsHeight = !this.$details.is( ':visible' ) ? 0 : this.$details.outerHeight();\n\t\twindowWidth = $window.width();\n\t\twindowHeight = $window.height() - detailsHeight;\n\t\twindowRatio = windowWidth / windowHeight;\n\t\t$img = this.$( 'img' );\n\n\t\tif ( this.imgRatio > windowRatio ) {\n\t\t\tif ( windowWidth < this.thumbWidth ) {\n\t\t\t\t$img.css( {\n\t\t\t\t\twidth: windowWidth,\n\t\t\t\t\theight: 'auto'\n\t\t\t\t} );\n\t\t\t}\n\t\t} else {\n\t\t\tif ( windowHeight < this.thumbHeight ) {\n\t\t\t\t$img.css( {\n\t\t\t\t\twidth: 'auto',\n\t\t\t\t\theight: windowHeight\n\t\t\t\t} );\n\t\t\t}\n\t\t}\n\t\tthis.$( '.image-wrapper' ).css( 'bottom', detailsHeight );\n\t},\n\n\t/**\n\t * Function to adjust the height of details section to not more than 50% of window height.\n\t * @memberof ImageOverlay\n\t * @instance\n\t */\n\tadjustDetails: function () {\n\t\tvar windowHeight = util.getWindow().height();\n\t\tif ( this.$( '.details' ).height() > windowHeight * 0.50 ) {\n\t\t\tthis.$( '.details' ).css( 'max-height', windowHeight * 0.50 );\n\t\t}\n\t}\n} );\n\n/**\n * fixme: remove this redundant constant.\n * @memberof ImageOverlay\n * @event\n */\nImageOverlay.EVENT_EXIT = 'ImageOverlay-exit';\n/**\n * @memberof ImageOverlay\n * @event\n */\nImageOverlay.EVENT_SLIDE = 'ImageOverlay-slide';\n\nmodule.exports = ImageOverlay;\n","var util = require( './../mobile.startup/util' ),\n\tmfExtend = require( './../mobile.startup/mfExtend' ),\n\tIcon = require( './../mobile.startup/Icon' ),\n\tView = require( './../mobile.startup/View' );\n\n/**\n * Shows the user a load failure message\n * @class LoadErrorMessage\n * @extends View\n * @fires LoadErrorMessage#retry\n *\n * @param {Object} options Configuration options\n */\nfunction LoadErrorMessage( options ) {\n\tif ( !options.retryPath ) {\n\t\tthrow new Error( '\\'retryPath\\' must be set in options param. Received: ' + options.retryPath );\n\t}\n\tView.call(\n\t\tthis,\n\t\t{ events: { 'click .load-fail-msg-link a': 'onRetry' } },\n\t\toptions\n\t);\n}\n\nmfExtend( LoadErrorMessage, View, {\n\ttemplate: mw.template.get( 'mobile.mediaViewer', 'LoadErrorMessage.hogan' ),\n\tisTemplateMode: true,\n\n\t/**\n\t\t* @inheritdoc\n\t\t* @cfg {Object} defaults Default options hash.\n\t\t* @cfg {string} defaults.icon HTML of the alert icon\n\t\t* @cfg {string} defaults.msgToUser Message shown when media load fails\n\t\t* @cfg {string} defaults.retryTxt Text of retry link\n\t\t* @memberof LoadErrorMessage\n\t\t* @instance\n\t\t*/\n\tdefaults: util.extend( {}, LoadErrorMessage.prototype.defaults, {\n\t\ticon: new Icon( {\n\t\t\tname: 'alert-invert',\n\t\t\tadditionalClassNames: 'load-fail-msg-icon'\n\t\t} ).toHtmlString(),\n\t\tmsgToUser: mw.msg( 'mobile-frontend-media-load-fail-message' ),\n\t\tretryTxt: mw.msg( 'mobile-frontend-media-load-fail-retry' )\n\t} ),\n\n\t/**\n\t * @inheritdoc\n\t * @memberof LoadErrorMessage\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tthis.$( '.load-fail-msg-link a' ).attr( 'href', '#' + this.options.retryPath );\n\t},\n\n\t/**\n\t * Event handler for retry event\n\t * @param {jQuery.Event} ev\n\t * @return {boolean} Returns false to prevent default behavior for links and\n\t * stop the event from propagating\n\t * @memberof LoadErrorMessage\n\t * @instance\n\t */\n\tonRetry: function () {\n\t\t/**\n\t\t * Triggered when retry button is clicked.\n\t\t * @event LoadErrorMessage#retry\n\t\t */\n\t\tthis.emit( 'retry' );\n\n\t\treturn false;\n\t}\n} );\n\nmodule.exports = LoadErrorMessage;\n","/** @event */\nvar\n\tNEARBY_EVENT_POST_RENDER = 'Nearby-postRender',\n\tMessageBox = require( '../mobile.startup/MessageBox' ),\n\tNearbyGateway = require( './NearbyGateway' ),\n\tutil = require( '../mobile.startup/util' ),\n\tWatchstarPageList = require( '../mobile.startup/watchstar/WatchstarPageList.js' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' );\n\n/**\n * List of nearby pages\n * @class Nearby\n * @uses NearbyGateway\n * @extends WatchstarPageList\n *\n * @param {Object} options Configuration options\n * @param {OO.EventEmitter} options.eventBus Object used to emit Nearby-postRender events\n * @param {Function} [options.onItemClick] Callback invoked when a result is\n *                                         clicked. Defaults to nop.\n */\nfunction Nearby( options ) {\n\tvar self = this,\n\t\t_super = WatchstarPageList;\n\n\tthis.range = options.range || mw.config.get( 'wgMFNearbyRange' ) || 1000;\n\tthis.source = options.source || 'nearby';\n\tthis.nearbyApi = new NearbyGateway( {\n\t\tapi: options.api\n\t} );\n\tthis.eventBus = options.eventBus;\n\n\tif ( options.errorType ) {\n\t\toptions.errorOptions = self._errorOptions( options.errorType );\n\t}\n\n\tthis.onItemClick = options.onItemClick;\n\n\t_super.apply( this, arguments );\n}\n\nmfExtend( Nearby, WatchstarPageList, {\n\t/**\n\t * @memberof Nearby\n\t * @instance\n\t */\n\terrorMessages: {\n\t\tempty: {\n\t\t\theading: mw.msg( 'mobile-frontend-nearby-noresults' ),\n\t\t\thasHeading: true,\n\t\t\tmsg: mw.msg( 'mobile-frontend-nearby-noresults-guidance' )\n\t\t},\n\t\thttp: {\n\t\t\theading: mw.msg( 'mobile-frontend-nearby-error' ),\n\t\t\thasHeading: true,\n\t\t\tmsg: mw.msg( 'mobile-frontend-nearby-error-guidance' )\n\t\t},\n\t\tincompatible: {\n\t\t\theading: mw.msg( 'mobile-frontend-nearby-requirements' ),\n\t\t\thasHeading: true,\n\t\t\tmsg: mw.msg( 'mobile-frontend-nearby-requirements-guidance' )\n\t\t}\n\t},\n\t/**\n\t * @memberof Nearby\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, WatchstarPageList.prototype.templatePartials, {\n\t\tpageList: WatchstarPageList.prototype.template,\n\t\tmessageBox: MessageBox.prototype.template\n\t} ),\n\t/**\n\t * @memberof Nearby\n\t * @instance\n\t */\n\ttemplate: mw.template.get( 'mobile.special.nearby.scripts', 'Nearby.hogan' ),\n\t/**\n\t * @memberof Nearby\n\t * @instance\n\t * @mixes WatchstarPageList#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {mw.Api} defaults.api\n\t * @property {Object} defaults.errorOptions options to pass to a messagebox template\n\t * tells the user that their location is being looked up\n\t */\n\tdefaults: util.extend( {}, WatchstarPageList.prototype.defaults, {\n\t\terrorOptions: undefined\n\t} ),\n\t/**\n\t * Request pages from api based on provided options.\n\t * When options.longitude and options.latitude set getPages near that location.\n\t * If those are not present use options.title to find pages near that title.\n\t * If no valid options given resolve return object with error message.\n\t * @memberof Nearby\n\t * @instance\n\t * @param {Object} options Configuration options\n\t * @return {jQuery.Deferred}\n\t * @private\n\t */\n\t_find: function ( options ) {\n\t\tvar result = util.Deferred(),\n\t\t\tself = this;\n\n\t\t/**\n\t\t * Handler for successful query\n\t\t * @param {Array} pages as passed by then callback of Nearby##getPages\n\t\t */\n\t\tfunction pagesSuccess( pages ) {\n\t\t\toptions.pages = pages;\n\t\t\tif ( pages && pages.length === 0 ) {\n\t\t\t\toptions.errorOptions = self._errorOptions( 'empty' );\n\t\t\t}\n\t\t\tself._isLoading = false;\n\t\t\tresult.resolve( options );\n\t\t}\n\n\t\t/**\n\t\t * Handler for failed query\n\t\t *\n\t\t * @param {string} code Error Code\n\t\t */\n\t\tfunction pagesError( code ) {\n\t\t\tself._isLoading = false;\n\t\t\toptions.errorOptions = self._errorOptions( code );\n\t\t\tresult.resolve( options );\n\t\t}\n\n\t\tif ( options.latitude && options.longitude ) {\n\t\t\tthis.nearbyApi.getPages(\n\t\t\t\t{\n\t\t\t\t\tlatitude: options.latitude,\n\t\t\t\t\tlongitude: options.longitude\n\t\t\t\t},\n\t\t\t\tthis.range, options.exclude\n\t\t\t).then( pagesSuccess, pagesError );\n\t\t} else if ( options.pageTitle ) {\n\t\t\tthis.nearbyApi.getPagesAroundPage( options.pageTitle, this.range )\n\t\t\t\t.then( pagesSuccess, pagesError );\n\t\t} else {\n\t\t\tif ( options.errorType ) {\n\t\t\t\toptions.errorOptions = this._errorOptions( options.errorType );\n\t\t\t}\n\t\t\tresult.resolve( options );\n\t\t}\n\t\treturn result;\n\t},\n\t/**\n\t * Generate a list of options that can be passed to a messagebox template.\n\t * @memberof Nearby\n\t * @instance\n\t * @private\n\t * @param {string} key to a defined error message\n\t * @param {string} msg Message to use, instead of a mapped error message\n\t *  from this.errorMessages\n\t * @return {Object}\n\t */\n\t_errorOptions: function ( key ) {\n\t\tvar message = this.errorMessages[ key ] || this.errorMessages.http;\n\t\treturn util.extend( {\n\t\t\tclassName: 'errorbox'\n\t\t}, message );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof Nearby\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tvar self = this;\n\n\t\tif ( !this._isLoading ) {\n\t\t\tthis.$( '.page-list' ).removeClass( 'hidden' );\n\t\t}\n\t\tWatchstarPageList.prototype.postRender.apply( this );\n\t\tthis._postRenderLinks();\n\t\tthis.$( function () {\n\t\t\t// todo: use the local emitter when refresh() doesn't recreate the\n\t\t\t//       OO.EventEmitter by calling the super's constructor.\n\t\t\tself.eventBus.emit( NEARBY_EVENT_POST_RENDER );\n\t\t} );\n\t},\n\t/**\n\t * Hijack links to apply several customisations to them:\n\t * Ensure that when clicked they register an uploads funnel.\n\t * Ensure that when a user navigates back to the page their page position is restored using\n\t * fragment identifier trickery.\n\t * @private\n\t * @memberof Nearby\n\t * @instance\n\t */\n\t_postRenderLinks: function () {\n\t\tvar self = this;\n\t\tthis.$( 'a' ).each( function ( i ) {\n\t\t\t// FIXME: not unique if multiple Nearby objects on same page\n\t\t\tself.$( this ).attr( 'id', 'nearby-page-list-item-' + i );\n\t\t} ).on( 'click', this.onItemClick );\n\t},\n\t/**\n\t * Refresh the list of the nearby articles depending on the options.\n\t * The current location, latitude/longitude, or page title can be used\n\t * to find the articles.\n\t * @memberof Nearby\n\t * @instance\n\t * @param {Object} options Configuration options\n\t * @throws {Error} If Nearby has not been initialised correctly.\n\t * @return {jQuery.Deferred}\n\t */\n\trefresh: function ( options ) {\n\t\tvar self = this,\n\t\t\t_super = WatchstarPageList;\n\n\t\tthis.$( '.page-list' ).addClass( 'hidden' );\n\t\t// Run it once for loader etc\n\t\tthis._isLoading = true;\n\t\tif ( ( options.latitude && options.longitude ) || options.pageTitle ) {\n\t\t\t// Flush any existing list of pages\n\t\t\toptions.pages = [];\n\n\t\t\t// Get some new pages\n\t\t\treturn this._find( options ).then( function ( options ) {\n\t\t\t\t_super.call( self, options );\n\t\t\t}, function ( errorType ) {\n\t\t\t\toptions.errorOptions = self._errorOptions( errorType );\n\t\t\t\tself._isLoading = false;\n\t\t\t\t_super.call( self, options );\n\t\t\t} );\n\t\t} else {\n\t\t\tthrow new Error( 'No title or longitude, latitude options have been passed' );\n\t\t}\n\t}\n} );\n\nmodule.exports = Nearby;\n","var limit = 50,\n\tPage = require( '../mobile.startup/Page' ),\n\tns = mw.config.get( 'wgContentNamespaces' ),\n\tutil = require( '../mobile.startup/util' ),\n\textendSearchParams = require( '../mobile.startup/extendSearchParams' );\n\n/**\n * API for retrieving nearby pages\n * @class NearbyGateway\n * @param {Object} options Configuration options\n * @param {mw.Api} options.api\n */\nfunction NearbyGateway( options ) {\n\tthis.api = options.api;\n}\n\nNearbyGateway.prototype = {\n\t/**\n\t * Returns a human readable string stating the distance in meters or kilometers\n\t * depending on size.\n\t * @memberof NearbyGateway\n\t * @instance\n\t * @private\n\t * @param {number} d The distance in meters.\n\t * @return {string} message stating how far the user is from the point of interest.\n\t */\n\t_distanceMessage: function ( d ) {\n\t\tif ( d < 1 ) {\n\t\t\td *= 100;\n\t\t\td = Math.ceil( d ) * 10;\n\t\t\tif ( d === 1000 ) {\n\t\t\t\td = 1;\n\t\t\t} else {\n\t\t\t\treturn mw.msg( 'mobile-frontend-nearby-distance-meters', mw.language.convertNumber( d ) );\n\t\t\t}\n\t\t} else {\n\t\t\tif ( d > 2 ) {\n\t\t\t\td *= 10;\n\t\t\t\td = Math.ceil( d ) / 10;\n\t\t\t\td = d.toFixed( 1 );\n\t\t\t} else {\n\t\t\t\td *= 100;\n\t\t\t\td = Math.ceil( d ) / 100;\n\t\t\t\td = d.toFixed( 2 );\n\t\t\t}\n\t\t}\n\t\treturn mw.msg( 'mobile-frontend-nearby-distance', mw.language.convertNumber( d ) );\n\t},\n\t/**\n\t * Returns a list of pages around a given point\n\t * @memberof NearbyGateway\n\t * @instance\n\t * @param {Object} coords In form { latitude: 0, longitude: 2 }\n\t * @param {number} range Number of meters to perform a geosearch for\n\t * @param {string} exclude Name of a title to exclude from the list of results\n\t * @return {jQuery.Deferred} Object taking list of pages as argument\n\t */\n\tgetPages: function ( coords, range, exclude ) {\n\t\treturn this._search( {\n\t\t\tggscoord: [ coords.latitude, coords.longitude ]\n\t\t}, range, exclude );\n\t},\n\n\t/**\n\t * Gets the pages around a page. It excludes itself from the search\n\t * @memberof NearbyGateway\n\t * @instance\n\t * @param {string} page Page title like \"W_San_Francisco\"\n\t * @param {number} range Number of meters to perform a geosearch for\n\t * @return {jQuery.Deferred} Object taking list of pages as argument\n\t */\n\tgetPagesAroundPage: function ( page, range ) {\n\t\treturn this._search( {\n\t\t\tggspage: page\n\t\t}, range, page );\n\t},\n\n\t/**\n\t * Searches for pages nearby\n\t * @memberof NearbyGateway\n\t * @instance\n\t * @private\n\t * @param {Object} params Parameters to use for searching\n\t * @param {number} range Number of meters to perform a geosearch for\n\t * @param {string} exclude Name of a title to exclude from the list of results\n\t * @return {jQuery.Deferred} Object taking list of pages as argument\n\t */\n\t_search: function ( params, range, exclude ) {\n\t\tvar requestParams,\n\t\t\td = util.Deferred(),\n\t\t\tself = this;\n\n\t\trequestParams = extendSearchParams( 'nearby', {\n\t\t\tcolimit: 'max',\n\t\t\tprop: [ 'coordinates' ],\n\t\t\tgenerator: 'geosearch',\n\t\t\tggsradius: range,\n\t\t\tggsnamespace: ns,\n\t\t\tggslimit: limit\n\t\t}, params );\n\n\t\tif ( params.ggscoord ) {\n\t\t\trequestParams.codistancefrompoint = params.ggscoord;\n\t\t} else if ( params.ggspage ) {\n\t\t\trequestParams.codistancefrompage = params.ggspage;\n\t\t}\n\n\t\tthis.api.ajax( requestParams ).then( function ( resp ) {\n\t\t\tvar pages;\n\n\t\t\t// resp.query.pages is an Array<Page> instead of a map like in other\n\t\t\t// API requests\n\t\t\tif ( resp.query ) {\n\t\t\t\tpages = resp.query.pages || [];\n\t\t\t} else {\n\t\t\t\tpages = [];\n\t\t\t}\n\n\t\t\tpages = pages.map( function ( page, i ) {\n\t\t\t\tvar coords, p;\n\t\t\t\tp = Page.newFromJSON( page );\n\t\t\t\tp.anchor = 'item_' + i;\n\n\t\t\t\t// protect against declined bug T49133\n\t\t\t\tif ( page.coordinates ) {\n\t\t\t\t\tcoords = page.coordinates[0];\n\t\t\t\t\t// FIXME: Make part of the Page object\n\t\t\t\t\tp.dist = coords.dist / 1000;\n\t\t\t\t\tp.latitude = coords.lat;\n\t\t\t\t\tp.longitude = coords.lon;\n\t\t\t\t\tp.proximity = self._distanceMessage( p.dist );\n\t\t\t\t} else {\n\t\t\t\t\tp.dist = 0;\n\t\t\t\t}\n\t\t\t\tif ( exclude !== page.title ) {\n\t\t\t\t\treturn p;\n\t\t\t\t} else {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t} ).filter( function ( page ) { return !!page; } );\n\n\t\t\tpages.sort( function ( a, b ) {\n\t\t\t\treturn a.dist > b.dist ? 1 : -1;\n\t\t\t} );\n\t\t\td.resolve( pages );\n\t\t}, function ( error ) {\n\t\t\td.reject( error );\n\t\t} );\n\t\treturn d;\n\t}\n};\n\nmodule.exports = NearbyGateway;\n","var util = require( '../mobile.startup/util' );\n\n/**\n * API for retrieving gallery photos\n * @class PhotoListGateway\n *\n * @param {Object} options Configuration options\n * @param {mw.Api} options.api\n * @param {string} options.url for overriding default URI for API queries\n */\nfunction PhotoListGateway( options ) {\n\tthis.api = options.api;\n\tthis.url = options.url;\n\tthis.username = options.username;\n\tthis.category = options.category;\n\tthis.limit = 10;\n\tthis.continueParams = {\n\t\tcontinue: ''\n\t};\n\tthis.canContinue = true;\n}\n\n/**\n * Returns a description based on the file name using\n * a regular expression that strips the file type suffix,\n * namespace prefix and any\n * date suffix in format YYYY-MM-DD HH-MM\n * @memberof PhotoListGateway\n * @instance\n * @private\n * @param {string} title Title of file\n * @return {string} Description for file\n */\nfunction getDescription( title ) {\n\ttitle = title.replace( /\\.[^. ]+$/, '' ); // replace filename suffix\n\t// strip namespace: prefix and date suffix from remainder\n\treturn title.replace( /^[^:]*:/, '' )\n\t\t.replace( / \\d{4}-\\d{1,2}-\\d{1,2} \\d{1,2}-\\d{1,2}$/, '' );\n}\n\nPhotoListGateway.prototype = {\n\t/**\n\t * Returns the value in pixels of a medium thumbnail\n\t * @memberof PhotoListGateway\n\t * @instance\n\t * @return {number}\n\t */\n\tgetWidth: function () {\n\t\treturn mw.config.get( 'wgMFThumbnailSizes' ).small;\n\t},\n\t/**\n\t * Extracts image data from api response\n\t * @memberof PhotoListGateway\n\t * @instance\n\t * @private\n\t * @param {Object} page as returned by api request\n\t * @return {Object} describing image.\n\t */\n\t_getImageDataFromPage: function ( page ) {\n\t\tvar img = page.imageinfo[0];\n\t\treturn {\n\t\t\turl: img.thumburl,\n\t\t\ttitle: page.title,\n\t\t\ttimestamp: img.timestamp,\n\t\t\tdescription: getDescription( page.title ),\n\t\t\tdescriptionUrl: img.descriptionurl\n\t\t};\n\t},\n\t/**\n\t * Get the associated query needed to retrieve images from API based\n\t * on currently configured options.\n\t * @memberof PhotoListGateway\n\t * @instance\n\t * @return {Object}\n\t */\n\tgetQuery: function () {\n\t\tvar query = util.extend( {\n\t\t\taction: 'query',\n\t\t\tprop: 'imageinfo',\n\t\t\t// FIXME: [API] have to request timestamp since api returns an object\n\t\t\t// rather than an array thus we need a way to sort\n\t\t\tiiprop: 'url|timestamp',\n\t\t\tiiurlwidth: this.getWidth()\n\t\t}, this.continueParams );\n\n\t\tif ( this.username ) {\n\t\t\tutil.extend( query, {\n\t\t\t\tgenerator: 'allimages',\n\t\t\t\tgaiuser: this.username,\n\t\t\t\tgaisort: 'timestamp',\n\t\t\t\tgaidir: 'descending',\n\t\t\t\tgailimit: this.limit\n\t\t\t} );\n\t\t} else if ( this.category ) {\n\t\t\tutil.extend( query, {\n\t\t\t\tgenerator: 'categorymembers',\n\t\t\t\tgcmtitle: 'Category:' + this.category,\n\t\t\t\tgcmtype: 'file',\n\t\t\t\t// FIXME [API] a lot of duplication follows due to the silly way generators work\n\t\t\t\tgcmdir: 'descending',\n\t\t\t\tgcmlimit: this.limit\n\t\t\t} );\n\t\t}\n\n\t\tif ( this.url ) {\n\t\t\t// A foreign api is being accessed! Enable anonymous CORS queries!\n\t\t\tquery.origin = '*';\n\t\t}\n\t\treturn query;\n\t},\n\t/**\n\t * Request photos beginning with the current value of endTimestamp\n\t * @memberof PhotoListGateway\n\t * @instance\n\t * @return {jQuery.Deferred} where parameter is a list of JavaScript\n\t *  objects describing an image.\n\t */\n\tgetPhotos: function () {\n\t\tvar self = this;\n\n\t\treturn this.api.ajax( this.getQuery(), { url: this.url } ).then( function ( resp ) {\n\t\t\tvar photos = [];\n\t\t\tif ( resp.query && resp.query.pages ) {\n\t\t\t\t// FIXME: [API] in an ideal world imageData would be a sorted array\n\t\t\t\t// but it is a map of {[id]: page}\n\t\t\t\tphotos = Object.keys( resp.query.pages ).map( function ( id ) {\n\t\t\t\t\treturn self._getImageDataFromPage( resp.query.pages[id] );\n\t\t\t\t} ).sort( function ( a, b ) {\n\t\t\t\t\treturn a.timestamp < b.timestamp ? 1 : -1;\n\t\t\t\t} );\n\t\t\t}\n\n\t\t\tif ( resp.continue !== undefined ) {\n\t\t\t\tself.continueParams = resp.continue;\n\t\t\t} else {\n\t\t\t\tself.canContinue = false;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tcanContinue: self.canContinue,\n\t\t\t\t// FIXME: Should reply with a list of PhotoItem or Photo classes.\n\t\t\t\tphotos: photos\n\t\t\t};\n\t\t} );\n\t}\n};\n\nPhotoListGateway.test = {\n\tgetDescription: getDescription\n};\n\nmodule.exports = PhotoListGateway;\n","var\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tPageList = require( '../mobile.startup/PageList' ),\n\tWatchstarPageList = require( '../mobile.startup/watchstar/WatchstarPageList' ),\n\tScrollEndEventEmitter = require( '../mobile.startup/ScrollEndEventEmitter' ),\n\tutil = require( '../mobile.startup/util' ),\n\tWatchListGateway = require( './WatchListGateway' );\n\n/**\n * An extension of the WatchstarPageList which preloads pages as all being\n * watched.\n * @extends WatchstarPageList\n * @class WatchList\n * @uses ScrollEndEventEmitter\n *\n * @fires watched\n * @fires watch\n * @param {Object} params Configuration options\n * @param {OO.EventEmitter} params.eventBus Object used to listen for scroll:throttled events\n */\nfunction WatchList( params ) {\n\tvar lastTitle,\n\t\toptions = util.extend( {}, {\n\t\t\tisBorderBox: false\n\t\t}, params );\n\n\t// Set up infinite scroll helper and listen to events\n\tthis.scrollEndEventEmitter = new ScrollEndEventEmitter( options.eventBus );\n\tthis.scrollEndEventEmitter.on( ScrollEndEventEmitter.EVENT_SCROLL_END,\n\t\tthis._loadPages.bind( this ) );\n\n\tif ( options.el ) {\n\t\tlastTitle = this.getLastTitle( options.el );\n\t}\n\tthis.gateway = new WatchListGateway( options.api, lastTitle );\n\n\tWatchstarPageList.call( this, options );\n}\n\nmfExtend( WatchList, WatchstarPageList, {\n\t/**\n\t * @inheritdoc\n\t * @memberof WatchList\n\t * @instance\n\t */\n\tpreRender: function () {\n\t\t// The DOM will be modified. Prevent any false scroll end events from\n\t\t// being emitted.\n\t\tthis.scrollEndEventEmitter.disable();\n\t\tthis.scrollEndEventEmitter.setElement( this.$el );\n\t},\n\t/**\n\t * Also sets a watch uploads funnel.\n\t * @inheritdoc\n\t * @memberof WatchList\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tvar\n\t\t\t$items,\n\t\t\tstatuses;\n\n\t\t// Skip a level from WatchstarPageList directly to PageList.\n\t\tPageList.prototype.postRender.apply( this );\n\n\t\t$items = this.queryUnitializedItems();\n\n\t\t// WatchList requests list of watched pages. The list contains only\n\t\t// watched pages so it's safe to transform the title map to a status map\n\t\t// with each entry marked watched (true).\n\t\tstatuses = Object.keys( this.parsePagesFromItems( $items ) )\n\t\t\t.reduce( function ( statuses, title ) {\n\t\t\t\tstatuses[ title ] = true;\n\t\t\t\treturn statuses;\n\t\t\t}, {} );\n\t\tthis.renderItems( $items, statuses );\n\n\t\t// The list has been extended. Re-enable scroll end events.\n\t\tthis.scrollEndEventEmitter.enable();\n\t},\n\n\t/**\n\t * Loads pages from the api and triggers render.\n\t * Infinite scroll is re-enabled in postRender.\n\t * @memberof WatchList\n\t * @instance\n\t */\n\t_loadPages: function () {\n\t\tthis.gateway.loadWatchlist().then( function ( pages ) {\n\t\t\tpages.forEach( function ( page ) {\n\t\t\t\tthis.appendPage( page );\n\t\t\t}.bind( this ) );\n\t\t\tthis.render();\n\t\t}.bind( this ) );\n\t},\n\n\t/**\n\t * Appends a list item\n\t * @memberof WatchList\n\t * @instance\n\t * @param {Page} page\n\t */\n\tappendPage: function ( page ) {\n\t\t// wikidata descriptions should not show in this view.\n\t\tvar templateOptions = util.extend( {}, page.options, {\n\t\t\twikidataDescription: undefined\n\t\t} );\n\t\tthis.$el.append( this.templatePartials.item.render( templateOptions ) );\n\t},\n\n\t/**\n\t * Get the last title from the rendered HTML.\n\t * Used for initializing the API\n\t * @memberof WatchList\n\t * @instance\n\t * @param {jQuery.Object} $el Dom element of the list\n\t * @return {string}\n\t */\n\tgetLastTitle: function ( $el ) {\n\t\treturn $el.find( 'li:last' ).attr( 'title' );\n\t}\n} );\n\nmodule.exports = WatchList;\n","var Page = require( '../mobile.startup/Page' ),\n\tutil = require( '../mobile.startup/util' ),\n\textendSearchParams = require( '../mobile.startup/extendSearchParams' );\n\n/**\n * @class WatchListGateway\n * @param {mw.Api} api\n * @param {string} lastTitle of page listed in Watchlist to be used as a continuation parameter\n */\nfunction WatchListGateway( api, lastTitle ) {\n\tthis.api = api;\n\t// Try to keep it in sync with SpecialMobileWatchlist::LIMIT (php)\n\tthis.limit = 50;\n\n\tif ( lastTitle ) {\n\t\tthis.continueParams = {\n\t\t\tcontinue: 'gwrcontinue||',\n\t\t\tgwrcontinue: '0|' + lastTitle.replace( / /g, '_' )\n\t\t};\n\t\tthis.shouldSkipFirstTitle = true;\n\t} else {\n\t\tthis.continueParams = {\n\t\t\tcontinue: ''\n\t\t};\n\t\tthis.shouldSkipFirstTitle = false;\n\t}\n\n\tthis.canContinue = true;\n}\n\nWatchListGateway.prototype = {\n\t/**\n\t * Load the list of items on the watchlist\n\t * @return {jQuery.Deferred}\n\t */\n\tloadWatchlist: function () {\n\t\tvar self = this,\n\t\t\tparams = extendSearchParams( 'watchlist', {\n\t\t\t\tprop: [ 'info', 'revisions' ],\n\t\t\t\trvprop: 'timestamp|user',\n\t\t\t\tgenerator: 'watchlistraw',\n\t\t\t\tgwrnamespace: '0',\n\t\t\t\tgwrlimit: this.limit\n\t\t\t}, this.continueParams );\n\n\t\tif ( this.canContinue === false ) {\n\t\t\treturn util.Deferred().resolve( [] );\n\t\t}\n\t\treturn this.api.get( params, {\n\t\t\turl: this.apiUrl\n\t\t} ).then( function ( data ) {\n\t\t\tif ( data.continue !== undefined ) {\n\t\t\t\tself.continueParams = data.continue;\n\t\t\t} else {\n\t\t\t\tself.canContinue = false;\n\t\t\t}\n\n\t\t\treturn self.parseData( data );\n\t\t} );\n\t},\n\n\t/**\n\t * Parse api response data into pagelist item format\n\t * @param {Object[]} data\n\t * @return {Page[]}\n\t */\n\tparseData: function ( data ) {\n\t\tvar pages;\n\n\t\tif ( !data.query || !data.query.pages ) {\n\t\t\treturn [];\n\t\t}\n\n\t\tpages = data.query.pages;\n\n\t\t// Sort results alphabetically (the api map doesn't have any order). The\n\t\t// watchlist is ordered alphabetically right now.\n\t\tpages.sort( function ( p1, p2 ) {\n\t\t\treturn p1.title === p2.title ? 0 : ( p1.title < p2.title ? -1 : 1 );\n\t\t} );\n\n\t\t// If we requested from the last item of the previous page, we shall\n\t\t// remove the first result (to avoid it being repeated)\n\t\tif ( this.shouldSkipFirstTitle ) {\n\t\t\tpages = pages.slice( 1 );\n\t\t\tthis.shouldSkipFirstTitle = false;\n\t\t}\n\n\t\t// Transform the items to a sensible format\n\t\treturn pages.map( Page.newFromJSON );\n\t}\n\n};\n\nmodule.exports = WatchListGateway;\n","var\n\tView = require( './View' ),\n\tmfExtend = require( './mfExtend' );\n\n/**\n * A wrapper for creating an anchor.\n * @class Anchor\n * @extends View\n */\nfunction Anchor() {\n\tView.apply( this, arguments );\n}\n\nmfExtend( Anchor, View, {\n\t/**\n\t * @inheritdoc\n\t * @memberof Anchor\n\t * @instance\n\t */\n\tisTemplateMode: true,\n\t/**\n\t * @memberof Anchor\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {boolean} defaults.progressive is progressive action\n\t * @property {boolean} defaults.destructive is destructive action\n\t * @property {string} defaults.additionalClassNames Additional class name(s).\n\t * @property {string} defaults.href url\n\t * @property {string} defaults.label of anchor\n\t */\n\tdefaults: {\n\t\tprogressive: undefined,\n\t\tdestructive: undefined,\n\t\tadditionalClassNames: '',\n\t\thref: undefined,\n\t\tlabel: undefined\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof Anchor\n\t * @instance\n\t */\n\ttemplate: mw.template.get( 'mobile.startup', 'anchor.hogan' )\n} );\n\nmodule.exports = Anchor;\n","var\n\tutil = require( './util' ),\n\tbrowser;\n\n/**\n * Memoize a class method. Caches the result of the method based on the\n * arguments. Instances do not share a cache.\n * @param {Function} method Method to be memoized\n * @return {Function}\n */\nfunction memoize( method ) {\n\t/**\n\t * Memoized version of the method\n\t * @return {Function}\n\t */\n\tvar memoized = function () {\n\t\tvar cache = this[ '__cache' + memoized.cacheId ] ||\n\t\t\t( this[ '__cache' + memoized.cacheId ] = {} ),\n\t\t\tkey = [].join.call( arguments, '|' );\n\t\tif ( Object.prototype.hasOwnProperty.call( cache, key ) ) {\n\t\t\treturn cache[ key ];\n\t\t}\n\t\treturn ( cache[ key ] = method.apply( this, arguments ) );\n\t};\n\tmemoized.cacheId = Date.now().toString() + Math.random().toString();\n\treturn memoized;\n}\n\n/**\n * Representation of user's current browser\n * @class Browser\n * @param {string} ua the user agent of the current browser\n * @param {jQuery.Object} $container an element to associate with the Browser object\n */\nfunction Browser( ua, $container ) {\n\tthis.userAgent = ua;\n\tthis.$el = $container;\n\tthis._fixIosLandscapeBug();\n}\n\nBrowser.prototype = {\n\t/**\n\t * When rotating to landscape stop page zooming on ios 4 and 5.\n\t * @memberof Browser\n\t * @instance\n\t * @private\n\t */\n\t_fixIosLandscapeBug: function () {\n\t\tvar self = this,\n\t\t\tviewport = this.$el.find( 'meta[name=\"viewport\"]' )[0];\n\n\t\t// see http://adactio.com/journal/4470/ (fixed in ios 6)\n\t\tif ( viewport && ( this.isIos( 4 ) || this.isIos( 5 ) ) ) {\n\t\t\tthis.lockViewport();\n\t\t\tdocument.addEventListener( 'gesturestart', function () {\n\t\t\t\tself.lockViewport();\n\t\t\t}, false );\n\t\t}\n\t},\n\t/**\n\t * Returns whether the current browser is an ios device.\n\t * FIXME: jquery.client does not support iPad detection so we cannot use it.\n\t * @memberof Browser\n\t * @instance\n\t * @param {number} [version] integer describing a specific version you want to test against.\n\t * @return {boolean}\n\t */\n\tisIos: memoize( function ( version ) {\n\t\tvar ua = this.userAgent,\n\t\t\tios = /ipad|iphone|ipod/i.test( ua );\n\n\t\tif ( ios && version ) {\n\t\t\tswitch ( version ) {\n\t\t\t\tcase 8:\n\t\t\t\t\t// Test UA for iOS8. Or for simulator look for Version 8\n\t\t\t\t\t// In the iOS simulator the OS is the host machine OS version\n\t\t\t\t\t// This makes testing in iOS8 simulator work as expected\n\t\t\t\t\treturn /OS 8_/.test( ua ) || /Version\\/8/.test( ua );\n\t\t\t\tcase 4:\n\t\t\t\t\treturn /OS 4_/.test( ua );\n\t\t\t\tcase 5:\n\t\t\t\t\treturn /OS 5_/.test( ua );\n\t\t\t\tdefault:\n\t\t\t\t\treturn false;\n\t\t\t}\n\t\t} else {\n\t\t\treturn ios;\n\t\t}\n\t} ),\n\t/**\n\t * Locks the viewport so that pinch zooming is disabled\n\t * @memberof Browser\n\t * @instance\n\t */\n\tlockViewport: function () {\n\t\tif ( this.$el ) {\n\t\t\tthis.$el.find( 'meta[name=\"viewport\"]' )\n\t\t\t\t.attr( 'content', 'initial-scale=1.0, maximum-scale=1.0, user-scalable=no' );\n\t\t}\n\t},\n\t/**\n\t * Determine if a device has a widescreen.\n\t * @memberof Browser\n\t * @instance\n\t * @return {boolean}\n\t */\n\tisWideScreen: memoize( function () {\n\t\tvar val = parseInt( mw.config.get( 'wgMFDeviceWidthTablet' ), 10 );\n\t\t// Check portrait and landscape mode to be consistent\n\t\treturn window.innerWidth >= val || window.innerHeight >= val;\n\t} ),\n\t/**\n\t * Checks browser support for CSS transforms, transitions\n\t * and CSS animation.\n\t * Currently assumes support for the latter 2 in the case of the\n\t * former.\n\t * See http://stackoverflow.com/a/12621264/365238\n\t * @memberof Browser\n\t * @instance\n\t * @return {boolean}\n\t */\n\tsupportsAnimations: memoize( function () {\n\t\tvar elemStyle = document.createElement( 'foo' ).style;\n\t\tfunction supportsProperty( property ) {\n\t\t\t// We only test \"webkit-\", because that's the only prefix needed for the relevant\n\t\t\t// properties (in supportsAnimations) and supported browsers. If usage is expanded,\n\t\t\t// other prefixes may need to be checked as well.\n\t\t\treturn property in elemStyle ||\n\t\t\t\t( 'webkit' + property[ 0 ].toUpperCase() + property.slice( 1 ) ) in elemStyle;\n\t\t}\n\t\treturn supportsProperty( 'animationName' ) &&\n\t\t\tsupportsProperty( 'transform' ) &&\n\t\t\tsupportsProperty( 'transition' );\n\t} ),\n\t/**\n\t * Whether touchstart and other touch events are supported by the current browser.\n\t * @memberof Browser\n\t * @instance\n\t * @return {boolean}\n\t */\n\tsupportsTouchEvents: memoize( function () {\n\t\treturn 'ontouchstart' in window;\n\t} ),\n\t/**\n\t * Detect if browser supports geolocation\n\t * @memberof Browser\n\t * @instance\n\t * @return {boolean}\n\t */\n\tsupportsGeoLocation: memoize( function () {\n\t\treturn 'geolocation' in window.navigator;\n\t} )\n};\n\n/**\n * @memberof Browser\n * @return {Browser}\n */\nBrowser.getSingleton = function () {\n\tvar $html;\n\tif ( !browser ) {\n\t\t$html = util.getDocument();\n\t\tbrowser = new Browser( window.navigator.userAgent, $html );\n\t}\n\treturn browser;\n};\n\nmodule.exports = Browser;\n","var\n\tmfExtend = require( './mfExtend' ),\n\tView = require( './View' );\n\n/**\n * A wrapper for creating a button.\n * @class Button\n * @extends View\n *\n * @param {Object} options Configuration options\n */\nfunction Button( options ) {\n\tif ( options.href ) {\n\t\toptions.tagName = 'a';\n\t}\n\tView.call( this, options );\n}\n\nmfExtend( Button, View, {\n\t/**\n\t * @inheritdoc\n\t * @memberof Button\n\t * @instance\n\t */\n\tisTemplateMode: true,\n\t/**\n\t * @memberof Button\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} defaults.tagName The name of the tag in which the button is wrapped.\n\t * @property {boolean} defaults.block is stacked button\n\t * @property {boolean} defaults.progressive is progressive action\n\t *   This option is deprecated. Please use `progressive`.\n\t * @property {boolean} defaults.quiet is quiet button\n\t * @property {boolean} defaults.destructive is destructive action\n\t * @property {string} defaults.additionalClassNames Additional class name(s).\n\t * @property {string} defaults.href url\n\t * @property {string} defaults.label of button\n\t */\n\tdefaults: {\n\t\ttagName: 'a',\n\t\tblock: undefined,\n\t\tprogressive: undefined,\n\t\tdestructive: undefined,\n\t\tquiet: undefined,\n\t\tadditionalClassNames: '',\n\t\thref: undefined,\n\t\tlabel: undefined\n\t},\n\t/**\n\t * @memberof Button\n\t * @instance\n\t */\n\ttemplate: mw.template.get( 'mobile.startup', 'button.hogan' )\n} );\n\nmodule.exports = Button;\n","var\n\tmfExtend = require( './mfExtend' ),\n\tDrawer = require( './Drawer' ),\n\tutil = require( './util' ),\n\tButton = require( './Button' ),\n\tAnchor = require( './Anchor' );\n\n/**\n * @typedef {string|number|boolean|undefined} QueryVal\n * @typedef {Object.<string, QueryVal|QueryVal[]>} QueryParams\n *\n * @typedef {Object} Options\n * @prop {string} [returnTo]\n * @prop {QueryParams} [queryParams]\n * @prop {QueryParams} [signupQueryParams]\n * @prop {Object} [options.progressiveButton] template options for Button element for signing in\n * @prop {Object} [options.actionAnchor] template options for Anchor element for signing up\n */\n\n/**\n * This creates the drawer at the bottom of the screen that appears when an anonymous\n * user tries to perform an action that requires being logged in. It presents the user\n * with options to log in or sign up for a new account.\n * @class CtaDrawer\n * @extends Drawer\n * @uses Button\n * @uses Icon\n * @uses Anchor\n * @param {Options} options\n */\nfunction CtaDrawer( options ) {\n\tDrawer.call( this,\n\t\tutil.extend( {}, Drawer.prototype.defaults, {\n\t\t\tprogressiveButton: new Button( {\n\t\t\t\tprogressive: true,\n\t\t\t\tlabel: mw.msg( 'mobile-frontend-watchlist-cta-button-login' )\n\t\t\t} ).options,\n\t\t\tactionAnchor: new Anchor( {\n\t\t\t\tprogressive: true,\n\t\t\t\tlabel: mw.msg( 'mobile-frontend-watchlist-cta-button-signup' )\n\t\t\t} ).options\n\t\t}, options )\n\t);\n}\n\nmfExtend( CtaDrawer, Drawer, {\n\t/**\n\t * @memberof CtaDrawer\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, Drawer.prototype.templatePartials, {\n\t\tbutton: Button.prototype.template,\n\t\tanchor: Anchor.prototype.template\n\t} ),\n\t/**\n\t\t * @memberof CtaDrawer\n\t\t * @instance\n\t\t */\n\ttemplate: mw.template.get( 'mobile.startup', 'CtaDrawer.hogan' ),\n\t/**\n\t\t * @inheritdoc\n\t\t * @memberof CtaDrawer\n\t\t * @instance\n\t\t */\n\tpreRender: function () {\n\t\tvar params = redirectParams( this.options.queryParams, this.options.returnTo );\n\n\t\t// Give the button and the anchor a default target, if it isn't set already. Buttons are\n\t\t// customized by Minerva's red link drawer, skins.minerva.scripts/init.js.\n\t\tif ( !this.options.progressiveButton.href ) {\n\t\t\tthis.options.progressiveButton.href = mw.util.getUrl( 'Special:UserLogin', params );\n\t\t}\n\t\tif ( !this.options.actionAnchor.href ) {\n\t\t\tthis.options.actionAnchor.href = mw.util.getUrl(\n\t\t\t\t'Special:UserLogin', signUpParams( params, this.options.signupQueryParams )\n\t\t\t);\n\t\t}\n\t}\n} );\n\n/**\n * Special:UserLogin post-request redirect query parameters.\n * @param {QueryParams} params\n * @param {string} [redirectURL]\n * @return {QueryParams}\n */\nfunction redirectParams( params, redirectURL ) {\n\treturn util.extend( {\n\t\t// use wgPageName as this includes the namespace if outside Main\n\t\treturnto: redirectURL || mw.config.get( 'wgPageName' )\n\t}, params );\n}\n\n/**\n * Special:UserLogin account creation query parameters.\n * @param {...QueryParams} params\n * @return {QueryParams}\n */\nfunction signUpParams() {\n\t[].push.call( arguments, { type: 'signup' } );\n\treturn util.extend.apply( util, arguments );\n}\n\nCtaDrawer.prototype.test = {\n\tredirectParams: redirectParams,\n\tsignUpParams: signUpParams\n};\n\nmodule.exports = CtaDrawer;\n","var\n\tmfExtend = require( './mfExtend' ),\n\tPanel = require( './Panel' ),\n\tutil = require( './util' ),\n\tIcon = require( './Icon' );\n\n/**\n * A {@link View} that pops up from the bottom of the screen.\n * @class Drawer\n * @extends Panel\n * @param {Object} [props]\n */\nfunction Drawer( props ) {\n\tPanel.call( this,\n\t\tutil.extend(\n\t\t\t{ className: 'drawer position-fixed' },\n\t\t\tprops,\n\t\t\t{ events: util.extend( { click: 'stopPropagation' }, ( props || {} ).events ) }\n\t\t)\n\t);\n}\n\nmfExtend( Drawer, Panel, {\n\t/**\n\t * @memberof Drawer\n\t * @instance\n\t * @mixes Panel#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} defaults.cancelButton HTML of the button that closes the drawer.\n\t */\n\tdefaults: util.extend( {}, Panel.prototype.defaults, {\n\t\t// Used by CtaDrawer, BlockMessage.\n\t\tcollapseIcon: new Icon( {\n\t\t\tname: 'arrow',\n\t\t\tadditionalClassNames: 'cancel'\n\t\t} ).options\n\t} ),\n\t/**\n\t * @memberof Drawer\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, Panel.prototype.templatePartials, {\n\t\ticon: Icon.prototype.template\n\t} ),\n\t/**\n\t * Defines an element that the Drawer should automatically be appended to.\n\t * @memberof Drawer\n\t * @instance\n\t * @property {string}\n\t */\n\tappendToElement: 'body',\n\t/**\n\t * Whether the drawer should disappear on a scroll event\n\t * @memberof Drawer\n\t * @instance\n\t * @property {boolean}\n\t */\n\tcloseOnScroll: true,\n\n\t/**\n\t * @inheritdoc\n\t * @memberof Drawer\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tvar self = this;\n\t\t// This module might be loaded at the top of the page e.g. Special:Uploads\n\t\t// Thus ensure we wait for the DOM to be loaded\n\t\tutil.docReady( function () {\n\t\t\tself.appendTo( self.appendToElement );\n\t\t\tself.$el.parent().addClass( 'has-drawer' );\n\t\t} );\n\t\tthis.on( 'show', this.onShowDrawer.bind( this ) );\n\t\tthis.on( 'hide', this.onHideDrawer.bind( this ) );\n\t},\n\t/**\n\t * Stop Propagation event handler\n\t * @memberof Drawer\n\t * @instance\n\t * @param {Object} ev event object\n\t * Allow the drawer itself to be clickable (e.g. for copying and pasting references\n\t * clicking links in reference)\n\t */\n\tstopPropagation: function ( ev ) {\n\t\tev.stopPropagation();\n\t},\n\n\t/**\n\t * ShowDrawer event handler\n\t * @memberof Drawer\n\t * @instance\n\t */\n\tonShowDrawer: function () {\n\t\tvar self = this;\n\n\t\tthis.$el.parent().addClass( 'drawer-visible' );\n\n\t\tsetTimeout( function () {\n\t\t\tvar $window = util.getWindow();\n\t\t\t$window.one( 'click.drawer', self.hide.bind( self ) );\n\t\t\tif ( self.closeOnScroll ) {\n\t\t\t\t$window.one( 'scroll.drawer', self.hide.bind( self ) );\n\t\t\t}\n\t\t}, self.minHideDelay );\n\t},\n\n\t/**\n\t * HideDrawer event handler\n\t * @memberof Drawer\n\t * @instance\n\t */\n\tonHideDrawer: function () {\n\t\tthis.$el.parent().removeClass( 'drawer-visible' );\n\t\t// .one() registers one callback for scroll and click independently\n\t\t// if one fired, get rid of the other one\n\t\tutil.getWindow().off( '.drawer' );\n\t}\n} );\n\nmodule.exports = Drawer;\n","var\n\tmfExtend = require( './mfExtend' ),\n\tView = require( './View' );\n\n/**\n * A wrapper for creating an icon.\n * @class Icon\n * @extends View\n *\n * @param {Object} options Configuration options\n */\nfunction Icon( options ) {\n\tif ( options.hasText ) {\n\t\toptions.modifier = 'mw-ui-icon-before';\n\t}\n\tif ( options.href ) {\n\t\toptions.tagName = 'a';\n\t}\n\tView.call( this, options );\n}\n\nmfExtend( Icon, View, {\n\t/**\n\t * @inheritdoc\n\t * @memberof Icon\n\t * @instance\n\t */\n\tpreRender: function () {\n\t\tthis.setRotationClass();\n\t},\n\t/**\n\t * Internal method that sets the correct rotation class for the icon\n\t * based on the value of rotation\n\t * @memberof Icon\n\t * @instance\n\t * @private\n\t */\n\tsetRotationClass: function () {\n\t\tvar options = this.options;\n\t\tif ( options.rotation ) {\n\t\t\tswitch ( options.rotation ) {\n\t\t\t\tcase -180:\n\t\t\t\tcase 180:\n\t\t\t\t\toptions._rotationClass = 'mf-mw-ui-icon-rotate-flip';\n\t\t\t\t\tbreak;\n\t\t\t\tcase -90:\n\t\t\t\t\toptions._rotationClass = 'mf-mw-ui-icon-rotate-anti-clockwise';\n\t\t\t\t\tbreak;\n\t\t\t\tcase 90:\n\t\t\t\t\toptions._rotationClass = 'mf-mw-ui-icon-rotate-clockwise';\n\t\t\t\t\tbreak;\n\t\t\t\tcase 0:\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error( 'Bad value for rotation given. Must be 90, 0 or 180.' );\n\t\t\t}\n\t\t}\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof Icon\n\t * @instance\n\t */\n\tisTemplateMode: true,\n\t/**\n\t * @memberof Icon\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {boolean} defaults.hasText Whether the icon has text.\n\t * @property {boolean} defaults.isSmall Whether the icon should be small.\n\t * @property {string} [defaults.href] value of href attribute,\n\t *  when set tagName will default to anchor tag\n\t * @property {string} defaults.tagName The name of the tag in which the icon is wrapped.\n\t *  Defaults to 'a' when href option present.\n\t * @property {string} defaults.base String used as a base for generating class names.\n\t * Defaults to 'mw-ui-icon'.\n\t * @property {string} defaults.name Name of the icon.\n\t * @property {string} defaults.modifier Additional class name.\n\t * Defaults to 'mw-ui-icon-element'.\n\t * @property {string} defaults.title Tooltip text.\n\t * @property {boolean} defaults.rotation will rotate the icon by a certain number\n\t *  of degrees.\n\t *  Must be 90, 0 or 180 or will throw exception.\n\t */\n\tdefaults: {\n\t\trotation: 0,\n\t\thasText: false,\n\t\thref: undefined,\n\t\tglyphPrefix: 'mf',\n\t\ttagName: 'div',\n\t\tisSmall: false,\n\t\tbase: 'mw-ui-icon',\n\t\tname: '',\n\t\tmodifier: 'mw-ui-icon-element',\n\t\ttitle: ''\n\t},\n\t/**\n\t * Return the full class name that is required for the icon to render\n\t * @memberof Icon\n\t * @instance\n\t * @return {string}\n\t */\n\tgetClassName: function () {\n\t\treturn this.$el.attr( 'class' );\n\t},\n\t/**\n\t * Return the class that relates to the icon glyph\n\t * @memberof Icon\n\t * @instance\n\t * @return {string}\n\t */\n\tgetGlyphClassName: function () {\n\t\treturn this.options.base + '-' + this.options.glyphPrefix + '-' + this.options.name;\n\t},\n\t/**\n\t * Return the HTML representation of this view\n\t * @memberof Icon\n\t * @instance\n\t * @return {string}\n\t */\n\ttoHtmlString: function () {\n\t\treturn this.parseHTML( '<div>' ).append( this.$el ).html();\n\t},\n\ttemplate: mw.template.get( 'mobile.startup', 'icon.hogan' )\n} );\n\nmodule.exports = Icon;\n","var\n\tView = require( './View' ),\n\tmfExtend = require( './mfExtend' );\n\n/**\n * @class MessageBox\n * @extends View\n */\nfunction MessageBox() {\n\tView.apply( this, arguments );\n}\n\nmfExtend( MessageBox, View, {\n\t/**\n\t * @inheritdoc\n\t * @memberof MessageBox\n\t * @instance\n\t */\n\tisTemplateMode: true,\n\t/**\n\t * @memberof MessageBox\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} [defaults.heading] heading to show along with message (text)\n\t * @property {string} defaults.msg message to show (html)\n\t * @property {string} defaults.className either errorbox, warningbox or successbox\n\t */\n\tdefaults: {},\n\t/**\n\t * @memberof MessageBox\n\t * @instance\n\t */\n\ttemplate: mw.template.get( 'mobile.startup', 'MessageBox.hogan' )\n} );\n\nmodule.exports = MessageBox;\n","var\n\tView = require( './View' ),\n\tIcon = require( './Icon' ),\n\tButton = require( './Button' ),\n\tAnchor = require( './Anchor' ),\n\ticons = require( './icons' ),\n\tutil = require( './util' ),\n\tbrowser = require( './Browser' ).getSingleton(),\n\tmfExtend = require( './mfExtend' ),\n\ttestPassiveOpts, supportsPassive, passiveOpts;\n\n// Detect browser support for the 'passive' event option.\n// https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener#Safely_detecting_option_support\ntry {\n\tsupportsPassive = false;\n\ttestPassiveOpts = Object.defineProperty( {}, 'passive', {\n\t\tget: function () {\n\t\t\tsupportsPassive = true;\n\t\t\treturn true;\n\t\t}\n\t} );\n\twindow.addEventListener( 'testPassive', null, testPassiveOpts );\n\twindow.removeEventListener( 'testPassive', null, testPassiveOpts );\n\tpassiveOpts = supportsPassive ? { passive: false } : false;\n} catch ( e ) {}\n\n/**\n * Mobile modal window\n * @class Overlay\n * @extends View\n * @uses Icon\n * @uses Button\n * @fires Overlay#Overlay-exit\n * @fires Overlay#hide\n * @param {Object} props\n * @param {Object} props.events - custom events to be bound to the overlay.\n * @param {boolean} props.noHeader renders an overlay without a header\n */\nfunction Overlay( props ) {\n\tthis.isIos = browser.isIos();\n\t// Set to true when overlay has failed to load\n\tthis.hasLoadError = false;\n\n\tView.call(\n\t\tthis,\n\t\tutil.extend(\n\t\t\t{ className: 'overlay' },\n\t\t\tprops,\n\t\t\t{\n\t\t\t\tevents: util.extend(\n\t\t\t\t\t{\n\t\t\t\t\t\t// FIXME: Remove .initial-header selector\n\t\t\t\t\t\t'click .cancel, .confirm, .initial-header .back': 'onExitClick',\n\t\t\t\t\t\tclick: 'stopPropagation'\n\t\t\t\t\t},\n\t\t\t\t\tprops.events\n\t\t\t\t)\n\t\t\t}\n\t\t)\n\t);\n}\n\nmfExtend( Overlay, View, {\n\t/**\n\t * Identify whether the element contains position fixed elements\n\t * @memberof Overlay\n\t * @instance\n\t * @property {boolean}\n\t */\n\thasFixedHeader: true,\n\t/**\n\t * Is overlay fullscreen\n\t * @memberof Overlay\n\t * @instance\n\t * @property {boolean}\n\t */\n\tfullScreen: true,\n\n\t/**\n\t * True if this.hide() should be invoked before firing the Overlay-exit\n\t * event\n\t * @memberof Overlay\n\t * @instance\n\t * @property {boolean}\n\t */\n\thideOnExitClick: true,\n\n\ttemplatePartials: {\n\t\theader: mw.template.get( 'mobile.startup', 'header.hogan' ),\n\t\tanchor: Anchor.prototype.template,\n\t\tbutton: Button.prototype.template\n\t},\n\ttemplate: mw.template.get( 'mobile.startup', 'Overlay.hogan' ),\n\t/**\n\t * @memberof Overlay\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} defaults.saveMessage Caption for save button on edit form.\n\t * @property {string} defaults.cancelButton HTML of the cancel button.\n\t * @property {string} defaults.backButton HTML of the back button.\n\t * @property {string} defaults.headerButtonsListClassName A comma separated string of class\n\t * names of the wrapper of the header buttons.\n\t * @property {boolean} defaults.headerChrome Whether the header has chrome.\n\t * @property {string} defaults.spinner HTML of the spinner icon.\n\t * @property {Object} [defaults.footerAnchor] options for an optional Anchor\n\t *  that can appear in the footer\n\t */\n\tdefaults: {\n\t\tsaveMsg: mw.msg( 'mobile-frontend-editor-save' ),\n\t\tcancelButton: icons.cancel().toHtmlString(),\n\t\tbackButton: new Icon( {\n\t\t\ttagName: 'button',\n\t\t\tname: 'back',\n\t\t\tadditionalClassNames: 'back',\n\t\t\tlabel: mw.msg( 'mobile-frontend-overlay-close' )\n\t\t} ).toHtmlString(),\n\t\theaderButtonsListClassName: '',\n\t\theaderChrome: false,\n\t\tspinner: icons.spinner().toHtmlString()\n\t},\n\t/**\n\t * Flag overlay to close on content tap\n\t * @memberof Overlay\n\t * @instance\n\t * @property {boolean}\n\t */\n\tcloseOnContentTap: false,\n\n\t/**\n\t * Shows the spinner right to the input field.\n\t * @memberof Overlay\n\t * @instance\n\t * @method\n\t */\n\tshowSpinner: function () {\n\t\tthis.$spinner.removeClass( 'hidden' );\n\t},\n\n\t/**\n\t * Hide the spinner near to the input field.\n\t * @memberof Overlay\n\t * @instance\n\t * @method\n\t */\n\thideSpinner: function () {\n\t\tthis.$spinner.addClass( 'hidden' );\n\t},\n\n\t/**\n\t * @inheritdoc\n\t * @memberof Overlay\n\t * @instance\n\t */\n\tpostRender: function () {\n\n\t\tthis.$overlayContent = this.$( '.overlay-content' );\n\t\tthis.$spinner = this.$( '.spinner' );\n\t\tif ( this.isIos ) {\n\t\t\tthis.$el.addClass( 'overlay-ios' );\n\t\t}\n\t\t// Truncate any text inside in the overlay header.\n\t\tthis.$( '.overlay-header h2 span' ).addClass( 'truncated-text' );\n\t\tthis.setupEmulatedIosOverlayScrolling();\n\t},\n\n\t/**\n\t * Setups an emulated scroll behaviour for overlays in ios.\n\t * @memberof Overlay\n\t * @instance\n\t */\n\tsetupEmulatedIosOverlayScrolling: function () {\n\t\tvar self = this,\n\t\t\t$content = this.$( '.overlay-content' );\n\n\t\tif ( this.isIos && this.hasFixedHeader ) {\n\t\t\t$content[0].addEventListener( 'touchstart', this.onTouchStart.bind( this ), passiveOpts );\n\t\t\t$content[0].addEventListener( 'touchmove', this.onTouchMove.bind( this ), passiveOpts );\n\t\t\t// wait for things to render before doing any calculations\n\t\t\tsetTimeout( function () {\n\t\t\t\tvar $window = util.getWindow();\n\t\t\t\tself._resizeContent( $window.height() );\n\t\t\t}, 0 );\n\t\t}\n\t},\n\t/**\n\t * ClickBack event handler\n\t * @memberof Overlay\n\t * @instance\n\t * @param {Object} ev event object\n\t */\n\tonExitClick: function ( ev ) {\n\t\tev.preventDefault();\n\t\tev.stopPropagation();\n\t\tif ( this.hideOnExitClick ) {\n\t\t\tthis.hide();\n\t\t}\n\t\tthis.emit( Overlay.EVENT_EXIT );\n\t},\n\t/**\n\t * Event handler for touchstart, for IOS\n\t * @memberof Overlay\n\t * @instance\n\t * @param {Object} ev Event Object\n\t */\n\tonTouchStart: function ( ev ) {\n\t\tthis.startY = ev.touches[0].pageY;\n\t},\n\t/**\n\t * Event handler for touch move, for IOS\n\t * @memberof Overlay\n\t * @instance\n\t * @param {Object} ev Event Object\n\t */\n\tonTouchMove: function ( ev ) {\n\t\tvar\n\t\t\ty = ev.touches[0].pageY,\n\t\t\tcontentOuterHeight = this.$overlayContent.outerHeight(),\n\t\t\tcontentLength = this.$overlayContent.prop( 'scrollHeight' ) - contentOuterHeight;\n\n\t\t// Stop propagation so that this.iosTouchmoveHandler doesn't run\n\t\tev.stopPropagation();\n\n\t\t// prevent scrolling and bouncing outside of .overlay-content\n\t\tif (\n\t\t\t( this.$overlayContent.scrollTop() === 0 && this.startY < y ) ||\n\t\t\t( this.$overlayContent.scrollTop() === contentLength && this.startY > y )\n\t\t) {\n\t\t\tev.preventDefault();\n\t\t}\n\t},\n\t/**\n\t * Stop clicks in the overlay from propagating to the page\n\t * (prevents non-fullscreen overlays from being closed when they're tapped)\n\t * @memberof Overlay\n\t * @instance\n\t * @param {Object} ev Event Object\n\t */\n\tstopPropagation: function ( ev ) {\n\t\tev.stopPropagation();\n\t},\n\t/**\n\t * Attach overlay to current view and show it.\n\t * @memberof Overlay\n\t * @instance\n\t */\n\tshow: function () {\n\t\tvar self = this,\n\t\t\t$html = util.getDocument(),\n\t\t\t$window = util.getWindow();\n\n\t\tthis.scrollTop = window.pageYOffset;\n\n\t\tif ( this.fullScreen ) {\n\t\t\t$html.addClass( 'overlay-enabled' );\n\t\t\t// skip the URL bar if possible\n\t\t\twindow.scrollTo( 0, 1 );\n\t\t}\n\n\t\tif ( this.closeOnContentTap ) {\n\t\t\t$html.find( '#mw-mf-page-center' ).one( 'click', this.hide.bind( this ) );\n\t\t}\n\n\t\t// prevent scrolling and bouncing outside of .overlay-content\n\t\tif ( this.isIos && this.hasFixedHeader ) {\n\t\t\tthis.iosTouchmoveHandler = function ( ev ) {\n\t\t\t\t// Note that this event handler only runs if onTouchMove did not call\n\t\t\t\t// stopPropagation() (only if the page was touched outside of our overlay).\n\t\t\t\tev.preventDefault();\n\t\t\t};\n\t\t\tthis.iosResizeHandler = function () {\n\t\t\t\tself._resizeContent( $window.height() );\n\t\t\t};\n\t\t\t$window[0].addEventListener( 'touchmove', this.iosTouchmoveHandler, passiveOpts );\n\t\t\t$window.on( 'resize', this.iosResizeHandler );\n\t\t}\n\n\t\tthis.$el.addClass( 'visible' );\n\t},\n\t/**\n\t * Detach the overlay from the current view\n\t * @memberof Overlay\n\t * @instance\n\t * @param {boolean} [force] Whether the overlay should be closed regardless of\n\t * state (see PhotoUploadProgress)\n\t * @return {boolean} Whether the overlay was successfully hidden or not\n\t */\n\thide: function () {\n\t\tvar $window = util.getWindow(),\n\t\t\t$html = util.getDocument();\n\n\t\tif ( this.fullScreen ) {\n\t\t\t$html.removeClass( 'overlay-enabled' );\n\t\t\t// return to last known scroll position\n\t\t\twindow.scrollTo( window.pageXOffset, this.scrollTop );\n\t\t}\n\n\t\tthis.$el.detach();\n\n\t\tif ( this.isIos ) {\n\t\t\t$window[0].removeEventListener( 'touchmove', this.iosTouchmoveHandler, passiveOpts );\n\t\t\t$window.off( 'resize', this.iosResizeHandler );\n\t\t}\n\n\t\t/**\n\t\t * Fired when the overlay is closed.\n\t\t * @event Overlay#hide\n\t\t */\n\t\tthis.emit( 'hide' );\n\n\t\treturn true;\n\t},\n\n\t/**\n\t * Fit the overlay content height to the window taking overlay header and footer heights\n\t * into consideration.\n\t * @memberof Overlay\n\t * @instance\n\t * @private\n\t * @param {number} windowHeight The height of the window\n\t */\n\t_resizeContent: function ( windowHeight ) {\n\t\tthis.$overlayContent.height(\n\t\t\twindowHeight -\n\t\t\tthis.$( '.overlay-header-container' ).outerHeight() -\n\t\t\tthis.$( '.overlay-footer-container' ).outerHeight()\n\t\t);\n\t},\n\n\t/**\n\t * Show elements that are selected by the className.\n\t * Also hide .hideable elements\n\t * Can't use jQuery's hide() and show() because show() sets display: block.\n\t * And we want display: table for headers.\n\t * @memberof Overlay\n\t * @instance\n\t * @protected\n\t * @param {string} className CSS selector to show\n\t */\n\tshowHidden: function ( className ) {\n\t\tthis.$( '.hideable' ).addClass( 'hidden' );\n\t\tthis.$( className ).removeClass( 'hidden' );\n\t}\n} );\n\n/*\n * Fires when close button is clicked. Not to be confused with hide event.\n * @memberof Overlay\n * @event Overlay#Overlay-exit\n */\nOverlay.EVENT_EXIT = 'Overlay-exit';\n\nmodule.exports = Overlay;\n","/* global $ */\nvar\n\tutil = require( './util' ),\n\tmfExtend = require( './mfExtend' ),\n\toverlayManager = null;\n\n/**\n * Manages opening and closing overlays when the URL hash changes to one\n * of the registered values (see OverlayManager.add()).\n *\n * This allows overlays to function like real pages, with similar browser back/forward\n * and refresh behavior.\n *\n * @class OverlayManager\n * @param {Router} router\n * @param {string} appendToSelector\n */\nfunction OverlayManager( router, appendToSelector ) {\n\trouter.on( 'route', this._checkRoute.bind( this ) );\n\tthis.router = router;\n\t// use an object instead of an array for entries so that we don't\n\t// duplicate entries that already exist\n\tthis.entries = {};\n\t// stack of all the open overlays, stack[0] is the latest one\n\tthis.stack = [];\n\tthis.hideCurrent = true;\n\t// Set the element that overlays will be appended to\n\tif ( !appendToSelector ) {\n\t\tmw.log.warn( 'appendToSelector will soon be a required parameter to OverlayManager' );\n\t}\n\tthis.appendToSelector = appendToSelector || 'body';\n}\n\n/**\n * Attach an event to the overlays hide event\n * @param {Overlay} overlay\n */\nfunction attachHideEvent( overlay ) {\n\toverlay.on( 'hide', function () {\n\t\toverlay.emit( '_om_hide' );\n\t} );\n}\n\nmfExtend( OverlayManager, {\n\t/**\n\t * Don't try to hide the active overlay on a route change event triggered\n\t * by hiding another overlay.\n\t * Called when hiding an overlay.\n\t * @memberof OverlayManager\n\t * @instance\n\t * @private\n\t */\n\t_onHideOverlay: function () {\n\t\tthis.hideCurrent = false;\n\n\t\tthis.router.back();\n\t},\n\n\t/** Attach overlay to DOM\n\t * @memberof OverlayManager\n\t * @instance\n\t * @private\n\t * @param {Overlay} overlay to attach\n\t*/\n\t_attachOverlay: function ( overlay ) {\n\t\tif ( !overlay.$el.parents().length ) {\n\t\t\t$( this.appendToSelector ).append( overlay.$el );\n\t\t}\n\t},\n\t/**\n\t * Show the overlay and bind the '_om_hide' event to _onHideOverlay.\n\t * @memberof OverlayManager\n\t * @instance\n\t * @private\n\t * @param {Overlay} overlay to show\n\t */\n\t_show: function ( overlay ) {\n\n\t\t// if hidden using overlay (not hardware) button, update the state\n\t\toverlay.once( '_om_hide', this._onHideOverlay.bind( this ) );\n\n\t\tthis._attachOverlay( overlay );\n\t\toverlay.show();\n\t},\n\n\t/**\n\t * Hide overlay\n\t * @memberof OverlayManager\n\t * @instance\n\t * @private\n\t * @param {Overlay} overlay to hide\n\t * @return {boolean} Whether the overlay has been hidden\n\t */\n\t_hideOverlay: function ( overlay ) {\n\t\tvar result;\n\n\t\t// remove the callback for updating state when overlay closed using\n\t\t// overlay close button\n\t\toverlay.off( '_om_hide' );\n\n\t\tresult = overlay.hide( this.stack.length > 1 );\n\n\t\t// if closing prevented, reattach the callback\n\t\tif ( !result ) {\n\t\t\toverlay.once( '_om_hide', this._onHideOverlay.bind( this ) );\n\t\t}\n\n\t\treturn result;\n\t},\n\n\t/**\n\t * Show match's overlay if match is not null.\n\t * @memberof OverlayManager\n\t * @instance\n\t * @private\n\t * @param {Object|null} match Object with factory function's result. null if no match.\n\t */\n\t_processMatch: function ( match ) {\n\t\tvar factoryResult,\n\t\t\tself = this;\n\n\t\tif ( match ) {\n\t\t\tif ( match.overlay ) {\n\t\t\t\t// if the match is an overlay that was previously opened, reuse it\n\t\t\t\tself._show( match.overlay );\n\t\t\t} else {\n\t\t\t\t// else create an overlay using the factory function result (either\n\t\t\t\t// a promise or an overlay)\n\t\t\t\tfactoryResult = match.factoryResult;\n\t\t\t\t// http://stackoverflow.com/a/13075985/365238\n\t\t\t\tif ( typeof factoryResult.promise === 'function' ) {\n\t\t\t\t\tfactoryResult.then( function ( overlay ) {\n\t\t\t\t\t\tmatch.overlay = overlay;\n\t\t\t\t\t\tattachHideEvent( overlay );\n\t\t\t\t\t\tself._show( overlay );\n\t\t\t\t\t} );\n\t\t\t\t} else {\n\t\t\t\t\tmatch.overlay = factoryResult;\n\t\t\t\t\tattachHideEvent( match.overlay );\n\t\t\t\t\tself._show( factoryResult );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * A callback for Router's `route` event.\n\t * @memberof OverlayManager\n\t * @instance\n\t * @private\n\t * @param {jQuery.Event} ev Event object.\n\t */\n\t_checkRoute: function ( ev ) {\n\t\tvar\n\t\t\tcurrent = this.stack[0],\n\t\t\tmatch;\n\n\t\t// When entering an overlay for the first time,\n\t\t// the manager should remember the user's scroll position\n\t\t// overlays always open at top of page\n\t\t// and we'll want to restore it later.\n\t\t// This should happen before the call to _matchRoute which will \"show\" the overlay.\n\t\t// The Overlay has similar logic for overlays that are not managed via the overlay.\n\t\tif ( !current ) {\n\t\t\tthis.scrollTop = window.pageYOffset;\n\t\t}\n\n\t\tmatch = Object.keys( this.entries ).reduce( function ( m, id ) {\n\t\t\treturn m || this._matchRoute( ev.path, this.entries[ id ] );\n\t\t}.bind( this ), null );\n\n\t\t// if there is an overlay in the stack and it's opened, try to close it\n\t\tif (\n\t\t\tcurrent &&\n\t\t\tcurrent.overlay !== undefined &&\n\t\t\tthis.hideCurrent &&\n\t\t\t!this._hideOverlay( current.overlay )\n\t\t) {\n\t\t\t// if hide prevented, prevent route change event\n\t\t\tev.preventDefault();\n\t\t} else if ( !match ) {\n\t\t\t// if hidden and no new matches, reset the stack\n\t\t\tthis.stack = [];\n\t\t\t// restore the scroll position.\n\t\t\twindow.scrollTo( window.pageXOffset, this.scrollTop );\n\t\t}\n\n\t\tthis.hideCurrent = true;\n\t\tthis._processMatch( match );\n\t},\n\n\t/**\n\t * Check if a given path matches one of the entries.\n\t * @memberof OverlayManager\n\t * @instance\n\t * @private\n\t * @param {string} path Path (hash) to check.\n\t * @param {Object} entry Entry object created in OverlayManager#add.\n\t * @return {Object|null} Match object with factory function's result.\n\t *  Returns null if no match.\n\t */\n\t_matchRoute: function ( path, entry ) {\n\t\tvar\n\t\t\tnext,\n\t\t\tmatch = path.match( entry.route ),\n\t\t\tprevious = this.stack[1],\n\t\t\tself = this;\n\n\t\t/**\n\t\t * Returns object to add to stack\n\t\t * @method\n\t\t * @ignore\n\t\t * @return {Object}\n\t\t */\n\t\tfunction getNext() {\n\t\t\treturn {\n\t\t\t\tpath: path,\n\t\t\t\tfactoryResult: entry.factory.apply( self, match.slice( 1 ) )\n\t\t\t};\n\t\t}\n\n\t\tif ( match ) {\n\t\t\t// if previous stacked overlay's path matches, assume we're going back\n\t\t\t// and reuse a previously opened overlay\n\t\t\tif ( previous && previous.path === path ) {\n\t\t\t\tif ( previous.overlay && previous.overlay.hasLoadError ) {\n\t\t\t\t\tself.stack.shift();\n\t\t\t\t\t// Loading of overlay failed so we want to replace it with a new\n\t\t\t\t\t// overlay (which will try to load successfully)\n\t\t\t\t\tself.stack[0] = getNext();\n\t\t\t\t\treturn self.stack[0];\n\t\t\t\t}\n\n\t\t\t\tself.stack.shift();\n\t\t\t\treturn previous;\n\t\t\t} else {\n\t\t\t\tnext = getNext();\n\t\t\t\tif ( this.stack[0] && next.path === this.stack[0].path ) {\n\t\t\t\t\t// current overlay path is same as path to check which means overlay\n\t\t\t\t\t// is attempting to refresh so just replace current overlay with new\n\t\t\t\t\t// overlay\n\t\t\t\t\tself.stack[0] = next;\n\t\t\t\t} else {\n\t\t\t\t\tself.stack.unshift( next );\n\t\t\t\t}\n\t\t\t\treturn next;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t},\n\n\t/**\n\t * Add an overlay that should be shown for a specific fragment identifier.\n\t *\n\t * The following code will display an overlay whenever a user visits a URL that\n\t * end with '#/hi/name'. The value of `name` will be passed to the overlay.\n\t *\n\t *     @example\n\t *     overlayManager.add( /\\/hi\\/(.*)/, function ( name ) {\n\t *       var factoryResult = $.Deferred();\n\t *\n\t *       mw.using( 'mobile.HiOverlay', function () {\n\t *         var HiOverlay = M.require( 'HiOverlay' );\n\t *         factoryResult.resolve( new HiOverlay( { name: name } ) );\n\t *       } );\n\t *\n\t *       return factoryResult;\n\t *     } );\n\t *\n\t * @memberof OverlayManager\n\t * @instance\n\t * @param {RegExp} route route regular expression, optionally with parameters.\n\t * @param {Function} factory a function returning an overlay or a $.Deferred\n\t * which resolves to an overlay.\n\t */\n\tadd: function ( route, factory ) {\n\t\tvar self = this,\n\t\t\tentry = {\n\t\t\t\troute: route,\n\t\t\t\tfactory: factory\n\t\t\t};\n\n\t\tthis.entries[route] = entry;\n\t\t// Check if overlay should be shown for the current path.\n\t\t// The DOM must fully load before we can show the overlay because Overlay relies on it.\n\t\tutil.docReady( function () {\n\t\t\tself._processMatch( self._matchRoute( self.router.getPath(), entry ) );\n\t\t} );\n\t},\n\n\t/**\n\t * Replace the currently displayed overlay with a new overlay without changing the\n\t * URL. This is useful for when you want to switch overlays, but don't want to\n\t * change the back button or close box behavior.\n\t *\n\t * @memberof OverlayManager\n\t * @instance\n\t * @param {Object} overlay The overlay to display\n\t */\n\treplaceCurrent: function ( overlay ) {\n\t\tif ( this.stack.length === 0 ) {\n\t\t\tthrow new Error( 'Trying to replace OverlayManager\\'s current overlay, but stack is empty' );\n\t\t}\n\t\tthis._hideOverlay( this.stack[0].overlay );\n\t\tthis.stack[0].overlay = overlay;\n\t\tattachHideEvent( overlay );\n\t\tthis._show( overlay );\n\t}\n} );\n\n/**\n * Retrieve a singleton instance using 'mediawiki.router'.\n * @memberof OverlayManager\n * @return {OverlayManager}\n */\nOverlayManager.getSingleton = function () {\n\tif ( !overlayManager ) {\n\t\toverlayManager = new OverlayManager( mw.loader.require( 'mediawiki.router' ), 'body' );\n\t}\n\treturn overlayManager;\n};\n\nmodule.exports = OverlayManager;\n","var\n\tHTML = mw.html,\n\tmfExtend = require( './mfExtend' ),\n\ttime = require( './time' ),\n\tutil = require( './util' ),\n\tSection = require( './Section' ),\n\tThumbnail = require( './Thumbnail' ),\n\tView = require( './View' ),\n\tHEADING_SELECTOR = mw.config.get( 'wgMFMobileFormatterHeadings', [ 'h1', 'h2', 'h3', 'h4', 'h5' ] ).join( ',' ),\n\tBLACKLISTED_THUMBNAIL_CLASS_SELECTORS = [ 'noviewer', 'metadata' ];\n\n/**\n * Mobile page view object\n *\n * @class Page\n * @uses Section\n * @extends View\n *\n * @param {Object} options Configuration options\n */\nfunction Page( options ) {\n\n\tutil.extend( this, {\n\t\toptions: options,\n\t\ttitle: options.title,\n\t\tdisplayTitle: options.displayTitle,\n\t\turl: options.url || mw.util.getUrl( options.title ),\n\t\tid: options.id,\n\t\twikidataDescription: options.wikidataDescription,\n\t\tthumbnail: ( Object.prototype.hasOwnProperty.call( options, 'thumbnail' ) ) ?\n\t\t\toptions.thumbnail : false,\n\t\tisMissing: ( options.isMissing !== undefined ) ?\n\t\t\toptions.isMissing : options.id === 0\n\t} );\n\n\tthis.options.isBorderBox = false;\n\tthis.options.languageUrl = mw.util.getUrl( 'Special:MobileLanguages/' + this.title );\n\n\tView.call( this, this.options );\n\n\t// Fallback if no displayTitle provided\n\tif ( !this.displayTitle ) {\n\t\tthis.displayTitle = this.getDisplayTitle();\n\t}\n\n\tif ( this.thumbnail && this.thumbnail.width ) {\n\t\tthis.thumbnail.isLandscape = this.thumbnail.width > this.thumbnail.height;\n\t}\n}\n\nmfExtend( Page, View, {\n\t/**\n\t * @memberof Page\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {number} defaults.id Page ID. The default value of 0 represents a\n\t * new or missing page. Be sure to override it to avoid side effects.\n\t * @property {string} defaults.title Title of the page. It includes prefix where needed and\n\t * is human readable, e.g. Talk:The man who lived.\n\t * @property {string} defaults.displayTitle HTML title of the page for display. Falls back\n\t * to defaults.title (escaped) if no value is provided. Must be safe HTML!\n\t * @property {number} defaults.namespaceNumber the number of the\n\t *  namespace the page belongs to\n\t * @property {Object} defaults.protection List of permissions as returned by API,\n\t * e.g. [{ edit: ['*'] }]\n\t * @property {Array} defaults.sections Array of {Section} objects.\n\t * @property {boolean} defaults.isMainPage Whether the page is the Main Page.\n\t * @property {boolean} defaults.isMissing Whether the page exists in the wiki.\n\t * @property {Object} defaults.thumbnail thumbnail definition corresponding to page image\n\t * @property {boolean} defaults.thumbnail.isLandscape whether the image is in\n\t *  landscape format\n\t * @property {number} defaults.thumbnail.width of image in pixels.\n\t * @property {number} defaults.thumbnail.height of image in pixels.\n\t * @property {string} defaults.thumbnail.source url for image\n\t */\n\tdefaults: {\n\t\tid: 0,\n\t\ttitle: '',\n\t\tdisplayTitle: '',\n\t\tnamespaceNumber: 0,\n\t\tprotection: {\n\t\t\tedit: [ '*' ]\n\t\t},\n\t\tsections: [],\n\t\tisMissing: false,\n\t\tisMainPage: false,\n\t\turl: undefined,\n\t\tthumbnail: {\n\t\t\tisLandscape: undefined,\n\t\t\tsource: undefined,\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\t/**\n\t * Retrieve the title that should be displayed to the user\n\t * @memberof Page\n\t * @instance\n\t * @return {string} HTML\n\t */\n\tgetDisplayTitle: function () {\n\t\treturn this.options.displayTitle || HTML.escape( this.options.title );\n\t},\n\t/**\n\t * Determine if current page is in a specified namespace\n\t * @memberof Page\n\t * @instance\n\t * @param {string} namespace Name of namespace\n\t * @return {boolean}\n\t */\n\tinNamespace: function ( namespace ) {\n\t\treturn this.options.namespaceNumber === mw.config.get( 'wgNamespaceIds' )[namespace];\n\t},\n\n\t/**\n\t * Find the heading in the page.\n\t * This has the benefit of excluding any additional h2s and h3s that may\n\t * have been added programatically.\n\t * @method\n\t * @param {number} sectionIndex as defined by the PHP parser.\n\t *  It should correspond to the section id\n\t *  used in the edit link for the section.\n\t *  Note, confusingly, this is different from section \"ID\" which is\n\t * used in methods\n\t * @return {jQuery.Object}\n\t */\n\tfindSectionHeadingByIndex: function ( sectionIndex ) {\n\t\tif ( sectionIndex < 1 ) {\n\t\t\t// negative indexes will search from the end, which is behaviour we do not want.\n\t\t\t// return an empty set when this happens.\n\t\t\treturn this.$();\n\t\t} else {\n\t\t\treturn this.$( HEADING_SELECTOR )\n\t\t\t\t// Headings must strictly be a child element of a section element\n\t\t\t\t// or the parser-output.\n\t\t\t\t// Not an ancestor!\n\t\t\t\t.filter( '.mw-parser-output > *, [class^=\"mf-section-\"] > *' ).eq( sectionIndex - 1 );\n\t\t}\n\t},\n\t/**\n\t * Finds all child elements that match the selector in a given section or subsection.\n\t * Returns any direct child elements that match the selector,\n\t * (i.e. searches only one level deep)\n\t * as well as any elements that match the selector within those children.\n\t * If the Page has no headings (e.g. a stub),\n\t * then the search will target all nodes within the page.\n\t *\n\t * This code should work on desktop (PHP parser HTML)\n\t * as well as mobile formatted HTML (PHP parser + MobileFormatter)\n\t * @method\n\t * @param {number} sectionIndex as defined by the PHP parser. It should correspond to\n\t *  the section id used in the edit link for the section.\n\t *  Note, confusingly, this is different from section \"ID\" which is\n\t *  used in methods\n\t * @param {string} selector to match\n\t * @return {jQuery.Object}\n\t */\n\tfindChildInSectionLead: function ( sectionIndex, selector ) {\n\t\tvar $heading, $nextHeading, $container, $lead,\n\t\t\theadingSelector = HEADING_SELECTOR;\n\n\t\tfunction withNestedChildren( $matchingNodes ) {\n\t\t\treturn $matchingNodes.find( selector ).addBack();\n\t\t}\n\n\t\tif ( sectionIndex === 0 ) {\n\t\t\t// lead is easy\n\t\t\t$lead = this.getLeadSectionElement();\n\t\t\tif ( $lead && $lead.length ) {\n\t\t\t\treturn withNestedChildren( $lead.children( selector ) );\n\t\t\t} else {\n\t\t\t\t$heading = this.findSectionHeadingByIndex( 1 );\n\t\t\t\treturn $heading.length ? withNestedChildren( $heading.prevAll( selector ) ) :\n\t\t\t\t\t// this page is a stub so search entire page\n\t\t\t\t\tthis.$( selector );\n\t\t\t}\n\t\t}\n\n\t\t// find heading associated with the section by looking at its\n\t\t// index position in the article\n\t\t// section ids relate to the element position in the page and the first heading\n\t\t// lead has been dealt with above, so first heading corresponds to section 1,\n\t\t// the first heading in the article.\n\t\t$heading = this.findSectionHeadingByIndex( sectionIndex );\n\n\t\t// If section-heading is present on the heading,\n\t\t// then we know the page has been MobileFormatted\n\t\t// and that this is a wrapped section\n\t\tif ( $heading.hasClass( 'section-heading' ) ) {\n\t\t\t// get content of section\n\t\t\t$container = $heading.next();\n\t\t\t// inside section find the first heading\n\t\t\t$nextHeading = $container.find( headingSelector ).eq( 0 );\n\t\t\treturn $nextHeading.length ?\n\t\t\t\t// find all amboxes before the next heading\n\t\t\t\twithNestedChildren( $nextHeading.prevAll( selector ) ) :\n\t\t\t\t// There is no subheadings inside\n\t\t\t\t// Grab all issues in section\n\t\t\t\twithNestedChildren( $container.children( selector ) );\n\t\t} else {\n\t\t\t// the heading relates to a subsection (or unwrapped desktop section),\n\t\t\t// so grab elements between this and the next one\n\t\t\t$nextHeading = $heading.eq( 0 ).nextAll( headingSelector ).eq( 0 );\n\t\t\treturn $heading.nextUntil( $nextHeading, selector );\n\t\t}\n\t},\n\n\t/**\n\t * Get the lead section of the page view.\n\t * @memberof Page\n\t * @instance\n\t * @return {jQuery.Object|null}\n\t */\n\tgetLeadSectionElement: function () {\n\t\t/*\n\t\t * The page is formatted as follows:\n\t\t * <div id=\"bodyContent\">\n\t\t *   <!-- content of the page.. -->\n\t\t *   <div id=\"mw-content-text\">\n\t\t *     <div class=\"mf-section-0\">lead section</div>\n\t\t *     <h2></h2>\n\t\t *     <div class=\"mf-section-1\">second section</div>\n\t\t *   </div>\n\t\t * </div>\n\t\t */\n\t\tif ( this.$( '.mf-section-0' ).length ) {\n\t\t\treturn this.$( '.mf-section-0' );\n\t\t}\n\t\t// no lead section found\n\t\treturn null;\n\t},\n\n\t/**\n\t * Determines if content model is wikitext\n\t * @memberof Page\n\t * @instance\n\t * @return {boolean}\n\t */\n\tisWikiText: function () {\n\t\treturn mw.config.get( 'wgPageContentModel' ) === 'wikitext';\n\t},\n\n\t/**\n\t * Checks whether the current page is the main page\n\t * @memberof Page\n\t * @instance\n\t * @return {boolean}\n\t */\n\tisMainPage: function () {\n\t\treturn this.options.isMainPage;\n\t},\n\t/**\n\t * Checks whether the current page is watched\n\t * @memberof Page\n\t * @instance\n\t * @return {boolean}\n\t */\n\tisWatched: function () {\n\t\treturn this.options.isWatched;\n\t},\n\n\t/**\n\t * Return the latest revision id for this page\n\t * @memberof Page\n\t * @instance\n\t * @return {number}\n\t */\n\tgetRevisionId: function () {\n\t\treturn this.options.revId;\n\t},\n\n\t/**\n\t * Return prefixed page title\n\t * @memberof Page\n\t * @instance\n\t * @return {string}\n\t */\n\tgetTitle: function () {\n\t\treturn this.options.title;\n\t},\n\n\t/**\n\t * Return page id\n\t * @memberof Page\n\t * @instance\n\t * @return {number}\n\t */\n\tgetId: function () {\n\t\treturn this.options.id;\n\t},\n\n\t/**\n\t * return namespace id\n\t * @memberof Page\n\t * @instance\n\t * @return {number} namespace Number\n\t */\n\tgetNamespaceId: function () {\n\t\tvar nsId,\n\t\t\targs = this.options.title.split( ':' );\n\n\t\tif ( args[1] ) {\n\t\t\tnsId = mw.config.get( 'wgNamespaceIds' )[ args[0].toLowerCase().replace( ' ', '_' ) ] || 0;\n\t\t} else {\n\t\t\tnsId = 0;\n\t\t}\n\t\treturn nsId;\n\t},\n\n\t/**\n\t * Determines if current page is a talk page\n\t * @memberof Page\n\t * @instance\n\t * @return {boolean} Whether the page is a talk page or not\n\t */\n\tisTalkPage: function () {\n\t\tvar ns = this.getNamespaceId();\n\t\t// all talk pages are odd Numbers (except the case of special pages)\n\t\treturn ns > 0 && ns % 2 === 1;\n\t},\n\n\t/**\n\t * @inheritdoc\n\t * @memberof Page\n\t * @instance\n\t */\n\tpreRender: function () {\n\t\tthis.sections = [];\n\t\tthis._sectionLookup = {};\n\t\tthis.title = this.options.title;\n\n\t\tthis.options.sections.forEach( function ( sectionData ) {\n\t\t\tvar section = new Section( sectionData );\n\t\t\tthis.sections.push( section );\n\t\t\tthis._sectionLookup[section.id] = section;\n\t\t}.bind( this ) );\n\t},\n\n\t/**\n\t * Return all the thumbnails in the article.\n\t * Images which have a class or link container (.image|.thumbimage)\n\t * that matches one of the items of the constant BLACKLISTED_THUMBNAIL_CLASS_SELECTORS\n\t * will be excluded.\n\t * A thumbnail nested inside one of these classes will still be returned.\n\t * e.g. `<div class=\"noviewer\"><a class=\"image\"><img></a></div>` is not a valid thumbnail\n\t * `<a class=\"image noviewer\"><img></a>` is not a valid thumbnail\n\t * `<a class=\"image\"><img class=\"noviewer\"></a>` is not a valid thumbnail\n\t * @memberof Page\n\t * @instance\n\t * @return {Thumbnail[]}\n\t */\n\tgetThumbnails: function () {\n\t\tvar $thumbs,\n\t\t\t$el = this.$el,\n\t\t\tblacklistSelector = '.' + BLACKLISTED_THUMBNAIL_CLASS_SELECTORS.join( ',.' ),\n\t\t\tthumbs = [];\n\n\t\tif ( !this._thumbs ) {\n\t\t\t$thumbs = $el.find( 'a.image, a.thumbimage' )\n\t\t\t\t.not( blacklistSelector );\n\n\t\t\t$thumbs.each( function () {\n\t\t\t\tvar $a = $el.find( this ),\n\t\t\t\t\t$lazyImage = $a.find( '.lazy-image-placeholder' ),\n\t\t\t\t\t// Parents need to be checked as well.\n\t\t\t\t\tvalid = $a.parents( blacklistSelector ).length === 0 &&\n\t\t\t\t\t\t$a.find( blacklistSelector ).length === 0,\n\t\t\t\t\tlegacyMatch = $a.attr( 'href' ).match( /title=([^/&]+)/ ),\n\t\t\t\t\tmatch = $a.attr( 'href' ).match( /[^/]+$/ );\n\n\t\t\t\t// filter out invalid lazy loaded images if so far image is valid\n\t\t\t\tif ( $lazyImage.length && valid ) {\n\t\t\t\t\t// if the regex matches it means the image has one of the classes\n\t\t\t\t\t// thus we must invert the result\n\t\t\t\t\tvalid = !new RegExp( '\\\\b(' + BLACKLISTED_THUMBNAIL_CLASS_SELECTORS.join( '|' ) + ')\\\\b' )\n\t\t\t\t\t\t.test( $lazyImage.data( 'class' ) );\n\t\t\t\t}\n\n\t\t\t\tif ( valid && ( legacyMatch || match ) ) {\n\t\t\t\t\tthumbs.push(\n\t\t\t\t\t\tnew Thumbnail( {\n\t\t\t\t\t\t\tel: $a,\n\t\t\t\t\t\t\tfilename: decodeURIComponent(\n\t\t\t\t\t\t\t\tlegacyMatch ? legacyMatch[1] : match[0]\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t} )\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t} );\n\t\t\tthis._thumbs = thumbs;\n\t\t}\n\t\treturn this._thumbs;\n\t},\n\n\t/**\n\t * FIXME: Change function signature to take the anchor of the heading\n\t * @memberof Page\n\t * @instance\n\t * @param {string} id of the section as defined by MobileFormatter.\n\t * Note, that currently, this is different from\n\t * the PHP parser in that it relates to top-level sections.\n\t * For example, mf-section-1 would relate to section 1. See FIXME.\n\t * @return {Section}\n\t */\n\tgetSection: function ( id ) {\n\t\treturn this._sectionLookup[ id ];\n\t},\n\n\t/**\n\t * Obtain the list of high level (and grouped) sections.\n\t * Note that this list will not include subsections.\n\t * @memberof Page\n\t * @instance\n\t * @return {Array} of Section instances\n\t */\n\tgetSections: function () {\n\t\treturn this.sections;\n\t},\n\n\t/**\n\t * Returns a jQuery object representing all redlinks on the page.\n\t * @memberof Page\n\t * @instance\n\t * @return {jQuery.Object}\n\t */\n\tgetRedLinks: function () {\n\t\treturn this.$( '.new' );\n\t}\n} );\n\n/**\n * Create a Page object from an API response.\n *\n * @memberof Page\n * @param {Object} resp as representing a page in the API\n * @return {Page}\n */\nPage.newFromJSON = function ( resp ) {\n\tvar revision, displayTitle,\n\t\tthumb = resp.thumbnail,\n\t\tpageprops = resp.pageprops || {\n\t\t\tdisplaytitle: HTML.escape( resp.title )\n\t\t},\n\t\tterms = resp.terms;\n\n\tif ( pageprops || terms ) {\n\t\t// The label is either the display title or the label pageprop\n\t\t// (the latter used by Wikidata)\n\t\t// Long term we want to consolidate these.\n\t\t// Note that pageprops.displaytitle is HTML, while\n\t\t// terms.label[0] is plain text.\n\t\tdisplayTitle = terms && terms.label ?\n\t\t\tHTML.escape( terms.label[0] ) : pageprops.displaytitle;\n\t}\n\t// Add Wikidata descriptions if available (T101719)\n\tresp.wikidataDescription = resp.description || undefined;\n\n\tif ( thumb ) {\n\t\tresp.thumbnail.isLandscape = thumb.width > thumb.height;\n\t}\n\n\t// page may or may not exist.\n\tif ( resp.revisions && resp.revisions[0] ) {\n\t\trevision = resp.revisions[0];\n\t\tresp.lastModified = time.getLastModifiedMessage(\n\t\t\tnew Date( revision.timestamp ).getTime() / 1000,\n\t\t\trevision.user\n\t\t);\n\t}\n\n\treturn new Page(\n\t\tutil.extend( resp, {\n\t\t\tid: resp.pageid,\n\t\t\tisMissing: !!resp.missing,\n\t\t\turl: mw.util.getUrl( resp.title ),\n\t\t\tdisplayTitle: displayTitle // this is HTML!\n\t\t} )\n\t);\n};\n\n/**\n * Selector for matching headings\n *\n * @memberof Page\n */\nPage.HEADING_SELECTOR = HEADING_SELECTOR;\n\nmodule.exports = Page;\n","var sectionTemplate = mw.template.get( 'mobile.startup', 'Section.hogan' ),\n\tutil = require( './util.js' ),\n\tactionParams = require( './actionParams' ),\n\tcache = {};\n\n/**\n * Add child to listOfSections if the level of child is the same as the last\n * child of listOfSections, otherwise add it to the children of the last\n * section of listOfSections. If listOfSections is empty, just add child to it.\n * @private\n * @param {Array} listOfSections - Array of section ids\n * @param {Object} child - Section to be added to listOfSections\n */\nfunction assignToParent( listOfSections, child ) {\n\tvar section;\n\tif ( listOfSections.length === 0 ) {\n\t\tlistOfSections.push( child );\n\t} else {\n\t\t// take a look at the last child\n\t\tsection = listOfSections[listOfSections.length - 1];\n\t\t// If the level is the same as another section in this list it is a sibling\n\t\tif ( parseInt( section.level, 10 ) === parseInt( child.level, 10 ) ) {\n\t\t\tlistOfSections.push( child );\n\t\t} else {\n\t\t\t// Otherwise take a look at that sections children recursively\n\t\t\tassignToParent( section.subsections, child );\n\t\t}\n\t}\n}\n\n/**\n * Order sections hierarchically\n * @private\n * @param {Array} sections Array of section objects created from response HTML\n * @return {Array} Ordered array of sections\n */\nfunction transformSections( sections ) {\n\tvar\n\t\tsectionLevels = sections.map( function ( s ) {\n\t\t\treturn s.level;\n\t\t} ),\n\t\texistingSectionLevels = sectionLevels.filter( function ( level ) {\n\t\t\treturn !!level;\n\t\t} ),\n\t\tcollapseLevel = Math.min.apply( this, existingSectionLevels ).toString(),\n\t\tlastSection,\n\t\tresult = [];\n\n\t// if the first section level is not equal to collapseLevel, this first\n\t// section will not have a parent and will be appended to the result.\n\tsections.forEach( function ( section ) {\n\t\tif ( section.line !== undefined ) {\n\t\t\tsection.line = section.line.replace( /<\\/?a\\b[^>]*>/g, '' );\n\t\t}\n\t\tsection.subsections = [];\n\n\t\tif (\n\t\t\t!lastSection ||\n\t\t\t(\n\t\t\t\t!section.level ||\n\t\t\t\tsection.level === collapseLevel\n\t\t\t) ||\n\t\t\t// make sure lastSections first child's level is bigger than section.level\n\t\t\t(\n\t\t\t\tlastSection.subsections.length &&\n\t\t\t\tlastSection.subsections[0].level > section.level\n\t\t\t) ||\n\t\t\t// also make sure section.level is not bigger than the lastSection.level\n\t\t\t(\n\t\t\t\tlastSection.level &&\n\t\t\t\tlastSection.level >= section.level\n\t\t\t)\n\t\t) {\n\t\t\tresult.push( section );\n\t\t\tlastSection = section;\n\t\t} else {\n\t\t\tassignToParent( lastSection.subsections, section );\n\t\t\tlastSection.text += sectionTemplate.render( section );\n\t\t}\n\t} );\n\n\treturn result;\n}\n\n/**\n * API for providing Page data\n * @class PageGateway\n * @param {mw.Api} api\n */\nfunction PageGateway( api ) {\n\tthis.api = api;\n}\n\nPageGateway.prototype = {\n\t/**\n\t * Retrieve a page from the api\n\t * @memberof PageGateway\n\t * @instance\n\t * @param {string} title the title of the page to be retrieved\n\t * @param {string} endpoint an alternative api url to retrieve the page from\n\t * @param {boolean} leadOnly When set only the lead section content is returned\n\t * @return {jQuery.Deferred} with parameter page data that can be passed to a Page view\n\t */\n\tgetPage: function ( title, endpoint, leadOnly ) {\n\t\tvar timestamp,\n\t\t\td = util.Deferred(),\n\t\t\tparams = endpoint ? {\n\t\t\t\turl: endpoint,\n\t\t\t\tdataType: 'jsonp'\n\t\t\t} : {},\n\t\t\tprotection = {\n\t\t\t\tedit: [ '*' ]\n\t\t\t};\n\n\t\tutil.extend( params,\n\t\t\tactionParams( {\n\t\t\t\taction: 'mobileview',\n\t\t\t\tpage: title,\n\t\t\t\tvariant: mw.config.get( 'wgPageContentLanguage' ),\n\t\t\t\tredirect: 'yes',\n\t\t\t\tprop: 'id|sections|text|lastmodified|lastmodifiedby|languagecount|hasvariants|protection|displaytitle|revision',\n\t\t\t\tnoheadings: 'yes',\n\t\t\t\tsectionprop: 'level|line|anchor',\n\t\t\t\tsections: leadOnly ? 0 : 'all'\n\t\t\t} )\n\t\t);\n\n\t\tif ( !cache[title] ) {\n\t\t\tcache[title] = this.api.get( params ).then( function ( resp ) {\n\t\t\t\tvar sections, lastModified, resolveObj, mv;\n\n\t\t\t\tif ( resp.error ) {\n\t\t\t\t\treturn d.reject( resp.error );\n\t\t\t\t} else if ( !resp.mobileview.sections ) {\n\t\t\t\t\treturn d.reject( 'No sections' );\n\t\t\t\t} else {\n\t\t\t\t\tmv = resp.mobileview;\n\t\t\t\t\tsections = transformSections( mv.sections );\n\t\t\t\t\t// Assume the timestamp is in the form TS_ISO_8601\n\t\t\t\t\t// and we don't care about old browsers\n\t\t\t\t\t// change to seconds to be consistent with PHP\n\t\t\t\t\ttimestamp = new Date( mv.lastmodified ).getTime() / 1000;\n\t\t\t\t\tlastModified = mv.lastmodifiedby;\n\n\t\t\t\t\t// FIXME: [API] the API sometimes returns an object and sometimes an array\n\t\t\t\t\t// There are various quirks with the format of protection level\n\t\t\t\t\t// as returned by api.\n\t\t\t\t\t// Also it is usually incomplete - if something is missing this means\n\t\t\t\t\t// that it has no protection level.\n\t\t\t\t\t// When an array this means there is no protection level set.\n\t\t\t\t\t// To keep the data type consistent either use the predefined\n\t\t\t\t\t// protection level,\n\t\t\t\t\t// or extend it with what is returned by API.\n\t\t\t\t\tprotection = Array.isArray( mv.protection ) ?\n\t\t\t\t\t\tprotection :\n\t\t\t\t\t\tutil.extend( protection, mv.protection );\n\n\t\t\t\t\tresolveObj = {\n\t\t\t\t\t\ttitle: title,\n\t\t\t\t\t\tid: mv.id,\n\t\t\t\t\t\trevId: mv.revId,\n\t\t\t\t\t\tprotection: protection,\n\t\t\t\t\t\tlead: sections[0].text,\n\t\t\t\t\t\tsections: sections.slice( 1 ),\n\t\t\t\t\t\tisMainPage: mv.mainpage !== undefined,\n\t\t\t\t\t\thistoryUrl: mw.util.getUrl( title, {\n\t\t\t\t\t\t\taction: 'history'\n\t\t\t\t\t\t} ),\n\t\t\t\t\t\tlastModifiedTimestamp: timestamp,\n\t\t\t\t\t\tlanguageCount: mv.languagecount,\n\t\t\t\t\t\thasVariants: mv.hasvariants !== undefined,\n\t\t\t\t\t\tdisplayTitle: mv.displaytitle\n\t\t\t\t\t};\n\t\t\t\t\t// Add non-anonymous user information\n\t\t\t\t\tif ( lastModified ) {\n\t\t\t\t\t\tutil.extend( resolveObj, {\n\t\t\t\t\t\t\tlastModifiedUserName: lastModified.name,\n\t\t\t\t\t\t\tlastModifiedUserGender: lastModified.gender\n\t\t\t\t\t\t} );\n\t\t\t\t\t}\n\t\t\t\t\t// FIXME: Return a Page class here\n\t\t\t\t\treturn resolveObj;\n\t\t\t\t}\n\t\t\t}, function ( msg ) {\n\t\t\t\treturn d.reject( msg );\n\t\t\t} );\n\t\t}\n\n\t\treturn cache[title];\n\t},\n\n\t/**\n\t * Invalidate the internal cache for a given page\n\t * @memberof PageGateway\n\t * @instance\n\t * @param {string} title the title of the page who's cache you want to invalidate\n\t */\n\tinvalidatePage: function ( title ) {\n\t\tdelete cache[title];\n\t},\n\n\t/**\n\t * Gets language variant list for a page; helper function for getPageLanguages()\n\t * @memberof PageGateway\n\t * @instance\n\t * @private\n\t * @param  {string} title Name of the page to obtain variants for\n\t * @param  {Object} data Data from API\n\t * @return {Array|boolean} List of language variant objects or false if no variants exist\n\t */\n\t_getLanguageVariantsFromApiResponse: function ( title, data ) {\n\t\tvar generalData = data.query.general,\n\t\t\tvariantPath = generalData.variantarticlepath,\n\t\t\tvariants = [];\n\n\t\tif ( !generalData.variants ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Create the data object for each variant and store it\n\t\tObject.keys( generalData.variants ).forEach( function ( index ) {\n\t\t\tvar item = generalData.variants[ index ],\n\t\t\t\tvariant = {\n\t\t\t\t\tautonym: item.name,\n\t\t\t\t\tlang: item.code\n\t\t\t\t};\n\n\t\t\tif ( variantPath ) {\n\t\t\t\tvariant.url = variantPath\n\t\t\t\t\t.replace( '$1', title )\n\t\t\t\t\t.replace( '$2', item.code );\n\t\t\t} else {\n\t\t\t\tvariant.url = mw.util.getUrl( title, {\n\t\t\t\t\tvariant: item.code\n\t\t\t\t} );\n\t\t\t}\n\t\t\tvariants.push( variant );\n\t\t} );\n\n\t\treturn variants;\n\t},\n\n\t/**\n\t * Retrieve available languages for a given title\n\t * @memberof PageGateway\n\t * @instance\n\t * @param {string} title the title of the page languages should be retrieved for\n\t * @param {string} [language] when provided the names of the languages returned\n\t *  will be translated additionally into this language.\n\t * @return {jQuery.Deferred} which is called with an object containing langlinks\n\t * and variant links as defined @ https://en.m.wikipedia.org/w/api.php?action=help&modules=query%2Blanglinks\n\t */\n\tgetPageLanguages: function ( title, language ) {\n\t\tvar self = this,\n\t\t\targs = actionParams( {\n\t\t\t\tmeta: 'siteinfo',\n\t\t\t\tsiprop: 'general',\n\t\t\t\tprop: 'langlinks',\n\t\t\t\tlllimit: 'max',\n\t\t\t\ttitles: title\n\t\t\t} );\n\n\t\tif ( language ) {\n\t\t\targs.llprop = 'url|autonym|langname';\n\t\t\targs.llinlanguagecode = language;\n\t\t} else {\n\t\t\targs.llprop = 'url|autonym';\n\t\t}\n\t\treturn this.api.get( args ).then( function ( resp ) {\n\t\t\treturn {\n\t\t\t\tlanguages: resp.query.pages[0].langlinks || [],\n\t\t\t\tvariants: self._getLanguageVariantsFromApiResponse( title, resp )\n\t\t\t};\n\t\t}, function () {\n\t\t\treturn util.Deferred().reject();\n\t\t} );\n\t},\n\n\t/**\n\t * Extract sections from headings in $el\n\t * @memberof PageGateway\n\t * @instance\n\t * @private\n\t * @param {jQuery.Object} $el object from which sections are extracted\n\t * @return {Array} Array of section objects created from headings in $el\n\t * FIXME: Where's a better place for getSectionsFromHTML and this function to live?\n\t * Answer: Possibly Page.js\n\t */\n\t_getAPIResponseFromHTML: function ( $el ) {\n\t\t// FIXME: use Page.HEADING_SELECTOR\n\t\tvar $headings = $el.find( 'h1,h2,h3,h4,h5,h6' ),\n\t\t\tsections = [];\n\n\t\t$headings.each( function () {\n\t\t\tvar level = this.tagName.substr( 1 ),\n\t\t\t\t$span = $el.find( this ).find( '.mw-headline' );\n\n\t\t\tif ( $span.length ) {\n\t\t\t\tsections.push( {\n\t\t\t\t\tlevel: level,\n\t\t\t\t\tline: $span.html(),\n\t\t\t\t\tanchor: $span.attr( 'id' ) || '',\n\t\t\t\t\ttext: ''\n\t\t\t\t} );\n\t\t\t}\n\t\t} );\n\t\treturn sections;\n\t},\n\n\t/**\n\t * Order sections hierarchically\n\t * @memberof PageGateway\n\t * @instance\n\t * @param {jQuery.Object} $el object from which sections are extracted\n\t * @return {Array} Ordered array of sections\n\t */\n\tgetSectionsFromHTML: function ( $el ) {\n\t\treturn transformSections( this._getAPIResponseFromHTML( $el ) );\n\t}\n};\n\nmodule.exports = PageGateway;\n","var\n\tmfExtend = require( './mfExtend' ),\n\tView = require( './View' ),\n\tbrowser = require( './Browser' ).getSingleton();\n\n/**\n * List of items page view\n * @class PageList\n * @extends View\n */\nfunction PageList() {\n\tView.apply( this, arguments );\n}\n\nmfExtend( PageList, View, {\n\t/**\n\t * @memberof PageList\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {Page[]} defaults.pages Array of Page objects. These should match\n\t *                              the Page model and not necessarily the\n\t *                              underlying API format used.\n\t * E.g. [\n\t *   {\n\t *     heading: \"<strong>C</strong>laude Monet\",\n\t *     id: undefined,\n\t *     title: \"Claude Monet\",\n\t *     displayTitle: \"<i>Claude Monet</i>\",\n\t *     url: \"/wiki/Claude_Monet\",\n\t *     thumbnail: {\n\t *       height: 62,\n\t *       source: \"http://127.0.0.1:8080/images/thumb/thumb.jpg\",\n\t *       width: 80,\n\t *       isLandscape: true\n\t *     }\n\t *   }\n\t * ]\n\t */\n\tdefaults: {\n\t\tpages: []\n\t},\n\t/**\n\t * Render page images for the existing page list. Assumes no page images have been loaded.\n\t * @memberof PageList\n\t * @instance\n\t */\n\trenderPageImages: function () {\n\t\tvar self = this;\n\n\t\tsetTimeout( function () {\n\t\t\tself.$( '.list-thumb' ).each( function () {\n\t\t\t\tvar style = self.$( this ).data( 'style' );\n\t\t\t\tself.$( this ).attr( 'style', style );\n\t\t\t} );\n\t\t\t// Delay an unnecessary load of images on mobile (slower?) connections\n\t\t\t// In particular on search results which can be regenerated quickly.\n\t\t}, browser.isWideScreen() ? 0 : 1000 );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof PageList\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tthis.renderPageImages();\n\t},\n\ttemplate: mw.template.get( 'mobile.startup', 'PageList.hogan' ),\n\t/**\n\t * @memberof PageList\n\t * @instance\n\t */\n\ttemplatePartials: {\n\t\t// The server uses a very different structure in\n\t\t// SpecialMobileEditWatchlist.getLineHtml(). Be aware of these differences\n\t\t// when updating server rendered items.\n\t\titem: mw.template.get( 'mobile.startup', 'PageListItem.hogan' )\n\t}\n} );\n\nmodule.exports = PageList;\n","var\n\tmfExtend = require( './mfExtend' ),\n\tutil = require( './util' ),\n\tView = require( './View' );\n\n/**\n * An abstract class for a {@link View} that comprises a simple panel.\n * @class Panel\n * @extends View\n *\n * @param {Object} [params] Configuration options\n */\nfunction Panel( params ) {\n\tView.call( this, util.extend(\n\t\t{ className: 'panel' },\n\t\tparams,\n\t\t{ events: util.extend( { 'click .cancel': 'onCancel' }, ( params || {} ).events ) } )\n\t);\n}\n\nmfExtend( Panel, View, {\n\t// in milliseconds\n\tminHideDelay: 10,\n\n\t/**\n\t * Cancel event handler\n\t * @memberof Panel\n\t * @instance\n\t * @param {Object} ev Event Object\n\t */\n\tonCancel: function ( ev ) {\n\t\tev.preventDefault();\n\t\tthis.hide();\n\t},\n\n\t/**\n\t * Shows panel after a slight delay\n\t * @memberof Panel\n\t * @instance\n\t * @method\n\t */\n\tshow: function () {\n\t\tvar self = this;\n\n\t\tif ( !self.isVisible() ) {\n\t\t\t// use setTimeout to allow the browser to redraw if render() was called\n\t\t\t// just before show(); this is important for animations to work\n\t\t\t// (0ms doesn't work on Firefox, 10ms is enough)\n\t\t\t//\n\t\t\t// FIXME: setTimeout should be reconsidered in T209129\n\t\t\tsetTimeout( function () {\n\t\t\t\tself.$el.addClass( 'visible animated' );\n\t\t\t\tself.emit( 'show' );\n\t\t\t}, self.minHideDelay );\n\t\t}\n\t},\n\n\t/**\n\t * Hides panel\n\t * @memberof Panel\n\t * @instance\n\t */\n\thide: function () {\n\t\tvar self = this;\n\n\t\t// see comment in show()\n\t\tsetTimeout( function () {\n\t\t\tself.$el.removeClass( 'visible' );\n\t\t\tself.emit( 'hide' );\n\t\t}, self.minHideDelay );\n\t},\n\n\t/**\n\t * Determines if panel is visible\n\t * @memberof Panel\n\t * @instance\n\t * @return {boolean} Panel is visible\n\t */\n\tisVisible: function () {\n\t\treturn this.$el.hasClass( 'visible' );\n\t},\n\n\t/**\n\t * Shows or hides panel\n\t * @memberof Panel\n\t * @instance\n\t */\n\ttoggle: function () {\n\t\tif ( this.isVisible() ) {\n\t\t\tthis.hide();\n\t\t} else {\n\t\t\tthis.show();\n\t\t}\n\t}\n} );\n\nmodule.exports = Panel;\n","var util = require( './util' ),\n\tmfExtend = require( './mfExtend' );\n\n/**\n * Class to assist a view in implementing infinite scrolling on some DOM\n * element. This module itself is only responsible for emitting an Event when\n * the bottom of an Element is scrolled to.\n *\n * @class ScrollEndEventEmitter\n * @mixins OO.EventEmitter\n *\n * Use this class in a view to help it do infinite scrolling.\n *\n * 1. Initialize it in the constructor `initialize` and listen to the\n *   EVENT_SCROLL_END event it emits (and call your loading function then)\n * 2. On preRender (once we have the DOM element) set it into the infinite\n *   scrolling object and disable it until we've loaded.\n * 3. Once you have loaded the list and put it in the DOM, enable the\n *   infinite scrolling detection.\n *   * Everytime the scroller detection triggers a load, it auto disables\n *     to not trigger multiple times. After you have loaded, manually\n *     re-enable it.\n *\n * Example:\n *     @example\n *     <code>\n *       var\n *         mfExtend = require( './mfExtend' ),\n *         ScrollEndEventEmitter = require( './ScrollEndEventEmitter' ),\n *         eventBus = require( './eventBusSingleton' );\n *       mfExtend( PhotoList, View, {\n *         //...\n *         initialize: function ( options ) {\n *           this.gateway = new PhotoListGateway( {\n *             username: options.username\n *           } );\n *           // 1. Set up infinite scroll helper and listen to events\n *           this.scrollEndEventEmitter = new ScrollEndEventEmitter( eventBus, 1000 );\n *           this.scrollEndEventEmitter.on( ScrollEndEventEmitter.EVENT_SCROLL_END,\n *             this._loadPhotos.bind( this ) );\n *           View.prototype.initialize.apply( this, arguments );\n *         },\n *         preRender: function () {\n *           // 2. Disable until we've got the list rendered and set DOM el\n *           this.scrollEndEventEmitter.setElement( this.$el );\n *           this.scrollEndEventEmitter.disable();\n *         },\n *         _loadPhotos: function () {\n *           var self = this;\n *           this.gateway.getPhotos().then( function ( photos ) {\n *             // load photos into the DOM ...\n *             // 3. and (re-)enable infinite scrolling\n *             self.scrollEndEventEmitter.enable();\n *           } );\n *         }\n *       } );\n *     </code>\n *\n * @fires ScrollEndEventEmitter#ScrollEndEventEmitter-scrollEnd\n * @param {Object} eventBus object to listen for scroll:throttled events\n * @param {number} [threshold=100] distance in pixels used to calculate if scroll\n * position is near the end of the $el\n */\nfunction ScrollEndEventEmitter( eventBus, threshold ) {\n\tthis.threshold = threshold || 100;\n\tthis.eventBus = eventBus;\n\tthis.enable();\n\tOO.EventEmitter.call( this );\n}\nOO.mixinClass( ScrollEndEventEmitter, OO.EventEmitter );\n\n/**\n * Fired when scroll bottom has been reached.\n * @event ScrollEndEventEmitter#ScrollEndEventEmitter-scrollEnd\n */\nScrollEndEventEmitter.EVENT_SCROLL_END = 'ScrollEndEventEmitter-scrollEnd';\n\nmfExtend( ScrollEndEventEmitter, {\n\t/**\n\t * Listen to scroll on window and notify this._onScroll\n\t * @memberof ScrollEndEventEmitter\n\t * @instance\n\t * @private\n\t */\n\t_bindScroll: function () {\n\t\tif ( !this._scrollHandler ) {\n\t\t\tthis._scrollHandler = this._onScroll.bind( this );\n\t\t\tthis.eventBus.on( 'scroll:throttled', this._scrollHandler );\n\t\t}\n\t},\n\t/**\n\t * Unbind scroll handler\n\t * @memberof ScrollEndEventEmitter\n\t * @instance\n\t * @private\n\t */\n\t_unbindScroll: function () {\n\t\tif ( this._scrollHandler ) {\n\t\t\tthis.eventBus.off( 'scroll:throttled', this._scrollHandler );\n\t\t\tthis._scrollHandler = null;\n\t\t}\n\t},\n\t/**\n\t * Scroll handler. Triggers load event when near the end of the container.\n\t * @memberof ScrollEndEventEmitter\n\t * @instance\n\t * @private\n\t */\n\t_onScroll: function () {\n\t\tif ( this.$el && this.enabled && this.scrollNearEnd() ) {\n\t\t\t// Disable when triggering an event. Won't trigger again until\n\t\t\t// re-enabled.\n\t\t\tthis.disable();\n\t\t\tthis.emit( ScrollEndEventEmitter.EVENT_SCROLL_END );\n\t\t}\n\t},\n\t/**\n\t * Is the scroll position near the end of the container element?\n\t * @memberof ScrollEndEventEmitter\n\t * @instance\n\t * @private\n\t * @return {boolean}\n\t */\n\tscrollNearEnd: function () {\n\t\tvar $window = util.getWindow(),\n\t\t\tscrollBottom = $window.scrollTop() + $window.height(),\n\t\t\tendPosition = this.$el.offset().top + this.$el.outerHeight();\n\t\treturn scrollBottom + this.threshold > endPosition;\n\t},\n\t/**\n\t * Enable the ScrollEndEventEmitter so that it triggers events.\n\t * @memberof ScrollEndEventEmitter\n\t * @instance\n\t */\n\tenable: function () {\n\t\tthis.enabled = true;\n\t\tthis._bindScroll();\n\t},\n\t/**\n\t * Disable the ScrollEndEventEmitter so that it doesn't trigger events.\n\t * @memberof ScrollEndEventEmitter\n\t * @instance\n\t */\n\tdisable: function () {\n\t\tthis.enabled = false;\n\t\tthis._unbindScroll();\n\t},\n\t/**\n\t * Set the element to compare to scroll position to\n\t * @memberof ScrollEndEventEmitter\n\t * @instance\n\t * @param {jQuery.Object} $el jQuery element where we want to listen for\n\t * scroll end.\n\t */\n\tsetElement: function ( $el ) {\n\t\tthis.$el = $el;\n\t}\n} );\n\nmodule.exports = ScrollEndEventEmitter;\n","var\n\tmfExtend = require( './mfExtend' ),\n\ticons = require( './icons' ),\n\tView = require( './View' );\n\n/**\n * Builds a section of a page\n * @class Section\n * @extends View\n *\n * @param {Object} options Configuration options\n */\nfunction Section( options ) {\n\tvar self = this;\n\toptions.tag = 'h' + options.level;\n\tthis.line = options.line;\n\tthis.text = options.text;\n\tthis.hasReferences = options.hasReferences || false;\n\tthis.id = options.id || null;\n\tthis.anchor = options.anchor;\n\tthis.subsections = [];\n\t( options.subsections || [] ).forEach( function ( section ) {\n\t\tself.subsections.push( new Section( section ) );\n\t} );\n\tView.call( this, options );\n}\n\nmfExtend( Section, View, {\n\ttemplate: mw.template.get( 'mobile.startup', 'Section.hogan' ),\n\t/**\n\t * @memberof Section\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} defaults.text Section text.\n\t * @property {string} defaults.spinner HTML of the spinner icon.\n\t */\n\tdefaults: {\n\t\tline: undefined,\n\t\ttext: '',\n\t\tspinner: icons.spinner().toHtmlString()\n\t}\n} );\n\nmodule.exports = Section;\n","var\n\tmfExtend = require( './mfExtend' ),\n\tutil = require( './util' ),\n\tView = require( './View' );\n\n/**\n * Representation of a thumbnail\n *\n * @class Thumbnail\n * @extends View\n * @param {Object} options\n */\nfunction Thumbnail( options ) {\n\tView.call( this,\n\t\tutil.extend( { isBorderBox: false }, options )\n\t);\n}\n\nmfExtend( Thumbnail, View, {\n\t/**\n\t * @memberof Thumbnail\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} defaults.filename uri decoded filename including File: prefix\n\t *  associated with thumbnail\n\t */\n\tdefaults: {\n\t\tfilename: undefined\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof Thumbnail\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tthis.options.description = this.$el.siblings( '.thumbcaption' ).text();\n\t},\n\t/**\n\t * Obtain description for thumbnail\n\t * @memberof Thumbnail\n\t * @instance\n\t * @return {string}\n\t */\n\tgetDescription: function () {\n\t\treturn this.options.description;\n\t},\n\t/**\n\t * Return the page title for the thumbnail\n\t * @memberof Thumbnail\n\t * @instance\n\t * @return {string}\n\t */\n\tgetFileName: function () {\n\t\treturn this.options.filename;\n\t}\n} );\n\nmodule.exports = Thumbnail;\n","var browser = require( './Browser' ).getSingleton(),\n\tutil = require( './util' ),\n\tescapeHash = util.escapeHash,\n\tarrowOptions = {\n\t\tname: 'arrow',\n\t\tadditionalClassNames: 'indicator'\n\t},\n\tIcon = require( './Icon' );\n\n/**\n *\n * @typedef {Object} ToggledEvent\n * @prop {boolean} expanded True if section is opened, false if closed.\n * @prop {Page} page\n * @prop {boolean} isReferenceSection\n * @prop {JQuery.Object} $heading\n */\n\n/**\n * A class for enabling toggling\n *\n * @class Toggler\n * @param {Object} options\n * @param {OO.EventEmitter} options.eventBus Object used to emit section-toggled events.\n * @param {jQuery.Object} options.$container to apply toggling to\n * @param {string} options.prefix a prefix to use for the id.\n * @param {Page} [options.page] to allow storage of session for future visits\n * @param {Page} [options.isClosed]\n */\nfunction Toggler( options ) {\n\tthis.eventBus = options.eventBus;\n\tthis._enable( options.$container, options.prefix, options.page, options.isClosed );\n}\n\n/**\n * Using the settings module looks at what sections were previously expanded on\n * existing page.\n *\n * @param {Page} page\n * @return {Object} representing open sections\n */\nfunction getExpandedSections( page ) {\n\tvar expandedSections = JSON.parse( mw.storage.get( 'expandedSections' ) || '{}' );\n\texpandedSections[page.title] = expandedSections[page.title] || {};\n\treturn expandedSections;\n}\n\n/**\n* @param {Object} expandedSections\n* Save expandedSections to localStorage\n*/\nfunction saveExpandedSections( expandedSections ) {\n\tmw.storage.set(\n\t\t'expandedSections', JSON.stringify( expandedSections )\n\t);\n}\n\n/**\n * Given an expanded heading, store it to localStorage.\n * If the heading is collapsed, remove it from localStorage.\n *\n * @param {jQuery.Object} $heading - A heading belonging to a section\n * @param {Page} page\n */\nfunction storeSectionToggleState( $heading, page ) {\n\tvar headline = $heading.find( 'span' ).attr( 'id' ),\n\t\tisSectionOpen = $heading.hasClass( 'open-block' ),\n\t\texpandedSections = getExpandedSections( page );\n\n\tif ( headline ) {\n\t\tif ( isSectionOpen ) {\n\t\t\texpandedSections[page.title][headline] = ( new Date() ).getTime();\n\t\t} else {\n\t\t\tdelete expandedSections[page.title][headline];\n\t\t}\n\n\t\tsaveExpandedSections( expandedSections );\n\t}\n}\n\n/**\n * Expand sections that were previously expanded before leaving this page.\n * @param {Toggler} toggler\n * @param {jQuery.Object} $container\n * @param {Page} page\n */\nfunction expandStoredSections( toggler, $container, page ) {\n\tvar $sectionHeading, $headline,\n\t\texpandedSections = getExpandedSections( page ),\n\t\t$headlines = $container.find( '.section-heading span' );\n\n\t$headlines.each( function () {\n\t\t$headline = $container.find( this );\n\t\t$sectionHeading = $headline.parents( '.section-heading' );\n\t\t// toggle only if the section is not already expanded\n\t\tif (\n\t\t\texpandedSections[page.title][$headline.attr( 'id' )] &&\n\t\t!$sectionHeading.hasClass( 'open-block' )\n\t\t) {\n\t\t\ttoggler.toggle( $sectionHeading, page );\n\t\t}\n\t} );\n}\n\n/**\n * Clean obsolete (saved more than a day ago) expanded sections from\n * localStorage.\n * @param {Page} page\n */\nfunction cleanObsoleteStoredSections( page ) {\n\tvar now = ( new Date() ).getTime(),\n\t\texpandedSections = getExpandedSections( page ),\n\t\t// the number of days between now and the time a setting was saved\n\t\tdaysDifference;\n\tObject.keys( expandedSections ).forEach( function ( page ) {\n\t\tvar sections = expandedSections[ page ];\n\t\t// clean the setting if it is more than a day old\n\t\tObject.keys( sections ).forEach( function ( section ) {\n\t\t\tvar timestamp = sections[ section ];\n\t\t\tdaysDifference = Math.floor( ( now - timestamp ) / 1000 / 60 / 60 / 24 );\n\t\t\tif ( daysDifference >= 1 ) {\n\t\t\t\tdelete expandedSections[page][section];\n\t\t\t}\n\t\t} );\n\t} );\n\tsaveExpandedSections( expandedSections );\n}\n\n/**\n * Given a heading, toggle it and any of its children\n *\n * @memberof Toggler\n * @instance\n * @param {jQuery.Object} $heading A heading belonging to a section\n */\nToggler.prototype.toggle = function ( $heading ) {\n\tvar indicator,\n\t\twasExpanded = $heading.is( '.open-block' ),\n\t\tpage = $heading.data( 'page' ),\n\t\t$content = $heading.next();\n\n\t$heading.toggleClass( 'open-block' );\n\t$heading.data( 'indicator' ).remove();\n\n\tarrowOptions.rotation = wasExpanded ? 0 : 180;\n\tindicator = new Icon( arrowOptions ).prependTo( $heading );\n\t$heading.data( 'indicator', indicator );\n\n\t$content\n\t\t.toggleClass( 'open-block' )\n\t\t.attr( {\n\t\t\t'aria-pressed': !wasExpanded,\n\t\t\t'aria-expanded': !wasExpanded\n\t\t} );\n\n\t/**\n\t * Global event emitted after a section has been toggled\n\t * @event section-toggled\n\t * @type {ToggledEvent}\n\t */\n\tthis.eventBus.emit( 'section-toggled', {\n\t\texpanded: wasExpanded,\n\t\tpage: page,\n\t\tisReferenceSection: Boolean( $content.attr( 'data-is-reference-section' ) ),\n\t\t$heading: $heading\n\t} );\n\n\tif ( !browser.isWideScreen() ) {\n\t\tstoreSectionToggleState( $heading, page );\n\t}\n};\n\n/**\n * Enables toggling via enter and space keys\n *\n * @param {Toggler} toggler instance.\n * @param {jQuery.Object} $heading\n */\nfunction enableKeyboardActions( toggler, $heading ) {\n\t$heading.on( 'keypress', function ( ev ) {\n\t\tif ( ev.which === 13 || ev.which === 32 ) {\n\t\t\t// Only handle keypresses on the \"Enter\" or \"Space\" keys\n\t\t\ttoggler.toggle( $heading );\n\t\t}\n\t} ).find( 'a' ).on( 'keypress mouseup', function ( ev ) {\n\t\tev.stopPropagation();\n\t} );\n}\n\n/**\n * Reveals an element and its parent section as identified by it's id\n *\n * @memberof Toggler\n * @instance\n * @param {string} selector A css selector that identifies a single element\n * @param {Object} $container jQuery element to search in\n */\nToggler.prototype.reveal = function ( selector, $container ) {\n\tvar $target, $heading;\n\n\t// jQuery will throw for hashes containing certain characters which can break toggling\n\ttry {\n\t\t$target = $container.find( escapeHash( selector ) );\n\t\t$heading = $target.parents( '.collapsible-heading' );\n\t\t// The heading is not a section heading, check if in a content block!\n\t\tif ( !$heading.length ) {\n\t\t\t$heading = $target.parents( '.collapsible-block' ).prev( '.collapsible-heading' );\n\t\t}\n\t\tif ( $heading.length && !$heading.hasClass( 'open-block' ) ) {\n\t\t\tthis.toggle( $heading );\n\t\t}\n\t\tif ( $heading.length ) {\n\t\t\t// scroll again after opening section (opening section makes the page longer)\n\t\t\twindow.scrollTo( 0, $target.offset().top );\n\t\t}\n\t} catch ( e ) {}\n};\n\n/**\n * Enables section toggling in a given container when wgMFCollapseSectionsByDefault\n * is enabled.\n *\n * @memberof Toggler\n * @instance\n * @param {jQuery.Object} $container to apply toggling to\n * @param {string} prefix a prefix to use for the id.\n * @param {Page} [page] to allow storage of session for future visits\n * @param {Page} [isClosed] whether the element should begin closed\n * @private\n */\nToggler.prototype._enable = function ( $container, prefix, page, isClosed ) {\n\tvar tagName, expandSections, indicator, $content,\n\t\t$firstHeading,\n\t\t$link,\n\t\tself = this,\n\t\tcollapseSectionsByDefault = mw.config.get( 'wgMFCollapseSectionsByDefault' );\n\n\t// Also allow .section-heading if some extensions like Wikibase\n\t// want to toggle other headlines than direct descendants of $container.\n\t$firstHeading = $container.find( '> h1,> h2,> h3,> h4,> h5,> h6,.section-heading' ).eq( 0 );\n\ttagName = $firstHeading.prop( 'tagName' ) || 'H1';\n\n\tif ( collapseSectionsByDefault === undefined ) {\n\t\t// Old default behavior if on cached output\n\t\tcollapseSectionsByDefault = true;\n\t}\n\texpandSections = !collapseSectionsByDefault || mw.storage.get( 'expandSections' ) === 'true';\n\n\t$container.children( tagName ).each( function ( i ) {\n\t\tvar isReferenceSection,\n\t\t\t$heading = $container.find( this ),\n\t\t\t$indicator = $heading.find( '.indicator' ),\n\t\t\tid = prefix + 'collapsible-block-' + i;\n\t\t// Be sure there is a div wrapping the section content.\n\t\t// Otherwise, collapsible sections for this page is not enabled.\n\t\tif ( $heading.next().is( 'div' ) ) {\n\t\t\t$content = $heading.next( 'div' );\n\t\t\tisReferenceSection = Boolean( $content.attr( 'data-is-reference-section' ) );\n\t\t\t$heading\n\t\t\t\t.addClass( 'collapsible-heading ' )\n\t\t\t\t.data( 'section-number', i )\n\t\t\t\t.data( 'page', page )\n\t\t\t\t.attr( {\n\t\t\t\t\ttabindex: 0,\n\t\t\t\t\t'aria-haspopup': 'true',\n\t\t\t\t\t'aria-controls': id\n\t\t\t\t} )\n\t\t\t\t.on( 'click', function ( ev ) {\n\t\t\t\t\t// don't toggle, if the click target was a link\n\t\t\t\t\t// (a link in a section heading)\n\t\t\t\t\t// See T117880\n\t\t\t\t\tif ( !ev.target.href ) {\n\t\t\t\t\t\t// prevent taps/clicks on edit button after toggling (bug 56209)\n\t\t\t\t\t\tev.preventDefault();\n\t\t\t\t\t\tself.toggle( $heading );\n\t\t\t\t\t}\n\t\t\t\t} );\n\n\t\t\tarrowOptions.rotation = expandSections ? 180 : 0;\n\t\t\tindicator = new Icon( arrowOptions );\n\t\t\tif ( $indicator.length ) {\n\t\t\t\t// replace the existing indicator\n\t\t\t\t$indicator.replaceWith( indicator.$el );\n\t\t\t} else {\n\t\t\t\tindicator.prependTo( $heading );\n\t\t\t}\n\t\t\t$heading.data( 'indicator', indicator.$el );\n\t\t\t$content\n\t\t\t\t.addClass( 'collapsible-block' )\n\t\t\t\t.eq( 0 )\n\t\t\t\t.attr( {\n\t\t\t\t\t// We need to give each content block a unique id as that's\n\t\t\t\t\t// the only way we can tell screen readers what element we're\n\t\t\t\t\t// referring to (aria-controls)\n\t\t\t\t\tid: id,\n\t\t\t\t\t'aria-pressed': 'false',\n\t\t\t\t\t'aria-expanded': 'false'\n\t\t\t\t} );\n\n\t\t\tenableKeyboardActions( self, $heading );\n\t\t\tif (\n\t\t\t\t!isReferenceSection && (\n\t\t\t\t\t!isClosed && browser.isWideScreen() || expandSections\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\t// Expand sections by default on wide screen devices\n\t\t\t\t// or if the expand sections setting is set.\n\t\t\t\t// The wide screen logic for determining whether to collapse sections initially\n\t\t\t\t// should be kept in sync with mobileoptions#initLocalStorageElements().\n\t\t\t\tself.toggle( $heading );\n\t\t\t}\n\t\t}\n\t} );\n\n\t/* eslint-disable no-restricted-properties */\n\t/**\n\t * Checks the existing hash and toggles open any section that contains the fragment.\n\t *\n\t * @method\n\t */\n\tfunction checkHash() {\n\t\tvar hash = window.location.hash;\n\t\tif ( hash.indexOf( '#' ) === 0 ) {\n\t\t\tself.reveal( hash, $container );\n\t\t}\n\t}\n\n\t/**\n\t * Checks the value of wgInternalRedirectTargetUrl and reveals the collapsed\n\t * section that contains it if present\n\t *\n\t * @method\n\t */\n\tfunction checkInternalRedirectAndHash() {\n\t\tvar internalRedirect = mw.config.get( 'wgInternalRedirectTargetUrl' ),\n\t\t\tinternalRedirectHash = internalRedirect ? internalRedirect.split( '#' )[1] : false;\n\n\t\tif ( internalRedirectHash ) {\n\t\t\twindow.location.hash = internalRedirectHash;\n\t\t\tself.reveal( internalRedirectHash, $container );\n\t\t}\n\t}\n\t/* eslint-enable no-restricted-properties */\n\n\tcheckInternalRedirectAndHash();\n\tcheckHash();\n\t// Restricted to links created by editors and thus outside our control\n\t// T166544 - don't do this for reference links - they will be handled elsewhere\n\t$link = $container.find( 'a:not(.reference a)' );\n\t$link.on( 'click', function () {\n\t\t// the link might be an internal link with a hash.\n\t\t// if it is check if we need to reveal any sections.\n\t\tif ( $link.attr( 'href' ) !== undefined &&\n\t\t$link.attr( 'href' ).indexOf( '#' ) > -1\n\t\t) {\n\t\t\tcheckHash();\n\t\t}\n\t} );\n\tutil.getWindow().on( 'hashchange', function () {\n\t\tcheckHash();\n\t} );\n\n\tif ( !browser.isWideScreen() && page ) {\n\t\texpandStoredSections( this, $container, page );\n\t\tcleanObsoleteStoredSections( page );\n\t}\n};\n\nToggler._getExpandedSections = getExpandedSections;\nToggler._expandStoredSections = expandStoredSections;\nToggler._cleanObsoleteStoredSections = cleanObsoleteStoredSections;\n\nmodule.exports = Toggler;\n","/* global $, document */\nvar util = require( './util' ),\n\tmfExtend = require( './mfExtend' ),\n\t// Cached regex to split keys for `delegate`.\n\tdelegateEventSplitter = /^(\\S+)\\s*(.*)$/,\n\tidCounter = 0;\n\n/**\n * Generate a unique integer id (unique within the entire client session).\n * Useful for temporary DOM ids.\n * @param {string} prefix Prefix to be used when generating the id.\n * @return {string}\n */\nfunction uniqueId( prefix ) {\n\tvar id = ( ++idCounter ).toString();\n\treturn prefix ? prefix + id : id;\n}\n\n/**\n * Should be extended using extend().\n *\n * When options contains el property, this.$el in the constructed object\n * will be set to the corresponding jQuery object. Otherwise, this.$el\n * will be an empty div.\n *\n * When extended using extend(), if the extended prototype contains\n * template property, this.$el will be filled with rendered template (with\n * options parameter used as template data).\n *\n * template property can be a string which will be passed to mw.template.compile()\n * or an object that has a render() function which accepts an object with\n * template data as its argument (similarly to an object created by\n * mw.template.compile()).\n *\n * You can also define a defaults property which should be an object\n * containing default values for the template (if they're not present in\n * the options parameter).\n *\n * If this.$el is not a jQuery object bound to existing DOM element, the\n * view can be attached to an element using appendTo(), prependTo(),\n * insertBefore(), insertAfter() proxy functions.\n *\n * append(), prepend(), before(), after() can be used to modify $el. on()\n * can be used to bind events.\n *\n * You can also use declarative DOM events binding by specifying an `events`\n * map on the class. The keys will be 'event selector' and the value can be\n * either the name of a method to call, or a function. All methods and\n * functions will be executed on the context of the View.\n *\n * Inspired from Backbone.js\n * https://github.com/jashkenas/backbone/blob/master/backbone.js#L1128\n *\n * Example:\n * ```js\n *     var\n *       MyComponent = View.extend( {\n *         edit: function ( ev ) {\n *           //...\n *         },\n *         save: function ( ev ) {\n *           //...\n *         }\n *       } ),\n *       instance = new MyComponent({\n *         events: {\n *           'mousedown .title': 'edit',\n *           'click .button': 'save',\n *           'click .open': function(e) { ... }\n *         }\n *       });\n * ```\n *\n * Example:\n * ```js\n *     var View, section;\n *     function Section( options ) {\n *       var defaultOptions = {\n *         events: {\n *           // ...\n *         }\n *       }\n *       View.call( this, util.extends( {}, defaultOptions, options ) );\n *     }\n *     View = require( './View' );\n *     require( './mfExtend' )( Section, View, {\n *       template: mw.template.compile( \"&lt;h2&gt;{{title}}&lt;/h2&gt;\" ),\n *     } );\n *     section = new Section( { title: 'Test', text: 'Test section body' } );\n *     section.appendTo( 'body' );\n * ```\n *\n * @class View\n * @mixins OO.EventEmitter\n */\n\nfunction View() {\n\tthis.initialize.apply( this, arguments );\n}\nOO.mixinClass( View, OO.EventEmitter );\nmfExtend( View, {\n\t/**\n\t * Name of tag that contains the rendered template\n\t * @memberof View\n\t * @instance\n\t * @property {string} tagName\n\t */\n\ttagName: 'div',\n\t/**\n\t * Tells the View to ignore tagName and className when constructing the element\n\t * and to rely solely on the template\n\t * @memberof View\n\t * @instance\n\t * @property {boolean} isTemplateMode\n\t */\n\tisTemplateMode: false,\n\t/**\n\t * @memberof View\n\t * @instance\n\t * @property {Mixed}\n\t * Specifies the template used in render(). Object|string|HoganTemplate\n\t */\n\ttemplate: undefined,\n\n\t/**\n\t * Specifies partials (sub-templates) for the main template. Example:\n\t *\n\t *     @example\n\t *     // example content for the \"some\" template (sub-template will be\n\t *     // inserted where {{>content}} is):\n\t *     // <h1>Heading</h1>\n\t *     // {{>content}}\n\t *\n\t *     oo.mfExtend( SomeView, View, {\n\t *       template: M.template.get( 'some.hogan' ),\n\t *       templatePartials: { content: M.template.get( 'sub.hogan' ) }\n\t *     }\n\t *\n\t * @memberof View\n\t * @instance\n\t * @property {Object}\n\t */\n\ttemplatePartials: {},\n\n\t/**\n\t * A set of default options that are merged with options passed into the initialize\n\t * function.\n\t * @memberof View\n\t * @instance\n\t * @property {Object} defaults Default options hash.\n\t * @property {jQuery.Object|string} [defaults.el] jQuery selector to use for rendering.\n\t * @property {boolean} [defaults.skipTemplateRender] Whether to enhance views already in\n\t * DOM. When enabled, the template is disabled so that it is not rendered in the DOM.\n\t * Use in conjunction with View::defaults.$el to associate the View with an existing\n\t * already rendered element in the DOM.\n\t */\n\tdefaults: {},\n\n\t/**\n\t * Run once during construction to set up the View\n\t * @memberof View\n\t * @instance\n\t * @param {Object} options Object passed to the constructor.\n\t * @param {Object.<string, string>} [options.events]\n\t */\n\tinitialize: function ( options ) {\n\t\tvar self = this;\n\n\t\tOO.EventEmitter.call( this );\n\t\toptions = util.extend( {}, this.defaults, options );\n\t\tthis.options = options;\n\t\t// Assign a unique id for dom events binding/unbinding\n\t\tthis.cid = uniqueId( 'view' );\n\n\t\t// TODO: if template compilation is too slow, don't compile them on a\n\t\t// per object basis, but don't worry about it now (maybe add cache to\n\t\t// M.template.compile())\n\t\tif ( typeof this.template === 'string' ) {\n\t\t\tthis.template = mw.template.compile( this.template );\n\t\t}\n\n\t\tif ( options.el ) {\n\t\t\t// Note the element may not be in the document so must use global jQuery here\n\t\t\tthis.$el = $( options.el );\n\t\t} else {\n\t\t\tthis.$el = this.parseHTML( '<' + this.tagName + '>' );\n\t\t}\n\n\t\t// Make sure the element is ready to be manipulated\n\t\tif ( this.$el.length ) {\n\t\t\tthis._postInitialize( options );\n\t\t} else {\n\t\t\tutil.docReady( function () {\n\t\t\t\t// Note the element may not be in the document so must use global jQuery here\n\t\t\t\tself.$el = $( options.el );\n\t\t\t\tself._postInitialize( options );\n\t\t\t} );\n\t\t}\n\t},\n\n\t/**\n\t * Called when this.$el is ready.\n\t * @memberof View\n\t * @instance\n\t * @private\n\t * @param {Object} props\n\t */\n\t_postInitialize: function ( props ) {\n\t\tvar\n\t\t\tBORDER_BOX_CLASS = 'view-border-box',\n\t\t\tclassName = props.className;\n\n\t\tthis.$el.addClass( className );\n\t\t// border-box will be added provided this flag is not set\n\t\tif ( props.isBorderBox !== false ) {\n\t\t\tthis.$el.addClass( BORDER_BOX_CLASS );\n\t\t}\n\n\t\tthis.render( {} );\n\t},\n\n\t/**\n\t * Function called before the view is rendered. Can be redefined in\n\t * objects that extend View.\n\t * @memberof View\n\t * @instance\n\t */\n\tpreRender: function () {},\n\n\t/**\n\t * Function called after the view is rendered. Can be redefined in\n\t * objects that extend View.\n\t *\n\t * @memberof View\n\t * @instance\n\t */\n\tpostRender: function () {},\n\n\t// eslint-disable-next-line valid-jsdoc\n\t/**\n\t * Fill this.$el with template rendered using data if template is set.\n\t *\n\t * @memberof View\n\t * @instance\n\t * @param {Object} data Template data. Will be merged into the view's\n\t * options\n\t * @chainable\n\t */\n\trender: function ( data ) {\n\t\tvar $el, html;\n\t\tutil.extend( this.options, data );\n\t\tthis.preRender();\n\t\tthis.undelegateEvents();\n\t\tif ( this.template && !this.options.skipTemplateRender ) {\n\t\t\thtml = this.template.render( this.options, this.templatePartials );\n\t\t\tif ( this.isTemplateMode ) {\n\t\t\t\t$el = $( html );\n\t\t\t\tthis.$el.replaceWith( $el );\n\t\t\t\tthis.$el = $el;\n\t\t\t} else {\n\t\t\t\tthis.$el.html( html );\n\t\t\t}\n\t\t}\n\t\tthis.postRender();\n\t\tthis.delegateEvents();\n\t\treturn this;\n\t},\n\n\t/**\n\t * Wraps this.$el.find, so that you can search for elements in the view's\n\t * ($el's) scope.\n\t *\n\t * @memberof View\n\t * @instance\n\t * @param {string} query A jQuery CSS selector.\n\t * @return {JQuery.Object} jQuery object containing results of the search.\n\t */\n\t$: function ( query ) {\n\t\treturn this.$el.find( query );\n\t},\n\n\t/**\n\t * Set callbacks, where `this.options.events` is a hash of\n\t *\n\t * { 'event selector': 'callback' }\n\t *\n\t * {\n\t *   'mousedown .title': 'edit',\n\t *   'click .button': 'save',\n\t *   'click .open': function(e) { ... }\n\t * }\n\t *\n\t * pairs. Callbacks will be bound to the view, with `this` set properly.\n\t * Uses event delegation for efficiency.\n\t * Omitting the selector binds the event to `this.el`.\n\t *\n\t * @memberof View\n\t * @instance\n\t * @param {Object} events Optionally set this events instead of the ones on this.\n\t */\n\tdelegateEvents: function ( events ) {\n\t\tvar match, key, method;\n\t\tevents = events || this.options.events;\n\t\tif ( events ) {\n\t\t\t// Remove current events before re-binding them\n\t\t\tthis.undelegateEvents();\n\t\t\tfor ( key in events ) {\n\t\t\t\tmethod = events[ key ];\n\t\t\t\t// If the method is a string name of this.method, get it\n\t\t\t\tif ( typeof method !== 'function' ) {\n\t\t\t\t\tmethod = this[ events[ key ] ];\n\t\t\t\t}\n\t\t\t\tif ( method ) {\n\t\t\t\t\t// Extract event and selector from the key\n\t\t\t\t\tmatch = key.match( delegateEventSplitter );\n\t\t\t\t\tthis.delegate( match[ 1 ], match[ 2 ], method.bind( this ) );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * Add a single event listener to the view's element (or a child element\n\t * using `selector`). This only works for delegate-able events: not `focus`,\n\t * `blur`, and not `change`, `submit`, and `reset` in Internet Explorer.\n\t *\n\t * @memberof View\n\t * @instance\n\t * @param {string} eventName\n\t * @param {string} selector\n\t * @param {Function} listener\n\t */\n\tdelegate: function ( eventName, selector, listener ) {\n\t\tthis.$el.on( eventName + '.delegateEvents' + this.cid, selector,\n\t\t\tlistener );\n\t},\n\n\t/**\n\t * Clears all callbacks previously bound to the view by `delegateEvents`.\n\t * You usually don't need to use this, but may wish to if you have multiple\n\t * views attached to the same DOM element.\n\t * @memberof View\n\t * @instance\n\t */\n\tundelegateEvents: function () {\n\t\tif ( this.$el ) {\n\t\t\tthis.$el.off( '.delegateEvents' + this.cid );\n\t\t}\n\t},\n\n\t/**\n\t * A finer-grained `undelegateEvents` for removing a single delegated event.\n\t * `selector` and `listener` are both optional.\n\t *\n\t * @memberof View\n\t * @instance\n\t * @param {string} eventName\n\t * @param {string} selector\n\t * @param {Function} listener\n\t */\n\tundelegate: function ( eventName, selector, listener ) {\n\t\tthis.$el.off( eventName + '.delegateEvents' + this.cid, selector,\n\t\t\tlistener );\n\t},\n\n\t/**\n\t * See parseHTML method of util singleton\n\t *\n\t * @memberof View\n\t * @instance\n\t * @param {string} html to turn into a jQuery object.\n\t * @return {jQuery.Object}\n\t */\n\tparseHTML: function ( html ) {\n\t\t// document is explicitly passed due to a bug we found in Safari 11.1.2 where failure\n\t\t// to use document resulted in an element without access to the documentElement\n\t\t// this should be redundant, but no problem in being explicit (T214451).\n\t\treturn util.parseHTML( html, document );\n\t}\n} );\n\n/**\n * @memberof View\n * @instance\n * @func append\n * @param {...(string|Node|Node[]|JQuery)} contents\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func append\n * @param {function(number, string): string|Node|Node[]|JQuery} contents\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func prepend\n * @param {...(string|Node|Node[]|JQuery)} contents\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func prepend\n * @param {function(number, string): string|Node|Node[]|JQuery} contents\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func appendTo\n * @param {string|Node|Node[]|JQuery} target\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func prependTo\n * @param {string|Node|Node[]|JQuery} target\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func after\n * @param {...(string|Node|Node[]|JQuery)} contents\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func after\n * @param {function(number, string): string|Node|Node[]|JQuery} contents\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func before\n * @param {...(string|Node|Node[]|JQuery)} contents\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func before\n * @param {function(number, string): string|Node|Node[]|JQuery} contents\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func insertAfter\n * @param {string|Node|Node[]|JQuery} target\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func insertBefore\n * @param {string|Node|Node[]|JQuery} target\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func remove\n * @param {string} [selector]\n * @return {this}\n */\n\n/**\n * @memberof View\n * @instance\n * @func detach\n * @param {string} [selector]\n * @return {this}\n */\n\n[\n\t'append',\n\t'prepend',\n\t'appendTo',\n\t'prependTo',\n\t'after',\n\t'before',\n\t'insertAfter',\n\t'insertBefore',\n\t'remove',\n\t'detach'\n].forEach( function ( prop ) {\n\tView.prototype[prop] = function () {\n\t\tthis.$el[prop].apply( this.$el, arguments );\n\t\treturn this;\n\t};\n} );\n\nmodule.exports = View;\n","var util = require( './util' ),\n\tdefaultParams = {\n\t\taction: 'query',\n\t\tformatversion: 2\n\t};\n\n/**\n * Extends the default params for an action query with otherParams\n * @param {Object} otherParams\n * @return {Object}\n */\nfunction actionParams( otherParams ) {\n\tvar scriptPath = mw.config.get( 'wgMFContentProviderScriptPath' );\n\treturn util.extend( {}, defaultParams, {\n\t\torigin: scriptPath ? '*' : undefined\n\t}, otherParams );\n}\n\nmodule.exports = actionParams;\n","/* This module defines several types of cache classes to use in other\n * modules.\n * The interface, that all types use, is kept synchronous driven by current\n * usage patterns, but will need to be revisited in case usage patterns\n * suggest we need asynchronous caches.\n */\n\n/**\n * In memory cache implementation\n *\n * @class MemoryCache\n */\nfunction MemoryCache() {\n\tthis._cache = {};\n}\n\n/**\n * Retrieve a cached value from a key\n * @memberof MemoryCache\n * @instance\n * @param {string} key\n * @return {Mixed}\n */\nMemoryCache.prototype.get = function ( key ) {\n\treturn this._cache[ key ];\n};\n\n/**\n * Cache a value by key\n * @memberof MemoryCache\n * @instance\n * @param {string} key\n * @param {Mixed} value\n */\nMemoryCache.prototype.set = function ( key, value ) {\n\tthis._cache[ key ] = value;\n};\n\n/**\n * Null object cache implementation\n *\n * @class NoCache\n */\nfunction NoCache() { }\n\n/**\n * NoOp\n * @memberof NoCache\n * @instance\n */\nNoCache.prototype.get = function () { };\n\n/**\n * NoOp\n * @memberof NoCache\n * @instance\n */\nNoCache.prototype.set = function () { };\n\nmodule.exports = {\n\tMemoryCache: MemoryCache,\n\tNoCache: NoCache\n};\n","/**\n * Mobile mode helper class\n *\n * @class context\n * @singleton\n */\nmodule.exports = {\n\t/**\n\t * Gets current mobile mode\n\t * @memberof context\n\t * @instance\n\t * @return {string|null} Name of mode - either `stable` or `beta`. It is `null` if desktop.\n\t */\n\tgetMode: function () {\n\t\treturn mw.config.get( 'wgMFMode' );\n\t}\n};\n","var util = require( './util' ),\n\tactionParams = require( './actionParams.js' );\n\n/**\n * Extends the API query parameters to include those parameters required to also fetch Wikibase\n * descriptions and appropriately sized thumbnail images as well as those required to make a query.\n *\n * This function wraps `util.extend` with some Wikibase-specific configuration\n * variable management\n * but, like `util.extend`, is variadic and so can be used as a replacement for it in search\n * gateways, e.g.\n *\n * ```\n * var params = extendSearchParams(\n *   'nearby',\n *   baseParams,\n *   specializedParams,\n *   moreSpecializedParams\n * );\n * ```\n *\n * @param {string} feature The name of the feature\n * @throws {Error} If `feature` isn't one that shows Wikidata descriptions. See the\n *  `wgMFDisplayWikibaseDescriptions` configuration variable for detail\n * @return {Object}\n */\nfunction extendSearchParams( feature ) {\n\tvar displayWikibaseDescriptions = mw.config.get( 'wgMFDisplayWikibaseDescriptions', {} ),\n\t\tscriptPath = mw.config.get( 'wgMFContentProviderScriptPath' ),\n\t\targs,\n\t\tresult;\n\n\tif ( !Object.prototype.hasOwnProperty.call( displayWikibaseDescriptions, feature ) ) {\n\t\tthrow new Error( '\"' + feature + '\" isn\\'t a feature that shows Wikibase descriptions.' );\n\t}\n\n\t// Construct the arguments for a call to `util.extend`\n\t// such that if it were hand-written, then it\n\t// would look like the following:\n\t//\n\t// ```\n\t// var result = util.extend( {\n\t//   prop: []\n\t// }, params, /* ..., */ mw.config.get( 'wgMFSearchAPIParams' ) );\n\t// ```\n\targs = Array.prototype.slice.call( arguments, 1 );\n\targs.unshift( {\n\t\tprop: []\n\t} );\n\targs.push( mw.config.get( 'wgMFSearchAPIParams' ) );\n\n\tresult = util.extend.apply( {}, args );\n\tresult.prop = result.prop.concat( mw.config.get( 'wgMFQueryPropModules' ) );\n\n\tif ( displayWikibaseDescriptions[feature] ) {\n\t\tif ( result.prop.indexOf( 'description' ) === -1 ) {\n\t\t\tresult.prop.push( 'description' );\n\t\t}\n\t}\n\n\tif ( scriptPath ) {\n\t\t// A foreign api is being accessed! Enable anonymous CORS queries!\n\t\tresult.origin = '*';\n\t}\n\treturn actionParams( result );\n}\nmodule.exports = extendSearchParams;\n","var\n\tCANCEL_GLYPH = 'overlay-close',\n\tIcon = require( './Icon' ),\n\tutil = require( './util' );\n\n/**\n * A set of shared icons.\n *\n * Factory methods are used to keep separate features that use the same icons\n * from accidentally manipulating one another's DOM when calling methods like\n * `remove`.\n *\n * @class icons\n * @singleton\n * @uses Icon\n */\nmodule.exports = {\n\tCANCEL_GLYPH: CANCEL_GLYPH,\n\t// Exported to support testing and stubbing\n\tIcon: Icon,\n\t/**\n\t * Gets a cancel icon\n\t *\n\t * The icon should be used to inform the user that the front-end is\n\t * communicating with the back-end.\n\t * @memberof icons\n\t * @instance\n\t * @param {string} variant\n\t * @return {Icon}\n\t */\n\tcancel: function ( variant ) {\n\t\tvar glyph = variant ? CANCEL_GLYPH + '-' + variant : CANCEL_GLYPH;\n\t\treturn new this.Icon( {\n\t\t\ttagName: 'button',\n\t\t\tname: glyph,\n\t\t\tadditionalClassNames: 'cancel',\n\t\t\tlabel: mw.msg( 'mobile-frontend-overlay-close' )\n\t\t} );\n\t},\n\t/**\n\t * Gets a spinner icon.\n\t *\n\t * The icon should be used to inform the user that the front-end is\n\t * communicating with the back-end.\n\t * @memberof icons\n\t * @instance\n\t * @param {Object} [options] See `Icon` for more details\n\t * @return {Icon}\n\t */\n\tspinner: function ( options ) {\n\t\toptions = options || {};\n\n\t\treturn new this.Icon( util.extend( options, {\n\t\t\tname: 'spinner',\n\t\t\tlabel: mw.msg( 'mobile-frontend-loading-message' ),\n\t\t\tadditionalClassNames: 'spinner loading'\n\t\t} ) );\n\t},\n\t/**\n\t * Gets a non-filled watch star icon.\n\t *\n\t * @memberof icons\n\t * @instance\n\t * @return {Icon}\n\t */\n\twatchIcon: function () {\n\t\treturn new this.Icon( {\n\t\t\tname: 'watch',\n\t\t\tadditionalClassNames: 'watch-this-article'\n\t\t} );\n\t},\n\t/**\n\t * Gets a filled watch star icon.\n\t *\n\t * @memberof icons\n\t * @instance\n\t * @return {Icon}\n\t */\n\twatchedIcon: function () {\n\t\treturn new this.Icon( {\n\t\t\tname: 'watched',\n\t\t\tadditionalClassNames: 'watch-this-article watched'\n\t\t} );\n\t}\n};\n","var\n\tutil = require( '../util' ),\n\tplaceholderClass = 'lazy-image-placeholder';\n\n/**\n * @param {HTMLElement} root\n * @return {HTMLElement[]}\n */\nfunction queryPlaceholders( root ) {\n\treturn Array.prototype.slice.call(\n\t\troot.getElementsByClassName( placeholderClass )\n\t);\n}\n\n/**\n * Load an image on demand\n * @param {HTMLElement[]} placeholders a list of images that have not been loaded.\n * @return {JQuery.Deferred}\n */\nfunction loadImages( placeholders ) {\n\t// jQuery.when() is variadic and does not accept an array. Simulate spread with apply.\n\treturn util.when.apply( util, placeholders.map( function ( placeholder ) {\n\t\treturn module.exports.loadImage( placeholder ).promise;\n\t} )\n\t);\n}\n\n/**\n * Load an image on demand\n * @param {HTMLElement} placeholder\n * @return {{promise: JQuery.Deferred<'load'|'error'>, image: HTMLImageElement}}\n */\nfunction loadImage( placeholder ) {\n\tvar\n\t\tdeferred = util.Deferred(),\n\t\t// data-width and height are attributes and do not specify dimension.\n\t\twidth = placeholder.dataset.width || '0',\n\t\theight = placeholder.dataset.height || '0',\n\t\timage = new Image( parseInt( width, 10 ), parseInt( height, 10 ) );\n\n\timage.className = placeholder.dataset.class || '';\n\timage.alt = placeholder.dataset.alt || '';\n\timage.style.cssText = placeholder.style.cssText || '';\n\n\t// When the image has loaded\n\timage.addEventListener( 'load', function () {\n\t\t// Swap the HTML inside the placeholder (to keep the layout and\n\t\t// dimensions the same and not trigger layouts\n\t\timage.classList.add( 'image-lazy-loaded' );\n\t\tif ( placeholder.parentNode ) {\n\t\t\tplaceholder.parentNode.replaceChild( image, placeholder );\n\t\t}\n\t\tdeferred.resolve( 'load' );\n\t}, { once: true } );\n\timage.addEventListener( 'error', function () {\n\t\t// Never reject. Quietly resolve so that jQuery.when() awaits for all Deferreds to complete.\n\t\t// Reevaluate using Deferred.reject in T136693.\n\t\tdeferred.resolve( 'error' );\n\t}, { once: true } );\n\n\t// Trigger image download after binding the load handler\n\timage.src = placeholder.dataset.src || '';\n\timage.srcset = placeholder.dataset.srcset || '';\n\n\treturn {\n\t\tpromise: deferred,\n\t\timage: image\n\t};\n}\n\nmodule.exports = {\n\tqueryPlaceholders: queryPlaceholders,\n\tloadImages: loadImages,\n\tloadImage: loadImage,\n\ttest: {\n\t\tplaceholderClass: placeholderClass\n\t}\n};\n","var\n\tlazyImageLoader = require( './lazyImages/lazyImageLoader' ),\n\tutil = require( './util' ),\n\tPage = require( './Page' ),\n\tDeferred = util.Deferred,\n\ticons = require( './icons' ),\n\tspinner = icons.spinner();\n\n/**\n * Load the references section content from API if it's not already loaded.\n *\n * All references tags content will be loaded per section.\n * @param {OO.EventEmitter} eventBus\n * @param {ToggledEvent} data Information about the section.\n * @param {ReferencesGateway} gateway\n * @param {Page} page\n * @return {jQuery.Promise|void} rejected when not a reference section.\n */\nfunction loadReferences( eventBus, data, gateway, page ) {\n\tvar $content, $spinner;\n\n\t// If the section was expanded before toggling, do not load anything as\n\t// section is being collapsed now.\n\t// Also return early if lazy loading is not required or the section is\n\t// not a reference section\n\tif (\n\t\tdata.expanded ||\n\t\t!data.isReferenceSection\n\t) {\n\t\treturn;\n\t}\n\n\t$content = data.$heading.next();\n\n\tfunction loadImagesAndSetData() {\n\t\t// lazy load images if any\n\t\tlazyImageLoader.loadImages( lazyImageLoader.queryPlaceholders( $content[0] ) );\n\t\t// Do not attempt further loading even if we're unable to load this time.\n\t\t$content.data( 'are-references-loaded', 1 );\n\t}\n\n\tif ( !$content.data( 'are-references-loaded' ) ) {\n\t\t$content.children().addClass( 'hidden' );\n\t\t$spinner = spinner.$el.prependTo( $content );\n\n\t\t// First ensure we retrieve all of the possible lists\n\t\treturn gateway.getReferencesLists( data.page )\n\t\t\t.then( function () {\n\t\t\t\tvar lastId;\n\n\t\t\t\t$content.find( '.mf-lazy-references-placeholder' ).each( function () {\n\t\t\t\t\tvar refListIndex = 0,\n\t\t\t\t\t\t$placeholder = $content.find( this ),\n\t\t\t\t\t\t// search for id of the collapsible heading\n\t\t\t\t\t\tid = getSectionId( $placeholder );\n\n\t\t\t\t\tif ( lastId !== id ) {\n\t\t\t\t\t\t// If the placeholder belongs to a new section reset index\n\t\t\t\t\t\trefListIndex = 0;\n\t\t\t\t\t\tlastId = id;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// otherwise increment it\n\t\t\t\t\t\trefListIndex++;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( id ) {\n\t\t\t\t\t\tgateway.getReferencesList( data.page, id )\n\t\t\t\t\t\t\t.then( function ( refListElements ) {\n\t\t\t\t\t\t\t\t// Note if no section html is provided\n\t\t\t\t\t\t\t\t// no substitution will happen\n\t\t\t\t\t\t\t\t// so user is forced to rely on placeholder link.\n\t\t\t\t\t\t\t\tif ( refListElements && refListElements[refListIndex] ) {\n\t\t\t\t\t\t\t\t\t$placeholder.replaceWith(\n\t\t\t\t\t\t\t\t\t\trefListElements[refListIndex]\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} );\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t\t// Show the section now the references lists have been placed.\n\t\t\t\t$spinner.remove();\n\t\t\t\t$content.children().removeClass( 'hidden' );\n\t\t\t\t/**\n\t\t\t\t * Fired when references list is loaded into the HTML\n\t\t\t\t * @event references-loaded\n\t\t\t\t */\n\t\t\t\teventBus.emit( 'references-loaded', page );\n\n\t\t\t\tloadImagesAndSetData();\n\t\t\t}, function () {\n\t\t\t\t$spinner.remove();\n\t\t\t\t// unhide on a failure\n\t\t\t\t$content.children().removeClass( 'hidden' );\n\n\t\t\t\tloadImagesAndSetData();\n\t\t\t} );\n\t} else {\n\t\treturn Deferred().reject().promise();\n\t}\n}\n\n/**\n * Get the id of the section $el belongs to.\n * @param {jQuery.Object} $el\n * @return {string|null} either the anchor (id attribute of the section heading\n *  or null if none found)\n */\nfunction getSectionId( $el ) {\n\tvar id,\n\t\thSelector = Page.HEADING_SELECTOR,\n\t\t$parent = $el.parent(),\n\t\t// e.g. matches Subheading in\n\t\t// <h2>H</h2><div><h3 id=\"subheading\">Subh</h3><a class=\"element\"></a></div>\n\t\t$heading = $el.prevAll( hSelector ).eq( 0 );\n\n\tif ( $heading.length ) {\n\t\tid = $heading.find( '.mw-headline' ).attr( 'id' );\n\t\tif ( id ) {\n\t\t\treturn id;\n\t\t}\n\t}\n\tif ( $parent.length ) {\n\t\t// if we couldnt find a sibling heading, check the sibling of the parents\n\t\t// consider <div><h2 /><div><$el/></div></div>\n\t\treturn getSectionId( $parent );\n\t} else {\n\t\treturn null;\n\t}\n}\n\nmodule.exports = {\n\tloadReferences: loadReferences,\n\ttest: {\n\t\tgetSectionId: getSectionId\n\t}\n};\n","var\n\ticons = require( './icons' ),\n\tOverlay = require( './Overlay' );\n\n/**\n * Overlay that initially shows loading animation until\n * caller hides it with .hide()\n *\n * @return {Overlay}\n */\nfunction loadingOverlay() {\n\tvar overlay = new Overlay( {\n\t\tclassName: 'overlay overlay-loading',\n\t\tnoHeader: true\n\t} );\n\ticons.spinner().$el.appendTo( overlay.$( '.overlay-content' ) );\n\treturn overlay;\n}\n\nmodule.exports = loadingOverlay;\n","/**\n * Extends a class with new methods and member properties.\n *\n * @param {Function} Child function\n * @param {Object|Function} ParentOrPrototype class to inherit from\n *  OR if no inheriting class a prototype to extend the class with\n * @param {Object} [prototype]\n */\nfunction mfExtend( Child, ParentOrPrototype, prototype ) {\n\tvar key;\n\tif ( prototype ) {\n\t\tOO.inheritClass( Child, ParentOrPrototype );\n\t} else {\n\t\tOO.initClass( Child );\n\t\tprototype = ParentOrPrototype;\n\t}\n\tfor ( key in prototype ) {\n\t\tChild.prototype[key] = prototype[key];\n\t}\n}\n\nmodule.exports = mfExtend;\n","/**\n * Class for managing modules\n *\n * A module in this context is essentially a Javascript class (not to be confused with\n * ResourceLoader modules).\n *\n * @class ModuleLoader\n */\nfunction ModuleLoader() {\n\t/**\n\t * @property {Object} register of defined modules\n\t * @private\n\t */\n\tthis._register = {};\n}\n\nModuleLoader.prototype = {\n\t/**\n\t * Require (import) a module previously defined using define().\n\t * Searches core module registry using mw.loader.require before consulting\n\t * its own local registry. This method is deprecated, please do not use.\n\t * @memberof ModuleLoader\n\t * @instance\n\t * @param {string} id Required module id.\n\t * @return {Object} Required module, can be any JavaScript object.\n\t */\n\trequire: function ( id ) {\n\t\tvar module, args,\n\t\t\tregistry = this._register;\n\n\t\t/**\n\t\t * @return {Object} Module\n\t\t */\n\t\tfunction localRequire() {\n\t\t\tif ( !Object.hasOwnProperty.call( registry, id ) ) {\n\t\t\t\tthrow new Error( 'MobileFrontend Module not found: ' + id );\n\t\t\t}\n\t\t\treturn registry[ id ];\n\t\t}\n\t\targs = id.split( '/' );\n\t\ttry {\n\t\t\tmodule = mw.loader.require( args[0] );\n\t\t\tif ( module[ args[1] ] ) {\n\t\t\t\treturn module[ args[1] ];\n\t\t\t} else {\n\t\t\t\treturn localRequire();\n\t\t\t}\n\t\t} catch ( e ) {\n\t\t\treturn localRequire();\n\t\t}\n\t},\n\n\t/**\n\t * Define a module which can be later required (imported) using require().\n\t * @memberof ModuleLoader\n\t * @instance\n\t * @param {string} id Defined module id.\n\t * @param {Object} obj Defined module body, can be any JavaScript object.\n\t * @return {Object}\n\t */\n\tdefine: function ( id, obj ) {\n\t\tvar self = this;\n\n\t\tif ( Object.hasOwnProperty.call( this._register, id ) ) {\n\t\t\tthrow new Error( 'Module already exists: ' + id );\n\t\t}\n\t\tthis._register[ id ] = obj;\n\t\t// return an object of additionally functions to do with the registered module\n\t\treturn {\n\t\t\t/**\n\t\t\t * @see ModuleLoader#deprecate\n\t\t\t * @param {string} deprecatedId Defined module id, which is deprecated.\n\t\t\t * @ignore\n\t\t\t */\n\t\t\tdeprecate: function ( deprecatedId ) {\n\t\t\t\tself.deprecate( deprecatedId, obj, id );\n\t\t\t}\n\t\t};\n\t},\n\n\t/**\n\t * Deprecate a module and give an replacement (if there is any).\n\t * @memberof ModuleLoader\n\t * @instance\n\t * @param {string} id Defined module id, which is deprecated.\n\t * @param {Object} obj Defined module body, can be any JavaScript object.\n\t * @param {string} [replacement] Give an optional replacement for this module (which\n\t * needs to be already defined!)\n\t */\n\tdeprecate: function ( id, obj, replacement ) {\n\t\tvar msg;\n\t\tif ( replacement ) {\n\t\t\t// add an alternative for this module, if any given\n\t\t\tmsg = 'Use ' + replacement + ' instead.';\n\t\t}\n\t\t// register it as a deprecated one\n\t\tmw.log.deprecate( this._register, id, obj, msg );\n\t}\n};\n\nmodule.exports = ModuleLoader;\n","var\n\tloadingOverlay = require( './loadingOverlay' ),\n\tutil = require( './util' );\n\n/**\n * Utility library for looking up details on the current user\n * @class loader\n * @singleton\n */\nmodule.exports = {\n\t// Exported to support testing and stubbing\n\tnewLoadingOverlay: function () {\n\t\treturn loadingOverlay();\n\t},\n\t/**\n\t * Loads a module via ResourceLoader\n\t * and displays a full screen LoadingOverlay during load time.\n\t * @memberof loader\n\t * @instance\n\t * @param {string} name ResourceLoader module name to load asynchronously.\n\t * @param {boolean} delegateHide if true the caller is responsible for hiding\n\t *  the intermediate loader.\n\t * @param {boolean} [showLoadingOverlay] if false a loading overlay will be hidden while\n\t *  loading the module. Defaults to true.\n\t * @return {jQuery.Promise}\n\t */\n\tloadModule: function ( name, delegateHide, showLoadingOverlay ) {\n\t\tvar loadingOverlay = this.newLoadingOverlay();\n\n\t\tshowLoadingOverlay = ( showLoadingOverlay !== undefined ) ? showLoadingOverlay : true;\n\t\tif ( showLoadingOverlay ) {\n\t\t\tloadingOverlay.appendTo( document.body );\n\t\t\tloadingOverlay.show();\n\t\t}\n\n\t\tfunction hideOverlayIfNeeded() {\n\t\t\tif ( !delegateHide && showLoadingOverlay ) {\n\t\t\t\tloadingOverlay.hide();\n\t\t\t}\n\t\t}\n\t\treturn mw.loader.using( name ).then( function () {\n\t\t\thideOverlayIfNeeded();\n\n\t\t\treturn loadingOverlay;\n\t\t}, function () {\n\t\t\thideOverlayIfNeeded();\n\n\t\t\treturn util.Deferred().reject().promise();\n\t\t} );\n\t}\n};\n","var\n\tPage = require( '../Page' ),\n\tutil = require( '../util' ),\n\textendSearchParams = require( '../extendSearchParams' );\n\n/**\n * @class SearchGateway\n * @uses mw.Api\n * @param {mw.Api} api\n */\nfunction SearchGateway( api ) {\n\tthis.api = api;\n\tthis.searchCache = {};\n\tthis.generator = mw.config.get( 'wgMFSearchGenerator' );\n}\n\nSearchGateway.prototype = {\n\t/**\n\t * The namespace to search in.\n\t * @memberof SearchGateway\n\t * @instance\n\t * @type {number}\n\t */\n\tsearchNamespace: 0,\n\n\t/**\n\t * Get the data used to do the search query api call.\n\t * @memberof SearchGateway\n\t * @instance\n\t * @param {string} query to search for\n\t * @return {Object}\n\t */\n\tgetApiData: function ( query ) {\n\t\tvar prefix = this.generator.prefix,\n\t\t\tdata = extendSearchParams( 'search', {\n\t\t\t\tgenerator: this.generator.name\n\t\t\t} );\n\n\t\tdata.redirects = '';\n\n\t\tdata['g' + prefix + 'search'] = query;\n\t\tdata['g' + prefix + 'namespace'] = this.searchNamespace;\n\t\tdata['g' + prefix + 'limit'] = 15;\n\n\t\t// If PageImages is being used configure further.\n\t\tif ( data.pilimit ) {\n\t\t\tdata.pilimit = 15;\n\t\t\tdata.pithumbsize = mw.config.get( 'wgMFThumbnailSizes' ).tiny;\n\t\t}\n\t\treturn data;\n\t},\n\n\t/**\n\t * Escapes regular expression wildcards (metacharacters) by adding a \\\\ prefix\n\t * @memberof SearchGateway\n\t * @instance\n\t * @param {string} str a string\n\t * @return {Object} a regular expression that can be used to search for that str\n\t * @private\n\t */\n\t_createSearchRegEx: function ( str ) {\n\t\t// '\\[' can be unescaped, but leave it balanced with '`]'\n\t\t// eslint-disable-next-line no-useless-escape\n\t\tstr = str.replace( /[-\\[\\]{}()*+?.,\\\\^$|#\\s]/g, '\\\\$&' );\n\t\treturn new RegExp( '^(' + str + ')', 'ig' );\n\t},\n\n\t/**\n\t * Takes a label potentially beginning with term\n\t * and highlights term if it is present with strong\n\t * @memberof SearchGateway\n\t * @instance\n\t * @param {string} label a piece of text\n\t * @param {string} term a string to search for from the start\n\t * @return {string} safe html string with matched terms encapsulated in strong tags\n\t * @private\n\t */\n\t_highlightSearchTerm: function ( label, term ) {\n\t\tlabel = util.parseHTML( '<span>' ).text( label ).html();\n\t\tterm = util.parseHTML( '<span>' ).text( term ).html();\n\n\t\treturn label.replace( this._createSearchRegEx( term ), '<strong>$1</strong>' );\n\t},\n\n\t/**\n\t * Return data used for creating {Page} objects\n\t * @memberof SearchGateway\n\t * @instance\n\t * @param {string} query to search for\n\t * @param {Object} pageInfo from the API\n\t * @return {Object} data needed to create a {Page}\n\t * @private\n\t */\n\t_getPage: function ( query, pageInfo ) {\n\t\tvar page = Page.newFromJSON( pageInfo );\n\n\t\t// If displaytext is set in the generator result (eg. by Wikibase),\n\t\t// use that as display title.\n\t\t// Otherwise default to the page's title.\n\t\t// FIXME: Given that displayTitle could have html in it be safe and just highlight text.\n\t\t// Note that highlightSearchTerm does full HTML escaping before highlighting.\n\t\tpage.displayTitle = this._highlightSearchTerm(\n\t\t\tpageInfo.displaytext ? pageInfo.displaytext : page.title,\n\t\t\tquery\n\t\t);\n\t\tpage.index = pageInfo.index;\n\n\t\treturn page;\n\t},\n\n\t/**\n\t * Process the data returned by the api call.\n\t * @memberof SearchGateway\n\t * @instance\n\t * @param {string} query to search for\n\t * @param {Object} data from api\n\t * @return {Array}\n\t * @private\n\t */\n\t_processData: function ( query, data ) {\n\t\tvar self = this,\n\t\t\tresults = [];\n\n\t\tif ( data.query ) {\n\n\t\t\tresults = data.query.pages || {};\n\t\t\tresults = Object.keys( results ).map( function ( id ) {\n\t\t\t\treturn self._getPage( query, results[ id ] );\n\t\t\t} );\n\t\t\t// sort in order of index\n\t\t\tresults.sort( function ( a, b ) {\n\t\t\t\treturn a.index < b.index ? -1 : 1;\n\t\t\t} );\n\t\t}\n\n\t\treturn results;\n\t},\n\n\t/**\n\t * Perform a search for the given query.\n\t * @memberof SearchGateway\n\t * @instance\n\t * @param {string} query to search for\n\t * @return {jQuery.Deferred}\n\t */\n\tsearch: function ( query ) {\n\t\tvar xhr, request,\n\t\t\tself = this;\n\n\t\tif ( !this.isCached( query ) ) {\n\t\t\txhr = this.api.get( this.getApiData( query ) );\n\t\t\trequest = xhr\n\t\t\t\t.then( function ( data ) {\n\t\t\t\t\t// resolve the Deferred object\n\t\t\t\t\treturn {\n\t\t\t\t\t\tquery: query,\n\t\t\t\t\t\tresults: self._processData( query, data )\n\t\t\t\t\t};\n\t\t\t\t}, function () {\n\t\t\t\t\t// reset cached result, it maybe contains no value\n\t\t\t\t\tself.searchCache[query] = undefined;\n\t\t\t\t} );\n\n\t\t\t// cache the result to prevent the execution of one search query twice\n\t\t\t// in one session\n\t\t\tthis.searchCache[query] = request.promise( {\n\t\t\t\tabort: function () { xhr.abort(); }\n\t\t\t} );\n\t\t}\n\n\t\treturn this.searchCache[query];\n\t},\n\n\t/**\n\t * Check if the search has already been performed in given session.\n\t * @memberof SearchGateway\n\t * @instance\n\t * @param {string} query\n\t * @return {boolean}\n\t */\n\tisCached: function ( query ) {\n\t\treturn Boolean( this.searchCache[ query ] );\n\t}\n};\n\nmodule.exports = SearchGateway;\n","var units = [ 'seconds', 'minutes', 'hours', 'days', 'months', 'years' ],\n\tutil = require( './util' ),\n\tlimits = [ 1, 60, 3600, 86400, 2592000, 31536000 ];\n\n/** @class time */\n\n/**\n * Calculate the correct unit of timestamp\n * @memberof time\n * @instance\n * @param {number} timestampDelta\n * @return {{value: number, unit: string}}\n */\nfunction timeAgo( timestampDelta ) {\n\tvar i = 0;\n\twhile ( i < limits.length && timestampDelta > limits[i + 1] ) {\n\t\t++i;\n\t}\n\treturn {\n\t\tvalue: Math.round( timestampDelta / limits[i] ),\n\t\tunit: units[i]\n\t};\n}\n\n/**\n * Calculate the correct unit of timestamp delta\n * @memberof time\n * @instance\n * @param {number} timestamp\n * @return {{value: number, unit: string}}\n */\nfunction getTimeAgoDelta( timestamp ) {\n\tvar currentTimestamp = Math.round( new Date().getTime() / 1000 );\n\n\treturn timeAgo( currentTimestamp - timestamp );\n}\n\n/**\n * Whether timestamp delta is less than a day old\n * @memberof time\n * @instance\n * @param {{value: number, unit: string}} delta Object of timestamp and its label\n * @return {boolean}\n */\nfunction isRecent( delta ) {\n\treturn [ 'seconds', 'minutes', 'hours' ].indexOf( delta.unit ) > -1;\n}\n\n/**\n * Is delta less than 10 seconds?\n * @memberof time\n * @instance\n * @param {{value: number, unit: string}} delta Object of timestamp and its label\n * @return {boolean}\n */\nfunction isNow( delta ) {\n\treturn delta.unit === 'seconds' && delta.value < 10;\n}\n\n/**\n * Return a message relating to the last modified relative time.\n * @memberof time\n * @instance\n * @param {number} ts timestamp\n * @param {string} username of the last user to modify the page\n * @param {string} [gender] of the last user to modify the page\n * @param {string} [historyUrl] url to the history page for the message, if omitted\n *  returns plain text string rather than html\n * @return {string}\n */\nfunction getLastModifiedMessage( ts, username, gender, historyUrl ) {\n\tvar delta, html,\n\t\tkeys = {\n\t\t\tseconds: 'mobile-frontend-last-modified-with-user-seconds',\n\t\t\tminutes: 'mobile-frontend-last-modified-with-user-minutes',\n\t\t\thours: 'mobile-frontend-last-modified-with-user-hours',\n\t\t\tdays: 'mobile-frontend-last-modified-with-user-days',\n\t\t\tmonths: 'mobile-frontend-last-modified-with-user-months',\n\t\t\tyears: 'mobile-frontend-last-modified-with-user-years'\n\t\t},\n\t\targs = [];\n\n\tgender = gender || 'unknown';\n\n\tdelta = getTimeAgoDelta( ts );\n\tif ( isNow( delta ) ) {\n\t\targs.push( 'mobile-frontend-last-modified-with-user-just-now', gender, username );\n\t} else {\n\t\targs.push( keys[ delta.unit ], gender, username,\n\t\t\tmw.language.convertNumber( delta.value )\n\t\t);\n\t}\n\n\targs.push(\n\t\thistoryUrl || '#',\n\t\t// Abuse PLURAL support to determine if the user is anonymous or not\n\t\tmw.language.convertNumber( username ? 1 : 0 ),\n\t\t// Our abuse of PLURAL support means we have to pass the relative URL\n\t\t// rather than construct it from a wikilink\n\t\tusername ? mw.util.getUrl( 'User:' + username ) : ''\n\t);\n\thtml = mw.message.apply( this, args ).parse();\n\tif ( historyUrl ) {\n\t\treturn html;\n\t} else {\n\t\treturn util.parseHTML( '<div>' ).html( html ).text();\n\t}\n}\n\n/**\n * Return a message relating to the registration date of the user\n * @memberof time\n * @instance\n * @param {string} ts timestamp\n * @param {string} [gender] of the last user editing this page\n * @return {string}\n */\nfunction getRegistrationMessage( ts, gender ) {\n\tvar delta, html,\n\t\tkeys = {\n\t\t\tseconds: 'mobile-frontend-joined-seconds',\n\t\t\tminutes: 'mobile-frontend-joined-minutes',\n\t\t\thours: 'mobile-frontend-joined-hours',\n\t\t\tdays: 'mobile-frontend-joined-days',\n\t\t\tmonths: 'mobile-frontend-joined-months',\n\t\t\tyears: 'mobile-frontend-joined-years'\n\t\t},\n\t\targs = [];\n\n\tgender = gender || 'unknown';\n\n\tdelta = getTimeAgoDelta( parseInt( ts, 10 ) );\n\tif ( isNow( delta ) ) {\n\t\targs.push( 'mobile-frontend-joined-just-now', gender );\n\t} else {\n\t\targs.push( keys[ delta.unit ], gender, mw.language.convertNumber( delta.value ) );\n\t}\n\thtml = mw.message.apply( this, args ).parse();\n\treturn html;\n}\n\nmodule.exports = {\n\tgetLastModifiedMessage: getLastModifiedMessage,\n\tgetRegistrationMessage: getRegistrationMessage,\n\ttimeAgo: timeAgo,\n\tgetTimeAgoDelta: getTimeAgoDelta,\n\tisNow: isNow,\n\tisRecent: isRecent\n};\n","var\n\tutil = require( './util' ),\n\tstorageKey = 'mobileFrontend/toast';\n\n/**\n * Wrapper for one global Toast\n * @class Toast\n */\nfunction Toast() {\n\tmw.requestIdleCallback( this._showPending.bind( this ) );\n}\n\n/**\n * Show a message with the given class in a toast.\n * @memberof Toast\n * @instance\n * @param {string} msg Message to show in the toast\n * @param {Object|string} [options]\n *  If a string (deprecated) CSS class to add to the element\n *  If an object, more options for the notification see mw.notification.show.\n *  For backwards compatibility reasons if a string is given it will be\n *  treated as options.type\n */\nToast.prototype.show = function ( msg, options ) {\n\tif ( typeof options === 'string' ) {\n\t\tmw.log.warn( 'The use of the cssClass parameter of Toast.show is deprecated, please convert it to an ' +\n\t\t\t\t'options object.' );\n\t\toptions = {\n\t\t\ttype: options\n\t\t};\n\t}\n\n\toptions = util.extend( {\n\t\ttag: 'toast'\n\t}, options );\n\n\tthis.notification = mw.notify( msg, options );\n};\n\n/**\n * Hide the Toast if it's visible.\n * @memberof Toast\n * @instance\n */\nToast.prototype.hide = function () {\n\tif ( this.notification !== undefined ) {\n\t\tthis.notification.then( function ( notif ) {\n\t\t\tnotif.close();\n\t\t} );\n\t}\n};\n\n/**\n * Save the toast data in storage so that we can show it on page reload.\n * Also check whether there is a pending message that's not shown yet.\n * If yes, output a warning message and discard this message.\n * This is to ensure that the page needs to be reloaded before adding\n * a new message for showing later.\n * @memberof Toast\n * @instance\n * @param {string} content Content to be placed in element\n * @param {string} [className] class to add to element\n */\nToast.prototype.showOnPageReload = function ( content, className ) {\n\tif ( mw.storage.get( storageKey ) ) {\n\t\tmw.log.warn(\n\t\t\t'A pending toast message already exits. ' +\n\t\t\t\t'The page should have been reloaded by now.'\n\t\t);\n\t\treturn;\n\t}\n\tmw.storage.set( storageKey, JSON.stringify( {\n\t\tcontent: content,\n\t\tclassName: className\n\t} ) );\n};\n\n/**\n * Show the previously saved toast data and delete it from storage\n * @memberof Toast\n * @instance\n * @private\n */\nToast.prototype._showPending = function () {\n\tvar data = mw.storage.get( storageKey );\n\tif ( data ) {\n\t\tdata = JSON.parse( data );\n\t\tthis.show( data.content, data.className );\n\t\tmw.storage.remove( storageKey );\n\t}\n};\n\nmodule.exports = new Toast();\n","/* global $ */\n\n/**\n * Utility library\n * @class util\n * @singleton\n */\nmodule.exports = {\n\t/**\n\t * Escape a string for use as a css selector\n\t * @memberof util\n\t * @instance\n\t * @param {string} selector\n\t * @return {string}\n\t */\n\tescapeSelector: function ( selector ) {\n\t\treturn $.escapeSelector( selector );\n\t},\n\t/**\n\t * Wrapper class for the $.grep\n\t * @memberof util\n\t * @instance\n\t * @return {jQuery.Deferred}\n\t */\n\tgrep: function () {\n\t\treturn $.grep.apply( $, arguments );\n\t},\n\t/**\n\t * Run method when document is ready.\n\t * @memberof util\n\t * @instance\n\t * @param {Function} fn\n\t * @return {jQuery.Object}\n\t */\n\tdocReady: function ( fn ) {\n\t\treturn $( fn );\n\t},\n\t/**\n\t * Wrapper class for the $.when\n\t * @memberof util\n\t * @instance\n\t * @return {jQuery.Deferred}\n\t */\n\twhen: function () {\n\t\treturn $.when.apply( $, arguments );\n\t},\n\t/**\n\t * Wrapper class for the Deferred method\n\t * @memberof util\n\t * @instance\n\t * @return {jQuery.Deferred}\n\t */\n\tDeferred: function () {\n\t\treturn $.Deferred();\n\t},\n\t/**\n\t * Adds a class to the document\n\t * @memberof util\n\t * @instance\n\t * @return {jQuery.Object} element representing the documentElement\n\t */\n\tgetDocument: function () {\n\t\treturn $( document.documentElement );\n\t},\n\t/**\n\t * Get the window object\n\t * @memberof util\n\t * @instance\n\t * @return {jQuery.Object}\n\t */\n\tgetWindow: function () {\n\t\treturn $( window );\n\t},\n\t/**\n\t * Given some html, create new element(s).\n\t * Unlike jQuery.parseHTML this will return a jQuery object\n\t * not an array.\n\t * @memberof util\n\t * @instance\n\t * @param {string} html\n\t * @param {Element} [ctx] Document element to serve as the context\n\t *  in which the HTML fragment will be created\n\t * @return {jQuery.Object}\n\t */\n\tparseHTML: function ( html, ctx ) {\n\t\tctx = ctx || document;\n\t\treturn $( $.parseHTML( html, ctx ) );\n\t},\n\t/**\n\t * wrapper for jQuery util function to check if something is numeric\n\t * @memberof util\n\t * @instance\n\t * @return {boolean}\n\t */\n\tisNumeric: function () {\n\t\treturn $.isNumeric.apply( $, arguments );\n\t},\n\t/**\n\t * Wrapper for jQuery.extend method. In future this can be bound to Object.assign\n\t * when support allows.\n\t *\n\t * Warning: if only one argument is supplied to util.extend(), this means the target argument\n\t * was omitted. In this case, the jQuery object itself is assumed to be the target.\n\t *\n\t * @memberof util\n\t * @instance\n\t * @return {Object}\n\t */\n\textend: function () {\n\t\treturn $.extend.apply( $, arguments );\n\t},\n\t/**\n\t * Escape dots and colons in a hash, jQuery doesn't like them because they\n\t * look like CSS classes and pseudoclasses. See\n\t * http://bugs.jquery.com/ticket/5241\n\t * http://stackoverflow.com/questions/350292/how-do-i-get-jquery-to-select-elements-with-a-period-in-their-id\n\t * @memberof util\n\t * @instance\n\t * @param {string} hash A hash to escape\n\t * @return {string}\n\t */\n\tescapeHash: function ( hash ) {\n\t\treturn hash.replace( /(:|\\.)/g, '\\\\$1' );\n\t},\n\n\t/**\n\t * Heuristic for determining whether an Event should be handled by\n\t * MobileFrontend or allowed to bubble to the browser.\n\t * @memberof util\n\t * @instance\n\t * @param {Event} ev\n\t * @return {boolean} True if event is modified with control, alt, meta, or\n\t *                   shift keys and should probably be handled by the\n\t *                   browser.\n\t *\n\t * todo: move this function to a ClickUtil file once bundling and code\n\t * splitting is supported.\n\t */\n\tisModifiedEvent: function ( ev ) {\n\t\treturn ev.altKey || ev.ctrlKey || ev.metaKey || ev.shiftKey;\n\t},\n\n\t/**\n\t * Pipe event emitted by source through proxy. Subscribers to proxy will receive the event as\n\t * though proxy was the originator.\n\t *\n\t * @param {OO.EventEmitter} src\n\t * @param {OO.EventEmitter} proxy\n\t * @param {string} event Event type to listen for.\n\t * @param {any[]} [args] Arguments to pass to\n\t *  subscribers, will be prepended to emitted arguments.\n\t * @return {OO.EventEmitter} The source.\n\t */\n\trepeatEvent: function ( src, proxy, event, args ) {\n\t\treturn src.on( event, function ( args ) {\n\t\t\treturn proxy.emit( event, args );\n\t\t}, args );\n\t}\n};\n","var View = require( '../View' ),\n\tWatchstarGateway = require( './WatchstarGateway' ),\n\ticons = require( '../icons' ),\n\tutil = require( '../util' ),\n\tmfExtend = require( '../mfExtend' ),\n\ttoast = require( '../toast' ),\n\tCtaDrawer = require( '../CtaDrawer' );\n\n/**\n * A clickable watchstar\n * @class Watchstar\n * @extends View\n * @uses CtaDrawer\n * @uses Icon\n * @uses WatchstarGateway\n * @uses Toast\n * @fires Watchstar#unwatch\n * @fires Watchstar#watch\n *\n * @param {Object} options Configuration options\n */\nfunction Watchstar( options ) {\n\tView.call(\n\t\tthis,\n\t\tutil.extend(\n\t\t\t{\n\t\t\t\tclassName: icons.watchIcon().getClassName(),\n\t\t\t\tevents: {\n\t\t\t\t// Disable clicks on original link\n\t\t\t\t\t'click a': 'onLinksClick',\n\t\t\t\t\tclick: 'onStatusToggle'\n\t\t\t\t}\n\t\t\t},\n\t\t\toptions\n\t\t)\n\t);\n}\n\nmfExtend( Watchstar, View, {\n\t/**\n\t * @memberof Watchstar\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {mw.Api} defaults.api\n\t * @property {Page} defaults.page Current page.\n\t * @property {string} defaults.funnel to log events with\n\t */\n\tdefaults: {\n\t\tpage: undefined,\n\t\tfunnel: 'unknown'\n\t},\n\t/**\n\t * @memberof Watchstar\n\t * @instance\n\t * @property {Object} ctaDrawerOptions Default options hash for the anonymous CtaDrawer.\n\t */\n\tctaDrawerOptions: {\n\t\tcontent: mw.msg( 'mobile-frontend-watchlist-cta' ),\n\t\tqueryParams: {\n\t\t\twarning: 'mobile-frontend-watchlist-purpose',\n\t\t\tcampaign: 'mobile_watchPageActionCta',\n\t\t\treturntoquery: 'article_action=watch'\n\t\t},\n\t\tsignupQueryParams: {\n\t\t\twarning: 'mobile-frontend-watchlist-signup-action'\n\t\t}\n\t},\n\t/**\n\t * @memberof Watchstar\n\t * @instance\n\t */\n\ttemplate: mw.template.compile( '<a role=\"button\">{{tooltip}}</a>', 'hogan' ),\n\t/**\n\t * @inheritdoc\n\t * @memberof Watchstar\n\t * @instance\n\t */\n\tinitialize: function ( options ) {\n\t\tvar self = this,\n\t\t\t_super = View.prototype.initialize;\n\n\t\tthis._watched = options.isWatched;\n\t\tthis.gateway = new WatchstarGateway( options.api );\n\n\t\t_super.call( self, options );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof Watchstar\n\t * @instance\n\t */\n\tpreRender: function () {\n\t\tthis.options.tooltip = this._watched ? mw.msg( 'unwatchthispage' ) : mw.msg( 'watchthispage' );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof Watchstar\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tvar unwatchedClass = icons.watchIcon().getGlyphClassName(),\n\t\t\twatchedClass = icons.watchedIcon().getGlyphClassName() + ' watched';\n\n\t\t// add tooltip to the div, not the <a> inside\n\t\t// because that <a> has zero width/height so cannot be hovered\n\t\tthis.$el.attr( 'title', this.options.tooltip );\n\n\t\t// Add watched class if necessary\n\t\tif ( !mw.user.isAnon() && this._watched ) {\n\t\t\tthis.$el.addClass( watchedClass ).removeClass( unwatchedClass );\n\t\t} else {\n\t\t\tthis.$el.addClass( unwatchedClass ).removeClass( watchedClass );\n\t\t}\n\t\tthis.$el.removeClass( 'hidden' );\n\t},\n\n\t/**\n\t * Prevent default on incoming events\n\t * @memberof Watchstar\n\t * @instance\n\t * @param {jQuery.Event} ev\n\t */\n\tonLinksClick: function ( ev ) {\n\t\tev.preventDefault();\n\t},\n\n\t/**\n\t * Triggered when a user anonymously clicks on the watchstar.\n\t * @memberof Watchstar\n\t * @instance\n\t */\n\tonStatusToggleAnon: function () {\n\t\tif ( !this.drawer ) {\n\t\t\tthis.drawer = new CtaDrawer( this.ctaDrawerOptions );\n\n\t\t}\n\t\tthis.drawer.show();\n\t},\n\n\t/**\n\t * Triggered when a logged in user clicks on the watchstar.\n\t * @memberof Watchstar\n\t * @instance\n\t */\n\tonStatusToggleUser: function () {\n\t\tvar\n\t\t\tself = this,\n\t\t\tgateway = this.gateway,\n\t\t\tpage = this.options.page,\n\t\t\tchecker,\n\t\t\tpostWatched = !this._watched;\n\n\t\tchecker = setInterval( function () {\n\t\t\ttoast.show( mw.msg( 'mobile-frontend-watchlist-please-wait' ) );\n\t\t}, 1000 );\n\t\tfunction stopInterval() {\n\t\t\tclearInterval( checker );\n\t\t}\n\t\tgateway.postStatusesByTitle( [ page.getTitle() ], postWatched ).then( function () {\n\t\t\tstopInterval();\n\n\t\t\tself._watched = postWatched;\n\t\t\tif ( postWatched ) {\n\t\t\t\tself.render();\n\t\t\t\t/**\n\t\t\t\t * Fired when the watch star is changed to watched status\n\t\t\t\t * @event Watchstar#watch\n\t\t\t\t */\n\t\t\t\tself.emit( 'watch' );\n\t\t\t\ttoast.show( mw.msg( 'mobile-frontend-watchlist-add', page.title ) );\n\t\t\t} else {\n\t\t\t\t/**\n\t\t\t\t * Fired when the watch star is changed to unwatched status\n\t\t\t\t * @event Watchstar#unwatch\n\t\t\t\t */\n\t\t\t\tself.emit( 'unwatch' );\n\t\t\t\tself.render();\n\t\t\t\ttoast.show( mw.msg( 'mobile-frontend-watchlist-removed', page.title ) );\n\t\t\t}\n\t\t}, function () {\n\t\t\tstopInterval();\n\n\t\t\ttoast.show( mw.msg( 'mobile-frontend-watchlist-error' ), 'error' );\n\t\t} );\n\t},\n\n\t/**\n\t * Event handler for clicking on watch star.\n\t * Make an API request if user is not anonymous.\n\t * @memberof Watchstar\n\t * @instance\n\t */\n\tonStatusToggle: function () {\n\t\tif ( mw.user.isAnon() ) {\n\t\t\tthis.onStatusToggleAnon.apply( this, arguments );\n\t\t} else {\n\t\t\tthis.onStatusToggleUser.apply( this, arguments );\n\t\t}\n\t}\n\n} );\n\nmodule.exports = Watchstar;\n","var util = require( '../util' ),\n\tactionParams = require( '../actionParams' );\n\n/**\n * @typedef {string|number} PageID Page ID. 0 / \"0\" is a special no-ID value.\n * {@link https://www.mediawiki.org/wiki/Manual:Page_table#page_id Page ID}\n *\n * @typedef {string} PageTitle Canonical page title.\n * {@link https://www.mediawiki.org/wiki/Manual:Title.php#Canonical_forms Canonical forms}\n *\n * @typedef {boolean} WatchStatus Page watch status; true if watched, false if\n *                                unwatched.\n * {@link https://www.mediawiki.org/wiki/API:Info API:Info} (see inprop.watched)\n * {@link https://www.mediawiki.org/wiki/API:Watch API:Watch} (see unwatch)\n *\n * @typedef {Object.<PageTitle, WatchStatus>} WatchStatusMap\n */\n\n/**\n * API for retrieving and modifying page watch statuses. This module interacts\n * with two endpoints, API:Info for GETs and API:Watch and for POSTs.\n *\n * @class WatchstarGateway\n * @param {mw.Api} api\n */\nfunction WatchstarGateway( api ) {\n\tthis.api = api;\n}\n\nWatchstarGateway.prototype = {\n\t/**\n\t * Issues zero to two asynchronous HTTP requests for the watch status of\n\t * each page ID and title passed.\n\t *\n\t * Every watch entry has a title but not necessarily a page ID. Entries\n\t * without IDs are missing pages, i.e., pages that do not exist. These\n\t * entries are used to observe when a page with a given title is created.\n\t * Although it is convenient to use titles because they're always present,\n\t * IDs are preferred since they're far less likely to exceed the URL length\n\t * limit.\n\t *\n\t * No request is issued when no IDs and no titles are passed. Given that the\n\t * server state does not change between the two requests, overlapping title\n\t * and ID members will behave as expected but there is no reason to issue\n\t * such a request.\n\t *\n\t * @memberof WatchstarGateway\n\t * @instance\n\t * @param {PageID[]} ids\n\t * @param {PageTitle[]} titles\n\t * @return {JQuery.Deferred<WatchStatusMap>}\n\t */\n\tgetStatuses: function ( ids, titles ) {\n\t\t// Issue two requests and coalesce the results.\n\t\treturn util.when(\n\t\t\tthis.getStatusesByID( ids ),\n\t\t\tthis.getStatusesByTitle( titles )\n\t\t).then( function () { return util.extend.apply( util, arguments ); } );\n\t},\n\n\t/**\n\t * @memberof WatchstarGateway\n\t * @instance\n\t * @param {PageID[]} ids\n\t * @return {JQuery.Deferred<WatchStatusMap>}\n\t */\n\tgetStatusesByID: function ( ids ) {\n\t\tvar self = this;\n\t\tif ( !ids.length ) {\n\t\t\treturn util.Deferred().resolve( {} );\n\t\t}\n\n\t\treturn this.api.get( {\n\t\t\tformatversion: 2,\n\t\t\taction: 'query',\n\t\t\tprop: 'info',\n\t\t\tinprop: 'watched',\n\t\t\tpageids: ids\n\t\t} ).then( function ( rsp ) {\n\t\t\treturn self._unmarshalGetResponse( rsp );\n\t\t} );\n\t},\n\n\t/**\n\t * @memberof WatchstarGateway\n\t * @instance\n\t * @param {PageTitle[]} titles\n\t * @return {JQuery.Deferred<WatchStatusMap>}\n\t */\n\tgetStatusesByTitle: function ( titles ) {\n\t\tvar self = this;\n\t\tif ( !titles.length ) {\n\t\t\treturn util.Deferred().resolve( {} );\n\t\t}\n\n\t\treturn this.api.get( actionParams( {\n\t\t\tprop: 'info',\n\t\t\tinprop: 'watched',\n\t\t\ttitles: titles\n\t\t} ) ).then( function ( rsp ) {\n\t\t\treturn self._unmarshalGetResponse( rsp );\n\t\t} );\n\t},\n\n\t/**\n\t * @memberof WatchstarGateway\n\t * @instance\n\t * @param {PageTitle[]} titles\n\t * @param {WatchStatus} watched\n\t * @return {JQuery.Deferred}\n\t */\n\tpostStatusesByTitle: function ( titles, watched ) {\n\t\tvar params = {\n\t\t\taction: 'watch',\n\t\t\ttitles: titles\n\t\t};\n\t\tif ( !watched ) {\n\t\t\tparams.unwatch = !watched;\n\t\t}\n\t\treturn this.api.postWithToken( 'watch', params );\n\t},\n\n\t/**\n\t * @memberof WatchstarGateway\n\t * @instance\n\t * @param {Object} rsp The API:Info response.\n\t * @return {JQuery.Deferred<WatchStatusMap>}\n\t * @see getStatusesByID\n\t * @see getStatusesByTitle\n\t */\n\t_unmarshalGetResponse: function ( rsp ) {\n\t\tvar pages = rsp && rsp.query && rsp.query.pages || [];\n\t\treturn pages.reduce( function ( statuses, page ) {\n\t\t\tstatuses[page.title] = page.watched;\n\t\t\treturn statuses;\n\t\t}, {} );\n\t}\n};\n\nmodule.exports = WatchstarGateway;\n","var PageList = require( '../PageList' ),\n\tWatchstar = require( './Watchstar' ),\n\tuser = mw.user,\n\tutil = require( '../util' ),\n\tPage = require( '../Page' ),\n\tmfExtend = require( '../mfExtend' ),\n\tWatchstarGateway = require( './WatchstarGateway' );\n\n/**\n * @typedef {Object.<PageTitle, PageID>} PageTitleToPageIDMap\n */\n\n/**\n * List of items page view\n * @class WatchstarPageList\n * @uses Page\n * @uses WatchstarGateway\n * @uses Watchstar\n * @extends PageList\n *\n * @fires WatchstarPageList#unwatch\n * @fires WatchstarPageList#watch\n * @param {Object} options Configuration options\n */\nfunction WatchstarPageList( options ) {\n\tthis.wsGateway = new WatchstarGateway( options.api );\n\tPageList.apply( this, arguments );\n}\n\nmfExtend( WatchstarPageList, PageList, {\n\t/**\n\t * @memberof WatchstarPageList\n\t * @instance\n\t * @mixes PageList#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {mw.Api} defaults.api\n\t */\n\n\tpostRender: function () {\n\t\tvar\n\t\t\tself = this,\n\t\t\t$items,\n\t\t\tpages,\n\t\t\tids = [],\n\t\t\ttitles = [];\n\n\t\tPageList.prototype.postRender.apply( this );\n\n\t\t$items = this.queryUnitializedItems();\n\t\tpages = this.parsePagesFromItems( $items );\n\n\t\tObject.keys( pages ).forEach( function ( title ) {\n\t\t\tvar id = pages[title];\n\t\t\t// Favor IDs since they're short and unlikely to exceed URL length\n\t\t\t// limits when batched.\n\t\t\tif ( id && id !== '0' ) {\n\t\t\t\t// ID is present and valid.\n\t\t\t\tids.push( id );\n\t\t\t} else {\n\t\t\t\t// Only titles are available for missing pages.\n\t\t\t\ttitles.push( title );\n\t\t\t}\n\t\t} );\n\n\t\treturn this.getPages( ids, titles ).then( function ( statuses ) {\n\t\t\tself.renderItems( $items, statuses );\n\t\t} );\n\t},\n\n\t/**\n\t * @param {JQuery.Element} $items\n\t * @param {WatchStatusMap} statuses\n\t * @return {void}\n\t */\n\tqueryUnitializedItems: function () {\n\t\treturn this.$( 'li:not(.with-watchstar)' );\n\t},\n\n\t/**\n\t * Retrieve pages\n\t *\n\t * @memberof WatchstarPageList\n\t * @instance\n\t * @param {PageID[]} ids\n\t * @param {PageTitle[]} titles\n\t * @return {JQuery.Deferred<WatchStatusMap>}\n\t */\n\tgetPages: function ( ids, titles ) {\n\t\t// Rendering Watchstars for anonymous users is not useful. Short-circuit\n\t\t// the request.\n\t\tif ( user.isAnon() ) {\n\t\t\treturn util.Deferred().resolve( {} );\n\t\t}\n\n\t\treturn this.wsGateway.getStatuses( ids, titles );\n\t},\n\n\t/**\n\t * @param {JQuery.Element} $items\n\t * @return {PageTitleToPageIDMap}\n\t * @memberof WatchstarPageList\n\t * @instance\n\t */\n\tparsePagesFromItems: function ( $items ) {\n\t\tvar\n\t\t\tself = this,\n\t\t\tpages = {};\n\t\t$items.each( function ( _, item ) {\n\t\t\tvar $item = self.$( item );\n\t\t\tpages[ $item.attr( 'title' ) ] = $item.data( 'id' );\n\t\t} );\n\t\treturn pages;\n\t},\n\n\t/**\n\t * @param {JQuery.Element} $items\n\t * @param {WatchStatusMap} statuses\n\t * @return {void}\n\t */\n\trenderItems: function ( $items, statuses ) {\n\t\tvar self = this;\n\n\t\t// Rendering Watchstars for anonymous users is not useful. Nothing to do.\n\t\tif ( user.isAnon() ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Create watch stars for each entry in list\n\t\t$items.each( function ( _, item ) {\n\t\t\tvar\n\t\t\t\t$item = self.$( item ),\n\t\t\t\tpage = new Page( {\n\t\t\t\t\t// FIXME: Set sections so we don't hit the api (hacky)\n\t\t\t\t\tsections: [],\n\t\t\t\t\ttitle: $item.attr( 'title' ),\n\t\t\t\t\tid: $item.data( 'id' )\n\t\t\t\t} ),\n\t\t\t\tel = self.parseHTML( '<div>' ).appendTo( $item ),\n\t\t\t\twatched = statuses[ page.getTitle() ];\n\n\t\t\tself._appendWatchstar( el, page, watched );\n\t\t\t$item.addClass( 'with-watchstar' );\n\t\t} );\n\t},\n\n\t/**\n\t * @param {HTMLElement} el\n\t * @param {Page} page\n\t * @param {WatchStatus} watched\n\t * @return {Watchstar}\n\t */\n\t_appendWatchstar: function ( el, page, watched ) {\n\t\tvar watchstar = new Watchstar( {\n\t\t\tapi: this.options.api,\n\t\t\tfunnel: this.options.funnel,\n\t\t\tisAnon: user.isAnon(),\n\t\t\t// WatchstarPageList.getPages() already retrieved the status of\n\t\t\t// each page. Explicitly set the watch state so another request\n\t\t\t// will not be issued by the Watchstar.\n\t\t\tisWatched: watched,\n\t\t\tpage: page,\n\t\t\tel: el\n\t\t} );\n\n\t\t/**\n\t\t * @event watch\n\t\t * Fired when an article in the PageList is watched.\n\t\t */\n\t\tutil.repeatEvent( watchstar, this, 'watch' );\n\n\t\t/**\n\t\t * @event unwatch\n\t\t * Fired when an article in the PageList is watched.\n\t\t */\n\t\tutil.repeatEvent( watchstar, this, 'unwatch' );\n\n\t\treturn watchstar;\n\t}\n} );\n\nmodule.exports = WatchstarPageList;\n","var\n\tutil = require( '../mobile.startup/util' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tView = require( '../mobile.startup/View' ),\n\tPageGateway = require( '../mobile.startup/PageGateway' ),\n\ticons = require( '../mobile.startup/icons' ),\n\tPage = require( '../mobile.startup/Page' );\n/**\n * Board of talk topics\n * @class TalkBoard\n * @extends View\n * @uses Page\n * @uses PageGateway\n * @param {Object} options\n * @param {Section[]} [options.headings] for rendering heading links.\n *   Api will be used if absent.\n * @param {mw.Api} options.api\n * @param {OO.EventEmitter} options.eventBus Object used to listen for\n * talk-discussion-added events\n */\nfunction TalkBoard( options ) {\n\tthis.eventBus = options.eventBus;\n\tthis.pageGateway = new PageGateway( options.api );\n\tView.call( this,\n\t\tutil.extend( options, {\n\t\t\tclassName: 'talk-board'\n\t\t} )\n\t);\n}\n\nmfExtend( TalkBoard, View, {\n\tisTemplateMode: true,\n\ttemplate: mw.template.get( 'mobile.talk.overlays', 'TalkBoard.hogan' ),\n\t/**\n\t * @inheritdoc\n\t * @memberof TalkBoard\n\t * @instance\n\t */\n\tpostRender: function ( options ) {\n\t\tView.prototype.postRender.call( this, options );\n\t\tthis.$el.append( icons.spinner().$el );\n\t\tthis.$spinner = this.$( '.spinner' );\n\t\tthis.$board = this.$( '.board' );\n\t\tif ( !this.options.headings ) {\n\t\t\tthis._loadContent( this.options );\n\t\t}\n\t\tthis.eventBus.on( 'talk-discussion-added', this._loadContent.bind( this ) );\n\t},\n\n\t/**\n\t * Show a loading spinner\n\t * @memberof TalkBoard\n\t * @instance\n\t */\n\tshowSpinner: function () {\n\t\tthis.$board.hide();\n\t\tthis.$spinner.show();\n\t},\n\n\t/**\n\t * Hide the loading spinner\n\t * @memberof TalkBoard\n\t * @instance\n\t */\n\thideSpinner: function () {\n\t\tthis.$spinner.hide();\n\t\tthis.$board.show();\n\t},\n\n\t/**\n\t * Load content of the talk page into the overlay\n\t * @memberof TalkBoard\n\t * @instance\n\t * @param {Object} options for the overlay\n\t * @private\n\t */\n\t_loadContent: function ( options ) {\n\t\tvar self = this;\n\t\toptions = options || this.options;\n\n\t\t// show a spinner\n\t\tthis.showSpinner();\n\t\t// clear actual content, if any\n\t\tthis.$( '.topic-title-list' ).empty();\n\n\t\tthis.pageGateway.getPage( options.title ).then( function ( pageData ) {\n\t\t\tself._addContent( pageData, options );\n\t\t}, function ( resp ) {\n\t\t\t// If the API returns the error code 'missingtitle', that means the\n\t\t\t// talk page doesn't exist yet.\n\t\t\tif ( resp === 'missingtitle' ) {\n\t\t\t\t// Create an empty page for new pages\n\t\t\t\tself._addContent( {\n\t\t\t\t\ttitle: options.title,\n\t\t\t\t\tsections: []\n\t\t\t\t}, options );\n\t\t\t} else {\n\t\t\t\tif ( self.options.onFail ) {\n\t\t\t\t\t// Run failure callback with current title\n\t\t\t\t\tself.options.onFail( options.title );\n\t\t\t\t} else {\n\t\t\t\t\t// If the API request fails for any other reason, load the talk\n\t\t\t\t\t// page manually rather than leaving the spinner spinning.\n\t\t\t\t\t// eslint-disable-next-line no-restricted-properties\n\t\t\t\t\twindow.location = mw.util.getUrl( options.title );\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\t},\n\n\t/**\n\t * Adds the content received from _loadContent to the Overlay and re-renders it.\n\t * @memberof TalkBoard\n\t * @instance\n\t * @private\n\t * @param {Object} pageData As returned from PageApi#getPage\n\t * @param {Object} options for the overlay\n\t */\n\t_addContent: function ( pageData, options ) {\n\t\tvar page = new Page( pageData ),\n\t\t\tsections = page.getSections();\n\n\t\tthis.page = page;\n\n\t\toptions.explanation = sections.length > 0 ? mw.msg( 'mobile-frontend-talk-explained' ) :\n\t\t\tmw.msg( 'mobile-frontend-talk-explained-empty' );\n\t\toptions.headings = sections;\n\n\t\t// content is there so re-render and hide the spinner\n\t\tthis.render( options );\n\t\tthis.hideSpinner();\n\t}\n} );\n\nmodule.exports = TalkBoard;\n","var\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tOverlay = require( '../mobile.startup/Overlay' ),\n\tPageGateway = require( '../mobile.startup/PageGateway' ),\n\tutil = require( '../mobile.startup/util' ),\n\tautosign = require( './autosign' ),\n\ttoast = require( '../mobile.startup/toast' ),\n\tIcon = require( '../mobile.startup/Icon' );\n\n/**\n * Overlay for adding a talk section\n * @class TalkSectionAddOverlay\n * @extends Overlay\n * @uses Toast\n *\n * @param {Object} options Configuration options\n * @param {Object} options.title Title of the talk page being modified\n * @param {Object} options.currentPageTitle Title of the page before the overlay appears\n * @param {OO.EventEmitter} options.eventBus Object used to emit talk-added-wo-overlay\n * and talk-discussion-added events\n */\nfunction TalkSectionAddOverlay( options ) {\n\tthis.editorApi = options.api;\n\tthis.pageGateway = new PageGateway( options.api );\n\tOverlay.call( this,\n\t\tutil.extend( options, {\n\t\t\tclassName: 'talk-overlay overlay',\n\t\t\tevents: {\n\t\t\t\t'input .wikitext-editor, .summary': 'onTextInput',\n\t\t\t\t'change .wikitext-editor, .summary': 'onTextInput',\n\t\t\t\t'click .confirm-save': 'onSaveClick'\n\t\t\t}\n\t\t} )\n\t);\n\tthis.title = options.title;\n\tthis.currentPageTitle = options.currentPageTitle;\n\tthis.eventBus = options.eventBus;\n\t// Variable to indicate, if the overlay will be closed by the save function\n\t// or by the user. If this is false and there is content in the input fields,\n\t// the user will be asked, if he want to abandon his changes before we close\n\t// the Overlay, otherwise the Overlay will be closed without any question.\n\tthis._saveHit = false;\n}\n\nmfExtend( TalkSectionAddOverlay, Overlay, {\n\t/**\n\t * @memberof TalkSectionAddOverlay\n\t * @instance\n\t * @mixes Overlay#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} defaults.cancelMsg Caption for cancel button on edit form.\n\t * @property {string} defaults.topicTitlePlaceHolder Placeholder text to prompt user to add\n\t * a talk page topic subject.\n\t * @property {string} defaults.topicContentPlaceHolder Placeholder text to prompt user\n\t *  to add content to talk page content.\n\t * @property {string} defaults.editingMsg Label for button which\n\t *  submits a new talk page topic.\n\t */\n\tdefaults: util.extend( {}, Overlay.prototype.defaults, {\n\t\tcancelMsg: mw.msg( 'mobile-frontend-editor-cancel' ),\n\t\ttopicTitlePlaceHolder: mw.msg( 'mobile-frontend-talk-add-overlay-subject-placeholder' ),\n\t\ttopicContentPlaceHolder: mw.msg( 'mobile-frontend-talk-add-overlay-content-placeholder' ),\n\t\teditingMsg: mw.msg( 'mobile-frontend-talk-add-overlay-submit' ),\n\t\twaitMsg: mw.msg( 'mobile-frontend-talk-topic-wait' ),\n\t\t// icons.spinner can't be used, .loading has a fixed height, which breaks overlay-header\n\t\twaitIcon: new Icon( {\n\t\t\tname: 'spinner',\n\t\t\tadditionalClassNames: 'savespinner loading'\n\t\t} ).toHtmlString()\n\t} ),\n\t/**\n\t * @inheritdoc\n\t * @memberof TalkSectionAddOverlay\n\t * @instance\n\t */\n\ttemplate: mw.template.get( 'mobile.talk.overlays', 'SectionAddOverlay.hogan' ),\n\t/**\n\t * @inheritdoc\n\t * @memberof TalkSectionAddOverlay\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, Overlay.prototype.templatePartials, {\n\t\tcontentHeader: mw.template.get( 'mobile.talk.overlays', 'SectionAddOverlay/contentHeader.hogan' ),\n\t\tsaveHeader: mw.template.get( 'mobile.editor.overlay', 'saveHeader.hogan' )\n\t} ),\n\t/**\n\t * @inheritdoc\n\t * @memberof TalkSectionAddOverlay\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tOverlay.prototype.postRender.call( this );\n\t\tthis.showHidden( '.initial-header' );\n\t\tthis.$confirm = this.$( 'button.confirm-save' );\n\t\tthis.$subject = this.$( '.summary' );\n\t\tthis.$ta = this.$( '.wikitext-editor' );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof TalkSectionAddOverlay\n\t * @instance\n\t */\n\thide: function () {\n\t\tvar empty,\n\t\t\tconfirmMessage = mw.msg( 'mobile-frontend-editor-cancel-confirm' );\n\n\t\tempty = ( !this.$subject.val() && !this.$ta.val() );\n\t\t// TODO: Replace with an OOUI dialog\n\t\tif ( this._saveHit || empty || window.confirm( confirmMessage ) ) {\n\t\t\treturn Overlay.prototype.hide.apply( this, arguments );\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t},\n\t/**\n\t * Handles an input into a textarea and enables or disables the submit button\n\t * @memberof TalkSectionAddOverlay\n\t * @instance\n\t */\n\tonTextInput: function () {\n\t\tvar self = this;\n\n\t\tclearTimeout( this.timer );\n\t\tthis.timer = setTimeout( function () {\n\t\t\tif ( !self.$ta.val().trim() || !self.$subject.val().trim() ) {\n\t\t\t\tself.$confirm.prop( 'disabled', true );\n\t\t\t} else {\n\t\t\t\tself.$confirm.prop( 'disabled', false );\n\t\t\t}\n\t\t}, 250 );\n\t},\n\t/**\n\t * Handles a click on the save button\n\t * @memberof TalkSectionAddOverlay\n\t * @instance\n\t */\n\tonSaveClick: function () {\n\t\tvar self = this,\n\t\t\tisOnTalkPage = self.title === self.currentPageTitle;\n\n\t\tthis.showHidden( '.saving-header' );\n\t\tthis.save().then( function ( status ) {\n\t\t\tif ( status === 'ok' ) {\n\t\t\t\tif ( isOnTalkPage ) {\n\t\t\t\t\tself.eventBus.emit( 'talk-added-wo-overlay' );\n\t\t\t\t} else {\n\t\t\t\t\tself.pageGateway.invalidatePage( self.title );\n\t\t\t\t\ttoast.show( mw.msg( 'mobile-frontend-talk-topic-feedback' ) );\n\t\t\t\t\tself.eventBus.emit( 'talk-discussion-added' );\n\t\t\t\t\tself.hide();\n\t\t\t\t}\n\t\t\t}\n\t\t}, function ( error ) {\n\t\t\tvar editMsg = mw.msg( 'mobile-frontend-talk-topic-error' );\n\n\t\t\tself.$confirm.prop( 'disabled', false );\n\t\t\tswitch ( error.details ) {\n\t\t\t\tcase 'protectedpage':\n\t\t\t\t\teditMsg = mw.msg( 'mobile-frontend-talk-topic-error-protected' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'noedit':\n\t\t\t\tcase 'blocked':\n\t\t\t\t\teditMsg = mw.msg( 'mobile-frontend-talk-topic-error-permission' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'spamdetected':\n\t\t\t\t\teditMsg = mw.msg( 'mobile-frontend-talk-topic-error-spam' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'badtoken':\n\t\t\t\t\teditMsg = mw.msg( 'mobile-frontend-talk-topic-error-badtoken' );\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\teditMsg = mw.msg( 'mobile-frontend-talk-topic-error' );\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\ttoast.show( editMsg, 'error' );\n\t\t\tself.showHidden( '.save-header, .save-panel' );\n\t\t} );\n\t},\n\t/**\n\t * Save new talk section\n\t * @memberof TalkSectionAddOverlay\n\t * @instance\n\t * @return {jQuery.Deferred} Object that either will be resolved with ok parameter\n\t * or rejected with type error.\n\t */\n\tsave: function () {\n\t\tvar heading = this.$subject.val(),\n\t\t\tself = this,\n\t\t\td = util.Deferred(),\n\t\t\ttext = this.$ta.val();\n\n\t\tthis.$ta.removeClass( 'error' );\n\t\tthis.$subject.removeClass( 'error' );\n\n\t\t// propagate, that we save an edit and want to close the Overlay without\n\t\t// any interruption (user questions e.g.)\n\t\tthis._saveHit = true;\n\n\t\tthis.$( '.content' ).empty().addClass( 'loading' );\n\t\t// FIXME: while saving: a spinner would be nice\n\t\t// FIXME: This should be using a gateway e.g. TalkGateway, PageGateway or EditorGateway\n\t\treturn this.editorApi.postWithToken( 'csrf', {\n\t\t\taction: 'edit',\n\t\t\tsection: 'new',\n\t\t\tsectiontitle: heading,\n\t\t\ttitle: self.title,\n\t\t\tsummary: mw.msg( 'newsectionsummary', heading ),\n\t\t\ttext: autosign( text )\n\t\t} ).then( function () {\n\t\t\treturn 'ok';\n\t\t}, function ( msg ) {\n\t\t\t// FIXME: Throw an Error\n\t\t\treturn d.reject( {\n\t\t\t\ttype: 'error',\n\t\t\t\tdetails: msg\n\t\t\t} );\n\t\t} );\n\t}\n} );\n\nmodule.exports = TalkSectionAddOverlay;\n","var\n\tuser = mw.user,\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tPageGateway = require( '../mobile.startup/PageGateway' ),\n\tOverlay = require( '../mobile.startup/Overlay' ),\n\tutil = require( '../mobile.startup/util' ),\n\tpopup = require( '../mobile.startup/toast' ),\n\tautosign = require( './autosign' ),\n\tPage = require( '../mobile.startup/Page' ),\n\tButton = require( '../mobile.startup/Button' );\n\n/**\n * Overlay for showing talk page section\n * @class TalkSectionOverlay\n * @extends Overlay\n * @uses PageGateway\n * @uses Page\n * @uses Button\n * @uses Toast\n * @param {Object} options\n */\nfunction TalkSectionOverlay( options ) {\n\tthis.editorApi = options.api;\n\tthis.pageGateway = new PageGateway( options.api );\n\tOverlay.call( this,\n\t\tutil.extend( options, {\n\t\t\tclassName: 'talk-overlay overlay',\n\t\t\tevents: {\n\t\t\t\t'focus textarea': 'onFocusTextarea',\n\t\t\t\t'click .save-button': 'onSaveClick'\n\t\t\t}\n\t\t} )\n\t);\n}\n\nmfExtend( TalkSectionOverlay, Overlay, {\n\ttemplatePartials: util.extend( {}, Overlay.prototype.templatePartials, {\n\t\theader: mw.template.get( 'mobile.talk.overlays', 'Section/header.hogan' ),\n\t\tcontent: mw.template.get( 'mobile.talk.overlays', 'Section/content.hogan' )\n\t} ),\n\t/**\n\t * @memberof TalkSectionOverlay\n\t * @instance\n\t * @mixes Overlay#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} defaults.title Title.\n\t * @property {Section} defaults.section that is currently being viewed in overlay.\n\t * @property {string} defaults.reply Reply heading.\n\t * @property {string} defaults.info Message that informs the user their talk reply will be\n\t * automatically signed.\n\t */\n\tdefaults: util.extend( {}, Overlay.prototype.defaults, {\n\t\tsaveButton: new Button( {\n\t\t\tblock: true,\n\t\t\tadditionalClassNames: 'save-button',\n\t\t\tprogressive: true,\n\t\t\tlabel: mw.msg( 'mobile-frontend-editor-save' )\n\t\t} ).options,\n\t\ttitle: undefined,\n\t\tsection: undefined,\n\t\treply: mw.msg( 'mobile-frontend-talk-reply' ),\n\t\tinfo: mw.msg( 'mobile-frontend-talk-reply-info' )\n\t} ),\n\t/**\n\t * Fetches the talk topics of the page specified in options.title\n\t * if options.section is not defined.\n\t * @inheritdoc\n\t * @memberof TalkSectionOverlay\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tOverlay.prototype.postRender.apply( this );\n\t\tthis.$saveButton = this.$( '.save-button' );\n\t\tif ( !this.options.section ) {\n\t\t\tthis.renderFromApi( this.options );\n\t\t} else {\n\t\t\tthis.hideSpinner();\n\t\t\tthis._enableComments();\n\t\t}\n\t},\n\t/**\n\t * Enables comments on the current rendered talk topic\n\t * @memberof TalkSectionOverlay\n\t * @instance\n\t * @private\n\t */\n\t_enableComments: function () {\n\t\tthis.$commentBox = this.$( '.comment' );\n\t\tif ( user.isAnon() ) {\n\t\t\tthis.$commentBox.remove();\n\t\t} else {\n\t\t\tthis.$textarea = this.$commentBox.find( 'textarea' );\n\t\t}\n\t},\n\t/**\n\t * Loads the discussion from api and add it to the Overlay\n\t * @memberof TalkSectionOverlay\n\t * @instance\n\t * @param {Object} options Render options\n\t */\n\trenderFromApi: function ( options ) {\n\t\tvar self = this;\n\n\t\tthis.pageGateway.getPage( options.title ).then( function ( pageData ) {\n\t\t\tvar page = new Page( pageData );\n\t\t\toptions.section = page.getSection( options.id );\n\t\t\tself.render( options );\n\t\t\tself.hideSpinner();\n\t\t} );\n\t},\n\t/**\n\t * Handler for focus of textarea\n\t * @memberof TalkSectionOverlay\n\t * @instance\n\t */\n\tonFocusTextarea: function () {\n\t\tthis.$textarea.removeClass( 'error' );\n\t},\n\t/**\n\t * Handle a click on the save button\n\t * @memberof TalkSectionOverlay\n\t * @instance\n\t */\n\tonSaveClick: function () {\n\t\tvar val = this.$textarea.val(),\n\t\t\tself = this;\n\n\t\tfunction enableSaveButton() {\n\t\t\tself.$saveButton.prop( 'disabled', false );\n\t\t}\n\t\tif ( val ) {\n\t\t\t// show a spinner\n\t\t\tthis.showSpinner();\n\t\t\tthis.$saveButton.prop( 'disabled', true );\n\t\t\t// sign and add newline to front\n\t\t\tval = '\\n\\n' + autosign( val );\n\t\t\t// FIXME: This should be using a gateway\n\t\t\t// e.g. TalkGateway, PageGateway or EditorGateway\n\t\t\tthis.editorApi.postWithToken( 'csrf', {\n\t\t\t\taction: 'edit',\n\t\t\t\ttitle: this.options.title,\n\t\t\t\tsection: this.options.id,\n\t\t\t\tappendtext: val,\n\t\t\t\tredirect: true\n\t\t\t} ).then( function () {\n\t\t\t\tpopup.show( mw.msg( 'mobile-frontend-talk-reply-success' ) );\n\t\t\t\t// invalidate the cache\n\t\t\t\tself.pageGateway.invalidatePage( self.options.title );\n\n\t\t\t\tself.renderFromApi( self.options );\n\n\t\t\t\tenableSaveButton();\n\t\t\t}, function ( data, response ) {\n\t\t\t\t// FIXME: Code sharing with EditorOverlay?\n\t\t\t\tvar msg,\n\t\t\t\t\t// When save failed with one of these error codes, the returned\n\t\t\t\t\t// message in response.error.info will be forwarded to the user.\n\t\t\t\t\t// FIXME: This shouldn't be needed when info texts are all localized.\n\t\t\t\t\twhitelistedErrorInfo = [\n\t\t\t\t\t\t'readonly',\n\t\t\t\t\t\t'blocked',\n\t\t\t\t\t\t'autoblocked'\n\t\t\t\t\t];\n\n\t\t\t\tif (\n\t\t\t\t\tresponse.error &&\n\t\t\t\t\twhitelistedErrorInfo.indexOf( response.error.code ) > -1\n\t\t\t\t) {\n\t\t\t\t\tmsg = response.error.info;\n\t\t\t\t} else {\n\t\t\t\t\tmsg = mw.msg( 'mobile-frontend-editor-error' );\n\t\t\t\t}\n\n\t\t\t\tself.hideSpinner();\n\t\t\t\tpopup.show( msg, 'toast error' );\n\n\t\t\t\tenableSaveButton();\n\t\t\t} );\n\t\t} else {\n\t\t\tthis.$textarea.addClass( 'error' );\n\t\t}\n\t}\n} );\n\nmodule.exports = TalkSectionOverlay;\n","/**\n * Autosign a block of text if necessary\n * @instance\n * @param {string} text\n * @return {string} text with an autosign (\"~~~~\") if necessary\n */\nfunction autosign( text ) {\n\treturn /~{3,5}/.test( text ) ? text : text + ' ~~~~';\n}\n\nmodule.exports = autosign;\n","var\n\tutil,\n\tCategoryGateway,\n\tsandbox,\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' );\n\nQUnit.module( 'MobileFrontend CategoryGateway.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\tutil = require( '../../../src/mobile.startup/util' );\n\t\tCategoryGateway = require( '../../../src/mobile.categories.overlays/CategoryGateway' );\n\n\t\tthis.getSpy = {\n\t\t\tget: sandbox.stub().returns( util.Deferred().resolve( {\n\t\t\t\tbatchcomplete: true,\n\t\t\t\tquery: {\n\t\t\t\t\tpages: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpageid: 5,\n\t\t\t\t\t\t\tns: 0,\n\t\t\t\t\t\t\ttitle: 'HelloWorld',\n\t\t\t\t\t\t\tcategories: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tns: 14,\n\t\t\t\t\t\t\t\t\ttitle: 'Category:Hello'\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t} ) )\n\t\t};\n\t\tthis.postSpy = {\n\t\t\tpostWithToken: sandbox.stub().returns( util.Deferred().resolve() )\n\t\t};\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'getCategories()', function ( assert ) {\n\tvar\n\t\tself = this,\n\t\tresult,\n\t\tgateway = new CategoryGateway( this.getSpy );\n\n\tresult = gateway.getCategories( 'HelloWorld' );\n\tassert.notStrictEqual( result, false, 'result should not return false' );\n\n\treturn result.then( function () {\n\t\tassert.strictEqual( gateway.canContinue, false, 'gateway should not continue' );\n\t\tassert.ok( self.getSpy.get.calledWith( {\n\t\t\taction: 'query',\n\t\t\tprop: 'categories',\n\t\t\ttitles: 'HelloWorld',\n\t\t\tclprop: 'hidden',\n\t\t\tcllimit: 50,\n\t\t\tformatversion: 2\n\t\t} ), 'invalid data passed to get api request' );\n\t} );\n\n} );\n\nQUnit.test( 'save()', function ( assert ) {\n\tvar\n\t\tself = this,\n\t\tgateway = new CategoryGateway( this.postSpy ),\n\t\ttitle = 'HelloWorld',\n\t\tcategories = '[[Category:World]]';\n\n\treturn gateway.save( title, categories ).then( function () {\n\t\tassert.ok( self.postSpy.postWithToken.calledWith( 'csrf', {\n\t\t\taction: 'edit',\n\t\t\ttitle: title,\n\t\t\tappendtext: categories,\n\t\t\tsummary: mw.msg( 'mobile-frontend-categories-summary' )\n\t\t} ), 'invalid data passed to post api request' );\n\t} );\n} );\n","var sandbox, EditorGateway, spy, postStub, apiReject, apiHappy, apiRvNoSection,\n\tapiCaptchaFail, apiAbuseFilterDisallow, apiAbuseFilterWarning, apiAbuseFilterOther,\n\tapiTestError, apiReadOnly, apiExpiredToken, apiWithSectionLine, apiHappyTestContent,\n\tapiEmptySuccessResponse, apiNoSectionLine, apiRejectHttp,\n\tutil = require( '../../../src/mobile.startup/util' ),\n\thappyResponse,\n\tcaptcha = {\n\t\ttype: 'image',\n\t\tmime: 'image/png',\n\t\tid: '1852528679',\n\t\turl: '/w/index.php?title=Especial:Captcha/image&wpCaptchaId=1852528679'\n\t},\n\tapiReadOnlyResponse = {\n\t\terror: {\n\t\t\tcode: 'readonly',\n\t\t\tinfo: 'The wiki is currently in read-only mode.',\n\t\t\treadonlyreason: 'This wiki is currently being upgraded to a newer software version.'\n\t\t}\n\t},\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tsinon = require( 'sinon' ),\n\too = require( '../utils/oo' ),\n\tmediaWiki = require( '../utils/mw' );\n\nQUnit.module( 'MobileFrontend mobile.editor.overlay/EditorGateway', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\tEditorGateway = require( '../../../src/mobile.editor.overlay/EditorGateway' );\n\t\thappyResponse = util.Deferred().resolve( {\n\t\t\tquery: {\n\t\t\t\tpages: [\n\t\t\t\t\t{\n\t\t\t\t\t\trevisions: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttimestamp: '2013-05-15T00:30:26Z',\n\t\t\t\t\t\t\t\tcontent: 'section'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t]\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\tuserinfo: {\n\t\t\t\t\tid: 0\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\t\tapiHappy = new mw.Api();\n\t\tapiReject = new mw.Api();\n\t\tapiRvNoSection = new mw.Api();\n\t\tapiCaptchaFail = new mw.Api();\n\t\tapiAbuseFilterDisallow = new mw.Api();\n\t\tapiAbuseFilterWarning = new mw.Api();\n\t\tapiAbuseFilterOther = new mw.Api();\n\t\tapiTestError = new mw.Api();\n\t\tapiReadOnly = new mw.Api();\n\t\tapiExpiredToken = new mw.Api();\n\t\tapiWithSectionLine = new mw.Api();\n\t\tapiHappyTestContent = new mw.Api();\n\t\tapiRejectHttp = new mw.Api();\n\t\tapiEmptySuccessResponse = new mw.Api();\n\t\tapiNoSectionLine = new mw.Api();\n\t\tsandbox.stub( apiCaptchaFail, 'postWithToken' ).returns(\n\t\t\tutil.Deferred().resolve( {\n\t\t\t\tedit: {\n\t\t\t\t\tresult: 'Failure',\n\t\t\t\t\tcaptcha: captcha\n\t\t\t\t}\n\t\t\t} )\n\t\t);\n\t\tspy = sandbox.stub( apiHappy, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiReject, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiRejectHttp, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiHappyTestContent, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiEmptySuccessResponse, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiAbuseFilterDisallow, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiAbuseFilterOther, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiTestError, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiExpiredToken, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiWithSectionLine, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiReadOnly, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiAbuseFilterWarning, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiCaptchaFail, 'get' ).returns( happyResponse );\n\t\tsandbox.stub( apiRvNoSection, 'get' ).returns(\n\t\t\tutil.Deferred().resolve( {\n\t\t\t\terror: {\n\t\t\t\t\tcode: 'rvnosuchsection'\n\t\t\t\t}\n\t\t\t} )\n\t\t);\n\t\tsandbox.stub( apiReject, 'postWithToken' ).returns( util.Deferred().resolve(\n\t\t\t{\n\t\t\t\terror: {\n\t\t\t\t\tcode: 'error code'\n\t\t\t\t}\n\t\t\t}\n\t\t) );\n\t\tsandbox.stub( apiRejectHttp, 'postWithToken' ).returns( util.Deferred().reject() );\n\t\tpostStub = sandbox.stub( apiHappy, 'postWithToken' ).returns(\n\t\t\tutil.Deferred().resolve( {\n\t\t\t\tedit: {\n\t\t\t\t\tresult: 'Success'\n\t\t\t\t}\n\t\t\t} )\n\t\t);\n\t\tsandbox.stub( apiEmptySuccessResponse, 'postWithToken' ).returns( util.Deferred().resolve( {} ) );\n\t\tsandbox.stub( apiHappyTestContent, 'post' ).returns( util.Deferred().resolve( {\n\t\t\tparse: {\n\t\t\t\ttitle: 'test',\n\t\t\t\ttext: {\n\t\t\t\t\t'*': '<h1>Heading 1</h1><h2>Heading 2</h2><p>test content</p>'\n\t\t\t\t},\n\t\t\t\tsections: {}\n\t\t\t}\n\t\t} ) );\n\t\tsandbox.stub( apiNoSectionLine, 'post' ).returns( util.Deferred().resolve( {\n\t\t\tparse: {\n\t\t\t\ttitle: 'test',\n\t\t\t\ttext: {\n\t\t\t\t\t'*': 'test content'\n\t\t\t\t},\n\t\t\t\tsections: {}\n\t\t\t}\n\t\t} ) );\n\t\tsandbox.stub( apiWithSectionLine, 'post' ).returns( util.Deferred().resolve( {\n\t\t\tparse: {\n\t\t\t\ttitle: 'test',\n\t\t\t\ttext: {\n\t\t\t\t\t'*': 'test content'\n\t\t\t\t},\n\t\t\t\tsections: {\n\t\t\t\t\t0: {\n\t\t\t\t\t\tline: 'Testsection'\n\t\t\t\t\t},\n\t\t\t\t\t1: {\n\t\t\t\t\t\tline: 'Testsection2'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} ) );\n\t\tsandbox.stub( apiExpiredToken, 'postWithToken' )\n\t\t\t.onFirstCall().returns( util.Deferred().resolve( {\n\t\t\t\tedit: {\n\t\t\t\t\tresult: 'Success'\n\t\t\t\t}\n\t\t\t} ) );\n\t\tsandbox.stub( apiAbuseFilterWarning, 'postWithToken' ).returns(\n\t\t\tutil.Deferred().resolve( {\n\t\t\t\tedit: {\n\t\t\t\t\tcode: 'abusefilter-warning-usuwanie-tekstu',\n\t\t\t\t\tinfo: 'Hit AbuseFilter: Usuwanie du\\u017cej ilo\\u015bci tekstu',\n\t\t\t\t\twarning: 'horrible desktop-formatted message',\n\t\t\t\t\tresult: 'Failure'\n\t\t\t\t}\n\t\t\t} )\n\t\t);\n\t\tsandbox.stub( apiAbuseFilterDisallow, 'postWithToken' ).returns(\n\t\t\tutil.Deferred().resolve( {\n\t\t\t\tedit: {\n\t\t\t\t\tcode: 'abusefilter-disallow',\n\t\t\t\t\tinfo: 'Scary filter',\n\t\t\t\t\twarning: 'horrible desktop-formatted message',\n\t\t\t\t\tresult: 'Failure'\n\t\t\t\t}\n\t\t\t} )\n\t\t);\n\t\tsandbox.stub( apiAbuseFilterOther, 'postWithToken' ).returns(\n\t\t\tutil.Deferred().resolve( {\n\t\t\t\tedit: {\n\t\t\t\t\tcode: 'abusefilter-something',\n\t\t\t\t\tinfo: 'Scary filter',\n\t\t\t\t\twarning: 'horrible desktop-formatted message',\n\t\t\t\t\tresult: 'Failure'\n\t\t\t\t}\n\t\t\t} )\n\t\t);\n\t\tsandbox.stub( apiTestError, 'postWithToken' ).returns(\n\t\t\tutil.Deferred().resolve( {\n\t\t\t\tedit: {\n\t\t\t\t\tcode: 'testerror',\n\t\t\t\t\tresult: 'Failure'\n\t\t\t\t}\n\t\t\t} )\n\t\t);\n\t\tsandbox.stub( apiReadOnly, 'postWithToken' ).returns( util.Deferred().reject( 'readonly', apiReadOnlyResponse ) );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#getContent (no section)', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiHappy,\n\t\ttitle: 'MediaWiki:Test.css'\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tassert.ok( spy.calledWith( {\n\t\t\taction: 'query',\n\t\t\tprop: [ 'revisions', 'info' ],\n\t\t\tmeta: 'userinfo',\n\t\t\trvprop: [ 'content', 'timestamp' ],\n\t\t\ttitles: 'MediaWiki:Test.css',\n\t\t\tintestactions: 'edit',\n\t\t\tintestactionsdetail: 'full',\n\t\t\tuiprop: 'options',\n\t\t\tformatversion: 2\n\t\t} ), 'rvsection not passed to api request' );\n\t} );\n} );\n\nQUnit.test( '#getContent', function ( assert ) {\n\tvar gateway;\n\n\tgateway = new EditorGateway( {\n\t\tapi: apiHappy,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function ( resp ) {\n\t\tassert.strictEqual( resp.text, 'section', 'return section content' );\n\t\tassert.strictEqual( resp.blockinfo, null );\n\t\treturn gateway.getContent();\n\t} ).then( function () {\n\t\tassert.strictEqual( spy.callCount, 1, 'cache content' );\n\t} );\n} );\n\nQUnit.test( '#getContent, new page', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiHappy,\n\t\ttitle: 'test',\n\t\tisNewPage: true\n\t} );\n\n\treturn gateway.getContent().then( function ( resp ) {\n\t\tassert.strictEqual( resp.text, '', 'return empty section' );\n\t\tassert.strictEqual( resp.blockinfo, undefined );\n\t\tassert.notOk( spy.called, 'don\\'t try to retrieve content using API' );\n\t} );\n} );\n\nQUnit.test( '#getContent, missing section', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiRvNoSection,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\tassert.rejects( gateway.getContent(), /^rvnosuchsection$/, 'return error code' );\n} );\n\nQUnit.test( '#getBlockInfo', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\t\tapi: apiHappy,\n\t\t\ttitle: 'test'\n\t\t} ),\n\t\tblockinfo = {\n\t\t\tblockedby: 'Test'\n\t\t},\n\t\tpageObj = {\n\t\t\trevisions: [\n\t\t\t\t{}\n\t\t\t],\n\t\t\tactions: {\n\t\t\t\tedit: [\n\t\t\t\t\t{\n\t\t\t\t\t\tcode: 'blocked',\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tblockinfo: blockinfo\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t}\n\t\t};\n\n\tassert.strictEqual( blockinfo, gateway.getBlockInfo( pageObj ) );\n} );\n\nQUnit.test( '#save, success', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiHappy,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\t\tassert.strictEqual( gateway.hasChanged, true, 'hasChanged is true' );\n\t\treturn gateway.save( {\n\t\t\tsummary: 'summary'\n\t\t} );\n\t} ).then( function () {\n\t\tassert.strictEqual( gateway.hasChanged, false, 'reset hasChanged' );\n\t\tassert.ok( postStub.calledWith( 'csrf', {\n\t\t\taction: 'edit',\n\t\t\ttitle: 'test',\n\t\t\tsection: 1,\n\t\t\ttext: 'section 1',\n\t\t\tsummary: 'summary',\n\t\t\tcaptchaid: undefined,\n\t\t\tcaptchaword: undefined,\n\t\t\tbasetimestamp: '2013-05-15T00:30:26Z',\n\t\t\tstarttimestamp: '2013-05-15T00:30:26Z'\n\t\t} ), 'save first section' );\n\t} );\n} );\n\nQUnit.test( '#save, new page', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiHappy,\n\t\ttitle: 'Talk:test',\n\t\tisNewPage: true\n\t} );\n\n\tgateway.getContent();\n\tgateway.setContent( 'section 0' );\n\treturn gateway.save( {\n\t\tsummary: 'summary'\n\t} ).then( function () {\n\t\tassert.strictEqual( gateway.hasChanged, false, 'reset hasChanged' );\n\t\tassert.ok( postStub.calledWith( 'csrf', {\n\t\t\taction: 'edit',\n\t\t\ttitle: 'Talk:test',\n\t\t\ttext: 'section 0',\n\t\t\tsummary: 'summary',\n\t\t\tcaptchaid: undefined,\n\t\t\tcaptchaword: undefined,\n\t\t\tbasetimestamp: undefined,\n\t\t\tstarttimestamp: undefined\n\t\t} ), 'save lead section' );\n\t} );\n} );\n\nQUnit.test( '#save, after #setPrependText', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiHappy,\n\t\ttitle: 'test'\n\t} );\n\n\tgateway.setPrependText( 'abc' );\n\treturn gateway.save( {\n\t\tsummary: 'summary'\n\t} ).then( function () {\n\t\tassert.strictEqual( gateway.hasChanged, false, 'reset hasChanged' );\n\t\tassert.ok( postStub.calledWith( 'csrf', {\n\t\t\taction: 'edit',\n\t\t\ttitle: 'test',\n\t\t\tprependtext: 'abc',\n\t\t\tsummary: 'summary',\n\t\t\tcaptchaid: undefined,\n\t\t\tcaptchaword: undefined,\n\t\t\tbasetimestamp: undefined,\n\t\t\tstarttimestamp: undefined\n\t\t} ), 'prepend text' );\n\t} );\n} );\n\nQUnit.test( '#save, submit CAPTCHA', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiHappy,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\t} ).then( function () {\n\t\treturn gateway.save( {\n\t\t\tsummary: 'summary',\n\t\t\tcaptchaId: 123,\n\t\t\tcaptchaWord: 'abc'\n\t\t} );\n\t} ).then( function () {\n\t\tassert.strictEqual( gateway.hasChanged, false, 'reset hasChanged' );\n\t\tassert.ok( postStub.calledWith( 'csrf', {\n\t\t\taction: 'edit',\n\t\t\ttitle: 'test',\n\t\t\tsection: 1,\n\t\t\ttext: 'section 1',\n\t\t\tsummary: 'summary',\n\t\t\tcaptchaid: 123,\n\t\t\tcaptchaword: 'abc',\n\t\t\tbasetimestamp: '2013-05-15T00:30:26Z',\n\t\t\tstarttimestamp: '2013-05-15T00:30:26Z'\n\t\t} ), 'save first section' );\n\t} );\n} );\n\nQUnit.test( '#save, request failure', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiRejectHttp,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\t\tassert.rejects( gateway.save(), function ( given ) {\n\t\t\tassert.propEqual( given, {\n\t\t\t\ttype: 'error',\n\t\t\t\tdetails: 'http'\n\t\t\t}, 'called with correct arguments' );\n\n\t\t\treturn true;\n\t\t}, 'call fail' );\n\t} );\n} );\n\nQUnit.test( '#save, API failure', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiReject,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\t\tassert.rejects( gateway.save(), function ( given ) {\n\t\t\tassert.propEqual( given, {\n\t\t\t\ttype: 'error',\n\t\t\t\tdetails: 'error code'\n\t\t\t}, 'called with correct arguments' );\n\n\t\t\treturn true;\n\t\t}, 'call fail' );\n\t} );\n} );\n\nQUnit.test( '#save, CAPTCHA response with image URL', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiCaptchaFail,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\t\tassert.rejects( gateway.save(), function ( given ) {\n\t\t\tassert.propEqual( given, {\n\t\t\t\ttype: 'captcha',\n\t\t\t\tdetails: captcha\n\t\t\t}, 'called with correct arguments' );\n\n\t\t\treturn true;\n\t\t}, 'call fail' );\n\t} );\n} );\n\nQUnit.test( '#save, AbuseFilter warning', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiAbuseFilterWarning,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\n\t\tassert.rejects( gateway.save(), function ( given ) {\n\t\t\tassert.propEqual( given, {\n\t\t\t\ttype: 'abusefilter',\n\t\t\t\tdetails: {\n\t\t\t\t\ttype: 'warning',\n\t\t\t\t\tmessage: 'horrible desktop-formatted message'\n\t\t\t\t}\n\t\t\t}, 'called with correct arguments' );\n\n\t\t\treturn true;\n\t\t}, 'call fail' );\n\t} );\n} );\n\nQUnit.test( '#save, AbuseFilter disallow', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiAbuseFilterDisallow,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\n\t\tassert.rejects( gateway.save(), function ( given ) {\n\t\t\tassert.propEqual( given, {\n\t\t\t\ttype: 'abusefilter',\n\t\t\t\tdetails: {\n\t\t\t\t\ttype: 'disallow',\n\t\t\t\t\tmessage: 'horrible desktop-formatted message'\n\t\t\t\t}\n\t\t\t}, 'called with correct arguments' );\n\n\t\t\treturn true;\n\t\t}, 'call fail' );\n\t} );\n} );\n\nQUnit.test( '#save, AbuseFilter other', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiAbuseFilterOther,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\n\t\tassert.rejects( gateway.save(), function ( given ) {\n\t\t\tassert.propEqual( given, {\n\t\t\t\ttype: 'abusefilter',\n\t\t\t\tdetails: {\n\t\t\t\t\ttype: 'other',\n\t\t\t\t\tmessage: 'horrible desktop-formatted message'\n\t\t\t\t}\n\t\t\t}, 'called with correct arguments' );\n\n\t\t\treturn true;\n\t\t}, 'call fail' );\n\t} );\n} );\n\nQUnit.test( '#save, extension errors', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiTestError,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\n\t\tassert.rejects( gateway.save(), function ( given ) {\n\t\t\tassert.propEqual( given, {\n\t\t\t\ttype: 'error',\n\t\t\t\tdetails: 'testerror'\n\t\t\t}, 'called with correct arguments' );\n\n\t\t\treturn true;\n\t\t}, 'call fail' );\n\t} );\n} );\nQUnit.test( '#save, read-only error', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\t\tapi: apiReadOnly,\n\t\t\ttitle: 'test',\n\t\t\tsectionId: 1\n\t\t} ),\n\t\tresolveSpy = sandbox.spy(),\n\t\trejectSpy = sandbox.spy(),\n\t\tdone = assert.async(),\n\t\texpectedReturnValue = {\n\t\t\ttype: 'readonly',\n\t\t\tdetails: {\n\t\t\t\tcode: 'readonly',\n\t\t\t\tinfo: 'The wiki is currently in read-only mode.',\n\t\t\t\treadonlyreason: 'This wiki is currently being upgraded to a newer software version.'\n\t\t\t}\n\t\t};\n\n\tgateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\t\treturn gateway.save();\n\t} ).then( resolveSpy, rejectSpy ).then( function () {\n\t\tassert.strictEqual( rejectSpy.calledWith( expectedReturnValue ), true );\n\t\tassert.strictEqual( resolveSpy.called, false, 'don\\'t call resolve' );\n\t\tdone();\n\t} );\n\n} );\n\nQUnit.test( '#save, unknown errors', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiEmptySuccessResponse,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\n\t\tassert.rejects( gateway.save(), function ( given ) {\n\t\t\tassert.propEqual( given, {\n\t\t\t\ttype: 'error',\n\t\t\t\tdetails: 'unknown'\n\t\t\t}, 'called with correct arguments' );\n\n\t\t\treturn true;\n\t\t}, 'call fail' );\n\t} );\n} );\n\nQUnit.test( '#save, without changes', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiHappy,\n\t\ttitle: 'test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\treturn gateway.setContent( 'section' );\n\t} ).then( function () {\n\t\tassert.strictEqual( gateway.hasChanged, false, 'hasChanged is false' );\n\t\treturn gateway.save( {\n\t\t\tsummary: 'summary'\n\t\t} );\n\t} ).then( function () {\n\t\tassert.ok( apiHappy.postWithToken.calledWith( 'csrf', {\n\t\t\taction: 'edit',\n\t\t\ttitle: 'test',\n\t\t\tsection: 1,\n\t\t\ttext: 'section',\n\t\t\tsummary: 'summary',\n\t\t\tcaptchaid: undefined,\n\t\t\tcaptchaword: undefined,\n\t\t\tbasetimestamp: '2013-05-15T00:30:26Z',\n\t\t\tstarttimestamp: '2013-05-15T00:30:26Z'\n\t\t} ), 'save first section' );\n\t} );\n} );\n\nQUnit.test( '#EditorGateway', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\t\tapi: apiHappyTestContent,\n\t\t\ttitle: 'Test',\n\t\t\tsectionId: 1\n\t\t} ),\n\t\tresolveSpy = sandbox.spy();\n\n\treturn gateway.getPreview( { text: 'test content' } )\n\t\t.then( resolveSpy )\n\t\t.then( function () {\n\t\t\tassert.ok( apiHappyTestContent.post.calledWithMatch( {\n\t\t\t\ttext: 'test content'\n\t\t\t} ) );\n\t\t\tassert.ok( resolveSpy.calledWith( {\n\t\t\t\tline: '',\n\t\t\t\ttext: '<h1>Heading 1</h1><h2>Heading 2</h2><p>test content</p>'\n\t\t\t} ) );\n\t\t} );\n\n} );\n\nQUnit.test( '#EditorGateway, check without sectionLine', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiNoSectionLine,\n\t\ttitle: 'Test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getPreview( {\n\t\ttext: 'test content'\n\t} ).then( function ( section ) {\n\t\tassert.strictEqual( section.line, '', 'Ok, no section line returned' );\n\t} );\n} );\n\nQUnit.test( '#EditorGateway, check with sectionLine', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiWithSectionLine,\n\t\ttitle: 'Test',\n\t\tsectionId: 1\n\t} );\n\n\treturn gateway.getPreview( {\n\t\ttext: 'test content'\n\t} ).then( function ( section ) {\n\t\tassert.strictEqual( section.line, 'Testsection', 'Ok, section line returned' );\n\t} );\n} );\n\nQUnit.test( '#save, when token has expired', function ( assert ) {\n\tvar gateway = new EditorGateway( {\n\t\tapi: apiExpiredToken,\n\t\ttitle: 'MediaWiki:Test.css'\n\t} );\n\n\treturn gateway.getContent().then( function () {\n\t\tgateway.setContent( 'section 1' );\n\n\t\treturn gateway.save().then( function () {\n\t\t\tassert.strictEqual( apiExpiredToken.postWithToken.callCount, 1, 'check the spy was called twice' );\n\t\t} );\n\t} );\n} );\n","var sandbox, messageStub, getContentStub, previewResolve,\n\ttestUrl = '/w/index.php?title=User:Test',\n\tEditorGateway, EditorOverlay, BlockMessage,\n\tjQuery = require( '../utils/jQuery' ),\n\tsinon = require( 'sinon' ),\n\tutil = require( '../../../src/mobile.startup/util' ),\n\too = require( '../utils/oo' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' );\n\nQUnit.module( 'MobileFrontend mobile.editor.overlay/EditorOverlay', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tsandbox.stub( mw, 'msg' ).withArgs( 'mobile-frontend-editor-continue' ).returns( 'Continue' )\n\t\t\t.withArgs( 'mobile-frontend-editor-save' ).returns( 'Save' );\n\t\tEditorGateway = require( '../../../src/mobile.editor.overlay/EditorGateway' );\n\t\tEditorOverlay = require( '../../../src/mobile.editor.overlay/EditorOverlay' );\n\t\tBlockMessage = require( '../../../src/mobile.editor.overlay/BlockMessage' );\n\n\t\t// prevent event logging requests\n\t\tsandbox.stub( EditorOverlay.prototype, 'log' ).returns( util.Deferred().resolve() );\n\t\tmessageStub = sandbox.stub( BlockMessage.prototype, 'initialize' );\n\t\tsandbox.stub( BlockMessage.prototype, 'toggle' );\n\t\tgetContentStub = sandbox.stub( EditorGateway.prototype, 'getContent' );\n\t\t// avoid waiting to load 'moment',\n\t\t// using `expiry: 'infinity'` below ensures we don't need it\n\t\tsandbox.stub( mw.loader, 'using' ).returns( { then: function ( callback ) {\n\t\t\tcallback();\n\t\t} } );\n\t\tsandbox.stub( mw, 'confirmCloseWindow' ).returns( {\n\t\t\trelease: function () {}\n\t\t} );\n\t\tsandbox.stub( window, 'scrollTo' );\n\t\tsandbox.stub( mw.util, 'getUrl' ).returns( '/w/index.php?title=User:Test' );\n\t\tsandbox.stub( mw.config, 'get' ).withArgs( 'wgMFEditorOptions' ).returns( {\n\t\t\tskipPreview: true\n\t\t} ).withArgs( 'wgFormattedNamespaces' ).returns( { 2: 'User' } );\n\t\tgetContentStub.returns( util.Deferred().resolve( {\n\t\t\ttext: 'section 0',\n\t\t\tuser: {\n\t\t\t\tid: 1,\n\t\t\t\tname: 'Foo'\n\t\t\t},\n\t\t\tblock: null,\n\t\t\tblockedByUser: null\n\t\t} ) );\n\t\tpreviewResolve = util.Deferred().resolve( { text: 'previewtest' } );\n\t\tsandbox.stub( EditorGateway.prototype, 'getPreview' )\n\t\t\t.returns( previewResolve );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#initialize, blocked user', function ( assert ) {\n\tvar dBlockedContent = util.Deferred().resolve( {\n\t\ttext: 'section 0',\n\t\tuserinfo: {\n\t\t\toptions: {\n\t\t\t\tgender: 'female'\n\t\t\t}\n\t\t},\n\t\tblockinfo: {\n\t\t\tblockedby: 'Test',\n\t\t\tblockexpiry: 'infinity',\n\t\t\tblockreason: 'Testreason'\n\t\t}\n\t} );\n\tgetContentStub.returns( dBlockedContent );\n\t// eslint-disable-next-line no-new\n\tnew EditorOverlay( {\n\t\ttitle: 'test.css'\n\t} );\n\n\treturn dBlockedContent.then( function () {\n\t\tassert.ok(\n\t\t\tmessageStub.calledWith( {\n\t\t\t\tclassName: 'drawer position-fixed',\n\t\t\t\tevents: {\n\t\t\t\t\t'click .cancel': 'onCancel',\n\t\t\t\t\tclick: 'stopPropagation'\n\t\t\t\t},\n\t\t\t\tpartial: false,\n\t\t\t\tuser: {\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tgender: 'female'\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcreator: {\n\t\t\t\t\tname: 'Test',\n\t\t\t\t\turl: testUrl\n\t\t\t\t},\n\t\t\t\texpiry: null,\n\t\t\t\tduration: null,\n\t\t\t\treason: 'Testreason'\n\t\t\t} ),\n\t\t\t'There is a drawer notice, that i am blocked from editing'\n\t\t);\n\t} );\n} );\n\nQUnit.test( '#initialize, with given page and section', function ( assert ) {\n\tvar editorOverlay = new EditorOverlay( {\n\t\ttitle: 'test',\n\t\tsectionId: 0\n\t} );\n\n\t// The gateway is initialized with the correct properties,\n\t// particularly the correct section ID.\n\tassert.strictEqual( editorOverlay.gateway.title, 'test' );\n\tassert.strictEqual( editorOverlay.gateway.isNewPage, undefined );\n\tassert.strictEqual( editorOverlay.gateway.oldId, undefined );\n\tassert.strictEqual( editorOverlay.gateway.sectionId, 0 );\n\n\treturn getContentStub().then( function () {\n\t\tassert.strictEqual( editorOverlay.$content.val(), 'section 0', 'load correct section' );\n\t} );\n} );\n\nQUnit.test( '#initialize, without a section', function ( assert ) {\n\tvar editorOverlay = new EditorOverlay( {\n\t\ttitle: 'test.css'\n\t} );\n\n\treturn getContentStub().then( function () {\n\t\tassert.strictEqual( editorOverlay.gateway.title, 'test.css' );\n\t\tassert.strictEqual( editorOverlay.gateway.isNewPage, undefined );\n\t\tassert.strictEqual( editorOverlay.gateway.oldId, undefined );\n\t\tassert.strictEqual( editorOverlay.gateway.sectionId, undefined );\n\t} );\n} );\n\nQUnit.test( '#preview', function ( assert ) {\n\tvar editorOverlay = new EditorOverlay( {\n\t\ttitle: 'test',\n\t\tsectionId: 0\n\t} );\n\n\teditorOverlay.onStageChanges();\n\n\treturn previewResolve.then( function () {\n\t\tassert.strictEqual( editorOverlay.$preview.text(), '\\npreviewtest\\n', 'preview loaded correctly' );\n\t} );\n} );\n\nQUnit.test( '#without-preview', function ( assert ) {\n\tvar editorOverlay = new EditorOverlay( {\n\t\ttitle: 'test',\n\t\tsectionId: 0\n\t} );\n\treturn getContentStub().then( function () {\n\t\tassert.strictEqual( editorOverlay.$( '.continue' ).text(), 'Save', 'no preview loaded' );\n\t} );\n} );\n\nQUnit.test( '#initialize, as anonymous', function ( assert ) {\n\tvar editorOverlay = new EditorOverlay( {\n\t\ttitle: 'Main_page',\n\t\tisAnon: true\n\t} );\n\n\t// EditorOverlay triggers a call to _loadContent so will always start an async request.\n\t// Make this test async to ensure it finishes and doesn't cause side effects to other functions.\n\treturn getContentStub().then( function () {\n\t\tassert.ok( editorOverlay.$anonWarning.length > 0, 'Editorwarning (IP will be saved) visible.' );\n\t\tassert.ok( editorOverlay.$( '.anonymous' ).length > 0, 'Continue login has a second class.' );\n\t} );\n} );\n","var\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' ),\n\tLanguageOverlay,\n\tsandbox,\n\tapiLanguages = [\n\t\t{\n\t\t\tlang: 'ar',\n\t\t\turl: 'https://ar.wikipedia.org/wiki/%D8%A8%D8%A7%D8%B1%D8%A7%D9%83_%D8%A3%D9%88%D8%A8%D8%A7%D9%85%D8%A7',\n\t\t\ttitle: ' ',\n\t\t\tautonym: ''\n\t\t}, {\n\t\t\tlang: 'be',\n\t\t\turl: 'https://be.wikipedia.org/wiki/%D0%91%D0%B0%D1%80%D0%B0%D0%BA_%D0%90%D0%B1%D0%B0%D0%BC%D0%B0',\n\t\t\ttitle: ' ',\n\t\t\tautonym: ''\n\t\t}, {\n\t\t\tlang: 'be-x-old',\n\t\t\turl: 'https://be-x-old.wikipedia.org/wiki/%D0%91%D0%B0%D1%80%D0%B0%D0%BA_%D0%90%D0%B1%D0%B0%D0%BC%D0%B0',\n\t\t\ttitle: ' ',\n\t\t\tautonym: ' ()'\n\t\t}, {\n\t\t\tlang: 'ko',\n\t\t\turl: 'https://ko.wikipedia.org/wiki/%EB%B2%84%EB%9D%BD_%EC%98%A4%EB%B0%94%EB%A7%88',\n\t\t\ttitle: ' ',\n\t\t\tautonym: ''\n\t\t}, {\n\t\t\tlang: 'ru',\n\t\t\turl: 'https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D0%B0%D0%BC%D0%B0,_%D0%91%D0%B0%D1%80%D0%B0%D0%BA',\n\t\t\ttitle: ', ',\n\t\t\tautonym: ''\n\t\t}, {\n\t\t\tlang: 'uz',\n\t\t\turl: 'https://uz.wikipedia.org/wiki/Barak_Obama',\n\t\t\ttitle: 'Barak Obama',\n\t\t\tautonym: 'ozbekcha/'\n\t\t}, {\n\t\t\tlang: 'zh',\n\t\t\turl: 'https://zh.wikipedia.org/wiki/%E8%B4%9D%E6%8B%89%E5%85%8B%C2%B7%E5%A5%A5%E5%B7%B4%E9%A9%AC',\n\t\t\ttitle: '',\n\t\t\tautonym: ''\n\t\t}, {\n\t\t\tlang: 'zh-min-nan',\n\t\t\turl: 'https://zh-min-nan.wikipedia.org/wiki/Barack_Obama',\n\t\t\ttitle: 'Barack Obama',\n\t\t\tlangname: 'Chinese',\n\t\t\tautonym: 'Bn-lm-g'\n\t\t}, {\n\t\t\tlang: 'zh-yue',\n\t\t\turl: 'https://zh-yue.wikipedia.org/wiki/%E5%A5%A7%E5%B7%B4%E9%A6%AC',\n\t\t\ttitle: '',\n\t\t\tautonym: ''\n\t\t}, {\n\t\t\tlang: 'zu',\n\t\t\turl: 'https://zu.wikipedia.org/wiki/Barack_Obama',\n\t\t\ttitle: 'Barack Obama',\n\t\t\tautonym: 'isiZulu'\n\t\t}\n\t],\n\tdeviceLanguage = 'en-us',\n\tfrequentlyUsedLanguages = {\n\t\t'zh-min-nan': 1,\n\t\tzh: 2,\n\t\ten: 10,\n\t\tko: 1\n\t};\n\nQUnit.module( 'MobileFrontend LanguageOverlay.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\tLanguageOverlay = require( '../../../src/mobile.languages.structured/LanguageOverlay' );\n\n\t\tsandbox.stub( mw.storage, 'get' ).withArgs( 'langMap' )\n\t\t\t.returns( JSON.stringify( frequentlyUsedLanguages ) );\n\n\t\tthis.languageOverlay = new LanguageOverlay( {\n\t\t\tcurrentLanguage: 'en',\n\t\t\tlanguages: apiLanguages,\n\t\t\tvariants: [],\n\t\t\tdeviceLanguage: deviceLanguage\n\t\t} );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'render output', function ( assert ) {\n\tassert.strictEqual(\n\t\tthis.languageOverlay.$( '.site-link-list.suggested-languages a' ).length,\n\t\t3,\n\t\t'There are 3 suggested languages.'\n\t);\n\n\tassert.strictEqual(\n\t\tthis.languageOverlay.$( '.site-link-list.all-languages a' ).length,\n\t\t7,\n\t\t'Seven languages are non-suggested.'\n\t);\n} );\n\nQUnit.test( 'filterLanguages()', function ( assert ) {\n\tthis.languageOverlay.filterLanguages( 'zh' );\n\tassert.strictEqual(\n\t\tthis.languageOverlay.$( '.site-link-list a:not(.hidden)' ).length,\n\t\t3,\n\t\t'Three languages match \"zh\" and only those languages are visible.'\n\t);\n\n\tthis.languageOverlay.filterLanguages( 'ol' );\n\tassert.ok(\n\t\tthis.languageOverlay.$( '.site-link-list a:not(.hidden)' ).length === 1 &&\n\t\tthis.languageOverlay.$( '.site-link-list a:not(.hidden)' ).hasClass( 'be-x-old' ),\n\t\t'One language (be-x-old) matches \"ol\" and only that language is visible.'\n\t);\n\n\tthis.languageOverlay.filterLanguages( 'chin' );\n\tassert.ok(\n\t\tthis.languageOverlay.$( '.site-link-list a:not(.hidden)' ).length === 1 &&\n\t\tthis.languageOverlay.$( '.site-link-list a:not(.hidden)' ).hasClass( 'zh-min-nan' ),\n\t\t'One language (zh-min-nan) matches \"Chin\" (langname) and only that language is visible.'\n\t);\n\n\tthis.languageOverlay.filterLanguages( '' );\n\tassert.strictEqual(\n\t\tthis.languageOverlay.$( '.site-link-list a:not(.hidden)' ).length,\n\t\t10,\n\t\t'The search filter has been cleared. All 10 languages (including variants) are visible.'\n\t);\n\n\tthis.languageOverlay.filterLanguages( '' );\n\tassert.strictEqual(\n\t\tthis.languageOverlay.$( '.site-link-list a:not(.hidden)' ).length,\n\t\t1,\n\t\t'One language matches \"\" and only that language is visible.'\n\t);\n} );\n","var\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\tsinon = require( 'sinon' ),\n\tutil,\n\tsandbox;\n\nQUnit.module( 'MobileFrontend mobile.languages.structured/util.test.js', {\n\tbeforeEach: function () {\n\t\tthis.apiLanguages = [\n\t\t\t{\n\t\t\t\tlang: 'ar',\n\t\t\t\turl: 'https://ar.wikipedia.org/wiki/%D8%A8%D8%A7%D8%B1%D8%A7%D9%83_%D8%A3%D9%88%D8%A8%D8%A7%D9%85%D8%A7',\n\t\t\t\ttitle: ' ',\n\t\t\t\tdir: 'rtl',\n\t\t\t\tautonym: ''\n\t\t\t}, {\n\t\t\t\tlang: 'be',\n\t\t\t\turl: 'https://be.wikipedia.org/wiki/%D0%91%D0%B0%D1%80%D0%B0%D0%BA_%D0%90%D0%B1%D0%B0%D0%BC%D0%B0',\n\t\t\t\ttitle: ' ',\n\t\t\t\tdir: 'ltr',\n\t\t\t\tautonym: ''\n\t\t\t}, {\n\t\t\t\tlang: 'be-x-old',\n\t\t\t\turl: 'https://be-x-old.wikipedia.org/wiki/%D0%91%D0%B0%D1%80%D0%B0%D0%BA_%D0%90%D0%B1%D0%B0%D0%BC%D0%B0',\n\t\t\t\ttitle: ' ',\n\t\t\t\tautonym: ' ()'\n\t\t\t}, {\n\t\t\t\tlang: 'es',\n\t\t\t\turl: 'https://en.wikipedia.org/wiki/Barack_Obama',\n\t\t\t\ttitle: 'Barack Obama',\n\t\t\t\tdir: 'ltr',\n\t\t\t\tautonym: 'Spanish'\n\t\t\t}, {\n\t\t\t\tlang: 'ko',\n\t\t\t\turl: 'https://ko.wikipedia.org/wiki/%EB%B2%84%EB%9D%BD_%EC%98%A4%EB%B0%94%EB%A7%88',\n\t\t\t\ttitle: ' ',\n\t\t\t\tdir: 'ltr',\n\t\t\t\tautonym: ''\n\t\t\t}, {\n\t\t\t\tlang: 'ru',\n\t\t\t\turl: 'https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D0%B0%D0%BC%D0%B0,_%D0%91%D0%B0%D1%80%D0%B0%D0%BA',\n\t\t\t\ttitle: ', ',\n\t\t\t\tdir: 'ltr',\n\t\t\t\tautonym: ''\n\t\t\t}, {\n\t\t\t\tlang: 'uz',\n\t\t\t\turl: 'https://uz.wikipedia.org/wiki/Barak_Obama',\n\t\t\t\ttitle: 'Barak Obama',\n\t\t\t\tdir: 'ltr',\n\t\t\t\tautonym: 'ozbekcha/'\n\t\t\t}, {\n\t\t\t\tlang: 'zh',\n\t\t\t\turl: 'https://zh.wikipedia.org/wiki/%E8%B4%9D%E6%8B%89%E5%85%8B%C2%B7%E5%A5%A5%E5%B7%B4%E9%A9%AC',\n\t\t\t\ttitle: '',\n\t\t\t\tdir: 'ltr',\n\t\t\t\tautonym: ''\n\t\t\t}, {\n\t\t\t\tlang: 'zh-min-nan',\n\t\t\t\turl: 'https://zh-min-nan.wikipedia.org/wiki/Barack_Obama',\n\t\t\t\ttitle: 'Barack Obama',\n\t\t\t\tdir: 'ltr',\n\t\t\t\tautonym: 'Bn-lm-g'\n\t\t\t}, {\n\t\t\t\tlang: 'zh-yue',\n\t\t\t\turl: 'https://zh-yue.wikipedia.org/wiki/%E5%A5%A7%E5%B7%B4%E9%A6%AC',\n\t\t\t\ttitle: '',\n\t\t\t\tdir: 'ltr',\n\t\t\t\tautonym: ''\n\t\t\t}, {\n\t\t\t\tlang: 'zu',\n\t\t\t\turl: 'https://zu.wikipedia.org/wiki/Barack_Obama',\n\t\t\t\ttitle: 'Barack Obama',\n\t\t\t\tdir: 'ltr',\n\t\t\t\tautonym: 'isiZulu'\n\t\t\t}\n\t\t];\n\t\tthis.apiVariants = [ {\n\t\t\tautonym: '',\n\t\t\tlang: 'zh',\n\t\t\turl: '/~bmansurov/mediawiki/index.php/3?variant=zh'\n\t\t}, {\n\t\t\tautonym: '',\n\t\t\tlang: 'zh-hans',\n\t\t\turl: '/~bmansurov/mediawiki/index.php/3?variant=zh-hans'\n\t\t} ];\n\n\t\tthis.deviceLanguage = 'en-us';\n\n\t\tthis.frequentlyUsedLanguages = {\n\t\t\tzh: 2,\n\t\t\tko: 1\n\t\t};\n\n\t\tthis.structuredLanguages = {\n\t\t\tall: [\n\t\t\t\t{\n\t\t\t\t\tlang: 'zh-min-nan',\n\t\t\t\t\tautonym: 'Bn-lm-g',\n\t\t\t\t\ttitle: 'Barack Obama',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://zh-min-nan.wikipedia.org/wiki/Barack_Obama'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'zu',\n\t\t\t\t\tautonym: 'isiZulu',\n\t\t\t\t\ttitle: 'Barack Obama',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://zu.wikipedia.org/wiki/Barack_Obama'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'uz',\n\t\t\t\t\tautonym: 'ozbekcha/',\n\t\t\t\t\ttitle: 'Barak Obama',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://uz.wikipedia.org/wiki/Barak_Obama'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'es',\n\t\t\t\t\tautonym: 'Spanish',\n\t\t\t\t\ttitle: 'Barack Obama',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://en.wikipedia.org/wiki/Barack_Obama'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'be',\n\t\t\t\t\tautonym: '',\n\t\t\t\t\ttitle: ' ',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://be.wikipedia.org/wiki/%D0%91%D0%B0%D1%80%D0%B0%D0%BA_%D0%90%D0%B1%D0%B0%D0%BC%D0%B0'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'be-x-old',\n\t\t\t\t\tautonym: ' ()',\n\t\t\t\t\ttitle: ' ',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://be-x-old.wikipedia.org/wiki/%D0%91%D0%B0%D1%80%D0%B0%D0%BA_%D0%90%D0%B1%D0%B0%D0%BC%D0%B0'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'ru',\n\t\t\t\t\tautonym: '',\n\t\t\t\t\ttitle: ', ',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D0%B0%D0%BC%D0%B0,_%D0%91%D0%B0%D1%80%D0%B0%D0%BA'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'ar',\n\t\t\t\t\tautonym: '',\n\t\t\t\t\ttitle: ' ',\n\t\t\t\t\tdir: 'rtl',\n\t\t\t\t\turl: 'https://ar.wikipedia.org/wiki/%D8%A8%D8%A7%D8%B1%D8%A7%D9%83_%D8%A3%D9%88%D8%A8%D8%A7%D9%85%D8%A7'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'zh-yue',\n\t\t\t\t\tautonym: '',\n\t\t\t\t\ttitle: '',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://zh-yue.wikipedia.org/wiki/%E5%A5%A7%E5%B7%B4%E9%A6%AC'\n\t\t\t\t}\n\t\t\t],\n\t\t\tsuggested: [\n\t\t\t\t{\n\t\t\t\t\tfrequency: 2,\n\t\t\t\t\tlang: 'zh',\n\t\t\t\t\tautonym: '',\n\t\t\t\t\ttitle: '',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://zh.wikipedia.org/wiki/%E8%B4%9D%E6%8B%89%E5%85%8B%C2%B7%E5%A5%A5%E5%B7%B4%E9%A9%AC'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfrequency: 1,\n\t\t\t\t\tlang: 'ko',\n\t\t\t\t\tautonym: '',\n\t\t\t\t\ttitle: ' ',\n\t\t\t\t\tdir: 'ltr',\n\t\t\t\t\turl: 'https://ko.wikipedia.org/wiki/%EB%B2%84%EB%9D%BD_%EC%98%A4%EB%B0%94%EB%A7%88'\n\t\t\t\t}\n\t\t\t]\n\t\t};\n\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\tsandbox.stub( mw.storage, 'get' ).withArgs( 'langMap' )\n\t\t\t.returns( JSON.stringify( this.frequentlyUsedLanguages ) );\n\n\t\tutil = require( '../../../src/mobile.languages.structured/util' );\n\n\t\tthis.saveSpy = sandbox.stub( util, 'saveFrequentlyUsedLanguages' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#getFrequentlyUsedLanguages', function ( assert ) {\n\n\tassert.propEqual( util.getFrequentlyUsedLanguages(), this.frequentlyUsedLanguages,\n\t\t'Frequently used languages is correct.' );\n} );\n\nQUnit.test( '#saveLanguageUsageCount', function ( assert ) {\n\tutil.saveLanguageUsageCount( 'ko', util.getFrequentlyUsedLanguages() );\n\tassert.ok( this.saveSpy.calledWith( {\n\t\tzh: 2,\n\t\tko: 2\n\t} ), 'Frequently used language is correctly saved.' );\n} );\n\nQUnit.test( '#getStructuredLanguages', function ( assert ) {\n\tvar result = util.getStructuredLanguages(\n\t\tthis.apiLanguages, false, this.frequentlyUsedLanguages, this.deviceLanguage\n\t);\n\n\tassert.propEqual(\n\t\tresult,\n\t\tthis.structuredLanguages,\n\t\t'Structured languages are correct, including sort order.'\n\t);\n} );\n\nQUnit.test( '#getStructuredLanguages device language', function ( assert ) {\n\tvar result =\n\t\tutil.getStructuredLanguages( this.apiLanguages, false, {}, 'es-lx' ).suggested[0].lang;\n\n\t// device language is a variant and only the parent language is available\n\tassert.strictEqual(\n\t\tresult,\n\t\t'es',\n\t\t'\"es\" is correctly selected as a suggested language even though the device language is \"es-lx\".'\n\t);\n} );\n\nQUnit.test( '#getStructuredLanguages variants', function ( assert ) {\n\tvar suggestedLanguages,\n\t\tvariantsMap = {};\n\n\tsuggestedLanguages = util.getStructuredLanguages(\n\t\tthis.apiLanguages, this.apiVariants, {}, this.deviceLanguage\n\t).suggested;\n\tthis.apiVariants.forEach( function ( variant ) {\n\t\tvariantsMap[ variant.lang ] = variant;\n\t} );\n\tsuggestedLanguages.forEach( function ( suggestedLanguage ) {\n\t\tassert.ok(\n\t\t\tObject.prototype.hasOwnProperty.call( variantsMap, suggestedLanguage.lang ),\n\t\t\t'Variant \"' + suggestedLanguage.lang + '\" is in the list of suggested languages.'\n\t\t);\n\t} );\n} );\n","var sandbox, ImageGateway, findSizeBucket,\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tutil = require( '../../../src/mobile.startup/util' );\n\nQUnit.module( 'MobileFrontend mobile.mediaViewer/ImageGateway', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\tImageGateway = require( '../../../src/mobile.mediaViewer/ImageGateway' );\n\t\tfindSizeBucket = ImageGateway._findSizeBucket;\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#findSizeBucket', function ( assert ) {\n\tassert.strictEqual( findSizeBucket( 300 ), 320, 'value lower than bucket' );\n\tassert.strictEqual( findSizeBucket( 800 ), 800, 'exact value' );\n\tassert.strictEqual( findSizeBucket( 9999 ), 2880, 'value greater than last bucket' );\n} );\n\nQUnit.test( 'ImageGateway#getThumb (missing page)', function ( assert ) {\n\tvar gateway,\n\t\tapi = {\n\t\t\tget: function () {\n\t\t\t\treturn util.Deferred().resolve( {\n\t\t\t\t\tquery: {\n\t\t\t\t\t\tpages: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttitle: 'Hello',\n\t\t\t\t\t\t\t\tmissing: true\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t]\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t}\n\t\t};\n\tgateway = new ImageGateway( { api: api } );\n\tassert.rejects(\n\t\tgateway.getThumb( 'Missing' ),\n\t\tfunction ( err ) {\n\t\t\treturn err.message.indexOf( 'The API failed' ) !== -1;\n\t\t},\n\t\t'A missing page throws an error which the client must handle'\n\t);\n} );\n","var sandbox, ImageOverlay,\n\tutil = require( '../../../src/mobile.startup/util' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' );\n\nQUnit.module( 'MobileFrontend mobile.mediaViewer/ImageOverlay', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\tImageOverlay = require( '../../../src/mobile.mediaViewer/ImageOverlay' );\n\n\t\tthis.image = {\n\t\t\tdescriptionurl: 'https://commons.wikimedia.org/wiki/File:The_Montgomery,_San_Francisco.jpg',\n\t\t\tthumbheight: 1024,\n\t\t\tthumburl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/The_Montgomery%2C_San_Francisco.jpg/676px-The_Montgomery%2C_San_Francisco.jpg',\n\t\t\tthumbwidth: 676,\n\t\t\turl: 'https://upload.wikimedia.org/wikipedia/commons/b/b1/The_Montgomery%2C_San_Francisco.jpg'\n\t\t};\n\t\tthis.imageGateway = {\n\t\t\tgetThumb: function () {\n\t\t\t\treturn util.Deferred().resolve( {\n\t\t\t\t\tquery: {\n\t\t\t\t\t\tpages: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\timageinfo: [ this.image ]\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t]\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t}\n\t\t};\n\t\tthis.router = {\n\t\t\tgetPath: function () {\n\t\t\t\treturn '/media/File%3AA_cursiva.gif';\n\t\t\t}\n\t\t};\n\t\tthis.thumbnails = [\n\t\t\t{\n\t\t\t\tfilename: 'foo',\n\t\t\t\tgetFileName: function () { return ''; },\n\t\t\t\tgetPath: function () { return ''; },\n\t\t\t\tgetDescription: function () { return ''; }\n\t\t\t},\n\t\t\t{\n\t\t\t\tfilename: 'bar',\n\t\t\t\tgetFileName: function () { return ''; },\n\t\t\t\tgetPath: function () { return ''; },\n\t\t\t\tgetDescription: function () { return ''; }\n\t\t\t}\n\t\t];\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'Shows details bar and image with successful api response', function ( assert ) {\n\tvar overlay = new ImageOverlay( {\n\t\tgateway: this.imageGateway,\n\t\ttitle: decodeURIComponent( this.image.url ),\n\t\tcaption: 'The Montgomery in 2012.',\n\t\trouter: this.router,\n\t\teventBus: {\n\t\t\ton: function () {}\n\t\t}\n\t} );\n\n\treturn this.imageGateway.getThumb().then( function () {\n\t\tassert.strictEqual( overlay.$el.find( 'img' ).length, 1, 'Image is present.' );\n\t\tassert.strictEqual( overlay.$el.find( '.load-fail-msg' ).length, 0, 'Load error msg is not visible' );\n\t\tassert.strictEqual( overlay.$el.find( '.details.is-visible' ).length, 1, 'Details bar present' );\n\t} );\n} );\n\nQUnit.test( 'Shows error message with failed api response', function ( assert ) {\n\tvar overlay, imageGateway = {\n\t\tgetThumb: function () {\n\t\t\treturn util.Deferred().reject( 'Load Error' );\n\t\t}\n\t};\n\n\toverlay = new ImageOverlay( {\n\t\tgateway: imageGateway,\n\t\ttitle: decodeURIComponent( this.image.url ),\n\t\tcaption: 'The Montgomery in 2012.',\n\t\trouter: this.router,\n\t\teventBus: {\n\t\t\ton: function () {}\n\t\t}\n\t} );\n\n\treturn imageGateway.getThumb().catch( function () {\n\t\tassert.strictEqual( overlay.$el.find( '.load-fail-msg' ).length, 1, 'Load error msg is visible' );\n\t\tassert.strictEqual( overlay.$el.find( '.details.is-visible' ).length, 0, 'Details bar is hidden' );\n\t} );\n} );\n\nQUnit.test( 'Toggling of details is disabled when overlay has load failure', function ( assert ) {\n\tvar overlay, imageGateway = {\n\t\tgetThumb: function () {\n\t\t\treturn util.Deferred().reject( 'Load Error' );\n\t\t}\n\t};\n\n\toverlay = new ImageOverlay( {\n\t\tgateway: imageGateway,\n\t\ttitle: decodeURIComponent( this.image.url ),\n\t\tcaption: 'The Montgomery in 2012.',\n\t\tthumbnails: this.thumbnails,\n\t\trouter: this.router,\n\t\teventBus: {\n\t\t\ton: function () {}\n\t\t}\n\t} );\n\n\treturn imageGateway.getThumb().catch( function () {\n\t\tassert.strictEqual( overlay.$el.find( '.details.is-visible' ).length, 0, 'Details bar is hidden' );\n\t\tassert.notStrictEqual( overlay.$el.find( '.details' ), 'none', 'Slider buttons are shown' );\n\t\tassert.notStrictEqual( overlay.$el.find( '.cancel' ), 'none', 'Cancel button is still shown' );\n\t\tassert.notStrictEqual( overlay.$el.find( '.prev' ), 'none', 'Slider buttons are still shown' );\n\n\t\toverlay.$el.find( '.image-wrapper' ).trigger( 'click' );\n\n\t\t// Assert that toggle didn't occur (would add display: none)\n\t\tassert.notStrictEqual( overlay.$el.find( '.details' ), 'none', 'Slider buttons are shown' );\n\t\tassert.notStrictEqual( overlay.$el.find( '.cancel' ), 'none', 'Cancel button is still shown' );\n\t\tassert.notStrictEqual( overlay.$el.find( '.prev' ), 'none', 'Slider buttons are still shown' );\n\t} );\n} );\n\nQUnit.test( 'Toggling of details is enabled when overlay loads successfully', function ( assert ) {\n\tvar overlay = new ImageOverlay( {\n\t\tgateway: this.imageGateway,\n\t\ttitle: decodeURIComponent( this.image.url ),\n\t\tcaption: 'The Montgomery in 2012.',\n\t\tthumbnails: this.thumbnails,\n\t\trouter: this.router,\n\t\teventBus: {\n\t\t\ton: function () {}\n\t\t}\n\t} );\n\n\treturn this.imageGateway.getThumb().then( function () {\n\t\tassert.strictEqual( overlay.$el.find( '.details.is-visible' ).length, 1, 'Details bar is shown' );\n\t\tassert.notStrictEqual( overlay.$el.find( '.details' ).css( 'display' ), 'none', 'Ensure display none rule is not set' );\n\t\tassert.notStrictEqual( overlay.$el.find( '.cancel' ).css( 'display' ), 'none', 'Cancel button is shown' );\n\t\tassert.notStrictEqual( overlay.$el.find( '.prev' ).css( 'display' ), 'none', 'Slider buttons are shown' );\n\n\t\toverlay.$el.find( '.image-wrapper' ).trigger( 'click' );\n\n\t\tassert.strictEqual( overlay.$el.find( '.details' ).css( 'display' ), 'none', 'Details bar is hidden' );\n\t\tassert.strictEqual( overlay.$el.find( '.cancel' ).css( 'display' ), 'none', 'Cancel button is hidden' );\n\t\tassert.strictEqual( overlay.$el.find( '.slider-button' ).css( 'display' ), 'none', 'Slider buttons are hidden' );\n\t} );\n} );\n","var\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' ),\n\tapi = {\n\t\tget: function () {}\n\t},\n\tsandbox,\n\tNearbyGateway,\n\tNearby,\n\tutil;\n\nQUnit.module( 'MobileFrontend Nearby.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\tutil = require( '../../../src/mobile.startup/util' );\n\t\tNearbyGateway = require( '../../../src/mobile.special.nearby.scripts/NearbyGateway' );\n\t\tNearby = require( '../../../src/mobile.special.nearby.scripts/Nearby' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'refresh() with no results, renders empty list', function ( assert ) {\n\tvar $el = util.parseHTML( '<div>' ), nearby,\n\t\tspy = sandbox.stub( NearbyGateway.prototype, 'getPages' )\n\t\t\t.returns( util.Deferred().resolve( [] ) ),\n\t\topts = {\n\t\t\tapi: api,\n\t\t\tlatitude: 37.7,\n\t\t\tlongitude: -122,\n\t\t\trange: 1000,\n\t\t\tel: $el,\n\t\t\teventBus: {\n\t\t\t\temit: function () {}\n\t\t\t}\n\t\t};\n\tnearby = new Nearby( opts );\n\n\treturn nearby.refresh( opts ).then( function () {\n\t\tassert.ok( spy.calledWithMatch( {\n\t\t\tlatitude: 37.7,\n\t\t\tlongitude: -122\n\t\t}, 1000 ), 'Check API got called' );\n\t\tassert.strictEqual( $el.find( 'li' ).length, 0, '0 pages render.' );\n\t\tassert.strictEqual( $el.find( '.errorbox' ).length, 1, 'Error message shown.' );\n\t\tassert.strictEqual( $el.find( '.loading' ).is( ':visible' ), false, 'No loader shown.' );\n\t} );\n} );\n\nQUnit.test( 'refresh() with results, renders with a location', function ( assert ) {\n\tvar\n\t\tspy,\n\t\tresp = {\n\t\t\tquery: {\n\t\t\t\tpages: [\n\t\t\t\t\t{\n\t\t\t\t\t\tpageid: 2,\n\t\t\t\t\t\twatched: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tpageid: 3,\n\t\t\t\t\t\twatched: false\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tpageid: 4,\n\t\t\t\t\t\twatched: false\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t}\n\t\t},\n\t\t$el = util.parseHTML( '<div>' ), nearby,\n\t\topts = {\n\t\t\tapi: api,\n\t\t\tlatitude: 37.7,\n\t\t\tlongitude: -122,\n\t\t\trange: 1000,\n\t\t\tel: $el,\n\t\t\teventBus: {\n\t\t\t\temit: function () {}\n\t\t\t}\n\t\t};\n\n\t// prevent hits to api due to watch status lookup\n\tsandbox.stub( api, 'get' ).returns( util.Deferred().resolve( resp ) );\n\n\tspy = sandbox.stub( NearbyGateway.prototype, 'getPages' )\n\t\t.returns( util.Deferred().resolve( [\n\t\t\t{\n\t\t\t\ttitle: 'Sutro Tower',\n\t\t\t\tid: 2\n\t\t\t},\n\t\t\t{\n\t\t\t\ttitle: 'Golden Gate bridge',\n\t\t\t\tid: 3\n\t\t\t},\n\t\t\t{\n\t\t\t\ttitle: 'Golden Gate Park',\n\t\t\t\tid: 4\n\t\t\t}\n\t\t] ) );\n\n\tnearby = new Nearby( opts );\n\treturn nearby.refresh( opts ).then( function () {\n\t\tassert.ok( spy.calledWithMatch( {\n\t\t\tlatitude: 37.7,\n\t\t\tlongitude: -122\n\t\t}, 1000 ), 'Check API got called' );\n\t\tassert.strictEqual( $el.find( 'li' ).length, 3, '3 pages render.' );\n\t} );\n} );\n\nQUnit.test( 'refresh() with server error, renders error', function ( assert ) {\n\tvar\n\t\t$el = util.parseHTML( '<div>' ),\n\t\tspy = sandbox.stub( NearbyGateway.prototype, 'getPages' )\n\t\t\t.returns( util.Deferred().reject() ),\n\t\tnearby,\n\t\topts = {\n\t\t\tapi: api,\n\t\t\tlatitude: 37.7,\n\t\t\tlongitude: -122,\n\t\t\trange: 1000,\n\t\t\tel: $el,\n\t\t\teventBus: {\n\t\t\t\temit: function () {}\n\t\t\t}\n\t\t};\n\tnearby = new Nearby( opts );\n\n\treturn nearby.refresh( opts ).then( function () {\n\t\tassert.ok( spy.calledWithMatch( {\n\t\t\tlatitude: 37.7,\n\t\t\tlongitude: -122\n\t\t}, 1000 ), 'Check API got called' );\n\t\tassert.strictEqual( $el.find( '.errorbox' ).length, 1, 'Check error got rendered' );\n\t\tassert.strictEqual( $el.find( '.errorbox h2' ).text(),\n\t\t\tnearby.errorMessages.http.heading, 'Check it is the correct heading' );\n\t} );\n} );\n\nQUnit.test( 'refresh() getting a title triggers different API method', function ( assert ) {\n\tvar\n\t\tspy,\n\t\t$el = util.parseHTML( '<div>' ),\n\t\tpageTitle = 'Hello Friends!',\n\t\tnearby,\n\t\topts = {\n\t\t\tapi: api,\n\t\t\tpageTitle: pageTitle,\n\t\t\trange: 1000,\n\t\t\tel: $el,\n\t\t\teventBus: {\n\t\t\t\temit: function () {}\n\t\t\t}\n\t\t};\n\n\tspy = sandbox.stub( NearbyGateway.prototype, 'getPagesAroundPage' )\n\t\t.returns( util.Deferred().reject() );\n\tnearby = new Nearby( opts );\n\tnearby.refresh( opts );\n\n\tassert.ok( spy.calledWithMatch( pageTitle, 1000 ), 'Check API got called' );\n} );\n","var\n\tsandbox,\n\tNearbyGateway,\n\tutil,\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' );\n\nQUnit.module( 'MobileFrontend NearbyGateway.js', {\n\tbeforeEach: function () {\n\t\tvar api;\n\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\t// needed for extendSearchParams to not throw exception about feature not\n\t\t// supporting wikibase descriptions in headless tests\n\t\tsandbox.stub( mw.config, 'get' )\n\t\t\t.withArgs( 'wgArticlePath' ).returns( '/w/' )\n\t\t\t.withArgs( 'wgMFDisplayWikibaseDescriptions', {} )\n\t\t\t.returns( {\n\t\t\t\tnearby: true\n\t\t\t} )\n\t\t\t// needed bc Page.js expects this call to return an array\n\t\t\t.withArgs( 'wgMFMobileFormatterHeadings', [ 'h1', 'h2', 'h3', 'h4', 'h5' ] )\n\t\t\t.returns( [ 'h1', 'h2', 'h3', 'h4', 'h5' ] );\n\n\t\tutil = require( '../../../src/mobile.startup/util' );\n\t\tNearbyGateway = require( '../../../src/mobile.special.nearby.scripts/NearbyGateway' );\n\n\t\tapi = {\n\t\t\tajax: function () {}\n\t\t};\n\t\tthis.nearbyGateway = new NearbyGateway( { api: api } );\n\n\t\t// stub mw.language behavior so we don't have to bring in the real thing\n\t\tsandbox.stub( mw.language, 'convertNumber', function ( arg ) {\n\t\t\treturn arg === '1.20' ? '1.2' : String( arg );\n\t\t} );\n\n\t\tsandbox.stub( api, 'ajax', function () {\n\t\t\treturn util.Deferred().resolve( {\n\t\t\t\tquery: {\n\t\t\t\t\tpages: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpageid: 20004112,\n\t\t\t\t\t\t\tns: 0,\n\t\t\t\t\t\t\ttitle: 'The Montgomery (San Francisco)',\n\t\t\t\t\t\t\tthumbnail: {\n\t\t\t\t\t\t\t\tsource: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/The_Montgomery%2C_San_Francisco.jpg/119px-The_Montgomery%2C_San_Francisco.jpg',\n\t\t\t\t\t\t\t\twidth: 119,\n\t\t\t\t\t\t\t\theight: 180\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tpageimage: 'The_Montgomery,_San_Francisco.jpg',\n\t\t\t\t\t\t\tcoordinates: [ {\n\t\t\t\t\t\t\t\tlat: 37.787,\n\t\t\t\t\t\t\t\tlon: -122.41,\n\t\t\t\t\t\t\t\tprimary: '',\n\t\t\t\t\t\t\t\tglobe: 'earth',\n\t\t\t\t\t\t\t\tdist: 120200\n\t\t\t\t\t\t\t} ]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpageid: 18618509,\n\t\t\t\t\t\t\tns: 0,\n\t\t\t\t\t\t\ttitle: 'Wikimedia Foundation',\n\t\t\t\t\t\t\tthumbnail: {\n\t\t\t\t\t\t\t\tsource: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c4/Wikimedia_Foundation_RGB_logo_with_text.svg/180px-Wikimedia_Foundation_RGB_logo_with_text.svg.png',\n\t\t\t\t\t\t\t\twidth: 180,\n\t\t\t\t\t\t\t\theight: 180\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tpageimage: 'Wikimedia_Foundation_RGB_logo_with_text.svg',\n\t\t\t\t\t\t\tcoordinates: [ {\n\t\t\t\t\t\t\t\tlat: 37.787,\n\t\t\t\t\t\t\t\tlon: -122.51,\n\t\t\t\t\t\t\t\tprimary: '',\n\t\t\t\t\t\t\t\tglobe: 'earth',\n\t\t\t\t\t\t\t\tdist: 0\n\t\t\t\t\t\t\t} ]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpageid: 9297443,\n\t\t\t\t\t\t\tns: 0,\n\t\t\t\t\t\t\ttitle: 'W San Francisco',\n\t\t\t\t\t\t\tcoordinates: [ {\n\t\t\t\t\t\t\t\tlat: 37.7854,\n\t\t\t\t\t\t\t\tlon: -122.61,\n\t\t\t\t\t\t\t\tprimary: '',\n\t\t\t\t\t\t\t\tglobe: 'earth',\n\t\t\t\t\t\t\t\tdist: 177400\n\t\t\t\t\t\t\t} ]\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t} );\n\t\t} );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '_distanceMessage()', function ( assert ) {\n\tvar\n\t\tself = this,\n\t\tmsgKm = 'mobile-frontend-nearby-distance',\n\t\tmsgM = 'mobile-frontend-nearby-distance-meters',\n\t\ttests = [\n\t\t\t[ 0.4834, msgM, '490' ],\n\t\t\t[ 0.5, msgM, '500' ],\n\t\t\t[ 0.723, msgM, '730' ],\n\t\t\t[ 0.999, msgKm, '1' ],\n\t\t\t[ 1.2, msgKm, '1.2' ],\n\t\t\t[ 1.588, msgKm, '1.59' ],\n\t\t\t[ 1.123, msgKm, '1.13' ],\n\t\t\t[ 2.561, msgKm, '2.6' ],\n\t\t\t[ 10.8334, msgKm, '10.9' ]\n\t\t];\n\n\tsandbox.spy( mw, 'msg' );\n\n\ttests.forEach( function ( test, i ) {\n\t\tself.nearbyGateway._distanceMessage( test[ 0 ] );\n\n\t\tassert.propEqual(\n\t\t\tmw.msg.getCall( i ).args,\n\t\t\t[\n\t\t\t\ttest[ 1 ], test[ 2 ]\n\t\t\t]\n\t\t);\n\t} );\n} );\n\nQUnit.test( 'getPages()', function ( assert ) {\n\treturn this.nearbyGateway.getPages( {\n\t\tlatitude: 37.787,\n\t\tlongitude: -122.51\n\t} ).then( function ( pages ) {\n\t\tassert.strictEqual( pages.length, 3 );\n\t\tassert.strictEqual( pages[ 0 ].title, 'Wikimedia Foundation' );\n\t\tassert.strictEqual( pages[ 0 ].thumbnail.isLandscape, false );\n\t\tassert.strictEqual( pages[ 2 ].title, 'W San Francisco' );\n\t\tassert.strictEqual( pages[ 2 ].thumbnail, false );\n\t\tassert.strictEqual( pages[ 2 ].dist.toPrecision( 6 ), '177.400' );\n\t} );\n} );\n\nQUnit.test( 'getPagesAroundPage()', function ( assert ) {\n\treturn this.nearbyGateway.getPagesAroundPage( 'Wikimedia Foundation' ).then( function ( pages ) {\n\t\tassert.strictEqual( pages.length, 2 );\n\t\tassert.strictEqual( pages[ 1 ].title, 'W San Francisco' );\n\t\tassert.strictEqual( pages[ 1 ].thumbnail, false );\n\t\tassert.strictEqual( pages[ 1 ].dist.toPrecision( 6 ), '177.400' );\n\t} );\n} );\n","var PhotoListGateway, sandbox, getDescription,\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' );\n\nQUnit.module( 'PhotoListGateway', {\n\tbeforeEach: function () {\n\t\t// All this stubbing really shouldn't be needed to test getDescription\n\t\t// But it is since require( '../mobile.startup/util' ) is imported by PhotoListGateway\n\t\t// Consider putting getDescription in a separate file to separate it from the View.\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\tPhotoListGateway = require( '../../../src/mobile.special.uploads.scripts/PhotoListGateway' );\n\t\tgetDescription = PhotoListGateway.test.getDescription;\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#getDescription', function ( assert ) {\n\tvar tests = [\n\t\t[ 'File:Pirates in SF 2013-04-03 15-44.png', 'Pirates in SF' ],\n\t\t[ 'File:Unpadded 9 pirates in SF 2013-04-03 15-9.png', 'Unpadded 9 pirates in SF' ],\n\t\t[ 'File:Jon lies next to volcano 2013-03-18 13-37.jpeg', 'Jon lies next to volcano' ],\n\t\t[ 'hello world 37.jpg', 'hello world 37' ],\n\t\t[ 'hello world again.jpeg', 'hello world again' ],\n\t\t[ 'Fichier:French Photo Timestamp 2013-04-03 15-44.jpg', 'French Photo Timestamp' ],\n\t\t[ 'Fichier:Full stop. Photo.unknownfileextension', 'Full stop. Photo' ],\n\t\t[ 'File:No file extension but has a . in the title', 'No file extension but has a . in the title' ],\n\t\t[ 'Fichier:French Photo.jpg', 'French Photo' ]\n\t];\n\n\ttests.forEach( function ( test, i ) {\n\t\tvar val = getDescription( test[ 0 ] );\n\t\tassert.strictEqual( val, test[ 1 ], 'test ' + i );\n\t} );\n} );\n","var\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' ),\n\tWatchList,\n\tIcon,\n\tsandbox;\n\nQUnit.module( 'MobileFrontend WatchList.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\tsandbox.stub( mw.user, 'isAnon' ).returns( false );\n\n\t\tWatchList = require( '../../../src/mobile.special.watchlist.scripts/WatchList' );\n\t\tIcon = require( '../../../src/mobile.startup/Icon' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'In watched mode', function ( assert ) {\n\tvar\n\t\tstub = {\n\t\t\tget: sandbox.stub()\n\t\t},\n\t\tpl = new WatchList( {\n\t\t\teventBus: {\n\t\t\t\ton: function () {},\n\t\t\t\toff: function () {}\n\t\t\t},\n\t\t\tapi: stub,\n\t\t\tpages: [\n\t\t\t\t{ title: 'Title 30' },\n\t\t\t\t{ title: 'Title 50' },\n\t\t\t\t{\n\t\t\t\t\ttitle: 'Title 60',\n\t\t\t\t\twatched: true\n\t\t\t\t}\n\t\t\t]\n\t\t} ),\n\t\twatchIconName = new Icon( {\n\t\t\tname: 'watched'\n\t\t} ).getGlyphClassName();\n\n\t// Avoid API requests due to scroll events (https://phabricator.wikimedia.org/T116258)\n\tpl.scrollEndEventEmitter.disable();\n\n\tassert.ok( stub.get.notCalled, 'Callback avoided' );\n\tassert.strictEqual( pl.$el.find( '.watch-this-article' ).length, 3, '3 articles have watch stars...' );\n\tassert.strictEqual( pl.$el.find( '.' + watchIconName ).length, 3, '...and all are marked as watched.' );\n} );\n","var\n\tWatchListGateway,\n\tsandbox,\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' ),\n\tutil = require( '../../../src/mobile.startup/util' ),\n\tresponse = {\n\t\tcontinue: {\n\t\t\tpageimages: {\n\t\t\t\tpicontinue: 9\n\t\t\t}\n\t\t},\n\t\twarnings: {\n\t\t\tquery: {\n\t\t\t\t'*': 'Formatting of continuation data will be changing soon. To continue using the current formatting, use the \\'rawcontinue\\' parameter. To begin using the new format, pass an empty string for \\'continue\\' in the initial query.'\n\t\t\t}\n\t\t},\n\t\tquery: {\n\t\t\tpages: [\n\t\t\t\t{\n\t\t\t\t\tpageid: 2,\n\t\t\t\t\tns: 0,\n\t\t\t\t\ttitle: 'Burrito',\n\t\t\t\t\tcontentmodel: 'wikitext',\n\t\t\t\t\tpagelanguage: 'en',\n\t\t\t\t\ttouched: '2014-12-17T10:06:49Z',\n\t\t\t\t\tlastrevid: 552,\n\t\t\t\t\tlength: 33534\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tpageid: 3,\n\t\t\t\t\tns: 0,\n\t\t\t\t\ttitle: 'Albert Einstein',\n\t\t\t\t\tcontentmodel: 'wikitext',\n\t\t\t\t\tpagelanguage: 'en',\n\t\t\t\t\ttouched: '2014-12-16T17:33:22Z',\n\t\t\t\t\tlastrevid: 4,\n\t\t\t\t\tlength: 19\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tpageid: 9,\n\t\t\t\t\tns: 0,\n\t\t\t\t\ttitle: 'Anne Dallas Dudley',\n\t\t\t\t\tcontentmodel: 'wikitext',\n\t\t\t\t\tpagelanguage: 'en',\n\t\t\t\t\ttouched: '2014-12-17T10:00:13Z',\n\t\t\t\t\tlastrevid: 18,\n\t\t\t\t\tlength: 12663\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tpageid: 10,\n\t\t\t\t\tns: 0,\n\t\t\t\t\ttitle: 'San Francisco',\n\t\t\t\t\tcontentmodel: 'wikitext',\n\t\t\t\t\tpagelanguage: 'en',\n\t\t\t\t\ttouched: '2014-12-17T10:04:55Z',\n\t\t\t\t\tlastrevid: 546,\n\t\t\t\t\tlength: 373791\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tpageid: 708,\n\t\t\t\t\tns: 0,\n\t\t\t\t\ttitle: 'Functional logic programming',\n\t\t\t\t\tcontentmodel: 'wikitext',\n\t\t\t\t\tpagelanguage: 'en',\n\t\t\t\t\ttouched: '2015-01-12T13:04:23Z',\n\t\t\t\t\tlastrevid: 1307,\n\t\t\t\t\tlength: 1392,\n\t\t\t\t\tnew: ''\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tpageid: 720,\n\t\t\t\t\tns: 0,\n\t\t\t\t\ttitle: 'Functional programming',\n\t\t\t\t\tcontentmodel: 'wikitext',\n\t\t\t\t\tpagelanguage: 'en',\n\t\t\t\t\ttouched: '2015-01-12T13:04:35Z',\n\t\t\t\t\tlastrevid: 1319,\n\t\t\t\t\tlength: 54839,\n\t\t\t\t\tnew: ''\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tns: 0,\n\t\t\t\t\ttitle: 'zzzz',\n\t\t\t\t\tmissing: true,\n\t\t\t\t\tcontentmodel: 'wikitext',\n\t\t\t\t\tpagelanguage: 'en'\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t};\n\nQUnit.module( 'MobileFrontend WatchListGateway.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\t// needed for extendSearchParams to not throw exception about feature not\n\t\t// supporting wikibase descriptions in headless tests\n\t\tsandbox.stub( mw.config, 'get' )\n\t\t\t.withArgs( 'wgMFDisplayWikibaseDescriptions', {} )\n\t\t\t.returns( {\n\t\t\t\twatchlist: true\n\t\t\t} )\n\t\t\t// needed bc Page.js expects this call to return an array\n\t\t\t.withArgs( 'wgMFMobileFormatterHeadings', [ 'h1', 'h2', 'h3', 'h4', 'h5' ] )\n\t\t\t.returns( [ 'h1', 'h2', 'h3', 'h4', 'h5' ] );\n\t\t// needed for browser tests. If not stubbed, Page's newFromJSON() will call\n\t\t// mw.util.getUrl which calls mw.config.get and expects back a value\n\t\tsandbox.stub( mw.util, 'getUrl', function () {} );\n\n\t\tWatchListGateway = require( '../../../src/mobile.special.watchlist.scripts/WatchListGateway' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'loadWatchlist() loads results from the first page', function ( assert ) {\n\tvar gateway = new WatchListGateway( new mw.Api() );\n\n\tsandbox.stub( mw.Api.prototype, 'get' )\n\t\t.returns( util.Deferred().resolve( response ) );\n\n\treturn gateway.loadWatchlist().then( function ( pages ) {\n\t\tvar params = mw.Api.prototype.get.firstCall.args[0];\n\n\t\tassert.strictEqual( params.continue, '', 'It should set the continue parameter' );\n\n\t\tassert.strictEqual( pages.length, 7, 'Got all the results' );\n\t\tassert.strictEqual( pages[0].displayTitle, 'Albert Einstein', 'Sorted alphabetically' );\n\t} );\n} );\n\nQUnit.test( 'loadWatchlist() loads results from the second page from last item of first', function ( assert ) {\n\tvar lastTitle = 'Albert Einstein',\n\t\tgateway = new WatchListGateway( new mw.Api(), lastTitle ),\n\t\tresponse1 = util.extend( {}, response, {\n\t\t\tcontinue: {\n\t\t\t\twatchlistraw: {\n\t\t\t\t\tgwrcontinue: '0|Albert Einstein'\n\t\t\t\t}\n\t\t\t}\n\t\t} ),\n\t\tstub;\n\n\t// First time we call the API for the second page\n\tstub = sandbox.stub( mw.Api.prototype, 'get' )\n\t\t.returns( util.Deferred().resolve( response1 ) );\n\n\treturn gateway.loadWatchlist().then( function ( pages ) {\n\t\tvar params = mw.Api.prototype.get.firstCall.args[0];\n\n\t\tassert.strictEqual( params.continue, 'gwrcontinue||', 'It should set the continue parameter' );\n\t\tassert.strictEqual( params.gwrcontinue, '0|Albert_Einstein', 'It should set the watchlistraw-specific continue parameter' );\n\n\t\t// Albert Einstein should not be in the results since it was the last\n\t\t// item in the first page.\n\t\tassert.strictEqual( pages.length, 6, 'Should have Albert removed from the results' );\n\t\tassert.strictEqual( pages[0].displayTitle, 'Anne Dallas Dudley', 'First item should be Anne' );\n\n\t\t// Let's call for the next page\n\t\tstub.returns( util.Deferred().resolve( response ) );\n\n\t\treturn gateway.loadWatchlist().then( function ( pages ) {\n\t\t\t// Albert Einstein should be the first result of the next page (not removed)\n\t\t\tassert.strictEqual( pages.length, 7, 'Albert should be in the results' );\n\t\t\tassert.strictEqual( pages[0].displayTitle, 'Albert Einstein', 'First item should be Albert' );\n\t\t} );\n\t} );\n} );\n\nQUnit.test( 'loadWatchlist() doesn\\'t throw an error when no pages are returned', function ( assert ) {\n\tvar gateway = new WatchListGateway( new mw.Api() );\n\n\tsandbox.stub( mw.Api.prototype, 'get' )\n\t\t.returns( util.Deferred().resolve( {\n\t\t\tbatchcomplete: ''\n\t\t} ) );\n\n\treturn gateway.loadWatchlist().then( function ( pages ) {\n\t\tassert.propEqual( pages, [] );\n\t} );\n} );\n\nQUnit.test( 'loadWatchlist() marks pages as new if necessary', function ( assert ) {\n\tvar gateway = new WatchListGateway( new mw.Api() );\n\n\tsandbox.stub( mw.Api.prototype, 'get' )\n\t\t.returns( util.Deferred().resolve( response ) );\n\n\treturn gateway.loadWatchlist().then( function ( pages ) {\n\t\tassert.strictEqual( pages[0].isMissing, false, 'Albert Einstein page isn\\'t marked as new' );\n\t\tassert.strictEqual( pages[6].isMissing, true, 'zzzz page is marked as new' );\n\t} );\n} );\n","/* global $ */\nvar\n\tBrowser = require( '../../../src/mobile.startup/Browser' ),\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tsinon = require( 'sinon' ),\n\tmediawiki = require( '../utils/mw' ),\n\t$html;\n/** @type {sinon.SinonSandbox} */ var sandbox; // eslint-disable-line one-var\n\nQUnit.module( 'MobileFrontend Browser.js', {\n\tbeforeEach: function () {\n\t\tvar tmpDOM;\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\tmediawiki.setUp( sandbox, global );\n\t\t// Use an empty html element to avoid calling methods in _fixIosLandscapeBug\n\t\ttmpDOM = window.document.implementation.createHTMLDocument( 'Test' );\n\t\t$html = $( tmpDOM );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'isIos()', function ( assert ) {\n\tvar browser = new Browser( 'Mozilla/5.0 (iPad; CPU OS 7_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html ),\n\t\tbrowser4 = new Browser( 'Mozilla/5.0 (iPad; CPU OS 4_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html ),\n\t\tbrowser5 = new Browser( 'Mozilla/5.0 (iPad; CPU OS 5_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html ),\n\t\tbrowser2 = new Browser( 'Mozilla/5.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/8.0 Mobile/11A465 Safari/9537.53', $html );\n\n\tassert.strictEqual( browser.isIos(), true );\n\tassert.strictEqual( browser.isIos( 8 ), false );\n\tassert.strictEqual( browser.isIos( 4 ), false );\n\tassert.strictEqual( browser.isIos( 5 ), false );\n\tassert.strictEqual( browser2.isIos(), true );\n\tassert.strictEqual( browser2.isIos( 8 ), true );\n\tassert.strictEqual( browser4.isIos( 4 ), true );\n\tassert.strictEqual( browser5.isIos( 5 ), true );\n} );\n\nQUnit.test( 'Methods are cached', function ( assert ) {\n\tvar ipad = new Browser( 'Mozilla/5.0 (iPad; CPU OS 7_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html ),\n\t\tiphone = new Browser( 'Mozilla/5.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/8.0 Mobile/11A465 Safari/9537.53', $html ),\n\t\tandroid2 = new Browser( 'Android 2', $html );\n\n\tfunction cache( obj, method ) {\n\t\treturn obj[ '__cache' + obj[ method ].cacheId ];\n\t}\n\n\t// Check that the same methods across different instances have their own\n\t// cache and don't interfere with one another\n\tassert.strictEqual( ipad.isIos(), true );\n\tassert.strictEqual( ipad.isIos( 8 ), false );\n\tassert.strictEqual( android2.isIos( 8 ), false );\n\tassert.strictEqual( iphone.isIos(), true );\n\tassert.strictEqual( iphone.isIos( 8 ), true );\n\n\t// Check that the caches have been filled\n\tassert.strictEqual( Object.keys( cache( ipad, 'isIos' ) ).length, 2, 'isIos on ipad cached as expected' );\n\tassert.strictEqual( Object.keys( cache( android2, 'isIos' ) ).length, 1, 'isIos on android cached as expected' );\n\tassert.strictEqual( Object.keys( cache( iphone, 'isIos' ) ).length, 2, 'isIos on iphone cached as expected' );\n} );\n\nQUnit.test( 'lockViewport()', function ( assert ) {\n\tvar browser = new Browser( 'Mozilla/5.0 (iPad; CPU OS 7_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html ),\n\t\tviewportTag,\n\t\tviewportTagVal;\n\tbrowser.$el.find( 'head' ).append( '<meta name=\"viewport\"/>' );\n\tbrowser.lockViewport();\n\tviewportTag = browser.$el.find( 'meta[name=\"viewport\"]' );\n\tviewportTagVal = viewportTag.attr( 'content' );\n\tassert.strictEqual( viewportTagVal, 'initial-scale=1.0, maximum-scale=1.0, user-scalable=no' );\n} );\n\nQUnit.test( 'isWideScreen()', function ( assert ) {\n\tvar browser = new Browser( 'Mozilla/5.0 (iPad; CPU OS 7_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html );\n\tsandbox.stub( mw.config, 'get', function () {\n\t\treturn '720px';\n\t} );\n\tassert.strictEqual( browser.isWideScreen(), true );\n} );\n\nQUnit.test( 'supportsAnimations() - true', function ( assert ) {\n\tvar\n\t\tbrowser = new Browser( 'Mozilla/5.0 (iPad; CPU OS 7_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html ),\n\t\tstub = sandbox.stub( document, 'createElement', function () {\n\t\t\treturn {\n\t\t\t\tstyle: {\n\t\t\t\t\tanimationName: '',\n\t\t\t\t\ttransform: '',\n\t\t\t\t\ttransition: ''\n\t\t\t\t}\n\t\t\t};\n\t\t} ),\n\t\tresult;\n\n\t// Browser QUnit depends on a non-stubbed version of document.createElement\n\t// when showing the test result in the browser so we need to save the returned\n\t// value in an intermediate variable and manually restore the stub here before\n\t// calling assert.strictEqual\n\tresult = browser.supportsAnimations();\n\tstub.restore();\n\n\tassert.strictEqual( result, true );\n} );\n\nQUnit.test( 'supportsAnimations() - false', function ( assert ) {\n\tvar\n\t\tbrowser = new Browser( 'Mozilla/5.0 (iPad; CPU OS 7_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html ),\n\t\tstub = sandbox.stub( document, 'createElement', function () {\n\t\t\treturn {\n\t\t\t\tstyle: {}\n\t\t\t};\n\t\t} ),\n\t\tresult;\n\n\t// Browser QUnit depends on a non-stubbed version of document.createElement\n\t// when showing the test result in the browser so we need to save the returned\n\t// value in an intermediate variable and manually restore the stub here before\n\t// calling assert.strictEqual\n\tresult = browser.supportsAnimations();\n\tstub.restore();\n\n\tassert.strictEqual( result, false );\n} );\n\nQUnit.test( 'supportsTouchEvents()', function ( assert ) {\n\tvar browser = new Browser( 'Mozilla/5.0 (iPad; CPU OS 7_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html );\n\twindow.ontouchstart = window.ontouchstart || undefined;\n\tassert.strictEqual( browser.supportsTouchEvents(), true );\n} );\n\nQUnit.test( 'supportsGeoLocation()', function ( assert ) {\n\tvar browser = new Browser( 'Mozilla/5.0 (iPad; CPU OS 7_0 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko)', $html );\n\twindow.navigator.geolocation = window.navigator.geolocation || undefined;\n\tassert.strictEqual( browser.supportsGeoLocation(), true );\n} );\n","var\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' ),\n\too = require( '../utils/oo' ),\n\tmediaWiki = require( '../utils/mw' ),\n\tButton,\n\tsandbox;\n\nQUnit.module( 'MobileFrontend Button.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\tButton = require( '../../../src/mobile.startup/Button' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'creates a link if passed href option', function ( assert ) {\n\tvar\n\t\turl = 'https://www.foo.com',\n\t\tbutton = new Button( {\n\t\t\thref: url\n\t\t} );\n\n\tassert.strictEqual( button.$el[0].tagName, 'A' );\n\tassert.strictEqual( button.$el[0].getAttribute( 'href' ), 'https://www.foo.com' );\n} );\n\nQUnit.test( 'does not add href attribute when not a link', function ( assert ) {\n\tvar button = new Button( {\n\t\ttagName: 'div'\n\t} );\n\n\tassert.strictEqual( button.$el[0].tagName, 'DIV' );\n\tassert.strictEqual( button.$el[0].href, undefined );\n} );\n","/* eslint-env es6 */\nmodule.exports = {\n\tdefaultURLs: `\n\t\t<div class=\" drawer position-fixed view-border-box \">\n\t\t\t<div\n\t\t\t\tclass=\" mw-ui-icon mw-ui-icon-mf-arrow mw-ui-icon-element cancel \"\n\t\t\t\ttitle=\"\"\n\t\t\t> </div>\n\t\t\t<p> </p>\n\t\t\t<a href=\" logIn \" class=\" mw-ui-button mw-ui-progressive \">\n\t\t\t\tLog in\n\t\t\t</a>\n\t\t\t<div>\n\t\t\t\t<a href=\" signUp \" class=\" mw-ui-anchor mw-ui-progressive \">\n\t\t\t\t\tSign up\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t</div>\n\t`,\n\toverrideURLs: `\n\t\t<div class=\" drawer position-fixed view-border-box \">\n\t\t\t<div\n\t\t\t\tclass=\" mw-ui-icon mw-ui-icon-mf-arrow mw-ui-icon-element cancel \"\n\t\t\t\ttitle=\"\"\n\t\t\t> </div>\n\t\t\t<p> </p>\n\t\t\t<a href=\" customLogIn \" class=\" mw-ui-button mw-ui-progressive \">\n\t\t\t\tcustom log in\n\t\t\t</a>\n\t\t\t<div>\n\t\t\t\t<a href=\" customSignUp \" class=\" mw-ui-anchor mw-ui-progressive \">\n\t\t\t\t\tcustom sign up\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t</div>\n\t`\n};\n","var\n\t// Imports\n\tCtaDrawer,\n\tdom = require( '../utils/dom' ),\n\tAnchor,\n\tButton,\n\tDrawer,\n\tjQuery = require( '../utils/jQuery' ),\n\tmw = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsandbox,\n\tsinon = require( 'sinon' ),\n\n\t// Variables\n\tparent;\n\nQUnit.module( 'MobileFrontend CtaDrawer.js', {\n\tbeforeEach: function () {\n\t\tvar parentID = 'ctaDrawerParent';\n\n\t\tsandbox = sinon.sandbox.create();\n\n\t\t// Set up required by all Views.\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\n\t\t// Additional CtaDrawer global dependency.\n\t\tmw.setUp( sandbox, global );\n\n\t\t// Force consistent messaging between Special:JavaScriptTest and Node.js.\n\t\tsandbox.stub( global.mw, 'msg', function ( id ) {\n\t\t\tswitch ( id ) {\n\t\t\t\tcase 'mobile-frontend-watchlist-cta-button-login': return 'Log in';\n\t\t\t\tcase 'mobile-frontend-watchlist-cta-button-signup': return 'Sign up';\n\t\t\t}\n\t\t\treturn id;\n\t\t} );\n\t\tsandbox.stub( global.mw.util, 'getUrl', function ( pageName, params ) {\n\t\t\treturn params.type ? 'signUp' : 'logIn';\n\t\t} );\n\n\t\t// Dynamically import Views to use fresh sandboxed dependencies.\n\t\tAnchor = require( '../../../src/mobile.startup/Anchor' );\n\t\tButton = require( '../../../src/mobile.startup/Button' );\n\t\tDrawer = require( '../../../src/mobile.startup/Drawer' );\n\t\tCtaDrawer = require( '../../../src/mobile.startup/CtaDrawer' );\n\n\t\t// Rewire the prototype, not the instance, since this property is used during construction.\n\t\tsandbox.stub( Drawer.prototype, 'appendToElement', '#' + parentID );\n\n\t\t// Create a disposable host Element. See T209129.\n\t\tparent = document.createElement( 'div' );\n\t\tparent.id = parentID;\n\t\tdocument.documentElement.appendChild( parent );\n\t},\n\n\tafterEach: function () {\n\t\t// Discard host Element.\n\t\tdocument.documentElement.removeChild( parent );\n\t\tparent = undefined;\n\n\t\tCtaDrawer = undefined;\n\t\tDrawer = undefined;\n\t\tButton = undefined;\n\t\tAnchor = undefined;\n\n\t\tjQuery.tearDown();\n\n\t\tsandbox.restore();\n\t}\n}, function () {\n\tQUnit.module( 'redirectParams()', function () {\n\t\tQUnit.test( 'empty props, default URL', function ( assert ) {\n\t\t\tvar subject = CtaDrawer.prototype.test.redirectParams;\n\t\t\tsandbox.stub( global.mw.config, 'get', function () {\n\t\t\t\treturn 'pageName';\n\t\t\t} );\n\t\t\tassert.propEqual( subject( {} ), { returnto: 'pageName' } );\n\t\t} );\n\n\t\tQUnit.test( 'empty props, nondefault URL', function ( assert ) {\n\t\t\tvar subject = CtaDrawer.prototype.test.redirectParams;\n\t\t\tassert.propEqual( subject( {}, 'url' ), { returnto: 'url' } );\n\t\t} );\n\n\t\tQUnit.test( 'nonempty props', function ( assert ) {\n\t\t\tvar subject = CtaDrawer.prototype.test.redirectParams;\n\t\t\tassert.propEqual( subject( { key: 'val' }, 'url' ), {\n\t\t\t\tkey: 'val',\n\t\t\t\treturnto: 'url'\n\t\t\t} );\n\t\t} );\n\t} );\n\n\tQUnit.module( 'signUpParams()', function () {\n\t\tQUnit.test( 'empty props', function ( assert ) {\n\t\t\tvar subject = CtaDrawer.prototype.test.signUpParams;\n\t\t\tassert.propEqual( subject( {} ), { type: 'signup' } );\n\t\t} );\n\n\t\tQUnit.test( 'nonempty props', function ( assert ) {\n\t\t\tvar subject = CtaDrawer.prototype.test.signUpParams;\n\t\t\tassert.propEqual( subject( { key: 'val' } ), {\n\t\t\t\tkey: 'val',\n\t\t\t\ttype: 'signup'\n\t\t\t} );\n\t\t} );\n\t} );\n\n\tQUnit.module( 'HTML', function () {\n\t\tQUnit.test( 'defaults', function ( assert ) {\n\t\t\tvar\n\t\t\t\tsubject = new CtaDrawer(),\n\t\t\t\t// Import the expected HTML as a string and replace spaces with a \\s*. This allows\n\t\t\t\t// the HTML some flexibility in how it's rendered.\n\t\t\t\thtml = new RegExp( require( './CtaDrawer.test.html' ).defaultURLs.replace( /\\s+/g, '\\\\s*' ) );\n\n\t\t\tsinon.assert.match( subject.$el.get( 0 ).outerHTML, html );\n\t\t\tassert.ok( true );\n\t\t} );\n\n\t\tQUnit.test( 'overrides', function ( assert ) {\n\t\t\tvar\n\t\t\t\tsubject = new CtaDrawer( {\n\t\t\t\t\tprogressiveButton: new Button( {\n\t\t\t\t\t\tprogressive: true,\n\t\t\t\t\t\tlabel: 'custom log in',\n\t\t\t\t\t\thref: 'customLogIn'\n\t\t\t\t\t} ).options,\n\t\t\t\t\tactionAnchor: new Anchor( {\n\t\t\t\t\t\tprogressive: true,\n\t\t\t\t\t\tlabel: 'custom sign up',\n\t\t\t\t\t\thref: 'customSignUp'\n\t\t\t\t\t} ).options\n\t\t\t\t} ),\n\t\t\t\thtml = new RegExp( require( './CtaDrawer.test.html' ).overrideURLs.replace( /\\s+/g, '\\\\s*' ) );\n\n\t\t\tsinon.assert.match( subject.$el.get( 0 ).outerHTML, html );\n\t\t\tassert.ok( true );\n\t\t} );\n\t} );\n} );\n","var\n\t// Imports\n\tdom = require( '../utils/dom' ),\n\tDrawer,\n\tjQuery = require( '../utils/jQuery' ),\n\tmw = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsandbox,\n\tsinon = require( 'sinon' ),\n\tutil = require( '../../../src/mobile.startup/util' ),\n\n\t// Variables\n\tparent;\n\n// util.docReady() usage appears to be necessary over\n// `document.addEventListener('DOMContentLoaded', ...)` as the latter fires before the subject's\n// internal usage of the former.\n\nQUnit.module( 'MobileFrontend Drawer.js', {\n\tbeforeEach: function () {\n\t\tvar parentID = 'drawerParent';\n\n\t\tsandbox = sinon.sandbox.create();\n\n\t\t// Set up required by all Views.\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\n\t\t// Additional Drawer global dependency.\n\t\tmw.setUp( sandbox, global );\n\n\t\t// Dynamically import Drawer to use fresh sandboxed dependencies.\n\t\tDrawer = require( '../../../src/mobile.startup/Drawer' );\n\n\t\t// Rewire the prototype, not the instance, since this property is used during construction.\n\t\tsandbox.stub( Drawer.prototype, 'appendToElement', '#' + parentID );\n\n\t\t// Create a disposable host Element. See T209129.\n\t\tparent = document.createElement( 'div' );\n\t\tparent.id = parentID;\n\t\tdocument.documentElement.appendChild( parent );\n\t},\n\n\tafterEach: function () {\n\t\t// Discard host Element.\n\t\tdocument.documentElement.removeChild( parent );\n\t\tparent = undefined;\n\n\t\tDrawer = undefined;\n\n\t\tjQuery.tearDown();\n\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'appends self to parent when DOM is loaded', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tsubject = new Drawer();\n\n\tutil.docReady( function () {\n\t\tassert.strictEqual( subject.$el.parent().get( 0 ), parent );\n\t\tdone();\n\t} );\n} );\n\nQUnit.test( 'adds class to parent when DOM is loaded', function ( assert ) {\n\tvar done = assert.async();\n\n\tnew Drawer(); // eslint-disable-line no-new\n\tutil.docReady( function () {\n\t\tassert.strictEqual( parent.className, 'has-drawer' );\n\t\tdone();\n\t} );\n} );\n\nQUnit.test( 'consumes clicks', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tevent = new window.Event( 'click' ),\n\t\tsubject = new Drawer();\n\n\tevent.stopPropagation = function () {\n\t\tassert.ok( true );\n\t\tdone();\n\t};\n\tsubject.$el.get( 0 ).dispatchEvent( event );\n} );\n\nQUnit.test( 'visible on show()', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tsubject = new Drawer();\n\n\tsubject.on( 'show', function () {\n\t\tassertVisible();\n\t\tassert.ok( true );\n\t\tdone();\n\t} );\n\n\tsubject.show();\n} );\n\nQUnit.test( 'hidden on hide()', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tsubject = new Drawer();\n\n\tsubject.on( 'hide', function () {\n\t\tassertHidden();\n\t\tassert.ok( true );\n\t\tdone();\n\t} );\n\n\tsubject.hide();\n} );\n\nQUnit.test( 'hidden on click once presented', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tsubject = new Drawer();\n\n\tsubject.on( 'hide', function () {\n\t\tassertHidden();\n\t\tassert.ok( true );\n\t\tdone();\n\t} );\n\n\tcallOnPresented( subject, function () {\n\t\tparent.click();\n\t} );\n\n\tsubject.show();\n} );\n\nQUnit.test( 'hidden on scroll once presented', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tsubject = new Drawer();\n\n\tsubject.on( 'hide', function () {\n\t\tassertHidden();\n\t\tassert.ok( true );\n\t\tdone();\n\t} );\n\n\tcallOnPresented( subject, function () {\n\t\t// https://github.com/jsdom/jsdom/issues/1422\n\t\tvar event = new window.Event( 'scroll', { bubbles: true } );\n\t\tparent.dispatchEvent( event );\n\t} );\n\n\tsubject.show();\n} );\n\nQUnit.test( 'HTML is valid', function ( assert ) {\n\tvar subject = new Drawer();\n\tassert.strictEqual(\n\t\tsubject.$el.get( 0 ).outerHTML, '<div class=\"drawer position-fixed view-border-box\"></div>'\n\t);\n} );\n\n/**\n * @param {Drawer} subject\n * @param {Function} callback\n * @return {void}\n*/\nfunction callOnPresented( subject, callback ) {\n\t// Wait for appearance.\n\tsubject.on( 'show', function () {\n\t\t// Wait for minimum presentation duration to expire.\n\t\tsetTimeout( callback, subject.minHideDelay );\n\t} );\n}\n\nfunction assertVisible() {\n\tsinon.assert.match( parent.className, /.*\\bdrawer-visible\\b.*/ );\n}\n\nfunction assertHidden() {\n\tsinon.assert.match( parent.className, /^((?!\\bdrawer-visible\\b).)*$/ );\n}\n","var\n\tsinon = require( 'sinon' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tmfExtend = require( '../../../src/mobile.startup/mfExtend' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tutil = require( '../../../src/mobile.startup/util' ),\n\tHogan = require( 'hogan.js' ),\n\tOverlay,\n\tsandbox;\n\nQUnit.module( 'MobileFrontend: Overlay.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\tOverlay = require( '../../../src/mobile.startup/Overlay' );\n\n\t\t// jsdom will throw \"Not implemented\" errors if we don't stub\n\t\t// window.scrollTo\n\t\tsandbox.stub( global.window, 'scrollTo' );\n\n\t\t// Create a dummy mw-mf-viewport if none exists\n\t\tif ( !util.getDocument().find( '#mw-mf-viewport' ).length ) {\n\t\t\tthis.$viewport = util.parseHTML( '<div>' ).attr( 'id', 'mw-mf-viewport' ).appendTo( 'body' );\n\t\t}\n\t},\n\tafterEach: function () {\n\t\tif ( this.$viewport ) {\n\t\t\tthis.$viewport.remove();\n\t\t}\n\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'Simple overlay', function ( assert ) {\n\tvar overlay = new Overlay( {\n\t\t\theading: '<h2>Overlay Title</h2>'\n\t\t} ),\n\t\theadingNode;\n\n\theadingNode = overlay.$el.find( 'h2:contains(\"Overlay Title\")' );\n\n\tassert.strictEqual( headingNode.length, 1 );\n} );\n\nQUnit.test( 'HTML overlay', function ( assert ) {\n\tvar overlay;\n\n\tfunction TestOverlay() {\n\t\tOverlay.apply( this, arguments );\n\t}\n\n\tmfExtend( TestOverlay, Overlay, {\n\t\ttemplatePartials: util.extend( Overlay.prototype.templatePartials, {\n\t\t\tcontent: Hogan.compile( '<div class=\"content\">YO</div>' )\n\t\t} )\n\t} );\n\toverlay = new TestOverlay( {\n\t\theading: 'Awesome'\n\t} );\n\n\tassert.strictEqual( overlay.$el.find( 'h2' ).html(), 'Awesome' );\n\tassert.strictEqual( overlay.$el.find( '.content' ).text(), 'YO' );\n} );\n\nQUnit.test( 'Close overlay', function ( assert ) {\n\tvar overlay = new Overlay( {\n\t\theading: '<h2>Title</h2>',\n\t\tcontent: 'Text'\n\t} );\n\n\toverlay.show();\n\toverlay.hide();\n\n\tassert.strictEqual( overlay.$el[ 0 ].parentNode, null, 'No longer in DOM' );\n} );\n","/* global $ */\nvar\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' ),\n\too = require( '../utils/oo' ),\n\tutil = require( '../../../src/mobile.startup/util' ),\n\tmediaWiki = require( '../utils/mw' ),\n\tOverlayManager,\n\tfakeRouter,\n\toverlayManager,\n\tsandbox;\n\nQUnit.module( 'MobileFrontend mobile.startup/OverlayManager', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\t// jsdom will throw \"Not implemented\" errors if we don't stub\n\t\t// window.scrollTo\n\t\tsandbox.stub( global.window, 'scrollTo' );\n\n\t\tOverlayManager = require( '../../../src/mobile.startup/OverlayManager' );\n\n\t\tthis.createFakeOverlay = function ( options ) {\n\t\t\tvar fakeOverlay = new OO.EventEmitter();\n\t\t\tfakeOverlay.hasLoadError = false;\n\t\t\tfakeOverlay.show = sandbox.spy();\n\t\t\tfakeOverlay.hide = function () {\n\t\t\t\tthis.emit( 'hide' );\n\t\t\t\treturn true;\n\t\t\t};\n\t\t\tfakeOverlay.$el = $( 'div' );\n\t\t\tsandbox.spy( fakeOverlay, 'hide' );\n\t\t\tutil.extend( fakeOverlay, options );\n\t\t\treturn fakeOverlay;\n\t\t};\n\n\t\tfakeRouter = new OO.EventEmitter();\n\t\tfakeRouter.getPath = sandbox.stub().returns( '' );\n\t\tfakeRouter.back = sandbox.spy();\n\t\tsandbox.stub( mw.loader, 'require' ).withArgs( 'mediawiki.router' ).returns( fakeRouter );\n\t\toverlayManager = new OverlayManager( fakeRouter, 'body' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#getSingleton', function ( assert ) {\n\tvar singleton = OverlayManager.getSingleton();\n\tassert.ok( singleton instanceof OverlayManager, 'singleton exists' );\n\tassert.strictEqual( singleton, OverlayManager.getSingleton(), 'same object returned each time' );\n} );\n\nQUnit.test( '#add', function ( assert ) {\n\tvar fakeOverlay = this.createFakeOverlay();\n\n\toverlayManager.add( /^test$/, function () {\n\t\treturn fakeOverlay;\n\t} );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'test'\n\t} );\n\n\tassert.strictEqual( fakeOverlay.show.callCount, 1, 'show registered overlay' );\n} );\n\nQUnit.test( '#show', function ( assert ) {\n\tvar fakeOverlay = this.createFakeOverlay(),\n\t\tshowSpy = sandbox.spy( overlayManager, '_show' );\n\n\toverlayManager.add( /^showTest$/, function () {\n\t\treturn fakeOverlay;\n\t} );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'showTest'\n\t} );\n\n\tassert.strictEqual( showSpy.callCount, 1, 'OverlayManager.show called on route change' );\n} );\n\nQUnit.test( '#add, with $.Deferred factory', function ( assert ) {\n\tvar deferred = util.Deferred(),\n\t\tfakeOverlay = this.createFakeOverlay();\n\tdeferred.show = sandbox.spy();\n\n\toverlayManager.add( /^foo$/, function () {\n\t\treturn deferred;\n\t} );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'foo'\n\t} );\n\tdeferred.resolve( fakeOverlay );\n\n\treturn deferred.then( function () {\n\t\tassert.notOk( deferred.show.called, 'don\\'t call show on Deferred' );\n\t\tassert.strictEqual( fakeOverlay.show.callCount, 1, 'show registered overlay' );\n\t} );\n} );\n\nQUnit.test( '#add, with current path', function ( assert ) {\n\tvar\n\t\tfakeOverlay = this.createFakeOverlay(),\n\t\tdeferred = util.Deferred();\n\tfakeRouter.getPath = sandbox.stub().returns( 'baha' );\n\n\toverlayManager.add( /^baha$/, function () {\n\t\treturn fakeOverlay;\n\t} );\n\n\t// Wait for $.ready because OverlayManager#add() does\n\tutil.docReady( function () {\n\t\tdeferred.resolve();\n\t} );\n\n\treturn deferred.then( function () {\n\t\tassert.strictEqual( fakeOverlay.show.callCount, 1, 'show registered overlay' );\n\t} );\n} );\n\nQUnit.test( '#replaceCurrent', function ( assert ) {\n\tvar fakeOverlay = this.createFakeOverlay(),\n\t\tanotherFakeOverlay = this.createFakeOverlay();\n\n\toverlayManager.add( /^test$/, function () {\n\t\treturn fakeOverlay;\n\t} );\n\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'test'\n\t} );\n\toverlayManager.replaceCurrent( anotherFakeOverlay );\n\tassert.strictEqual( fakeOverlay.hide.callCount, 1, 'hide overlay' );\n\tassert.strictEqual( anotherFakeOverlay.show.callCount, 1, 'show another overlay' );\n\tfakeRouter.emit( 'route', {\n\t\tpath: ''\n\t} );\n\tassert.strictEqual( anotherFakeOverlay.hide.callCount, 1, 'hide another overlay' );\n} );\n\nQUnit.test( 'route with params', function ( assert ) {\n\tvar\n\t\tfakeOverlay = this.createFakeOverlay(),\n\t\tfactoryStub = sandbox.stub().returns( fakeOverlay );\n\n\toverlayManager.add( /^sam\\/(\\d+)$/, factoryStub );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'sam/123'\n\t} );\n\n\tassert.ok( factoryStub.calledWith( '123' ), 'pass params from the route' );\n} );\n\nQUnit.test( 'hide when route changes', function ( assert ) {\n\tvar\n\t\tfakeOverlay = this.createFakeOverlay(),\n\t\tfactoryStub = sandbox.stub().returns( fakeOverlay );\n\n\toverlayManager.add( /^jon$/, factoryStub );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'jon'\n\t} );\n\tfakeRouter.emit( 'route', {\n\t\tpath: ''\n\t} );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'jon'\n\t} );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'other'\n\t} );\n\n\tassert.strictEqual( fakeOverlay.hide.callCount, 2, 'hide overlay' );\n\tassert.ok( fakeOverlay.hide.getCall( 0 ).notCalledWith( true ), 'don\\'t force hide (first)' );\n\tassert.ok( fakeOverlay.hide.getCall( 1 ).notCalledWith( true ), 'don\\'t force hide (second)' );\n} );\n\nQUnit.test( 'go back (change route) if overlay hidden but not by route change', function ( assert ) {\n\tvar\n\t\tfakeOverlay = this.createFakeOverlay(),\n\t\tfactoryStub = sandbox.stub().returns( fakeOverlay );\n\n\toverlayManager.add( /^joakino$/, factoryStub );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'joakino'\n\t} );\n\tfakeOverlay.hide();\n\n\tassert.strictEqual( fakeRouter.back.callCount, 1, 'route back' );\n} );\n\nQUnit.test( 'stacked overlays', function ( assert ) {\n\tvar\n\t\tfakeOverlay = this.createFakeOverlay(),\n\t\tfactoryStub = sandbox.stub().returns( fakeOverlay ),\n\t\tparentFakeOverlay = this.createFakeOverlay(),\n\t\tparentFactoryStub = sandbox.stub().returns( parentFakeOverlay );\n\n\toverlayManager.add( /^parent$/, parentFactoryStub );\n\toverlayManager.add( /^child$/, factoryStub );\n\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'parent'\n\t} );\n\tassert.strictEqual( parentFakeOverlay.show.callCount, 1, 'show parent' );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'child'\n\t} );\n\tassert.strictEqual( parentFakeOverlay.hide.callCount, 1, 'hide parent' );\n\tassert.ok( parentFakeOverlay.hide.calledWith( true ), 'hide parent forcefully (no confirmation)' );\n\tassert.strictEqual( fakeOverlay.show.callCount, 1, 'show child' );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'parent'\n\t} );\n\tassert.strictEqual( fakeOverlay.hide.callCount, 1, 'hide child' );\n\tassert.strictEqual( parentFakeOverlay.show.callCount, 2, 'show parent again' );\n\n\tassert.strictEqual( parentFactoryStub.callCount, 1, 'create parent only once' );\n} );\n\nQUnit.test( 'prevent route change', function ( assert ) {\n\tvar\n\t\tfakeOverlay = this.createFakeOverlay( {\n\t\t\thide: sandbox.stub().returns( false )\n\t\t} ),\n\t\tfactoryStub = sandbox.stub().returns( fakeOverlay ),\n\t\tev = {\n\t\t\tpath: '',\n\t\t\tpreventDefault: sandbox.spy()\n\t\t};\n\n\toverlayManager.add( /^rob$/, factoryStub );\n\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'rob'\n\t} );\n\tfakeRouter.emit( 'route', ev );\n\tassert.ok( ev.preventDefault.calledOnce, 'prevent route change' );\n} );\n\nQUnit.test( 'reload failed overlay when navigating to it again from another overlay', function ( assert ) {\n\tvar\n\t\tfailedOverlay = this.createFakeOverlay(),\n\t\tsuccessfulOverlay = this.createFakeOverlay(),\n\t\tfactoryStub,\n\t\tretryOverlayFn;\n\n\tfailedOverlay.hasLoadError = true;\n\tretryOverlayFn = sandbox.stub();\n\tretryOverlayFn.onCall( 0 ).returns( failedOverlay );\n\tretryOverlayFn.onCall( 1 ).returns( successfulOverlay );\n\tfactoryStub = function ( title ) {\n\t\tif ( title === '0' ) {\n\t\t\treturn retryOverlayFn();\n\t\t}\n\n\t\treturn successfulOverlay;\n\t};\n\n\toverlayManager.add( /^test\\/(\\d+)$/, factoryStub );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'test/0'\n\t} );\n\n\tassert.strictEqual( overlayManager.stack.length, 1, 'stack is correct size' );\n\tassert.ok( overlayManager.stack[0].overlay.hasLoadError, 'first overlay has load error' );\n\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'test/1'\n\t} );\n\n\tassert.strictEqual( overlayManager.stack.length, 2, 'stack is correct size' );\n\tassert.notOk( overlayManager.stack[0].overlay.hasLoadError, 'second overlay loads successfully' );\n\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'test/0'\n\t} );\n\n\tassert.strictEqual( overlayManager.stack.length, 1, 'stack decreases when going back to already visited overlay' );\n\tassert.notOk( overlayManager.stack[0].overlay.hasLoadError, 'Failed attempt is not cached and new overlay is loaded' );\n} );\n\nQUnit.test( 'replace overlay when route event path is equal to current path', function ( assert ) {\n\tvar\n\t\tfailedOverlay = this.createFakeOverlay(),\n\t\tsuccessfulOverlay = this.createFakeOverlay(),\n\t\tretryOverlayFn;\n\n\tfailedOverlay.hasLoadError = true;\n\tretryOverlayFn = sandbox.stub();\n\tretryOverlayFn.onCall( 0 ).returns( failedOverlay );\n\tretryOverlayFn.onCall( 1 ).returns( successfulOverlay );\n\n\toverlayManager.add( /^test\\/(\\d+)$/, retryOverlayFn );\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'test/0'\n\t} );\n\n\tassert.strictEqual( overlayManager.stack.length, 1, 'stack is correct size' );\n\tassert.ok( overlayManager.stack[0].overlay.hasLoadError, 'overlay has load error' );\n\n\tfakeRouter.emit( 'route', {\n\t\tpath: 'test/0'\n\t} );\n\n\tassert.strictEqual( overlayManager.stack.length, 1, 'stack is correct size (did not increase upon reload)' );\n\tassert.notOk( overlayManager.stack[0].overlay.hasLoadError, 'overlay retry loads successfully' );\n} );\n","var\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tmw = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\t// These both have heavy dependencies on jQuery so must be loaded later.\n\tPage, util,\n\tsinon = require( 'sinon' ),\n\tPARSER_OUTPUT = '<div class=\"mw-parser-output\">',\n\tMOBILE_TOC = '<div class=\"toc-mobile view-border-box\"><h2></h2><div></div></div>';\n/* eslint-disable one-var */\n/** @type {sinon.SinonSandbox} */ var sandbox;\n/** @type {typeof import('../../../src/mobile.startup/Page')} */ var stubPage;\n/** @type {typeof import('../../../src/mobile.startup/Page')} */ var mobileTocPage;\n/** @type {typeof import('../../../src/mobile.startup/Page')} */ var desktopPage;\n/** @type {typeof import('../../../src/mobile.startup/Page')} */ var sectionPage;\n/* eslint-enable one-var */\n\nQUnit.module( 'MobileFrontend Page', {\n\tbeforeEach: function () {\n\t\tvar ambox = function ( text ) {\n\t\t\t\treturn '<div class=\"ambox\">' + text + '</div>';\n\t\t\t},\n\t\t\tsectionHeading = function ( text ) {\n\t\t\t\treturn '<h2 class=\"section-heading\">' + text + '</h2>';\n\t\t\t},\n\t\t\tsectionSubHeading = function ( text, level ) {\n\t\t\t\tvar l = level || 'h3';\n\t\t\t\treturn '<' + l + '>' + text + '</' + l + '>';\n\t\t\t},\n\t\t\tsectionBody = function ( i, html ) {\n\t\t\t\treturn '<div class=\"mf-section-' + i + '\">' + html + '</div>';\n\t\t\t};\n\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tmw.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\n\t\tPage = require( '../../../src/mobile.startup/Page' );\n\t\tutil = require( '../../../src/mobile.startup/util' );\n\n\t\tstubPage = new Page( {\n\t\t\tel: util.parseHTML( PARSER_OUTPUT ).html(\n\t\t\t\t'<p>lead</p>' + ambox( 'a0' )\n\t\t\t)\n\t\t} );\n\t\tmobileTocPage = new Page( {\n\t\t\tel: util.parseHTML( PARSER_OUTPUT ).html(\n\t\t\t\tsectionBody( 0, ambox( 'a0' ) + '<p>lead</p>' + MOBILE_TOC ) +\n\t\t\t\t// section = 1\n\t\t\t\tsectionHeading( '1' ) +\n\t\t\t\tsectionBody( 1,\n\t\t\t\t\tambox( 'a1' ) +\n\t\t\t\t\t// section = 2\n\t\t\t\t\tsectionSubHeading( '1.1' ) +\n\t\t\t\t\tambox( 'a1.1' )\n\t\t\t\t)\n\t\t\t)\n\t\t} );\n\t\tdesktopPage = new Page( {\n\t\t\tel: util.parseHTML( PARSER_OUTPUT ).html(\n\t\t\t\t'<p>lead</p>' +\n\t\t\t\tambox( 'a0' ) +\n\t\t\t\t// section = 1\n\t\t\t\tsectionSubHeading( '1', 'h2' ) +\n\t\t\t\tambox( 'a1' ) +\n\t\t\t\t// section = 2\n\t\t\t\tsectionSubHeading( '1.1' ) +\n\t\t\t\tambox( 'a1.1' )\n\t\t\t)\n\t\t} );\n\t\tsectionPage = new Page( {\n\t\t\tel: util.parseHTML( PARSER_OUTPUT ).html(\n\t\t\t\tsectionBody( 0, '<p>lead</p>' + ambox( 'a0' ) ) +\n\t\t\t\t// section = 1\n\t\t\t\tsectionHeading( '1' ) +\n\t\t\t\tsectionBody( 1,\n\t\t\t\t\tambox( 'a1' ) +\n\t\t\t\t\t// section = 2\n\t\t\t\t\tsectionSubHeading( '1.1' ) +\n\t\t\t\t\tambox( 'a1.1' ) +\n\t\t\t\t\t// section = 3\n\t\t\t\t\tsectionSubHeading( '1.1.1', 'h4' ) +\n\t\t\t\t\tambox( 'a1.1.1' ) +\n\t\t\t\t\t// section = 4\n\t\t\t\t\tsectionSubHeading( '1.1.2', 'h4' ) +\n\t\t\t\t\tambox( 'a1.1.2' ) +\n\t\t\t\t\t// section = 5\n\t\t\t\t\tsectionSubHeading( '1.2' ) +\n\t\t\t\t\tambox( 'a1.1' )\n\t\t\t\t) +\n\t\t\t\t// section = 6\n\t\t\t\tsectionHeading( '2' ) +\n\t\t\t\tsectionBody( 6,\n\t\t\t\t\tambox( 'a2' )\n\t\t\t\t) +\n\t\t\t\t// section 7\n\t\t\t\tsectionHeading( '3' ) +\n\t\t\t\tsectionBody( 7, ambox( 'a3' ) ) +\n\t\t\t\t// section 8\n\t\t\t\tsectionHeading( 'Section with nested Ambox' ) +\n\t\t\t\tsectionBody( 8,\n\t\t\t\t\tambox(\n\t\t\t\t\t\t'<p>nested-ambox-parent,</p>' +\n\t\t\t\t\t\tambox( 'nested-ambox-1,' ) +\n\t\t\t\t\t\tambox( 'nested-ambox-2' )\n\t\t\t\t\t) ) +\n\t\t\t\t// section 9\n\t\t\t\tsectionHeading( 'Sub-section with nested Ambox' ) +\n\t\t\t\t\tsectionBody( 9,\n\t\t\t\t\t\tambox(\n\t\t\t\t\t\t\t'<p>nested-ambox-parent,</p>' +\n\t\t\t\t\t\t\tambox( 'nested-ambox-1,' ) +\n\t\t\t\t\t\t\tambox( 'nested-ambox-2' )\n\t\t\t\t\t\t) +\n\t\t\t\t\t\t// section 10\n\t\t\t\t\t\tsectionSubHeading( 'subsection heading' ) +\n\t\t\t\t\t\t// section 11\n\t\t\t\t\t\tsectionSubHeading( 'Another subsection heading' )\n\t\t\t\t\t)\n\t\t\t) // end .html()\n\t\t} ); // end new Page();\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#findInSectionLead', function ( assert ) {\n\t// check desktop page\n\t[\n\t\t[ 0, 'a0', 'lead section' ],\n\t\t[ 1, 'a1', 'h2' ],\n\t\t[ 2, 'a1.1', 'h3' ],\n\t\t[ 3, '', 'h4', 'selector does not match', '.foo' ],\n\t\t[ 111, '', 'Non-existent section' ]\n\t].forEach( function ( params, i ) {\n\t\tvar\n\t\t\tsection = params[0],\n\t\t\texpect = params[1],\n\t\t\ttest = params[2],\n\t\t\tselector = params[3] || '.ambox';\n\t\tassert.strictEqual(\n\t\t\tdesktopPage.findChildInSectionLead( section, selector ).text(),\n\t\t\texpect,\n\t\t\t'Found correct text in desktop test ' + i + ' case: ' + test\n\t\t);\n\t} );\n\t// check stub\n\t[\n\t\t[ 0, 'a0', 'lead section' ],\n\t\t[ 3, '', 'h4', 'selector does not match', '.foo' ],\n\t\t[ 111, '', 'Non-existent section' ]\n\t].forEach( function ( testcase ) {\n\t\tassert.strictEqual(\n\t\t\tstubPage.findChildInSectionLead( testcase[0], testcase[3] || '.ambox' ).text(),\n\t\t\ttestcase[1],\n\t\t\t'Stub: Found correct text in desktop test case:' + testcase[2]\n\t\t);\n\t} );\n\t// check mobile pages with section wrapping\n\t[\n\t\t[ 0, 'a0', 'lead section' ],\n\t\t[ 1, 'a1', 'h2' ],\n\t\t[ 2, 'a1.1', 'h3' ],\n\t\t[ 3, 'a1.1.1', 'h4' ],\n\t\t[ 3, '', 'h4', 'selector does not match', '.foo' ],\n\t\t[ 7, 'a3', 'h2 later' ],\n\t\t[ 111, '', 'Non-existent section' ]\n\t].forEach( function ( testcase ) {\n\t\tassert.strictEqual(\n\t\t\tsectionPage.findChildInSectionLead( testcase[0], testcase[3] || '.ambox' ).text(),\n\t\t\ttestcase[1],\n\t\t\t'Mobile: Found correct text in test case:' + testcase[2]\n\t\t);\n\t} );\n\t[\n\t\t[ 0, 'a0', 'lead section' ],\n\t\t[ 1, 'a1', 'h2' ],\n\t\t[ 2, 'a1.1', 'h3' ],\n\t\t[ 111, '', 'Non-existent section' ]\n\t].forEach( function ( testcase ) {\n\t\tassert.strictEqual(\n\t\t\tmobileTocPage.findChildInSectionLead( testcase[0], testcase[3] || '.ambox' ).text(),\n\t\t\ttestcase[1],\n\t\t\t'Mobile with table of contents: Found correct text in test case:' + testcase[2]\n\t\t);\n\t} );\n\n\t[\n\t\t[ 8, '.ambox', 'nested-ambox-parent,nested-ambox-1,nested-ambox-2', 'Nested elements in section' ],\n\t\t[ 9, '.ambox', 'nested-ambox-parent,nested-ambox-1,nested-ambox-2', 'Nested elements in subsection' ]\n\t].forEach( function ( testcase ) {\n\t\tvar result = sectionPage.findChildInSectionLead( testcase[0], testcase[1] );\n\t\tassert.strictEqual(\n\t\t\tresult.not( result.children() ).text(),\n\t\t\ttestcase[2],\n\t\t\t'Mobile: Found correct text in test case:' + testcase[3]\n\t\t);\n\t} );\n\n} );\n\nQUnit.test( '#isMainPage', function ( assert ) {\n\tvar p = new Page( {\n\t\t\ttitle: 'Main Page',\n\t\t\tisMainPage: true\n\t\t} ),\n\t\tp2 = new Page( {\n\t\t\ttitle: 'Foo'\n\t\t} );\n\tassert.strictEqual( p.isMainPage(), true, 'check main page flag is updated' );\n\tassert.strictEqual( p2.isMainPage(), false, 'check not marked as main page' );\n} );\n\nQUnit.test( '#getThumbnails', function ( assert ) {\n\tvar p, textPage, pLegacyUrls, thumbs, pNoViewer, pMetadata, pLazyImages, metadataTable,\n\t\tpLazyImagesTypo, pMetadataNested;\n\n\tp = new Page( {\n\t\tel: util.parseHTML( '<div><a href=\"/wiki/File:Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" class=\"image view-border-box\"><img alt=\"Cyanolimnas cerverai by Allan Brooks cropped.jpg\" src=\"//upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg/300px-Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" width=\"300\" height=\"303\" data-file-width=\"454\" data-file-height=\"459\"></a></div>' )\n\t} );\n\ttextPage = new Page( {\n\t\tel: util.parseHTML( '<div></div>' )\n\t} );\n\tpLegacyUrls = new Page( {\n\t\tel: util.parseHTML( '<div><a href=\"/wikpa/index.php?title=File:Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" class=\"image view-border-box\"><img alt=\"Cyanolimnas cerverai by Allan Brooks cropped.jpg\" src=\"//upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg/300px-Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" width=\"300\" height=\"303\" data-file-width=\"454\" data-file-height=\"459\"></a></div>' )\n\t} );\n\tthumbs = p.getThumbnails();\n\tpNoViewer = new Page( {\n\t\tel: util.parseHTML( '<div><a href=\"/wikpa/index.php?title=File:Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" class=\"image view-border-box noviewer\"><img alt=\"Cyanolimnas cerverai by Allan Brooks cropped.jpg\" src=\"//upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg/300px-Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" width=\"300\" height=\"303\" data-file-width=\"454\" data-file-height=\"459\"></a></div>' )\n\t} );\n\tpMetadata = new Page( {\n\t\tel: util.parseHTML( '<div><a href=\"/wikpa/index.php?title=File:Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" class=\"image view-border-box\"><img alt=\"Cyanolimnas cerverai by Allan Brooks cropped.jpg\" class=\"metadata\" src=\"//upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg/300px-Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" width=\"300\" height=\"303\" data-file-width=\"454\" data-file-height=\"459\"></a></div>' )\n\t} );\n\tpMetadataNested = new Page( {\n\t\tel: util.parseHTML( '<div class=\"noviewer\"><a href=\"/wikpa/index.php?title=File:Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" class=\"image view-border-box\"><img alt=\"Cyanolimnas cerverai by Allan Brooks cropped.jpg\" src=\"//upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg/300px-Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg\" width=\"300\" height=\"303\" data-file-width=\"454\" data-file-height=\"459\"></a></div>' )\n\t} );\n\tpLazyImages = new Page( {\n\t\tel: util.parseHTML( '<div><a href=\"/wiki/File:Design_portal_logo.jpg\" class=\"image\"><span class=\"lazy-image-placeholder\" style=\"width: 28px;height: 28px;\" data-src=\"//upload.wikimedia.org/wikipedia/commons/thumb/3/3b/Design_portal_logo.jpg/28px-Design_portal_logo.jpg\" data-alt=\"icon\" data-width=\"28\" data-height=\"28\" data-class=\"noviewer\">&nbsp;</span></a></div>' )\n\t} );\n\tpLazyImagesTypo = new Page( {\n\t\tel: util.parseHTML( '<div><a href=\"/wiki/File:Design_portal_logo.jpg\" class=\"image\"><span class=\"lazy-image-placeholder\" style=\"width: 28px;height: 28px;\" data-src=\"//upload.wikimedia.org/wikipedia/commons/thumb/3/3b/Design_portal_logo.jpg/28px-Design_portal_logo.jpg\" data-alt=\"icon\" data-width=\"28\" data-height=\"28\" data-class=\"wot noviewerz bar\">&nbsp;</span></a></div>' )\n\t} );\n\tmetadataTable = new Page( {\n\t\tel: util.parseHTML( '<div><table class=\"plainlinks metadata ambox ambox-content ambox-Unreferenced\" role=\"presentation\"><tr><td class=\"mbox-image\"><div style=\"width:52px\"><a href=\"/wiki/File:Question_book-new.svg\" class=\"image\"><span class=\"lazy-image-placeholder\" style=\"width: 50px;height: 39px;\" data-src=\"https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Question_book-new.svg/50px-Question_book-new.svg.png\" data-alt=\"\" data-width=\"50\" data-height=\"39\" data-srcset=\"https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Question_book-new.svg/75px-Question_book-new.svg.png 1.5x, https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Question_book-new.svg/100px-Question_book-new.svg.png 2x\"> </span></a></div></td></tr></table>' )\n\t} );\n\n\tassert.strictEqual( thumbs.length, 1, 'Found expected number of thumbnails.' );\n\tassert.strictEqual( thumbs[0].getFileName(), 'File:Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg',\n\t\t'Found expected filename.' );\n\n\tthumbs = textPage.getThumbnails();\n\tassert.strictEqual( thumbs.length, 0, 'This page has no thumbnails.' );\n\n\tthumbs = pLegacyUrls.getThumbnails();\n\tassert.strictEqual( thumbs.length, 1, 'Found expected number of thumbnails.' );\n\tassert.strictEqual( thumbs[0].getFileName(), 'File:Cyanolimnas_cerverai_by_Allan_Brooks_cropped.jpg',\n\t\t'Found expected filename.' );\n\n\tthumbs = pNoViewer.getThumbnails();\n\tassert.strictEqual( thumbs.length, 0, 'This page has no thumbnails.' );\n\n\tthumbs = pMetadata.getThumbnails();\n\tassert.strictEqual( thumbs.length, 0, 'This page has no thumbnails.' );\n\n\tthumbs = pMetadataNested.getThumbnails();\n\tassert.strictEqual( thumbs.length, 0,\n\t\t'Images inside a container with the class are not included. Images inside tables for example.' );\n\n\tthumbs = pLazyImages.getThumbnails();\n\tassert.strictEqual( thumbs.length, 0,\n\t\t'Consider whether the class is on an image which has not been lazy loaded.' );\n\n\tthumbs = metadataTable.getThumbnails();\n\tassert.strictEqual( thumbs.length, 0,\n\t\t'Consider whether the lazy loaded image is inside a .metadata container.' );\n\n\tthumbs = pLazyImagesTypo.getThumbnails();\n\tassert.strictEqual( thumbs.length, 1,\n\t\t'Thumbnail found if there is a typo.' );\n} );\n\nQUnit.test( '#getNamespaceId', function ( assert ) {\n\tvar testCases = [\n\t\t[ 'Main Page', 0 ],\n\t\t[ 'San Francisco', 0 ],\n\t\t[ 'San Francisco: Talk:2', 0 ],\n\t\t[ 'San Francisco: The Sequel', 0 ],\n\t\t[ 'Talk:Foo', 1 ],\n\t\t[ 'Project:Bar', 4 ],\n\t\t[ 'User talk:Jon', 3 ],\n\t\t[ 'Special:Nearby', -1 ]\n\t];\n\ttestCases.forEach( function ( tc ) {\n\t\tvar p = new Page( {\n\t\t\ttitle: tc[ 0 ]\n\t\t} );\n\t\tassert.strictEqual( p.getNamespaceId(), tc[ 1 ], 'Check namespace is as expected' );\n\t} );\n} );\n\nQUnit.test( '#isTalkPage', function ( assert ) {\n\tvar testCases = [\n\t\t[ 'Main Page', false ],\n\t\t[ 'San Francisco', false ],\n\t\t[ 'San Francisco: Talk:2', false ],\n\t\t[ 'San Francisco: The Sequel', false ],\n\t\t[ 'Talk:Foo', true ],\n\t\t[ 'Project talk:Bar', true ],\n\t\t[ 'User talk:Jon', true ],\n\t\t[ 'Special:Nearby', false ]\n\t];\n\ttestCases.forEach( function ( tc ) {\n\t\tvar p = new Page( {\n\t\t\ttitle: tc[ 0 ]\n\t\t} );\n\t\tassert.strictEqual( p.isTalkPage(), tc[ 1 ], 'Check test is as expected' );\n\t} );\n} );\n\nQUnit.test( '#isMissing', function ( assert ) {\n\tvar missing, notMissing;\n\tmissing = [\n\t\tnew Page( {\n\t\t\ttitle: 'Hello',\n\t\t\tid: 0\n\t\t} ),\n\t\tnew Page( {\n\t\t\ttitle: 'Hello',\n\t\t\tid: 5,\n\t\t\tisMissing: true\n\t\t} ),\n\t\tnew Page( {\n\t\t\ttitle: 'Hello',\n\t\t\tisMissing: true\n\t\t} )\n\t];\n\tnotMissing = [\n\t\tnew Page( {\n\t\t\ttitle: 'Hello',\n\t\t\tid: 4\n\t\t} ),\n\t\tnew Page( {\n\t\t\ttitle: 'Hello',\n\t\t\tid: 4,\n\t\t\tisMissing: false\n\t\t} ),\n\t\tnew Page( {\n\t\t\ttitle: 'Hello',\n\t\t\tisMissing: false\n\t\t} ),\n\t\tnew Page( {\n\t\t\ttitle: 'Hello',\n\t\t\tid: 0,\n\t\t\tisMissing: false\n\t\t} )\n\t];\n\tmissing.forEach( function ( page, i ) {\n\t\tassert.strictEqual( page.isMissing, true, 'page ' + i + ' is missing' );\n\t} );\n\tnotMissing.forEach( function ( page, i ) {\n\t\tassert.strictEqual( page.isMissing, false, 'page ' + i + ' is not missing' );\n\t} );\n} );\n\nQUnit.test( '#allowsXSS', function ( assert ) {\n\tvar p = new Page( {\n\t\t\ttitle: '<script>alert(\"oops, XSS possible!\");</script>'\n\t\t} ),\n\t\ttitleJSON = [\n\t\t\t{\n\t\t\t\tthumbnail: false,\n\t\t\t\ttitle: '<script>alert(\"oops, XSS possible!\");</script>',\n\t\t\t\tterms: false,\n\t\t\t\ttestDesc: 'Check against XSS in Page.newFromJSON displaytitle (when title set)'\n\t\t\t},\n\t\t\t{\n\t\t\t\tthumbnail: false,\n\t\t\t\tpageprops: [],\n\t\t\t\tterms: {\n\t\t\t\t\tlabel: [\n\t\t\t\t\t\t'<script>alert(\"oops, XSS possible!\");</script>'\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\ttestDesc: 'Check against XSS in Page.newFromJSON displaytitle (when Wikibase label set)'\n\t\t\t}\n\t\t];\n\n\tassert.strictEqual(\n\t\tp.getDisplayTitle(),\n\t\t'&lt;script&gt;alert(&quot;oops, XSS possible!&quot;);&lt;/script&gt;',\n\t\t'Check against XSS in Page.js constructor displaytitle (when title set)'\n\t);\n\n\ttitleJSON.forEach( function ( json ) {\n\t\tp = Page.newFromJSON( json );\n\n\t\tassert.strictEqual(\n\t\t\tp.getDisplayTitle(),\n\t\t\t'&lt;script&gt;alert(&quot;oops, XSS possible!&quot;);&lt;/script&gt;',\n\t\t\tjson.testDesc\n\t\t);\n\t} );\n} );\n","var util,\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tmediawiki = require( '../utils/mw' ),\n\tjQuery = require( '../utils/jQuery' ),\n\texamples = require( './../utils/PageInputs.html' ),\n\tpage = examples.page,\n\tpage2 = examples.page2,\n\ttestData = require( '../utils/PageGateway.responses' ),\n\tPageGateway,\n\tpageGateway,\n\tsandbox;\n\nQUnit.module( 'MobileFrontend PageGateway', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\tmediawiki.setUp( sandbox, global );\n\t\tutil = require( '../../../src/mobile.startup/util' );\n\t\tPageGateway = require( '../../../src/mobile.startup/PageGateway' );\n\t\tthis.api = new mw.Api();\n\t\tpageGateway = new PageGateway( this.api );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#getPage (h1s)', function ( assert ) {\n\n\tsandbox.stub( this.api, 'get' ).returns( util.Deferred().resolve( testData.getPageHeadings.input ) );\n\tpageGateway.invalidatePage( 'Test' );\n\n\tsandbox.stub( mw.util, 'getUrl' ).returns( 'Test:History' );\n\n\treturn pageGateway.getPage( 'Test' ).then( function ( resp ) {\n\t\tassert.propEqual( resp, testData.getPageHeadings.output, 'return lead and sections test 1' );\n\t} );\n} );\n\nQUnit.test( '#getPage', function ( assert ) {\n\tvar api = sandbox.stub( this.api, 'get' ).returns( util.Deferred().resolve( testData.getPage.input ) );\n\n\tsandbox.stub( mw.util, 'getUrl' ).returns( 'Test:History' );\n\n\tpageGateway.invalidatePage( 'Test' );\n\treturn pageGateway.getPage( 'Test' ).then( function ( resp ) {\n\t\tassert.propEqual( resp, testData.getPage.output, 'return lead and sections test 2' );\n\n\t\treturn pageGateway.getPage( 'Test' );\n\t} ).then( function () {\n\t\tassert.strictEqual( api.callCount, 1, 'cache page' );\n\t} );\n} );\n\nQUnit.test( '#getPageLanguages (response)', function ( assert ) {\n\tsandbox.stub( this.api, 'get' ).returns( util.Deferred().resolve( testData.getPageLanguagesResponse.input ) );\n\n\treturn pageGateway.getPageLanguages( 'Test' ).then( function ( resp ) {\n\t\tassert.propEqual( resp.languages,\n\t\t\ttestData.getPageLanguagesResponse.output.languages,\n\t\t\t'return augmented language links' );\n\n\t\tassert.propEqual( resp.variants,\n\t\t\ttestData.getPageLanguagesResponse.output.variants,\n\t\t\t'return augmented language variant links' );\n\t} );\n} );\n\nQUnit.test( '#getPageLanguages (call)', function ( assert ) {\n\tvar spy = sandbox.stub( this.api, 'get' ).returns( util.Deferred().reject() );\n\t// prevent rogue ajax request\n\t// eslint-disable-next-line no-undef\n\tsandbox.stub( $, 'ajax' ).returns( util.Deferred().resolve() );\n\tpageGateway.getPageLanguages( 'Title', 'fr' );\n\tassert.ok(\n\t\tspy.calledWith( testData.getPageLanguagesCall.output )\n\t);\n} );\n\nQUnit.test( '#_getAPIResponseFromHTML', function ( assert ) {\n\tvar resp = pageGateway._getAPIResponseFromHTML(\n\t\tutil.parseHTML( page )\n\t);\n\tassert.propEqual( testData.getAPIResponseFromHTML.input, resp );\n} );\n\nQUnit.test( '#getSectionsFromHTML malformed (h2 before h1)', function ( assert ) {\n\tvar resp = pageGateway.getSectionsFromHTML(\n\t\tutil.parseHTML( page2 )\n\t);\n\tassert.propEqual( resp, [\n\t\t{\n\t\t\tline: 'A1',\n\t\t\tlevel: '2',\n\t\t\tanchor: '1.0',\n\t\t\ttext: '<h3 id=\"\">A2.1</h3>\\n\\n',\n\t\t\tsubsections: [ {\n\t\t\t\tline: 'A2.1',\n\t\t\t\tlevel: '3',\n\t\t\t\tanchor: '',\n\t\t\t\ttext: '',\n\t\t\t\tsubsections: []\n\t\t\t} ]\n\t\t},\n\t\t{\n\t\t\tline: 'A2.2',\n\t\t\tlevel: '2',\n\t\t\tanchor: '',\n\t\t\ttext: '',\n\t\t\tsubsections: []\n\t\t},\n\t\t{\n\t\t\tline: 'A2',\n\t\t\tlevel: '1',\n\t\t\tanchor: '',\n\t\t\ttext: '<h2 id=\"\">A2.1</h2>\\n\\n',\n\t\t\tsubsections: [ {\n\t\t\t\tline: 'A2.1',\n\t\t\t\tlevel: '2',\n\t\t\t\tanchor: '',\n\t\t\t\ttext: '',\n\t\t\t\tsubsections: []\n\t\t\t} ]\n\t\t}\n\t] );\n} );\n\nQUnit.test( '#getPage (forwards api errors)', function ( assert ) {\n\tsandbox.stub( this.api, 'get' ).returns( util.Deferred().reject( 'missingtitle' ) );\n\treturn pageGateway.getPage( 'Err' ).catch( function ( msg ) {\n\t\tassert.strictEqual( msg, 'missingtitle' );\n\t} );\n} );\n\nQUnit.test( '#getPage (move protected page)', function ( assert ) {\n\tvar expected = {\n\t\tedit: [ '*' ],\n\t\tmove: [ 'sysop' ]\n\t};\n\tsandbox.stub( this.api, 'get' ).returns( util.Deferred().resolve( {\n\t\tmobileview: {\n\t\t\tid: -1,\n\t\t\tdisplaytitle: 'Test',\n\t\t\trevId: 42,\n\t\t\tlastmodifiedby: {\n\t\t\t\tname: 'bob',\n\t\t\t\tgender: 'unknown'\n\t\t\t},\n\t\t\tprotection: {\n\t\t\t\tmove: [ 'sysop' ]\n\t\t\t},\n\t\t\tlastmodified: '2013-10-28T18:49:56Z',\n\t\t\tlanguagecount: 10,\n\t\t\tsections: [\n\t\t\t\t{\n\t\t\t\t\tid: 0,\n\t\t\t\t\ttext: ''\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t} ) );\n\n\tpageGateway.invalidatePage( 'Test' );\n\treturn pageGateway.getPage( 'Test' ).then( function ( resp ) {\n\t\tassert.propEqual( resp.protection, expected );\n\t} );\n} );\n","var\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tPanel,\n\tsandbox;\n\nQUnit.module( 'MobileFrontend Panel.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\tPanel = require( '../../../src/mobile.startup/Panel' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'show() when not visible', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tpanel = new Panel();\n\n\tpanel.on( 'show', function () {\n\t\tassert.ok( panel.$el.hasClass( 'visible' ), 'Visible class is set' );\n\t\tassert.ok( panel.$el.hasClass( 'animated' ), 'Animated class is set' );\n\t\tdone();\n\t} );\n\n\tpanel.show();\n} );\n\nQUnit.test( 'hide() when visible', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tpanel = new Panel();\n\n\tpanel.on( 'hide', function () {\n\t\tassert.notOk( panel.$el.hasClass( 'visible', 'Visible class is removed' ) );\n\t\tdone();\n\t} );\n\n\tpanel.show();\n\tpanel.hide();\n} );\n\nQUnit.test( 'isVisible() when visible', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tpanel = new Panel();\n\n\tpanel.on( 'show', function () {\n\t\tassert.ok( panel.isVisible(), 'Returns true when visible' );\n\t\tdone();\n\t} );\n\n\tpanel.show();\n} );\n\nQUnit.test( 'isVisible() when not visible', function ( assert ) {\n\tvar panel = new Panel();\n\n\tassert.notOk( panel.isVisible(), 'Returns false when not visible' );\n} );\n\nQUnit.test( 'onCancel()', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tpanel = new Panel();\n\n\tpanel.on( 'hide', function () {\n\t\tassert.notOk( panel.$el.hasClass( 'visible' ), 'Removes visible class' );\n\t\tdone();\n\t} );\n\n\tpanel.show();\n\tpanel.onCancel( {\n\t\tpreventDefault: function () {}\n\t} );\n} );\n\nQUnit.test( 'toggle()', function ( assert ) {\n\tvar\n\t\tdone = assert.async(),\n\t\tpanel = new Panel();\n\n\tpanel.on( 'show', function () {\n\t\tassert.ok( panel.isVisible(), 'Shows panel when not visible' );\n\t\tpanel.toggle();\n\t} );\n\n\tpanel.on( 'hide', function () {\n\t\tassert.notOk( panel.isVisible(), 'Hides panel when visible' );\n\t\tdone();\n\t} );\n\n\tpanel.toggle();\n} );\n","var\n\tsinon = require( 'sinon' ),\n\too = require( '../utils/oo' ),\n\tsandbox,\n\tScrollEndEventEmitter;\n\nQUnit.module( 'MobileFrontend ScrollEndEventEmitter.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\too.setUp( sandbox, global );\n\n\t\tScrollEndEventEmitter = require( '../../../src/mobile.startup/ScrollEndEventEmitter' );\n\t},\n\tafterEach: function () {\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'initializes properly', function ( assert ) {\n\tvar\n\t\teventBus = {\n\t\t\ton: sinon.spy()\n\t\t},\n\t\tis = new ScrollEndEventEmitter( eventBus, 500 ),\n\t\tis2 = new ScrollEndEventEmitter( eventBus );\n\n\tassert.strictEqual( is.enabled, true,\n\t\t'Emission is enabled by default' );\n\tassert.strictEqual( is.threshold, 500, 'Threshold is saved' );\n\tassert.strictEqual( is2.threshold, 100,\n\t\t'Without a threshold we get a default' );\n\tassert.strictEqual( eventBus.on.withArgs( 'scroll:throttled',\n\t\tis._scrollHandler ).calledOnce, true, 'Scrolling handler is bound' );\n} );\n\nQUnit.test( 'emits scroll end event', function ( assert ) {\n\tvar\n\t\teventBus = {\n\t\t\ton: function ( _, handler ) {\n\t\t\t\tthis.handler = handler;\n\t\t\t},\n\t\t\toff: function () {}\n\t\t},\n\t\tis = new ScrollEndEventEmitter( eventBus );\n\n\t// stub scrollNearEnd method because headless tests don't support scrolling\n\tsandbox.stub( is, 'scrollNearEnd' ).returns( true );\n\tis.setElement( {} );\n\n\tis.on( ScrollEndEventEmitter.EVENT_SCROLL_END, function () {\n\t\tassert.ok( true, 'scroll end event emitted' );\n\t} );\n\t// trigger stubbed 'scroll:throttled' event\n\teventBus.handler();\n} );\n\nQUnit.test( 'doesn\\'t emit when disabled', function ( assert ) {\n\tvar\n\t\temitSpy = sandbox.spy( ScrollEndEventEmitter.prototype, 'emit' ),\n\t\teventBus = {\n\t\t\ton: function ( _, handler ) {\n\t\t\t\tthis.handler = handler;\n\t\t\t},\n\t\t\toff: function () {}\n\t\t},\n\t\tis = new ScrollEndEventEmitter( eventBus );\n\tis.setElement( {} );\n\tis.disable();\n\n\t// trigger stubbed 'scroll:throttled' event\n\teventBus.handler();\n\tassert.strictEqual( emitSpy.called, false, 'emit should not be called' );\n} );\n","var\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' ),\n\too = require( '../utils/oo' ),\n\tSection,\n\tsandbox;\n\nQUnit.module( 'MobileFrontend Section.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tSection = require( '../../../src/mobile.startup/Section' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'initialize with options', function ( assert ) {\n\tvar section = new Section( {\n\t\tlevel: '1',\n\t\tline: 'Line',\n\t\ttext: 'Text',\n\t\thasReferences: true,\n\t\tid: 'ID',\n\t\tanchor: 'Anchor'\n\t} );\n\n\tassert.strictEqual( section.line, 'Line', 'line is set' );\n\tassert.strictEqual( section.text, 'Text', 'text is set' );\n\tassert.strictEqual( section.hasReferences, true, 'hasReferences is set' );\n\tassert.strictEqual( section.id, 'ID', 'id is set' );\n\tassert.strictEqual( section.anchor, 'Anchor', 'anchor is set' );\n\tassert.strictEqual( section.subsections.length, 0, 'Subsections are empty' );\n} );\n\nQUnit.test( 'initialize with subsections', function ( assert ) {\n\tvar\n\t\tsection = new Section( {\n\t\t\tsubsections: [ {\n\t\t\t\tlevel: '',\n\t\t\t\tline: 'Line',\n\t\t\t\ttext: 'Text',\n\t\t\t\thasReferences: true,\n\t\t\t\tid: 'ID',\n\t\t\t\tanchor: 'Anchor'\n\t\t\t} ]\n\t\t} ),\n\t\tsubsection = section.subsections[ 0 ];\n\n\tassert.strictEqual( section.subsections.length, 1, 'Subsection is added to array' );\n\tassert.ok( subsection instanceof Section, 'Subsections are instances of Section' );\n\n\tassert.strictEqual( subsection.line, 'Line', 'line is set' );\n\tassert.strictEqual( subsection.text, 'Text', 'text is set' );\n\tassert.strictEqual( subsection.hasReferences, true, 'hasReferences is set' );\n\tassert.strictEqual( subsection.id, 'ID', 'id is set' );\n\tassert.strictEqual( subsection.anchor, 'Anchor', 'anchor is set' );\n\tassert.strictEqual( subsection.subsections.length, 0, 'Subsection children are empty' );\n} );\n","/* eslint-env es6 */\n/* global $ */\nvar\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' ),\n\too = require( '../utils/oo' ),\n\tmediawiki = require( '../utils/mw' ),\n\tsandbox,\n\tbrowser,\n\tToggler,\n\tsectionTemplate = `\n\t\t<h2>\n\t\t<span id=\"First_Section\">First Section</span>\n\t\t</h2>\n\t\t<div>\n\t\t\t<p>Text</p>\n\t\t</div>\n\t\t<h2 id=\"section_1\">\n\t\t\t<a href=\"#foo\">Dummy Link</a>\n\t\t</h2>\n\t\t<div></div>\n\t\t<h2>References</h2>\n\t\t<div data-is-reference-section=\"1\">\n\t\t\t<ol class=\"references\">\n\t\t\t\t<li id=\"cite_note-1\">\n\t\t\t\t\t<span class=\"mw-cite-backlink\">\n\t\t\t\t\t\t<a href=\"#cite_ref-1\"></a>\n\t\t\t\t\t</span> <span class=\"reference-text\">hello</span>\n\t\t\t\t</li>\n\t\t\t</ol>\n\t\t</div>\n`;\n\n/**\n * Mobile toggling\n */\nQUnit.module( 'MobileFrontend Toggler.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediawiki.setUp( sandbox, global );\n\n\t\tbrowser = require( '../../../src/mobile.startup/Browser' ).getSingleton();\n\t\tToggler = require( '../../../src/mobile.startup/Toggler' );\n\n\t\tsandbox.stub( mw.config, 'get' ).withArgs( 'wgMFCollapseSectionsByDefault' ).returns( true );\n\t\tsandbox.stub( browser, 'isWideScreen' ).returns( false );\n\n\t\tthis.page = { title: 'Toggle test' };\n\t\tthis.$container = $( '<div>' ).html( sectionTemplate );\n\t\tthis.$section0 = this.$container.find( 'h2' ).eq( 0 );\n\t\tthis.title = this.page.title;\n\t\tthis.headline = this.$section0.find( 'span' ).attr( 'id' );\n\t},\n\tafterEach: function () {\n\t\tmw.storage.remove( 'expandSections' );\n\t\tmw.storage.remove( 'expandedSections' );\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'Mobile mode - Toggle section', function ( assert ) {\n\tvar\n\t\ttoggle = new Toggler( {\n\t\t\teventBus: new OO.EventEmitter(),\n\t\t\t$container: this.$container,\n\t\t\tprefix: '',\n\t\t\tpage: this.page\n\t\t} ),\n\t\t$section = this.$section0,\n\t\t$content = this.$container.find( '.collapsible-block' ).eq( 0 );\n\n\ttoggle.toggle( $section );\n\n\tassert.strictEqual( $section.hasClass( 'open-block' ), true, 'open-block class present' );\n\n\ttoggle.toggle( $section );\n\n\tassert.strictEqual( $content.hasClass( 'open-block' ), false, 'check content gets closed on a toggle' );\n\tassert.strictEqual( $section.hasClass( 'open-block' ), false, 'check section is closed' );\n\t// Perform second toggle\n\ttoggle.toggle( $section );\n\tassert.strictEqual( $content.hasClass( 'open-block' ), true, 'check content reopened' );\n\tassert.strictEqual( $section.hasClass( 'open-block' ), true, 'check section has reopened' );\n} );\n\nQUnit.test( 'Mobile mode - Clicking a hash link to reveal an already open section', function ( assert ) {\n\tvar\n\t\ttoggle = new Toggler( {\n\t\t\teventBus: new OO.EventEmitter(),\n\t\t\t$container: this.$container,\n\t\t\tprefix: '',\n\t\t\tpage: this.page\n\t\t} );\n\n\ttoggle.toggle( this.$section0 );\n\n\tassert.strictEqual( this.$section0.hasClass( 'open-block' ), true, 'check section is open' );\n\ttoggle.reveal( 'First_Section', this.$container );\n\tassert.strictEqual( this.$section0.hasClass( 'open-block' ), true, 'check section is still open' );\n} );\n\nQUnit.test( 'Mobile mode - Reveal element', function ( assert ) {\n\tvar\n\t\ttoggle = new Toggler( {\n\t\t\teventBus: new OO.EventEmitter(),\n\t\t\t$container: this.$container,\n\t\t\tprefix: '',\n\t\t\tpage: this.page\n\t\t} );\n\n\ttoggle.toggle( this.$section0 );\n\n\ttoggle.reveal( 'First_Section' );\n\tassert.strictEqual( this.$container.find( '.collapsible-block' ).eq( 0 ).hasClass( 'open-block' ), true, 'check content is visible' );\n\tassert.strictEqual( this.$section0.hasClass( 'open-block' ), true, 'check section is open' );\n} );\n\nQUnit.test( 'Mobile mode - Clicking hash links', function ( assert ) {\n\tvar\n\t\ttoggle = new Toggler( {\n\t\t\teventBus: new OO.EventEmitter(),\n\t\t\t$container: this.$container,\n\t\t\tprefix: '',\n\t\t\tpage: this.page\n\t\t} );\n\n\ttoggle.toggle( this.$section0 );\n\n\tthis.$container.find( '[href=\"#First_Section\"]' ).trigger( 'click' );\n\tassert.strictEqual( this.$container.find( '.collapsible-block' ).eq( 0 ).hasClass( 'open-block' ), true, 'check content is visible' );\n\tassert.strictEqual( this.$section0.hasClass( 'open-block' ), true, 'check section is open' );\n} );\n\nQUnit.test( 'Mobile mode - Tap event toggles section', function ( assert ) {\n\tvar\n\t\ttoggle = new Toggler( {\n\t\t\teventBus: new OO.EventEmitter(),\n\t\t\t$container: this.$container,\n\t\t\tprefix: '',\n\t\t\tpage: this.page\n\t\t} ),\n\t\t$content = this.$container.find( '.collapsible-block' ).eq( 1 );\n\n\ttoggle.toggle( this.$section0 );\n\n\tassert.strictEqual( $content.hasClass( 'open-block' ), false, 'check content is hidden at start' );\n\n\tthis.$container.find( '#section_1' ).trigger( 'click' );\n\n\tassert.strictEqual( $content.hasClass( 'open-block' ), true, 'check content is shown on a toggle' );\n} );\n\nQUnit.test( 'Accessibility - Verify aria attributes', function ( assert ) {\n\tvar\n\t\ttoggle = new Toggler( {\n\t\t\teventBus: new OO.EventEmitter(),\n\t\t\t$container: this.$container,\n\t\t\tprefix: '',\n\t\t\tpage: this.page\n\t\t} ),\n\t\t$section = this.$container.find( '#section_1' ),\n\t\t$content = this.$container.find( '.collapsible-block' ).eq( 1 );\n\n\ttoggle.toggle( this.$section0 );\n\n\t// Test the initial state produced by the init function\n\tassert.strictEqual( $content.hasClass( 'open-block' ), false, 'check content is hidden at start' );\n\tassert.strictEqual( $content.attr( 'aria-pressed' ), 'false', 'check aria-pressed is false at start' );\n\tassert.strictEqual( $content.attr( 'aria-expanded' ), 'false', 'check aria-expanded is false at start' );\n\n\t// Test what the toggle() function gives us when hiding the section\n\t$section.trigger( 'click' );\n\tassert.strictEqual( $content.hasClass( 'open-block' ), true, 'check content is visible after toggling' );\n\tassert.strictEqual( $content.attr( 'aria-pressed' ), 'true', 'check aria-pressed is true after toggling' );\n\tassert.strictEqual( $content.attr( 'aria-expanded' ), 'true', 'check aria-expanded is true after toggling' );\n\n\t// Test what the toggle() function gives us when showing the section\n\t$section.trigger( 'click' );\n\tassert.strictEqual( $content.hasClass( 'open-block' ), false, 'check content is hidden after toggling' );\n\tassert.strictEqual( $content.attr( 'aria-pressed' ), 'false', 'check aria-pressed is false after toggling' );\n\tassert.strictEqual( $content.attr( 'aria-expanded' ), 'false', 'check aria-expanded is false after toggling' );\n} );\n\n/**\n * Tablet toggling\n */\nQUnit.test( 'Tablet mode - Open by default', function ( assert ) {\n\tbrowser.isWideScreen.returns( true );\n\n\t/* eslint-disable-next-line no-new */\n\tnew Toggler( {\n\t\teventBus: new OO.EventEmitter(),\n\t\t$container: this.$container,\n\t\tprefix: '',\n\t\tpage: this.page\n\t} );\n\n\tassert.strictEqual( this.$container.find( '.collapsible-block' ).eq( 1 ).hasClass( 'open-block' ),\n\t\ttrue, 'check section is visible at start' );\n\tassert.strictEqual( this.$container.find( '.collapsible-block' ).eq( 2 ).hasClass( 'open-block' ),\n\t\tfalse, 'check reference section is hidden at start' );\n} );\n\n/**\n * Expand sections user setting\n */\nQUnit.test( 'Tablet mode - Open by default 2', function ( assert ) {\n\n\tmw.config.get.withArgs( 'wgMFCollapseSectionsByDefault' ).returns( false );\n\n\t/* eslint-disable-next-line no-new */\n\tnew Toggler( {\n\t\teventBus: new OO.EventEmitter(),\n\t\t$container: this.$container,\n\t\tprefix: '',\n\t\tpage: this.page\n\t} );\n\n\tassert.strictEqual( this.$container.find( '.collapsible-block' ).eq( 1 ).hasClass( 'open-block' ), true, 'check section is visible at start' );\n} );\n\n/**\n * Accessibility\n */\nQUnit.test( 'Accessibility - Pressing space/ enter toggles a heading', function ( assert ) {\n\tvar $section = this.$container.find( '#section_1' ),\n\t\t$content,\n\t\tev = $.Event( 'keypress' );\n\n\tbrowser.isWideScreen.returns( false );\n\tmw.config.get.withArgs( 'wgMFCollapseSectionsByDefault' ).returns( true );\n\n\t/* eslint-disable-next-line no-new */\n\tnew Toggler( {\n\t\teventBus: new OO.EventEmitter(),\n\t\t$container: this.$container,\n\t\tprefix: '',\n\t\tpage: this.page\n\t} );\n\n\t$content = this.$container.find( '.collapsible-block' ).eq( 1 );\n\n\tassert.strictEqual( $content.hasClass( 'open-block' ), false, 'check content is hidden at start' );\n\n\t// Open the section with pressing space\n\tev.which = 32;\n\t$section.trigger( ev );\n\tassert.strictEqual( $content.hasClass( 'open-block' ), true, 'check content is shown after pressing space' );\n\n\t// Enter should close the section again\n\tev.which = 13;\n\t$section.trigger( ev );\n\tassert.strictEqual( $content.hasClass( 'open-block' ), false, 'check content is hidden after pressing enter' );\n} );\n\nQUnit.test( 'Clicking a link within a heading isn\\'t triggering a toggle', function ( assert ) {\n\n\tvar $section = $( '#section_1' ),\n\t\t$content = $( '.collapsible-block' ).eq( 1 );\n\n\t/* eslint-disable-next-line no-new */\n\tnew Toggler( {\n\t\teventBus: new OO.EventEmitter(),\n\t\t$container: this.$container,\n\t\tprefix: '',\n\t\tpage: this.page\n\t} );\n\n\tassert.strictEqual( $content.hasClass( 'open-block' ), false, 'check content is hidden at start' );\n\n\t$section.find( '> a' ).eq( 0 ).trigger( 'mouseup' );\n\tassert.strictEqual( $content.hasClass( 'open-block' ), false, 'check content is still being hidden after clicking on the link' );\n} );\n\nQUnit.test( 'Toggling a section stores its state.', function ( assert ) {\n\n\tvar\n\t\ttoggle = new Toggler( {\n\t\t\teventBus: new OO.EventEmitter(),\n\t\t\t$container: this.$container,\n\t\t\tprefix: '',\n\t\t\tpage: this.page\n\t\t} ),\n\t\t$section = this.$container.find( 'h2' ),\n\t\texpandedSections = Toggler._getExpandedSections( this.page ),\n\t\tmwStorageSetSpy = sandbox.spy( mw.storage, 'set' ),\n\t\tmwStorageSetCall,\n\t\tmwStorageSetCall2;\n\n\tassert.strictEqual( $.isEmptyObject( expandedSections[ this.title ] ),\n\t\ttrue,\n\t\t'no user setting about an expanded section exists already'\n\t);\n\n\ttoggle.toggle( $section );\n\tmwStorageSetCall = JSON.parse( mwStorageSetSpy.getCall( 0 ).args[1] );\n\n\tassert.strictEqual( typeof mwStorageSetCall[ this.title ][ this.headline ],\n\t\t'number',\n\t\t'the just toggled section state has been saved'\n\t);\n\n\ttoggle.toggle( $section );\n\tmwStorageSetCall2 = JSON.parse( mwStorageSetSpy.getCall( 1 ).args[1] );\n\n\tassert.strictEqual( mwStorageSetCall2[ this.title ][ this.headline ],\n\t\tundefined,\n\t\t'the just toggled section state has been removed'\n\t);\n\n} );\n\nQUnit.test( 'Check for and remove obsolete stored sections.', function ( assert ) {\n\tvar\n\t\texpandedSections,\n\t\tmwStorageSetSpy,\n\t\tlocalStorageValue,\n\t\tlocalStorageRemovalValue;\n\n\tlocalStorageValue = {};\n\tlocalStorageValue[ this.title ] = {};\n\tlocalStorageValue[ this.title ][ this.headline ] = ( new Date( 1990, 1, 1 ) ).getTime();\n\n\tsandbox.stub( mw.storage, 'get', function () {\n\t\treturn JSON.stringify( localStorageValue );\n\t} );\n\n\texpandedSections = Toggler._getExpandedSections( this.page );\n\tassert.strictEqual( typeof expandedSections[ this.title ][ this.headline ],\n\t\t'number',\n\t\t'manually created section state has been saved correctly'\n\t);\n\n\tmwStorageSetSpy = sandbox.spy( mw.storage, 'set' );\n\n\tToggler._cleanObsoleteStoredSections( this.page );\n\tlocalStorageRemovalValue = JSON.stringify( [ 'expandedSections', '{\"Toggle test\":{}}' ] );\n\tassert.strictEqual(\n\t\tJSON.stringify( mwStorageSetSpy.getCall( 0 ).args ),\n\t\tlocalStorageRemovalValue,\n\t\t'section, whose store time is manually changed to an older date,' +\n\t\t\t'has been removed from storage correctly'\n\t);\n} );\n\nQUnit.test( 'Expanding already expanded section does not toggle it.', function ( assert ) {\n\tvar\n\t\ttoggle = new Toggler( {\n\t\t\teventBus: new OO.EventEmitter(),\n\t\t\t$container: this.$container,\n\t\t\tprefix: '',\n\t\t\tpage: this.page\n\t\t} ),\n\t\t$section = this.$container.find( 'h2' ),\n\t\texpandedSections = Toggler._getExpandedSections( this.page ),\n\t\tmwStorageSetSpy,\n\t\tmwStorageSetCall;\n\n\tassert.strictEqual( $.isEmptyObject( expandedSections[ this.title ] ),\n\t\ttrue,\n\t\t'no expanded sections are stored in localStorage yet'\n\t);\n\n\tassert.strictEqual(\n\t\t$section.hasClass( 'open-block' ),\n\t\tfalse,\n\t\t'section does not have open-block class'\n\t);\n\n\tmwStorageSetSpy = sandbox.spy( mw.storage, 'set' );\n\n\t// manually toggle the second section\n\ttoggle.toggle( $section );\n\n\tassert.strictEqual(\n\t\t$section.hasClass( 'open-block' ),\n\t\ttrue,\n\t\t'revealed section has open-block class'\n\t);\n\n\texpandedSections = Toggler._getExpandedSections( this.page );\n\tmwStorageSetCall = JSON.parse( mwStorageSetSpy.getCall( 0 ).args[1] );\n\n\tassert.strictEqual( typeof mwStorageSetCall[this.title][ this.headline ],\n\t\t'number',\n\t\t'manually revealed section state has been correctly saved in localStorage'\n\t);\n\n\tToggler._expandStoredSections( toggle, this.$container, this.page );\n\n\tassert.strictEqual(\n\t\t$section.hasClass( 'open-block' ),\n\t\ttrue,\n\t\t'already revealed section still has open-block class after expanding sections'\n\t);\n} );\n\nQUnit.test( 'MobileFrontend toggle.js - Expand stored sections.', function ( assert ) {\n\n\tvar\n\t\t$section = this.$container.find( 'h2' ).eq( 0 ),\n\t\texpandedSections = Toggler._getExpandedSections( this.page ),\n\t\texpandedSectionsFromToggle;\n\n\t// Restore expanded sections only works on headings that are also section headings\n\tthis.$container.find( 'h2' ).addClass( 'section-heading' );\n\n\tassert.strictEqual( $section.hasClass( 'open-block' ), false, 'Section is collapsed.' );\n\n\tassert.strictEqual( $.isEmptyObject( expandedSections[ this.title ] ),\n\t\ttrue,\n\t\t'no user setting about an expanded section exists already'\n\t);\n\n\t// save a toggle state manually\n\texpandedSections[ this.title ][ this.headline ] = ( new Date() ).getTime();\n\n\tsandbox.stub( mw.storage, 'get', function () {\n\t\treturn JSON.stringify( expandedSections );\n\t} );\n\texpandedSectionsFromToggle = Toggler._getExpandedSections( this.page );\n\tassert.strictEqual( typeof expandedSectionsFromToggle[ this.title ][ this.headline ],\n\t\t'number',\n\t\t'manually created section state has been saved correctly'\n\t);\n\n\t/* eslint-disable-next-line no-new */\n\tnew Toggler( {\n\t\teventBus: new OO.EventEmitter(),\n\t\t$container: this.$container,\n\t\tprefix: '',\n\t\tpage: this.page\n\t} );\n\n\texpandedSections = Toggler._getExpandedSections( this.page );\n\tassert.strictEqual( typeof expandedSections[ this.title ][ this.headline ],\n\t\t'number',\n\t\t'manually created section state is still active after toggle.init()'\n\t);\n\tassert.strictEqual( $section.hasClass( 'open-block' ), true,\n\t\t'Saved section has been auto expanded.' );\n\n} );\n","/* global $ */\nvar\n\tHogan = require( 'hogan.js' ),\n\tmw = require( '../utils/mw' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmfExtend = require( '../../../src/mobile.startup/mfExtend' ),\n\tutil = require( '../../../src/mobile.startup/util' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' ),\n\tView;\n/** @type {sinon.SinonSandbox} */ var sandbox; // eslint-disable-line one-var\n\nQUnit.module( 'MobileFrontend mobile.startup/View', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmw.setUp( sandbox, global );\n\n\t\tView = require( '../../../src/mobile.startup/View' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'View', function ( assert ) {\n\tvar view = new View( {\n\t\tel: 'body'\n\t} );\n\tassert.ok( view.$el instanceof $, 'assign jQuery object to $el' );\n\tassert.strictEqual( view.$el[ 0 ].tagName.toUpperCase(), 'BODY', 'assign proper jQuery object to $el' );\n} );\n\nQUnit.test( 'View, jQuery proxy functions', function ( assert ) {\n\tvar view = new View( {\n\t\tel: 'body'\n\t} );\n\t[\n\t\t'append',\n\t\t'prepend',\n\t\t'appendTo',\n\t\t'prependTo',\n\t\t'after',\n\t\t'before',\n\t\t'insertAfter',\n\t\t'insertBefore',\n\t\t'remove',\n\t\t'detach'\n\t].forEach( function ( prop ) {\n\t\tvar stub = sandbox.stub( view.$el, prop );\n\t\tview[ prop ]( 'test', 1 );\n\t\tassert.ok( stub.calledWith( 'test', 1 ) );\n\t\tstub.restore();\n\t} );\n} );\n\nQUnit.test( 'View#preRender', function ( assert ) {\n\tvar view;\n\tfunction ChildView() {\n\t\tView.apply( this, arguments );\n\t}\n\n\tmfExtend( ChildView, View, {\n\t\ttemplate: Hogan.compile( '<p>{{text}}</p>' ),\n\t\tpreRender: function () {\n\t\t\tthis.options.text = 'hello';\n\t\t}\n\t} );\n\n\tview = new ChildView();\n\tassert.strictEqual( view.$el.html(), '<p>hello</p>', 'manipulate template data' );\n} );\n\nQUnit.test( 'View#postRender', function ( assert ) {\n\tvar spy = sandbox.spy();\n\tfunction ChildView() {\n\t\tView.apply( this, arguments );\n\t}\n\n\tmfExtend( ChildView, View, {\n\t\tpostRender: function () {\n\t\t\tspy();\n\t\t}\n\t} );\n\n\t// eslint-disable-next-line no-new\n\tnew ChildView();\n\tassert.strictEqual( spy.callCount, 1, 'invoke postRender' );\n} );\n\nQUnit.test( 'View#delegateEvents', function ( assert ) {\n\n\tvar view;\n\tfunction EventsView( props ) {\n\t\tView.call(\n\t\t\tthis,\n\t\t\tutil.extend(\n\t\t\t\t{\n\t\t\t\t\tevents: {\n\t\t\t\t\t\t'click p span': function ( ev ) {\n\t\t\t\t\t\t\tev.preventDefault();\n\t\t\t\t\t\t\tassert.ok( true, 'Span was clicked and handled' );\n\t\t\t\t\t\t},\n\t\t\t\t\t\t'click p': 'onParagraphClick',\n\t\t\t\t\t\tclick: 'onClick'\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tprops\n\t\t\t)\n\t\t);\n\t}\n\n\tmfExtend( EventsView, View, {\n\t\ttemplate: Hogan.compile( '<p><span>test</span></p>' ),\n\t\tonParagraphClick: function ( ev ) {\n\t\t\tev.preventDefault();\n\t\t\tassert.ok( true, 'Paragraph was clicked and handled' );\n\t\t},\n\t\tonClick: function ( ev ) {\n\t\t\tev.preventDefault();\n\t\t\tassert.ok( true, 'View was clicked and handled' );\n\t\t}\n\t} );\n\n\tview = new EventsView();\n\tview.appendTo( 'body' );\n\t// Check if events are set and handlers called\n\tview.$el.find( 'span' ).trigger( 'click' );\n\tview.$el.find( 'p' ).trigger( 'click' );\n\tview.$el.trigger( 'click' );\n\t// Check if events can be unset and handlers are not called\n\tview.undelegateEvents();\n\tview.$el.find( 'span' ).trigger( 'click' );\n\tview.$el.find( 'p' ).trigger( 'click' );\n\tview.$el.trigger( 'click' );\n} );\n\nQUnit.test( 'View#render (with isTemplateMode)', function ( assert ) {\n\tvar view, view2, textFirstRun,\n\t\t$parent = $( '<div>' );\n\tfunction TemplateModeView() {\n\t\tView.apply( this, arguments );\n\t}\n\n\tmfExtend( TemplateModeView, View, {\n\t\ttemplate: Hogan.compile( '<p class=\"foo\"><span>{{text}}</span></p>' ),\n\t\tisTemplateMode: true\n\t} );\n\n\tfunction ContainerView() {\n\t\tView.call( this, { className: 'bar' } );\n\t}\n\n\tmfExtend( ContainerView, View, {\n\t\ttemplate: Hogan.compile( '<p class=\"foo\"><span>test</span></p>' )\n\t} );\n\n\tview = new TemplateModeView();\n\ttextFirstRun = view.$el.text();\n\tview2 = new ContainerView();\n\tview.render();\n\tview2.render();\n\t// attach to the DOM\n\tview.$el.appendTo( $parent );\n\t// and then do a second render...\n\tview.render( { text: 'hello' } );\n\tassert.ok( view.$el.hasClass( 'foo' ) );\n\tassert.ok( view2.$el.hasClass( 'bar' ) );\n\tassert.strictEqual( textFirstRun, '', 'first run, no text defined' );\n\tassert.strictEqual( view.$el.text(), 'hello', 'second run, text has been defined' );\n\tassert.strictEqual( view.$el.parent( $parent ).length, 1,\n\t\t'A re-rendered view thats attached to the DOM remains attached to the DOM' );\n} );\n\nQUnit.test( 'View#render events (with isTemplateMode)', function ( assert ) {\n\tvar view;\n\tfunction TemplateModeView( props ) {\n\t\tView.call(\n\t\t\tthis,\n\t\t\tutil.extend( { events: { 'click span': 'onClick' } }, props )\n\t\t);\n\t}\n\n\tmfExtend( TemplateModeView, View, {\n\t\tonClick: function () {\n\t\t\tthis.$el.empty().text( 'hello world' );\n\t\t},\n\t\ttemplate: Hogan.compile( '<p class=\"foo\"><span>test</span></p>' ),\n\t\tisTemplateMode: true\n\t} );\n\n\tview = new TemplateModeView();\n\t// trigger event\n\tview.$( 'span' ).trigger( 'click' );\n\tassert.strictEqual( view.$el.text(), 'hello world', 'event was called' );\n\tassert.strictEqual( view.$( 'span' ).length, 0, 'span disappeared' );\n\n\t// do same again but call render twice\n\tview = new TemplateModeView();\n\t// force a re-render\n\tview.render();\n\t// trigger event to show events didn't get lost\n\tview.$( 'span' ).trigger( 'click' );\n\tassert.strictEqual( view.$el.text(), 'hello world', 'event was called' );\n\tassert.strictEqual( view.$( 'span' ).length, 0, 'span disappeared' );\n} );\n\nQUnit.test( 'View with className option', function ( assert ) {\n\t[\n\t\t[\n\t\t\tnew View(),\n\t\t\t'view-border-box',\n\t\t\t'className not defined on a normal View without options and isBorderBox is default'\n\t\t],\n\t\t[\n\t\t\tnew View( {} ),\n\t\t\t'view-border-box',\n\t\t\t'className not defined on a normal View with empty options and isBorderBox is default'\n\t\t],\n\t\t[\n\t\t\tnew View( {\n\t\t\t\tclassName: 'banana'\n\t\t\t} ),\n\t\t\t'banana view-border-box',\n\t\t\t'option is passed to View (along with default isBorderBox property)'\n\t\t],\n\t\t[\n\t\t\tnew View( { isBorderBox: false } ),\n\t\t\tundefined,\n\t\t\t'Passing isBorderBox option removes default view-border-box class'\n\t\t],\n\t\t[\n\t\t\tnew View( { isBorderBox: true } ),\n\t\t\t'view-border-box',\n\t\t\t'Passing isBorderBox option as true retains default view-border-box class'\n\t\t]\n\t].forEach( function ( test ) {\n\t\tassert.strictEqual( test[0].$el.attr( 'class' ), test[1], test[2] );\n\t} );\n} );\n","var cache = require( '../../../src/mobile.startup/cache' ),\n\tMemoryCache = cache.MemoryCache,\n\tmemoryCache = new MemoryCache();\n\nQUnit.module( 'MobileFrontend cache.js' );\n\nQUnit.test( 'cache set() and get()', function ( assert ) {\n\tmemoryCache.set( 'key', 'value' );\n\tassert.strictEqual( memoryCache.get( 'key' ), 'value' );\n} );\n","var sandbox,\n\tsinon = require( 'sinon' ),\n\tmediaWiki = require( '../utils/mw' ),\n\tcontext = require( '../../../src/mobile.startup/context' );\n\nQUnit.module( 'MobileFrontend context.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tmediaWiki.setUp( sandbox, global );\n\t},\n\tafterEach: function () { sandbox.restore(); }\n} );\n\nQUnit.test( 'getMode()', function ( assert ) {\n\tsandbox.stub( mw.config, 'get' ).withArgs( 'wgMFMode' )\n\t\t.returns( 'stable' );\n\tassert.strictEqual( context.getMode(), 'stable', 'Value comes straight from config' );\n} );\n","var sandbox, extendSearchParams,\n\tjQuery = require( '../utils/jQuery' ),\n\tmediaWiki = require( '../utils/mw' ),\n\tdom = require( '../utils/dom' ),\n\tsinon = require( 'sinon' );\n\nQUnit.module( 'MobileFrontend extendSearchParams.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tmediaWiki.setUp( sandbox, global );\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\tsandbox.stub( mw.config, 'get' )\n\t\t\t.withArgs( 'wgMFSearchAPIParams' ).returns(\n\t\t\t\t{\n\t\t\t\t\tfoo: 'bar'\n\t\t\t\t}\n\t\t\t)\n\t\t\t.withArgs( 'wgMFDisplayWikibaseDescriptions' ).returns(\n\t\t\t\t{\n\t\t\t\t\tsearch: true,\n\t\t\t\t\tnearby: false\n\t\t\t\t}\n\t\t\t)\n\t\t\t.withArgs( 'wgMFQueryPropModules' ).returns( [ 'baz' ] );\n\t\textendSearchParams = require( '../../../src/mobile.startup/extendSearchParams' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'it throws if the feature is invalid', function ( assert ) {\n\tvar expectedError = new Error( '\"foo\" isn\\'t a feature that shows Wikibase descriptions.' );\n\n\tassert.throws( function () {\n\t\textendSearchParams( 'foo', {} );\n\t}, expectedError );\n} );\n\nQUnit.test( 'it extends the parameters', function ( assert ) {\n\tvar params = extendSearchParams( 'search', {\n\t\t\tqux: 'quux',\n\t\t\tprop: [ 'corge' ]\n\t\t} ),\n\t\texpectedParams = {\n\t\t\taction: 'query',\n\t\t\tformatversion: 2,\n\t\t\tqux: 'quux',\n\t\t\tfoo: 'bar', // from wgMFSearchAPIParams\n\t\t\tprop: [ 'corge', 'baz', 'description' ] // from wgMFQueryPropModules and Wikibase-specific\n\t\t};\n\n\tassert.propEqual( params, expectedParams );\n} );\n\nQUnit.test( 'it doesn\\'t include Wikibase-specific parameters if the feature is disabled', function ( assert ) {\n\tvar params = extendSearchParams( 'nearby', {\n\t\tqux: 'quux'\n\t} );\n\n\tassert.strictEqual( params.prop.indexOf( 'description' ), -1 );\n\tassert.strictEqual( params.wbptterms, undefined );\n} );\n\nQUnit.test( 'it adds the MobileFrontend configuration to given terms types', function ( assert ) {\n\tvar params = extendSearchParams( 'search', {\n\t\twbptterms: 'grault'\n\t} );\n\n\tassert.strictEqual(\n\t\tparams.wbptterms,\n\t\t'grault',\n\t\t'The given \"wbptterms\" is added to the default.'\n\t);\n} );\n\nQUnit.test( 'it prioritizes MobileFrontend configuration', function ( assert ) {\n\tvar params = extendSearchParams( 'search', {\n\t\t\tfoo: 'quux'\n\t\t} ),\n\t\texpectedParams = {\n\t\t\taction: 'query',\n\t\t\tformatversion: 2,\n\t\t\tfoo: 'bar',\n\t\t\tprop: [ 'baz', 'description' ]\n\t\t};\n\n\tassert.propEqual(\n\t\tparams,\n\t\texpectedParams,\n\t\t'The value of \"foo\" is overridden by the configuration.'\n\t);\n} );\n\nQUnit.test( 'it is variadic', function ( assert ) {\n\tvar params = extendSearchParams(\n\t\t\t'search',\n\t\t\t{\n\t\t\t\tbaz: 'qux'\n\t\t\t},\n\t\t\t{\n\t\t\t\tquux: 'corge'\n\t\t\t}\n\t\t),\n\t\texpectedParams = {\n\t\t\taction: 'query',\n\t\t\tformatversion: 2,\n\t\t\tfoo: 'bar',\n\t\t\tbaz: 'qux',\n\t\t\tquux: 'corge',\n\t\t\tprop: [ 'baz', 'description' ]\n\t\t};\n\n\tassert.propEqual( params, expectedParams );\n} );\n","var sandbox, icons, spy,\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' );\n\nQUnit.module( 'MobileFrontend icons.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\ticons = require( '../../../src/mobile.startup/icons' );\n\t\tspy = sandbox.spy( icons, 'Icon' );\n\t},\n\tafterEach: function () {\n\t\tsandbox.restore();\n\t\tjQuery.tearDown();\n\t}\n} );\n\nQUnit.test( '#cancel()', function ( assert ) {\n\ticons.cancel();\n\tassert.propEqual( spy.getCall( 0 ).args[ 0 ], {\n\t\ttagName: 'button',\n\t\tname: icons.CANCEL_GLYPH,\n\t\tadditionalClassNames: 'cancel',\n\t\tlabel: mw.msg( 'mobile-frontend-overlay-close' )\n\t}, 'Options are passed down' );\n} );\n\nQUnit.test( '#cancel(variant)', function ( assert ) {\n\ticons.cancel( 'gray' );\n\tassert.propEqual( spy.getCall( 0 ).args[ 0 ], {\n\t\ttagName: 'button',\n\t\tname: icons.CANCEL_GLYPH + '-gray',\n\t\tadditionalClassNames: 'cancel',\n\t\tlabel: mw.msg( 'mobile-frontend-overlay-close' )\n\t}, 'Options are passed down' );\n} );\n\nQUnit.test( '#spinner()', function ( assert ) {\n\ticons.spinner( {\n\t\tfoo: 'will be passed down',\n\t\tadditionalClassNames: 'will-be-ignored'\n\t} );\n\tassert.propEqual( spy.getCall( 0 ).args[ 0 ], {\n\t\tfoo: 'will be passed down',\n\t\tadditionalClassNames: 'spinner loading',\n\t\tname: 'spinner',\n\t\tlabel: mw.msg( 'mobile-frontend-loading-message' )\n\t}, 'Options are passed down' );\n} );\n","var\n\tpages = require( './../utils/PageInputs.html' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tlazyReferencesLoader,\n\tsinon = require( 'sinon' ),\n\tutil = require( '../../../src/mobile.startup/util' ),\n\tsandbox,\n\tPage;\n\nQUnit.module( 'MobileFrontend lazyReferencesLoader.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\tPage = require( '../../../src/mobile.startup/Page' );\n\t\tlazyReferencesLoader = require( '../../../src/mobile.startup/lazyReferencesLoader' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#lazyReferencesLoader collapsed', function ( assert ) {\n\tvar\n\t\t$content = util.parseHTML( '<div>' ).append( pages.skinPage ),\n\t\teventBus = {\n\t\t\ton: function () {},\n\t\t\toff: function () {},\n\t\t\temit: function () {}\n\t\t},\n\t\tgateway = {\n\t\t\tgetReferencesLists: function () {},\n\t\t\tgetReferencesList: function () {}\n\t\t},\n\t\tpage = new Page( { title: 'Foo' } );\n\n\tsandbox.stub( gateway, 'getReferencesLists' ).returns( util.Deferred().resolve( {} ) );\n\tsandbox.stub( gateway, 'getReferencesList' )\n\t\t.withArgs( page, 'Notes_and_references' ).returns( util.Deferred().resolve( util.parseHTML( '<p>' ).text( 'P' ) ) )\n\t\t.withArgs( page, 'Notes' ).returns( util.Deferred().resolve( util.parseHTML( '<p>' ).text( 'A' ) ) )\n\t\t.withArgs( page, 'Refs' ).returns( util.Deferred().resolve( util.parseHTML( '<p>' ).text( 'B' ) ) )\n\t\t.withArgs( page, 'More_refs' ).returns( util.Deferred().resolve( util.parseHTML( '<p>' ).html( '<p>E</p><p>F</p>' ).children() ) );\n\n\treturn lazyReferencesLoader.loadReferences( eventBus, {\n\t\texpanded: false,\n\t\tpage: page,\n\t\tisReferenceSection: true,\n\t\t$heading: $content.find( '#Notes_and_references' ).parent()\n\t}, gateway, page ).then( function () {\n\t\tassert.strictEqual( $content.find( '.mf-section-2' ).text().replace( /[\\t\\n]/g, '' ),\n\t\t\t'TextPNotesARefsBno forgetMore refs1E2F3',\n\t\t\t'Check all the references section is populated correctly.' );\n\t} );\n} );\n\nQUnit.test( '#lazyReferencesLoader expanded', function ( assert ) {\n\tvar\n\t\t$content = util.parseHTML( '<div>' ).append( pages.skinPage ),\n\t\teventBus = {\n\t\t\ton: function () {},\n\t\t\toff: function () {},\n\t\t\temit: function () {}\n\t\t},\n\t\tgateway = {\n\t\t\tgetReferencesLists: function () {},\n\t\t\tgetReferencesList: function () {}\n\t\t},\n\t\tpage = new Page( { title: 'Foo' } ),\n\t\tresult;\n\n\tresult = lazyReferencesLoader.loadReferences( eventBus, {\n\t\texpanded: true,\n\t\tpage: page,\n\t\tisReferenceSection: true,\n\t\t$heading: $content.find( '#Notes_and_references' ).parent()\n\t}, gateway, page );\n\tassert.strictEqual( result, undefined );\n} );\n\nQUnit.test( '#getSectionId', function ( assert ) {\n\tvar\n\t\t$el = util.parseHTML(\n\t\t\t[\n\t\t\t\t'<div>',\n\t\t\t\t'<h2><span class=\"mw-headline\" id=\"heading\">H</span></h2>',\n\t\t\t\t'<div>',\n\t\t\t\t'<h3><span class=\"mw-headline\" id=\"subheading\">Subh</span></h3>',\n\t\t\t\t'<a class=\"element\"></a>',\n\t\t\t\t'</div>',\n\t\t\t\t'</div>'\n\t\t\t].join( '' )\n\t\t),\n\t\t$elTwo = util.parseHTML(\n\t\t\t[\n\t\t\t\t'<div>',\n\t\t\t\t'<h2><span class=\"mw-headline\" id=\"Notes_and_references\">Notes and references</span></h2>',\n\t\t\t\t'<div>',\n\t\t\t\t'<h3 class=\"in-block\"><span class=\"mw-headline\" id=\"Notes\">Notes</span></h3>',\n\t\t\t\t'<div class=\"reflist\"><a class=\"element\"></a></div>',\n\t\t\t\t'</div>',\n\t\t\t\t'</div>'\n\t\t\t].join( '' )\n\t\t),\n\t\t$elThree = util.parseHTML(\n\t\t\t[\n\t\t\t\t'<div id=\"mw-content-text\">',\n\t\t\t\t'<h2><span class=\"mw-headline\" id=\"heading\">Heading</span></h2>',\n\t\t\t\t'<div><a class=\"element\"></a></div>',\n\t\t\t\t'</div>'\n\t\t\t].join( '' )\n\t\t),\n\t\t$elFour = util.parseHTML(\n\t\t\t[\n\t\t\t\t'<div id=\"mw-content-text\">',\n\t\t\t\t'<div><a class=\"element\"></a></div>'\n\t\t\t].join( '' )\n\t\t),\n\t\t$elFive = util.parseHTML(\n\t\t\t[\n\t\t\t\t'<div id=\"mw-content-text\">',\n\t\t\t\t'<h2><span class=\"mw-headline\" id=\"Foo\">Foo</span></h2>',\n\t\t\t\t'<div>',\n\t\t\t\t'<p>Foo content.</p>',\n\t\t\t\t'</div>',\n\t\t\t\t'<h2><span class=\"mw-headline\" id=\"Bar\">Bar</span></h2>',\n\t\t\t\t'<div class=\"reflist\"><a class=\"element\"></a></div>',\n\t\t\t\t'</div>',\n\t\t\t\t'</div>'\n\t\t\t].join( '' )\n\t\t);\n\n\tassert.strictEqual(\n\t\tlazyReferencesLoader.test.getSectionId( $el.find( '.element' ) ),\n\t\t'subheading'\n\t);\n\tassert.strictEqual(\n\t\tlazyReferencesLoader.test.getSectionId( $elTwo.find( '.element' ) ),\n\t\t'Notes',\n\t\t'https://phabricator.wikimedia.org/T146394'\n\t);\n\tassert.strictEqual(\n\t\tlazyReferencesLoader.test.getSectionId( $elThree.find( '.element' ) ),\n\t\t'heading'\n\t);\n\tassert.strictEqual(\n\t\tlazyReferencesLoader.test.getSectionId( $elFour.find( '.element' ) ),\n\t\tnull\n\t);\n\tassert.strictEqual(\n\t\tlazyReferencesLoader.test.getSectionId( $elFive.find( '.element' ) ),\n\t\t'Bar'\n\t);\n} );\n","var mfExtend,\n\tsinon = require( 'sinon' ),\n\too = require( '../utils/oo' );\n\n/** @type {sinon.SinonSandbox} */ var sandbox; // eslint-disable-line one-var\n\nQUnit.module( 'MobileFrontend mfExtend.test.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\too.setUp( sandbox, global );\n\t\tmfExtend = require( '../../../src/mobile.startup/mfExtend' );\n\t},\n\tafterEach: function () { sandbox.restore(); }\n} );\n\nQUnit.test( 'mfExtend() - extending from constructor', function ( assert ) {\n\tfunction TestChild() {}\n\tfunction TestPrototype() {}\n\tmfExtend( TestChild, TestPrototype, {} );\n\tassert.strictEqual( TestChild.prototype instanceof TestPrototype, true );\n} );\n\nQUnit.test( 'mfExtend() - extending from object', function ( assert ) {\n\tvar testPrototype = new TestPrototype(),\n\t\ttestChild;\n\tfunction TestChild() {}\n\tfunction TestPrototype() {\n\t\tthis.protoMethod = function () {\n\t\t\treturn true;\n\t\t};\n\t}\n\tmfExtend( TestChild, testPrototype );\n\ttestChild = new TestChild();\n\tassert.strictEqual( testChild.protoMethod(), true );\n} );\n\nQUnit.test( 'mfExtend() - extending from constructor with overrides', function ( assert ) {\n\tvar testChild;\n\tfunction TestChild() {}\n\tfunction TestPrototype() {\n\t\tthis.protoMethod = function () {\n\t\t\treturn true;\n\t\t};\n\t}\n\tmfExtend( TestChild, TestPrototype, {\n\t\tprotoMethod: function () {\n\t\t\treturn false;\n\t\t}\n\t} );\n\ttestChild = new TestChild();\n\tassert.strictEqual( testChild.protoMethod(), false );\n} );\n","var\n\tModuleLoader,\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' );\n/** @type {sinon.SinonSandbox} */ var sandbox; // eslint-disable-line one-var\n\nQUnit.module( 'MobileFrontend ModuleLoader', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\too.setUp( sandbox, global );\n\n\t\tModuleLoader = require( '../../../src/mobile.startup/moduleLoader' );\n\t\tthis.loader = new ModuleLoader();\n\t},\n\tafterEach: function () { sandbox.restore(); }\n} );\n\nQUnit.test( '#require', function ( assert ) {\n\tthis.loader.define( 'foo', 1 );\n\tthis.loader.define( 'bar', 5 );\n\n\tassert.strictEqual( this.loader.require( 'foo' ), 1, 'Returns appropriate module' );\n\tassert.strictEqual( this.loader.require( 'bar' ), 5, 'Returns appropriate module' );\n\n\tassert.throws( function () {\n\t\tthis.loader.require( 'undefinedmodule' );\n\t}, 'Cannot require an undefined module.' );\n\tassert.throws( function () {\n\t\tthis.loader.require( 'mobile.modules/Foo' );\n\t}, 'Cannot require an undefined export on a known module.' );\n} );\n\nQUnit.test( '#define', function ( assert ) {\n\tvar loader = this.loader;\n\tloader.define( 'foo', 1 );\n\tloader.define( 'bar', 5 );\n\tassert.throws( function () {\n\t\tloader.define( 'bar', 50 );\n\t}, 'Cannot define two modules with the same name' );\n\tassert.strictEqual( this.loader.require( 'bar' ), 5, 'Returns first definition of module.' );\n} );\n","var\n\tsinon = require( 'sinon' ),\n\tdom = require( '../utils/dom' ),\n\tjQuery = require( '../utils/jQuery' ),\n\too = require( '../utils/oo' ),\n\tmediaWiki = require( '../utils/mw' ),\n\tutil = require( '../../../src/mobile.startup/util' ),\n\trlModuleLoader,\n\tsandbox;\n\nfunction assertShowHideWorksWhenSuccessful( assert, firstArg, secondArg, thirdArg ) {\n\tvar\n\t\tself = this,\n\t\tresult;\n\n\tsandbox.stub( rlModuleLoader, 'newLoadingOverlay' ).returns( this.stub );\n\n\tresult = rlModuleLoader.loadModule( firstArg, secondArg, thirdArg );\n\n\tassert.strictEqual( this.stub.show.callCount, 1, 'LoadingOverlay show() called once' );\n\tassert.strictEqual( this.stub.show.getCall( 0 ).args.length, 0, 'LoadingOverlay show() called with no args' );\n\tassert.strictEqual( this.stub.hide.callCount, 0, 'LoadingOverlay hide not called' );\n\n\tthis.deferred.resolve();\n\n\treturn result.then( function ( overlay ) {\n\t\tassert.strictEqual( overlay, self.stub, 'Promise resolves to overlay instance' );\n\t\tassert.strictEqual( self.stub.show.callCount, 1, 'LoadingOverlay show() called once' );\n\t\tassert.strictEqual( self.stub.hide.callCount, 1, 'LoadingOverlay hide() called once' );\n\t\tassert.strictEqual( self.stub.hide.getCall( 0 ).args.length, 0, 'LoadingOverlay hide() called with no args' );\n\t} );\n}\n\nQUnit.module( 'MobileFrontend rlModuleLoader.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\t\trlModuleLoader = require( '../../../src/mobile.startup/rlModuleLoader' );\n\n\t\t// jsdom will throw \"Not implemented\" errors if we don't stub\n\t\t// window.scrollTo\n\t\tsandbox.stub( global.window, 'scrollTo' );\n\n\t\tthis.stub = {\n\t\t\tappendTo: sandbox.spy(),\n\t\t\tshow: sandbox.spy(),\n\t\t\thide: sandbox.spy()\n\t\t};\n\t\tthis.deferred = util.Deferred();\n\n\t\tsandbox.stub( mw.loader, 'using' )\n\t\t\t.withArgs( 'mobile.mediaViewer' )\n\t\t\t.returns( this.deferred );\n\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( '#newLoadingOverlay does not blow up', function ( assert ) {\n\tassert.expect( 0 );\n\n\trlModuleLoader.newLoadingOverlay();\n} );\n\nQUnit.test( '#loadModule when instructed to show/hide overlay and successful', function ( assert ) {\n\treturn assertShowHideWorksWhenSuccessful.apply( this, [ assert, 'mobile.mediaViewer', false, true ] );\n} );\n\nQUnit.test( '#loadModule when instructed to show/hide overlay (default args) and successful', function ( assert ) {\n\treturn assertShowHideWorksWhenSuccessful.apply( this, [ assert, 'mobile.mediaViewer', false ] );\n} );\n\nQUnit.test( '#loadModule when instructed to show/hide overlay and not successful', function ( assert ) {\n\tvar\n\t\tself = this,\n\t\tresult;\n\n\tsandbox.stub( rlModuleLoader, 'newLoadingOverlay' ).returns( this.stub );\n\n\tresult = rlModuleLoader.loadModule( 'mobile.mediaViewer', false, true );\n\n\tthis.deferred.reject();\n\n\tassert.rejects( result, 'returned promise rejects' );\n\treturn result.catch( function () {\n\t\tassert.strictEqual( self.stub.show.callCount, 1, 'LoadingOverlay show() called once' );\n\t\tassert.strictEqual( self.stub.appendTo.callCount, 1, 'LoadingOverlay appendTo() called once' );\n\t\tassert.strictEqual( self.stub.hide.callCount, 1, 'LoadingOverlay hide() called once' );\n\t\tassert.strictEqual( self.stub.hide.getCall( 0 ).args.length, 0, 'LoadingOverlay hide() called with no args' );\n\t} );\n} );\n\nQUnit.test( '#loadModule when instructed to show/not hide overlay and successful', function ( assert ) {\n\tvar\n\t\tself = this,\n\t\tresult;\n\n\tsandbox.stub( rlModuleLoader, 'newLoadingOverlay' ).returns( this.stub );\n\n\tresult = rlModuleLoader.loadModule( 'mobile.mediaViewer', true, true );\n\n\tassert.strictEqual( this.stub.show.callCount, 1, 'LoadingOverlay show() called once' );\n\tassert.strictEqual( this.stub.show.getCall( 0 ).args.length, 0, 'LoadingOverlay show() called with no args' );\n\tassert.strictEqual( this.stub.hide.callCount, 0, 'LoadingOverlay hide() not called' );\n\n\tthis.deferred.resolve();\n\n\treturn result.then( function ( overlay ) {\n\t\tassert.strictEqual( overlay, self.stub, 'Promise resolves to overlay instance' );\n\t\tassert.strictEqual( self.stub.show.callCount, 1, 'LoadingOverlay show() called once' );\n\t\tassert.strictEqual( self.stub.hide.callCount, 0, 'LoadingOverlay hide() not called' );\n\t} );\n} );\n\nQUnit.test( '#loadModule when instructed to show/not hide overlay and not successful', function ( assert ) {\n\tvar\n\t\tself = this,\n\t\tresult;\n\n\tsandbox.stub( rlModuleLoader, 'newLoadingOverlay' ).returns( this.stub );\n\n\tresult = rlModuleLoader.loadModule( 'mobile.mediaViewer', true, true );\n\n\tthis.deferred.reject();\n\n\tassert.rejects( result, 'returned promise rejects' );\n\treturn result.catch( function () {\n\t\tassert.strictEqual( self.stub.show.callCount, 1, 'LoadingOverlay show() called once' );\n\t\tassert.strictEqual( self.stub.hide.callCount, 0, 'LoadingOverlay hide() not called' );\n\t} );\n} );\n\nQUnit.test( '#loadModule when instructed to not show overlay and successful', function ( assert ) {\n\tvar\n\t\tself = this,\n\t\tresult;\n\n\tsandbox.stub( rlModuleLoader, 'newLoadingOverlay' ).returns( this.stub );\n\n\tresult = rlModuleLoader.loadModule( 'mobile.mediaViewer', false, false );\n\n\tassert.strictEqual( this.stub.show.callCount, 0, 'LoadingOverlay show() not called' );\n\tassert.strictEqual( this.stub.hide.callCount, 0, 'LoadingOverlay hide() not called' );\n\n\tthis.deferred.resolve();\n\n\treturn result.then( function ( overlay ) {\n\t\tassert.strictEqual( overlay, self.stub, 'Promise resolves to overlay instance' );\n\t\tassert.strictEqual( self.stub.show.callCount, 0, 'LoadingOverlay show() not called' );\n\t\tassert.strictEqual( self.stub.hide.callCount, 0, 'LoadingOverlay hide() not called' );\n\t} );\n} );\n\nQUnit.test( '#loadModule when instructed to not show overlay and not successful', function ( assert ) {\n\tvar\n\t\tself = this,\n\t\tresult;\n\n\tsandbox.stub( rlModuleLoader, 'newLoadingOverlay' ).returns( this.stub );\n\n\tresult = rlModuleLoader.loadModule( 'mobile.mediaViewer', false, false );\n\n\tthis.deferred.reject();\n\n\tassert.rejects( result, 'returned promise rejects' );\n\treturn result.catch( function () {\n\t\tassert.strictEqual( self.stub.show.callCount, 0, 'LoadingOverlay show() not called' );\n\t\tassert.strictEqual( self.stub.hide.callCount, 0, 'LoadingOverlay hide() not called' );\n\t} );\n} );\n","var time = require( '../../../src/mobile.startup/time' );\n\nQUnit.module( 'MobileFrontend time.js' );\n\nQUnit.test( 'timeAgo()', function ( assert ) {\n\tassert.propEqual( time.timeAgo( 40 ), {\n\t\tvalue: 40,\n\t\tunit: 'seconds'\n\t} );\n\tassert.propEqual( time.timeAgo( 149 ), {\n\t\tvalue: 2,\n\t\tunit: 'minutes'\n\t} );\n\tassert.propEqual( time.timeAgo( 150 ), {\n\t\tvalue: 3,\n\t\tunit: 'minutes'\n\t} );\n\tassert.propEqual( time.timeAgo( 7500 ), {\n\t\tvalue: 2,\n\t\tunit: 'hours'\n\t} );\n\tassert.propEqual( time.timeAgo( 90000 ), {\n\t\tvalue: 1,\n\t\tunit: 'days'\n\t} );\n\tassert.propEqual( time.timeAgo( 9000000 ), {\n\t\tvalue: 3,\n\t\tunit: 'months'\n\t} );\n\tassert.propEqual( time.timeAgo( 32000000 ), {\n\t\tvalue: 1,\n\t\tunit: 'years'\n\t} );\n\tassert.propEqual( time.timeAgo( 102000000 ), {\n\t\tvalue: 3,\n\t\tunit: 'years'\n\t} );\n} );\n","/* global $ */\nvar util,\n\tdom = require( '../utils/dom' ),\n\tmw = require( '../utils/mw' ),\n\tjQuery = require( '../utils/jQuery' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' );\n\n/** @type {sinon.SinonSandbox} */ var sandbox; // eslint-disable-line one-var\n\nQUnit.module( 'MobileFrontend util.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tmw.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tutil = require( '../../../src/mobile.startup/util' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'escapeSelector()', function ( assert ) {\n\tassert.strictEqual(\n\t\tutil.escapeSelector( '#selector-starts-with-hash' ),\n\t\t'\\\\#selector-starts-with-hash'\n\t);\n} );\n\nQUnit.test( 'grep()', function ( assert ) {\n\tassert.propEqual(\n\t\tutil.grep( [ 1, 2 ], function ( n ) {\n\t\t\treturn n > 1;\n\t\t} ),\n\t\t[ 2 ]\n\t);\n} );\n\nQUnit.test( 'docReady()', function ( assert ) {\n\tvar docReady = util.docReady();\n\tassert.strictEqual(\n\t\tdocReady instanceof $,\n\t\ttrue\n\t);\n} );\n\nQUnit.test( 'when()', function ( assert ) {\n\treturn util.when( { resolved: true } ).then( function ( res ) {\n\t\tassert.strictEqual(\n\t\t\tres.resolved,\n\t\t\ttrue\n\t\t);\n\t} );\n} );\n\nQUnit.test( 'Deferred() - resolve', function ( assert ) {\n\tvar deferred = new util.Deferred(),\n\t\tresponse = 'response';\n\tdeferred.resolve( response );\n\treturn deferred.then( function ( res ) {\n\t\tassert.strictEqual( res, response );\n\t} );\n} );\n\nQUnit.test( 'Deferred() - reject', function ( assert ) {\n\tvar deferred = new util.Deferred(),\n\t\tresponse = 'response';\n\tdeferred.reject( response );\n\treturn deferred.catch( function ( error ) {\n\t\tassert.strictEqual( error, response );\n\t} );\n} );\nQUnit.test( 'getDocument()', function ( assert ) {\n\tassert.strictEqual( util.getDocument().length, 1 );\n} );\n\nQUnit.test( 'getWindow()', function ( assert ) {\n\tassert.strictEqual( util.getWindow().length, 1 );\n} );\n\nQUnit.test( 'parseHTML()', function ( assert ) {\n\tvar htmlFragment = util.parseHTML( '<p>element content</p>', document );\n\tassert.strictEqual( typeof htmlFragment === 'object', true );\n\tassert.strictEqual( htmlFragment[ 0 ].innerHTML, 'element content' );\n} );\n\nQUnit.test( 'isNumeric()', function ( assert ) {\n\tassert.strictEqual( util.isNumeric( 123 ), true );\n\tassert.strictEqual( util.isNumeric( '123' ), true );\n\tassert.strictEqual( util.isNumeric( 'The string 123 is true? I don\\'t like it.' ), false );\n\tassert.strictEqual( util.isNumeric( NaN ), false );\n} );\n\nQUnit.test( 'extend()', function ( assert ) {\n\tvar a = { a: 'apple' },\n\t\tb = { b: 'banana' };\n\tutil.extend( a, b );\n\tassert.strictEqual( JSON.stringify( a ), '{\"a\":\"apple\",\"b\":\"banana\"}' );\n} );\n\nQUnit.test( 'escapeHash()', function ( assert ) {\n\tassert.strictEqual( util.escapeHash( '#escape:...hash' ), '#escape\\\\:\\\\.\\\\.\\\\.hash' );\n} );\n\nQUnit.test( 'isModifiedEvent() - true', function ( assert ) {\n\tvar testEl = document.createElement( 'div' );\n\n\ttestEl.addEventListener( 'click', function ( ev ) {\n\t\tassert.strictEqual( util.isModifiedEvent( ev ), true );\n\t} );\n\n\ttestEl.dispatchEvent( new window.MouseEvent( 'click', { ctrlKey: true } ) );\n} );\n\nQUnit.test( 'isModifiedEvent() - false', function ( assert ) {\n\tvar testEl = document.createElement( 'div' );\n\n\ttestEl.addEventListener( 'click', function ( ev ) {\n\t\tassert.strictEqual( util.isModifiedEvent( ev ), false );\n\t} );\n\n\ttestEl.dispatchEvent( new window.MouseEvent( 'click' ) );\n} );\n\nQUnit.test( 'repeatEvent', function ( assert ) {\n\tvar proxy = new OO.EventEmitter(),\n\t\tsrc = new OO.EventEmitter(),\n\t\tsrcEventData = 'test data';\n\n\tutil.repeatEvent( src, proxy, 'test' );\n\n\tproxy.on( 'test', function ( data ) {\n\t\tassert.strictEqual(\n\t\t\tdata,\n\t\t\tsrcEventData,\n\t\t\t'proxy responds to source events correctly' );\n\t} );\n\tsrc.emit( 'test', srcEventData );\n} );\n","var\n\tTalkBoard,\n\tPageGateway,\n\tsandbox,\n\tutil = require( '../../../src/mobile.startup/util' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' );\n\nQUnit.module( 'MobileFrontend TalkBoard.js', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\tPageGateway = require( '../../../src/mobile.startup/PageGateway' );\n\t\tTalkBoard = require( '../../../src/mobile.talk.overlays/TalkBoard' );\n\n\t\tthis.getPageDeferredReject = util.Deferred().reject( 'missingtitle' );\n\t\tthis.getPageDeferredResolve = util.Deferred().resolve( {\n\t\t\ttitle: 'Talk:Topic',\n\t\t\tid: 1,\n\t\t\tlead: '',\n\t\t\tsections: [\n\t\t\t\t{\n\t\t\t\t\tid: 50,\n\t\t\t\t\tline: 'Topic 1'\n\t\t\t\t}\n\t\t\t]\n\t\t} );\n\t\tsandbox.stub( PageGateway.prototype, 'getPage' )\n\t\t\t.withArgs( 'Talk:No exist' ).returns(\n\t\t\t\tthis.getPageDeferredReject )\n\t\t\t.withArgs( 'Talk:Topic' ).returns(\n\t\t\t\tthis.getPageDeferredResolve\n\t\t\t);\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'initializes correctly when new page', function ( assert ) {\n\tvar\n\t\tself = this,\n\t\toptions = {\n\t\t\tapi: {},\n\t\t\ttitle: 'Talk:No exist',\n\t\t\teventBus: {\n\t\t\t\ton: function () {}\n\t\t\t}\n\t\t},\n\t\tboard = new TalkBoard( options ),\n\t\tpage;\n\n\treturn this.getPageDeferredReject.catch( function () {\n\t\tpage = board.page;\n\t\tassert.strictEqual( page.title, 'Talk:No exist', 'Title set' );\n\t\tassert.strictEqual( page.getSections().length, 0, 'A page was setup with no sections' );\n\t\tassert.strictEqual( board.$( '.content-header' ).text().trim(),\n\t\t\tmw.msg( 'mobile-frontend-talk-explained-empty' ),\n\t\t\t'Check the header knows it is empty.' );\n\n\t\t// reload discussion board via ajax\n\t\tboard._loadContent( options );\n\n\t\treturn self.getPageDeferredReject.catch( function () {\n\t\t\tassert.strictEqual( page.getSections().length, 0, 'Discussions reloaded, still no sections' );\n\n\t\t\t// check whether there is an Add discussion button\n\t\t\tassert.strictEqual( board.$( '.add' ).length, 0, 'There is no \"Add discussion\" button' );\n\t\t} );\n\t} );\n} );\n\nQUnit.test( 'initializes correctly when existing page (lists section headings)', function ( assert ) {\n\tvar board = new TalkBoard( {\n\t\tapi: {},\n\t\ttitle: 'Talk:Topic',\n\t\teventBus: {\n\t\t\ton: function () {}\n\t\t}\n\t} );\n\n\treturn this.getPageDeferredResolve.then( function () {\n\t\tassert.strictEqual( board.$( '.topic-title-list li' ).length, 1, 'One topic heading is listed' );\n\t\tassert.strictEqual( board.$( '.topic-title-list li a' ).eq( 0 ).text(), 'Topic 1',\n\t\t\t'The text of the second item is the section heading.' );\n\t\tassert.strictEqual( board.$( '.topic-title-list li a' ).data( 'id' ), 50,\n\t\t\t'The data id is set.' );\n\t\tassert.strictEqual( board.$( '.content-header' ).text().trim(),\n\t\t\tmw.msg( 'mobile-frontend-talk-explained' ),\n\t\t\t'Check the header knows it is not empty.' );\n\t} );\n} );\n","var\n\tTalkSectionAddOverlay,\n\tsandbox,\n\tutil = require( '../../../src/mobile.startup/util' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' );\n\nQUnit.module( 'MobileFrontend TalkSectionAddOverlay', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\tTalkSectionAddOverlay = require( '../../../src/mobile.talk.overlays/TalkSectionAddOverlay' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'save()', function ( assert ) {\n\tvar overlay = new TalkSectionAddOverlay( {\n\t\tapi: {\n\t\t\tpostWithToken: sandbox.stub().returns(\n\t\t\t\tutil.Deferred().resolve()\n\t\t\t)\n\t\t},\n\t\ttitle: 'Talk:No exist'\n\t} );\n\t// set the content of the new discussion\n\toverlay.$( 'input' ).val( 'Testtitle' );\n\toverlay.$( 'textarea' ).val( 'Testcontent' );\n\t// Check the values\n\tassert.strictEqual( overlay.$( 'input' ).val(), 'Testtitle', 'Testtitle set' );\n\tassert.strictEqual( overlay.$( 'textarea' ).val(), 'Testcontent', 'Testcontent set' );\n\t// Test the save of the new dicsussion\n\treturn overlay.save().then( function ( status ) {\n\t\tassert.strictEqual( status, 'ok', 'The new discussion was saved' );\n\t\t// check, if the save was recognized\n\t\t// (so the overlay can hide without confirmation of the user)\n\t\tassert.strictEqual( overlay._saveHit, true, 'The save was recognized' );\n\t} );\n} );\n","var\n\tTalkSectionOverlay,\n\tsandbox,\n\tutil = require( '../../../src/mobile.startup/util' ),\n\tjQuery = require( '../utils/jQuery' ),\n\tdom = require( '../utils/dom' ),\n\tmediaWiki = require( '../utils/mw' ),\n\too = require( '../utils/oo' ),\n\tsinon = require( 'sinon' );\n\nQUnit.module( 'MobileFrontend TalkSectionOverlay.js - logged in', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\tTalkSectionOverlay = require( '../../../src/mobile.talk.overlays/TalkSectionOverlay' );\n\n\t\t// don't create toasts in test environment\n\t\tthis.toastStub = sandbox.stub( mw, 'notify' );\n\n\t\tsandbox.stub( mw.user, 'isAnon' ).returns( false );\n\t\tthis.renderFromApiSpy = sandbox.stub( TalkSectionOverlay.prototype, 'renderFromApi' );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'Load section from api only, if needed', function ( assert ) {\n\t// eslint-disable-next-line no-new\n\tnew TalkSectionOverlay( {\n\t\tapi: {},\n\t\tsection: 'Testtext'\n\t} );\n\n\tassert.strictEqual( this.renderFromApiSpy.callCount, 0, 'Section requested from api, if no section given.' );\n\n\t// eslint-disable-next-line no-new\n\tnew TalkSectionOverlay( {\n\t\tapi: {}\n\t} );\n\tassert.strictEqual( this.renderFromApiSpy.callCount, 1, 'No Api request, if section given' );\n} );\n\nQUnit.test( 'Check comment box for logged in users', function ( assert ) {\n\tvar overlay = new TalkSectionOverlay( {\n\t\tapi: {},\n\t\tsection: 'Test'\n\t} );\n\n\tassert.ok( overlay.$( '.comment' ).length > 0, 'There is a visible comment box' );\n} );\n\nQUnit.test( 'Check error class on textarea', function ( assert ) {\n\tvar overlay;\n\n\toverlay = new TalkSectionOverlay( {\n\t\tapi: {},\n\t\tsection: 'Test'\n\t} );\n\n\t// add error class\n\toverlay.onSaveClick();\n\tassert.ok( overlay.$textarea.hasClass( 'error' ), 'Error class added when try to submit empty comment box.' );\n\toverlay.onFocusTextarea();\n\tassert.strictEqual( overlay.$textarea.hasClass( 'error' ), false, 'Error class removed after comment box get focus.' );\n} );\n\nQUnit.test( 'Check api request on save', function ( assert ) {\n\tvar\n\t\tdeferred = util.Deferred().resolve(),\n\t\tspy = sandbox.stub().returns( deferred ),\n\t\toverlay = new TalkSectionOverlay( {\n\t\t\tapi: {\n\t\t\t\tpostWithToken: spy\n\t\t\t},\n\t\t\ttitle: 'Talk:Test',\n\t\t\tid: 1,\n\t\t\tsection: 'Test'\n\t\t} );\n\n\toverlay.$textarea.val( 'Testcomment' );\n\toverlay.onSaveClick();\n\n\treturn deferred.then( function () {\n\t\tassert.ok( spy.calledWith( 'csrf', {\n\t\t\taction: 'edit',\n\t\t\ttitle: 'Talk:Test',\n\t\t\tsection: 1,\n\t\t\tappendtext: '\\n\\nTestcomment ~~~~',\n\t\t\tredirect: true\n\t\t} ), 'Save request passes!' );\n\t} );\n} );\n\nQUnit.module( 'MobileFrontend TalkSectionOverlay.js - anonymous (logged out)', {\n\tbeforeEach: function () {\n\t\tsandbox = sinon.sandbox.create();\n\t\tdom.setUp( sandbox, global );\n\t\tjQuery.setUp( sandbox, global );\n\t\too.setUp( sandbox, global );\n\t\tmediaWiki.setUp( sandbox, global );\n\n\t\tTalkSectionOverlay = require( '../../../src/mobile.talk.overlays/TalkSectionOverlay' );\n\n\t\tsandbox.stub( mw.user, 'isAnon' ).returns( false );\n\t},\n\tafterEach: function () {\n\t\tjQuery.tearDown();\n\t\tsandbox.restore();\n\t}\n} );\n\nQUnit.test( 'Check comment box for logged out users', function ( assert ) {\n\tvar overlay = new TalkSectionOverlay( {\n\t\tapi: {},\n\t\tsection: 'Test'\n\t} );\n\n\tassert.ok( overlay.$( '.comment' ).length > 0, 'There is a visible comment box' );\n} );\n","var autosign = require( '../../../src/mobile.talk.overlays/autosign' );\n\nQUnit.module( 'MobileFrontend autosign.js' );\n\nQUnit.test( '#autosign', function ( assert ) {\n\t[\n\t\t// Forgot to sign\n\t\t[ 'foo', 'foo ~~~~' ],\n\t\t// 3 tildes signing (no date)\n\t\t[ 'foo ~~~', 'foo ~~~' ],\n\t\t// 5 tildes (no name)\n\t\t[ 'foo ~~~~~', 'foo ~~~~~' ],\n\t\t// No double signing\n\t\t[ 'foo ~~~~', 'foo ~~~~' ],\n\t\t// Unconventional signing1\n\t\t[ 'foo ~~~~ yolo', 'foo ~~~~ yolo' ],\n\t\t// Unconventional signing 2\n\t\t[ '~~~~ yolo', '~~~~ yolo' ]\n\t].forEach( function ( testCase ) {\n\t\tassert.strictEqual( autosign( testCase[0] ), testCase[1], 'Autosigning works as expected' );\n\t} );\n} );\n","module.exports = {\n\tgetPageHeadings: {\n\t\tinput: {\n\t\t\tmobileview: {\n\t\t\t\tid: -1,\n\t\t\t\tdisplaytitle: 'Test',\n\t\t\t\trevId: 42,\n\t\t\t\tlastmodifiedby: {\n\t\t\t\t\tname: 'bob',\n\t\t\t\t\tgender: 'unknown'\n\t\t\t\t},\n\t\t\t\tprotection: [],\n\t\t\t\tlastmodified: '2013-10-28T18:49:56Z',\n\t\t\t\tlanguagecount: 10,\n\t\t\t\tsections: [\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 0,\n\t\t\t\t\t\ttext: ''\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlevel: '1',\n\t\t\t\t\t\tline: '1',\n\t\t\t\t\t\tanchor: '1',\n\t\t\t\t\t\tid: 1,\n\t\t\t\t\t\ttext: '<p>Text of 1\\n</p>'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlevel: '2',\n\t\t\t\t\t\tline: '<i>1.1</i>',\n\t\t\t\t\t\tanchor: '1.1',\n\t\t\t\t\t\tid: 2,\n\t\t\t\t\t\ttext: '<p>Text of 1.1\\n</p>'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlevel: '1',\n\t\t\t\t\t\tline: '2',\n\t\t\t\t\t\tanchor: '2',\n\t\t\t\t\t\tid: 3,\n\t\t\t\t\t\ttext: '<p>Text of 2\\n</p>'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlevel: '2',\n\t\t\t\t\t\tline: '2.1',\n\t\t\t\t\t\tanchor: '2.1',\n\t\t\t\t\t\tid: 4,\n\t\t\t\t\t\ttext: '<p>Text of 2.1\\n</p>'\n\t\t\t\t\t} ]\n\t\t\t}\n\t\t},\n\t\toutput: {\n\t\t\thistoryUrl: 'Test:History',\n\t\t\tlastModifiedUserName: 'bob',\n\t\t\tlastModifiedUserGender: 'unknown',\n\t\t\tlastModifiedTimestamp: 1382986196,\n\t\t\ttitle: 'Test',\n\t\t\trevId: 42,\n\t\t\tdisplayTitle: 'Test',\n\t\t\tid: -1,\n\t\t\tprotection: {\n\t\t\t\tedit: [ '*' ]\n\t\t\t},\n\t\t\tisMainPage: false,\n\t\t\tlanguageCount: 10,\n\t\t\thasVariants: false,\n\t\t\tlead: '',\n\t\t\tsections: [\n\t\t\t\t{\n\t\t\t\t\tlevel: '1',\n\t\t\t\t\tline: '1',\n\t\t\t\t\tanchor: '1',\n\t\t\t\t\tid: 1,\n\t\t\t\t\ttext: '<p>Text of 1\\n</p><h2 id=\"1.1\"><i>1.1</i></h2>\\n<p>Text of 1.1\\n</p>\\n',\n\t\t\t\t\tsubsections: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlevel: '2',\n\t\t\t\t\t\t\tline: '<i>1.1</i>',\n\t\t\t\t\t\t\tanchor: '1.1',\n\t\t\t\t\t\t\tid: 2,\n\t\t\t\t\t\t\ttext: '<p>Text of 1.1\\n</p>',\n\t\t\t\t\t\t\tsubsections: []\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlevel: '1',\n\t\t\t\t\tline: '2',\n\t\t\t\t\tanchor: '2',\n\t\t\t\t\tid: 3,\n\t\t\t\t\ttext: '<p>Text of 2\\n</p><h2 id=\"2.1\">2.1</h2>\\n<p>Text of 2.1\\n</p>\\n',\n\t\t\t\t\tsubsections: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlevel: '2',\n\t\t\t\t\t\t\tline: '2.1',\n\t\t\t\t\t\t\tanchor: '2.1',\n\t\t\t\t\t\t\tid: 4,\n\t\t\t\t\t\t\ttext: '<p>Text of 2.1\\n</p>',\n\t\t\t\t\t\t\tsubsections: []\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t},\n\tgetPage: {\n\t\tinput: {\n\t\t\tmobileview: {\n\t\t\t\tid: -1,\n\t\t\t\tprotection: {\n\t\t\t\t\tedit: [ 'sysop' ]\n\t\t\t\t},\n\t\t\t\tlastmodifiedby: {\n\t\t\t\t\tname: 'Melissa',\n\t\t\t\t\tgender: 'female'\n\t\t\t\t},\n\t\t\t\trevId: 42,\n\t\t\t\tdisplaytitle: 'Test',\n\t\t\t\tlastmodified: '2013-10-28T18:49:56Z',\n\t\t\t\tlanguagecount: 10,\n\t\t\t\tsections: [\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 0,\n\t\t\t\t\t\ttext: 'lead content'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlevel: '2',\n\t\t\t\t\t\tline: 'Aaa section',\n\t\t\t\t\t\tanchor: 'Aaa_section',\n\t\t\t\t\t\tid: 1,\n\t\t\t\t\t\ttext: 'aaa content'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlevel: '3',\n\t\t\t\t\t\tline: 'Subaaa section',\n\t\t\t\t\t\tanchor: 'Subaaa_section',\n\t\t\t\t\t\tid: 2,\n\t\t\t\t\t\ttext: 'subaaa content'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlevel: '2',\n\t\t\t\t\t\tline: 'Bbb section',\n\t\t\t\t\t\tanchor: 'Bbb_section',\n\t\t\t\t\t\tid: 3,\n\t\t\t\t\t\ttext: 'bbb content'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlevel: '2',\n\t\t\t\t\t\tline: 'References',\n\t\t\t\t\t\treferences: '',\n\t\t\t\t\t\tanchor: 'References',\n\t\t\t\t\t\tid: 4,\n\t\t\t\t\t\ttext: 'references'\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t}\n\t\t},\n\t\toutput: {\n\t\t\thistoryUrl: 'Test:History',\n\t\t\tlastModifiedUserName: 'Melissa',\n\t\t\tlastModifiedUserGender: 'female',\n\t\t\tlastModifiedTimestamp: 1382986196,\n\t\t\tprotection: {\n\t\t\t\tedit: [ 'sysop' ]\n\t\t\t},\n\t\t\ttitle: 'Test',\n\t\t\tdisplayTitle: 'Test',\n\t\t\tid: -1,\n\t\t\tisMainPage: false,\n\t\t\trevId: 42,\n\t\t\tlanguageCount: 10,\n\t\t\thasVariants: false,\n\t\t\tlead: 'lead content',\n\t\t\tsections: [\n\t\t\t\t{\n\t\t\t\t\tlevel: '2',\n\t\t\t\t\tline: 'Aaa section',\n\t\t\t\t\tanchor: 'Aaa_section',\n\t\t\t\t\tid: 1,\n\t\t\t\t\ttext: 'aaa content<h3 id=\"Subaaa_section\">Subaaa section</h3>\\nsubaaa content\\n',\n\t\t\t\t\tsubsections: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlevel: '3',\n\t\t\t\t\t\t\tline: 'Subaaa section',\n\t\t\t\t\t\t\tanchor: 'Subaaa_section',\n\t\t\t\t\t\t\tid: 2,\n\t\t\t\t\t\t\ttext: 'subaaa content',\n\t\t\t\t\t\t\tsubsections: []\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlevel: '2',\n\t\t\t\t\tline: 'Bbb section',\n\t\t\t\t\tanchor: 'Bbb_section',\n\t\t\t\t\tid: 3,\n\t\t\t\t\ttext: 'bbb content',\n\t\t\t\t\tsubsections: []\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlevel: '2',\n\t\t\t\t\tline: 'References',\n\t\t\t\t\treferences: '',\n\t\t\t\t\tanchor: 'References',\n\t\t\t\t\tid: 4,\n\t\t\t\t\ttext: 'references',\n\t\t\t\t\tsubsections: []\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t},\n\tgetPageLanguagesResponse: {\n\t\tinput: {\n\t\t\tquery: {\n\t\t\t\tpages: [\n\t\t\t\t\t{\n\t\t\t\t\t\tpageid: 94,\n\t\t\t\t\t\tns: 0,\n\t\t\t\t\t\ttitle: 'San Francisco',\n\t\t\t\t\t\tlanglinks: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlang: 'es',\n\t\t\t\t\t\t\t\turl: 'http://es.wikipedia.org/wiki/San_Francisco_(California)',\n\t\t\t\t\t\t\t\ttitle: 'San Francisco (California)',\n\t\t\t\t\t\t\t\tautonym: 'espa\\u00f1ol'\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlang: 'pl',\n\t\t\t\t\t\t\t\turl: 'http://pl.wikipedia.org/wiki/San_Francisco',\n\t\t\t\t\t\t\t\ttitle: 'San Francisco',\n\t\t\t\t\t\t\t\tautonym: 'polski'\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlang: 'sr',\n\t\t\t\t\t\t\t\turl: 'http://sr.wikipedia.org/wiki/%D0%A1%D0%B0%D0%BD_%D0%A4%D1%80%D0%B0%D0%BD%D1%86%D0%B8%D1%81%D0%BA%D0%BE',\n\t\t\t\t\t\t\t\ttitle: '\\u0421\\u0430\\u043d \\u0424\\u0440\\u0430\\u043d\\u0446\\u0438\\u0441\\u043a\\u043e',\n\t\t\t\t\t\t\t\tautonym: '\\u0441\\u0440\\u043f\\u0441\\u043a\\u0438 / srpski'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t]\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\tgeneral: {\n\t\t\t\t\tvariants: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcode: 'sr',\n\t\t\t\t\t\t\tname: 'sr'\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcode: 'sr-ec',\n\t\t\t\t\t\t\tname: '\\u040b\\u0438\\u0440\\u0438\\u043b\\u0438\\u0446\\u0430'\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcode: 'sr-el',\n\t\t\t\t\t\t\tname: 'Latinica'\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\tvariantarticlepath: '/$2/$1'\n\t\t\t\t},\n\t\t\t\tlanguages: [\n\t\t\t\t\t{\n\t\t\t\t\t\tcode: 'sr',\n\t\t\t\t\t\tname: ' / srpski'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcode: 'sr-ec',\n\t\t\t\t\t\tname: ' ()'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcode: 'sr-el',\n\t\t\t\t\t\tname: 'srpski (latinica)'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcode: 'es',\n\t\t\t\t\t\tname: 'espaol'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcode: 'pl',\n\t\t\t\t\t\tname: 'polski'\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t},\n\t\t\tlimits: {\n\t\t\t\tlanglinks: 500\n\t\t\t}\n\t\t},\n\t\toutput: {\n\t\t\tlanguages: [\n\t\t\t\t{\n\t\t\t\t\tlang: 'es',\n\t\t\t\t\turl: 'http://es.wikipedia.org/wiki/San_Francisco_(California)',\n\t\t\t\t\ttitle: 'San Francisco (California)',\n\t\t\t\t\tautonym: 'espa\\u00f1ol'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'pl',\n\t\t\t\t\turl: 'http://pl.wikipedia.org/wiki/San_Francisco',\n\t\t\t\t\ttitle: 'San Francisco',\n\t\t\t\t\tautonym: 'polski'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'sr',\n\t\t\t\t\turl: 'http://sr.wikipedia.org/wiki/%D0%A1%D0%B0%D0%BD_%D0%A4%D1%80%D0%B0%D0%BD%D1%86%D0%B8%D1%81%D0%BA%D0%BE',\n\t\t\t\t\ttitle: '\\u0421\\u0430\\u043d \\u0424\\u0440\\u0430\\u043d\\u0446\\u0438\\u0441\\u043a\\u043e',\n\t\t\t\t\tautonym: '\\u0441\\u0440\\u043f\\u0441\\u043a\\u0438 / srpski'\n\t\t\t\t}\n\t\t\t],\n\t\t\tvariants: [\n\t\t\t\t{\n\t\t\t\t\tlang: 'sr',\n\t\t\t\t\tautonym: 'sr',\n\t\t\t\t\turl: '/sr/Test'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'sr-ec',\n\t\t\t\t\tautonym: '\\u040b\\u0438\\u0440\\u0438\\u043b\\u0438\\u0446\\u0430',\n\t\t\t\t\turl: '/sr-ec/Test'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlang: 'sr-el',\n\t\t\t\t\tautonym: 'Latinica',\n\t\t\t\t\turl: '/sr-el/Test'\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t},\n\tgetPageLanguagesCall: {\n\t\toutput: {\n\t\t\taction: 'query',\n\t\t\tmeta: 'siteinfo',\n\t\t\tsiprop: 'general',\n\t\t\tprop: 'langlinks',\n\t\t\tllprop: 'url|autonym|langname',\n\t\t\tllinlanguagecode: 'fr',\n\t\t\tlllimit: 'max',\n\t\t\ttitles: 'Title',\n\t\t\tformatversion: 2\n\t\t}\n\t},\n\tgetAPIResponseFromHTML: {\n\t\tinput: [\n\t\t\t{\n\t\t\t\tline: 'A1',\n\t\t\t\tlevel: '1',\n\t\t\t\tanchor: '1.0',\n\t\t\t\ttext: ''\n\t\t\t},\n\t\t\t{\n\t\t\t\tline: 'A2.1',\n\t\t\t\tlevel: '2',\n\t\t\t\tanchor: '',\n\t\t\t\ttext: ''\n\t\t\t},\n\t\t\t{\n\t\t\t\tline: 'A2.2',\n\t\t\t\tlevel: '2',\n\t\t\t\tanchor: '',\n\t\t\t\ttext: ''\n\t\t\t},\n\t\t\t{\n\t\t\t\tline: 'A2',\n\t\t\t\tlevel: '1',\n\t\t\t\tanchor: '',\n\t\t\t\ttext: ''\n\t\t\t},\n\t\t\t{\n\t\t\t\tline: 'A2.1',\n\t\t\t\tlevel: '2',\n\t\t\t\tanchor: '',\n\t\t\t\ttext: ''\n\t\t\t}\n\t\t]\n\t}\n\n};\n","/* eslint-env es6 */\nvar page, page2, skinPage, referencesPage, lazyLoadedReferencesPage;\n\n/**\n * Important..\n * Even though this page supports ES6, it is still compiled to ES5\n * friendly JavaScript.\n * It is thus imperative you do not use substitution in these templates\n * or any other ES6 functions.\n * It is expected to run in Special:JavaScript/qunit/test.\n * A linter will bark at you if you break this.\n */\n\npage = `<div>\n\t<h1><span class=\"mw-headline\" id=\"1.0\">A1</span></h1>\n\t<h2><span class=\"mw-headline\">A2.1</span></h2>\n\t<h2><span class=\"mw-headline\">A2.2</span></h2>\n\t<h1><span class=\"mw-headline\">A2</span></h1>\n\t<h2><span class=\"mw-headline\">A2.1</span><span>[<a href=\"#\">edit</a>]</span></h2>\n\t<h1>Not to be shown in the TOC<span class=\"placeholder\"></span></h1>\n</div>`;\n\npage2 = `<div>\n<h2><span class=\"mw-headline\" id=\"1.0\">A1</span></h2>\n<h3><span class=\"mw-headline\">A2.1</span></h3>\n<h2><span class=\"mw-headline\">A2.2</span></h2>\n<h1><span class=\"mw-headline\">A2</span></h1>\n<h2><span class=\"mw-headline\">A2.1</span></h2>\n</div>`;\n\nskinPage = `<div id=\"mw-content-text\">\n\t<h2 class=\"section-heading collapsible-heading open-block\">\n\t\t<span class=\"mw-headline\" id=\"Notes_and_references\">Notes and references</span>\n\t</h2>\n\t<div class=\"mf-section-2 collapsible-block open-block\" data-is-reference-section=\"1\">\n\t\t<p>Text</p>\n\t\t<a class=\"mf-lazy-references-placeholder\"></a>\n\t\t<h3><span class=\"mw-headline\" id=\"Notes\">Notes</span></h3>\n\t\t<a class=\"mf-lazy-references-placeholder\"></a>\n\t\t<h4 class=\"in-block\"><span class=\"mw-headline\" id=\"Refs\">Refs</span></h4>\n\t\t<a class=\"mf-lazy-references-placeholder\"></a>\n\t\t<p>no forget</p>\n\t\t<h5 class=\"in-block\"><span class=\"mw-headline\" id=\"More_refs\">More refs</span></h5>\n\t\t<p>1</p>\n\t\t<a class=\"mf-lazy-references-placeholder\"></a>\n\t\t<p>2</p>\n\t\t<a class=\"mf-lazy-references-placeholder\"></a>\n\t\t<p>3</p>\n\t</div>\n</div>`;\n\nreferencesPage = `<div id=\"mfe-test-references\">\n<sup id=\"cite_ref-1\" class=\"reference\">\n\t<a href=\"#cite_note-1\">[1]</a>\n</sup>\n<p>\n\tsup with encoded href attribute\n\t<sup id=\"cite_ref-Obama_1995,_2004,_pp._910_11-0\" class=\"reference\">\n\t\t<a href=\"#cite_note-Obama_1995,_2004,_pp._9%E2%80%9310-11\">[11]</a>\n\t</sup>\n</p>\n<ol class=\"references\">\n\t<li id=\"cite_note-1\">\n\t\t<span class=\"mw-cite-backlink\">\n\t\t\t<a href=\"#cite_ref-1\"></a>\n\t\t</span> <span class=\"reference-text\">hello</span>\n\t</li>\n\t<li id=\"cite_note-Obama_1995,_2004,_pp._910-11\">\n\t\t<span class=\"mw-cite-backlink\">\n\t\t\t<a href=\"#cite_ref-1\"></a>\n\t\t</span> <span class=\"reference-text\">found</span>\n\t</li>\n</ol>\n</div>`;\n\nlazyLoadedReferencesPage = `<div>\n<h2><span class=\"mw-headline\" id=\"1.0\">A1</span></h1>\n<div>text</div>\n<h2>references</h2>\n<div>\n\t<a class=\"mf-lazy-references-placeholder\">View citations</a>\n</div>\n</div>`;\n\nmodule.exports = {\n\tlazyLoadedReferencesPage: lazyLoadedReferencesPage,\n\treferencesPage: referencesPage,\n\tskinPage: skinPage,\n\tpage: page,\n\tpage2: page2\n};\n","var\n\theadless = typeof window !== 'object',\n\tjsdom = headless && require( 'jsdom' );\n\nmodule.exports = {\n\t/**\n\t * @param {sinon.SinonSandbox} sandbox\n\t * @param {NodeJS.Global} global\n\t * @return {void}\n\t */\n\tsetUp: function ( sandbox, global ) {\n\t\tif ( headless ) {\n\t\t\tglobal.window = global.window || undefined;\n\t\t\tglobal.document = global.document || undefined;\n\t\t\tsandbox.stub( global, 'window', new jsdom.JSDOM().window );\n\t\t\tsandbox.stub( global, 'document', window.document );\n\t\t\tglobal.Image = global.window.Image;\n\t\t\tglobal.Event = global.window.Event;\n\t\t}\n\t}\n};\n","var headless = typeof window !== 'object';\n\nmodule.exports = {\n\t/**\n\t * @param {sinon.SinonSandbox} sandbox\n\t * @param {NodeJS.Global} global\n\t * @return {void}\n\t */\n\tsetUp: function ( sandbox, global ) {\n\t\tif ( headless ) {\n\t\t\tglobal.$ = global.$ || undefined;\n\t\t\tsandbox.stub( global, '$', require( 'jquery' ) );\n\t\t}\n\t},\n\ttearDown: function () {\n\t\tif ( headless ) {\n\t\t\t// prevent jQuery from caching the global window object.\n\t\t\tdelete require.cache[require.resolve( 'jquery' )];\n\t\t}\n\t}\n};\n","var\n\theadless = typeof window !== 'object',\n\tnewMockMediaWiki = require( './mockMediaWiki' );\n\nmodule.exports = {\n\t/**\n\t * @param {sinon.SinonSandbox} sandbox\n\t * @param {NodeJS.Global} global\n\t * @return {void}\n\t */\n\tsetUp: function ( sandbox, global ) {\n\t\tif ( headless ) {\n\t\t\tglobal.mw = global.mw || undefined;\n\t\t\tsandbox.stub( global, 'mw', newMockMediaWiki() );\n\t\t}\n\t}\n};\n","var headless = typeof window !== 'object';\n\nmodule.exports = {\n\t/**\n\t * @param {sinon.SinonSandbox} sandbox\n\t * @param {NodeJS.Global} global\n\t * @return {void}\n\t */\n\tsetUp: function ( sandbox, global ) {\n\t\tvar OO;\n\t\tif ( headless ) {\n\t\t\tOO = require( 'oojs' );\n\t\t\tOO.ui = {\n\t\t\t\tElement: {\n\t\t\t\t\tstatic: {\n\t\t\t\t\t\tgetClosestScrollableContainer: function () {}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tTool: function () {}\n\t\t\t};\n\t\t\tglobal.OO = global.OO || undefined;\n\t\t\tsandbox.stub( global, 'OO', OO );\n\t\t}\n\t}\n};\n","(function() { module.exports = this[\"jquery\"]; }());","(function() { module.exports = this[\"jsdom\"]; }());","(function() { module.exports = this[\"oojs\"]; }());","(function() { module.exports = this[\"sinon\"]; }());"],"sourceRoot":""}